<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>快乐学习大冒险</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="每天一点点，坚持就很棒！学习打卡应用">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="快乐学习大冒险">
  <meta name="apple-touch-fullscreen" content="yes">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Apple Touch Icons (iOS) -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png">
  <link rel="mask-icon" href="app-icon.svg" color="#4f46e5">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink-900: #0f172a;
      --ink-700: #1f2937;
      --glass: rgba(255, 255, 255, 0.6);
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.08);
      --shadow-card: 0 8px 18px rgba(15, 23, 42, 0.1);
      --border-soft: rgba(15, 23, 42, 0.18);
      --theme-bg: linear-gradient(135deg, #bff7d0 0%, #e8fff2 45%, #b7f2ad 100%);
      --theme-border: rgba(16, 185, 129, 0.65);
      --theme-tint: #d8ffe8;
      --primary-start: #10b981;
      --primary-end: #22c55e;
      --accent-start: #38bdf8;
      --accent-end: #3b82f6;
      --warm-start: #f59e0b;
      --warm-end: #f97316;
    }
    .theme-forest {
      --theme-bg: linear-gradient(135deg, #c9f7dc 0%, #ecfff4 45%, #c1f2b6 100%), radial-gradient(120px 80px at 12% 18%, rgba(34, 197, 94, 0.14), transparent 60%), radial-gradient(140px 90px at 85% 12%, rgba(16, 185, 129, 0.12), transparent 62%), radial-gradient(120px 80px at 78% 78%, rgba(34, 197, 94, 0.12), transparent 60%);
      --theme-border: rgba(16, 185, 129, 0.65);
      --theme-tint: #d8ffe8;
      --primary-start: #00A699;
      --primary-end: #00C1AE;
      --accent-start: #FF385C;
      --accent-end: #FF5A5F;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-ocean {
      --theme-bg: linear-gradient(145deg, #b5ecff 0%, #e3f7ff 45%, #9ccfff 100%), radial-gradient(140px 90px at 18% 20%, rgba(59, 130, 246, 0.14), transparent 62%), radial-gradient(160px 100px at 82% 18%, rgba(14, 165, 233, 0.12), transparent 62%), radial-gradient(140px 90px at 80% 78%, rgba(59, 130, 246, 0.12), transparent 60%);
      --theme-border: rgba(14, 165, 233, 0.65);
      --theme-tint: #d6f4ff;
      --primary-start: #007A87;
      --primary-end: #00A699;
      --accent-start: #FF385C;
      --accent-end: #FF5A5F;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-candy {
      --theme-bg: linear-gradient(135deg, #ffd9ea 0%, #fff1c8 45%, #d7e9ff 100%), radial-gradient(140px 90px at 16% 18%, rgba(244, 114, 182, 0.16), transparent 62%), radial-gradient(160px 100px at 82% 16%, rgba(59, 130, 246, 0.12), transparent 62%), radial-gradient(140px 90px at 78% 78%, rgba(251, 191, 36, 0.12), transparent 62%);
      --theme-border: rgba(255, 56, 92, 0.7);
      --theme-tint: #ffe4ef;
      --primary-start: #FF385C;
      --primary-end: #FF5A5F;
      --accent-start: #00A699;
      --accent-end: #00C1AE;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-buddy {
      --theme-bg: linear-gradient(145deg, #bedaff 0%, #e7f1ff 45%, #9cc1ff 100%), radial-gradient(150px 100px at 22% 20%, rgba(59, 130, 246, 0.16), transparent 62%), radial-gradient(170px 110px at 78% 18%, rgba(14, 165, 233, 0.14), transparent 62%), radial-gradient(150px 100px at 72% 78%, rgba(59, 130, 246, 0.12), transparent 60%);
      --theme-border: rgba(59, 130, 246, 0.7);
      --theme-tint: #dbeafe;
      --primary-start: #3B82F6;
      --primary-end: #60A5FA;
      --accent-start: #06B6D4;
      --accent-end: #22D3EE;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    :root {
      --ui-radius-lg: 20px;
      --ui-radius-md: 14px;
      --ui-sat: 1;
      --ui-motion-scale: 1;
      --header-compact: 108px;
      --header-compact-gap: 6px;
      --segmented-height: 38px;
      --surface: #ffffff;
      --surface-2: #f3f6f8;
      --border: rgba(15, 23, 42, 0.14);
      --text-muted: #66737b;
      --accent: #14b8a6;
      --accent-2: #2dd4bf;
      --accent-ink: #55627A;
      --accent-ink-2: #3F4A60;
      --accent-mint-a: #A6E7E2;
      --accent-mint-b: #86D5CD;
      --accent-muted: #6E7A8F;
      --accent-soft: #ecfeff;
      --accent-sat: 0.9;
      --accent-main: var(--accent-ink);
      --accent-main-2: var(--accent-ink-2);
      --cta-h: 42px;
      --cta-radius: 20px;
      --cta-text: #f5f9f9;
      --cta-border: rgba(60, 126, 124, 0.28);
      --cta-bg-a: #89cec6;
      --cta-bg-b: #74b9b1;
      --cta-shadow: 0 10px 18px -14px rgba(30, 82, 84, 0.24);
      --cta-gloss: rgba(255, 255, 255, 0.3);
      --ring: rgba(72, 151, 147, 0.2);
      --ring-ink: rgba(76, 90, 120, .20);
      --ring-mint: rgba(84, 167, 156, .16);
      --pill-bg: var(--surface-2);
      --pill-border: var(--border);
      --theme-name: "BASE";
      --shadow-soft: 0 6px 16px rgba(20, 184, 166, 0.22);
      --border-soft: rgba(20, 184, 166, 0.28);
      --task-border-soft: rgba(148, 163, 184, 0.18);
      --task-shadow-soft: 0 2px 8px rgba(15, 23, 42, 0.04);
      --r-cover: 24px;
      --r-tile: 15px;
      --shadow-cover: 0 16px 30px -20px rgba(15, 23, 42, 0.28), 0 2px 8px rgba(15, 23, 42, 0.08);
      --border-cover: rgba(15, 23, 42, 0.14);
      --ink-a: #8792A8;
      --ink-b: #69758E;
      --mint-a: #C8F2EE;
      --mint-b: #A4E2DA;
      --metal-gloss: 0.12;
    }
    .age-junior {
      --ui-radius-lg: 24px;
      --ui-radius-md: 16px;
      --ui-sat: 1.05;
      --ui-motion-scale: 1;
      --header-compact: 114px;
      --accent-sat: 0.98;
      --cta-radius: 20px;
      --accent-main: color-mix(in srgb, var(--accent-mint-b) 78%, #0f172a 22%);
      --accent-main-2: color-mix(in srgb, var(--accent-mint-b) 88%, #0f172a 12%);
      --cta-bg-a: #9FE1DB;
      --cta-bg-b: #77C8C0;
      --theme-name: "MINT";
      --cta-border: rgba(67,148,142,.18);
      --ring: var(--ring-mint);
      --accent-muted: #6A8F8C;
      --accent: #4fb6ad;
      --accent-2: #73cfc5;
      --accent-soft: #ecfffb;
      --shadow-soft: 0 8px 18px rgba(45, 212, 191, 0.24);
      --border-soft: rgba(45, 212, 191, 0.3);
      --r-cover: 28px;
      --r-tile: 16px;
      --shadow-cover: 0 14px 28px -18px rgba(38, 137, 130, 0.24), 0 2px 8px rgba(38, 137, 130, 0.09);
      --border-cover: rgba(93, 167, 160, 0.22);
      --mint-a: #D8F7F3;
      --mint-b: #AFE8E1;
      --metal-gloss: 0.1;
    }
    .age-senior {
      --ui-radius-lg: 16px;
      --ui-radius-md: 12px;
      --ui-sat: 0.92;
      --ui-motion-scale: 0.7;
      --header-compact: 104px;
      --accent-sat: 0.74;
      --theme-name: "INK";
      --accent-ink: #4B5872;
      --accent-ink-2: #364059;
      --accent-main: color-mix(in srgb, var(--accent-ink) 82%, #0f172a 18%);
      --accent-main-2: color-mix(in srgb, var(--accent-ink-2) 88%, #0f172a 12%);
      --cta-radius: 18px;
      --cta-bg-a: #7D8AA2;
      --cta-bg-b: #5D6B86;
      --cta-text: rgba(245, 248, 248, 0.92);
      --cta-border: rgba(54,64,89,.22);
      --cta-gloss: rgba(255,255,255,0.10);
      --cta-shadow: 0 9px 16px -14px rgba(41, 61, 67, 0.22);
      --ring: var(--ring-ink);
      --text-muted: #647089;
      --border: rgba(15, 23, 42, 0.16);
      --accent-muted: #66708A;
      --accent: #4B5872;
      --accent-2: #364059;
      --accent-soft: #f3f5f9;
      --shadow-soft: 0 5px 12px rgba(63, 74, 96, 0.14);
      --border-soft: rgba(63, 74, 96, 0.2);
      --r-cover: 20px;
      --r-tile: 12px;
      --shadow-cover: 0 15px 26px -20px rgba(15, 23, 42, 0.38), 0 3px 10px rgba(36, 45, 63, 0.16);
      --border-cover: rgba(71, 85, 105, 0.32);
      --ink-a: #7D889E;
      --ink-b: #5D6A84;
      --metal-gloss: 0.26;
    }

    body {
      font-family: "PingFang SC", "SF Pro Text", "SF Pro Display", "Noto Sans SC", sans-serif;
      font-size: 15px;
      letter-spacing: 0.2px;
      background-color: #f8fafc;
      color: var(--ink-900);
      padding-bottom: env(safe-area-inset-bottom);
    }

    body::before {
      content: none;
    }
    #app::after {
      content: "THEME";
      position: fixed;
      top: calc(env(safe-area-inset-top) + 10px);
      right: 10px;
      z-index: 9999;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.2px;
      color: rgba(15, 23, 42, 0.68);
      border: 1px solid rgba(148, 163, 184, 0.28);
      background: rgba(255, 255, 255, 0.72);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      pointer-events: none;
    }
    #app.age-junior::after { content: "JUNIOR · MINT"; }
    #app.age-senior::after { content: "SENIOR · INK"; }

    /* C4.5 de-green overrides */
    /* 1) downgrade success-green to themed ceramic pills */
    .daily-task-item .inline-flex.items-center.px-1\.5.py-0\.5.rounded-full,
    .daily-task-head .daily-completion-rate {
      background: var(--pill-bg) !important;
      border-color: var(--pill-border) !important;
      color: var(--accent-muted) !important;
      box-shadow: none !important;
    }

    /* 2) unify emerald/green utility leftovers to theme accent */
    .daily-task-item [class*="bg-emerald"],
    .daily-task-item [class*="text-emerald"],
    .daily-task-item [class*="border-emerald"],
    .daily-task-item [class*="bg-green"],
    .daily-task-item [class*="text-green"],
    .daily-task-item [class*="border-green"] {
      background: var(--pill-bg) !important;
      border-color: var(--pill-border) !important;
      color: var(--accent-main) !important;
      filter: saturate(0.9);
    }

    /* 3) icons avoid fluorescent green */
    .daily-task-item svg,
    .daily-task-item .task-status-icon {
      color: var(--accent-main) !important;
      stroke: currentColor;
    }

    /* 4) bottom-nav active underline follows theme */
    .bottom-nav button.bottom-nav-active::after {
      background: var(--cta-bg-b) !important;
    }

    /* 5) CTA more glazed, less slab */
    .add-task-primary {
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--cta-bg-a) 26%, var(--surface) 74%),
        color-mix(in srgb, var(--cta-bg-b) 28%, var(--surface) 72%)
      ) !important;
      border: 1px solid color-mix(in srgb, var(--cta-border) 62%, rgba(255,255,255,.38) 38%) !important;
    }

    /* 6) senior metal calm */
    #app.age-senior .add-task-primary {
      box-shadow: 0 8px 14px -12px rgba(17,24,39,.18), inset 0 1px 0 rgba(255,255,255,.16) !important;
    }

    @media (max-width: 640px) {
      body {
        font-size: 16px;
        letter-spacing: 0.25px;
      }
      .text-xs {
        font-size: 12px;
      }
      .text-sm {
        font-size: 14px;
      }
      .app-header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: var(--header-compact-gap);
      }
      .app-title {
        font-size: 18px;
        white-space: nowrap;
        width: auto;
      }
      .app-header > div:first-child {
        width: auto;
      }
      .header-right {
        align-items: center;
        width: auto;
        gap: 6px;
      }
      .profile-row {
        width: auto;
        justify-content: space-between;
      }
      .settings-modal {
        width: 92%;
        max-width: 92%;
        max-height: 85vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .settings-modal .pin-actions {
        flex-direction: column;
      }
      .settings-modal .pin-actions button {
        width: 100%;
        font-size: 14px;
        padding: 10px 14px;
      }
      .settings-modal .profile-item {
        flex-direction: column;
        align-items: stretch;
      }
      .settings-modal .profile-fields {
        display: grid;
        grid-template-columns: minmax(160px, 1fr) 72px;
        gap: 8px;
        align-items: center;
        max-width: 320px;
        margin: 0 auto;
      }
      .settings-modal .profile-name {
        width: 100%;
      }
      .settings-modal .profile-age {
        width: 100%;
      }
      .settings-modal .profile-actions {
        flex-direction: row;
        justify-content: space-between;
        gap: 8px;
      }
      .settings-modal .profile-actions button {
        flex: 1 1 auto;
        font-size: 12px;
        padding: 8px 10px;
      }
      .settings-modal .profile-new {
        flex-direction: column;
      }
      .settings-modal .profile-new button {
        width: 100%;
        padding: 10px 14px;
        font-size: 14px;
      }
      .settings-modal .danger-btn {
        font-size: 13px;
        padding: 8px 10px;
      }
      .settings-modal .danger-area {
        padding: 10px;
      }
      .settings-modal .danger-title {
        font-size: 12px;
      }
      .mobile-center {
        text-align: center;
      }
      .mobile-stack {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .settings-overlay {
        align-items: flex-start;
        padding: 16px 12px 24px;
      }
      .mobile-tabs button {
        font-size: 13px;
        padding: 8px 0;
      }
      .mobile-full {
        width: 100%;
      }
      .mobile-btn {
        width: 100%;
        font-size: 14px;
        padding: 10px 14px;
      }
      .mobile-input {
        width: 100%;
        font-size: 14px;
        padding: 10px 12px;
      }
      .mobile-tabs {
        font-size: 13px;
      }
      .mobile-tabs button {
        padding: 8px 0;
      }
      .mobile-chips {
        width: 100%;
        justify-content: center;
      }
      .mobile-chips button {
        padding: 8px 12px;
        font-size: 13px;
      }
      .mobile-actions {
        flex-direction: row;
        align-items: center;
        gap: 6px;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .ios-compact-header {
        max-height: var(--header-compact);
      }
      .ios-segmented-tabs {
        top: 0;
      }
    }

    .mature-ui {
      filter: saturate(0.92);
    }
    .mature-ui .app-title {
      font-family: "Noto Sans SC", sans-serif;
      letter-spacing: 0.4px;
    }
    .mature-ui .soft-shadow {
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .mature-ui .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm,
    .mature-ui .theme-pill-active {
      filter: saturate(0.85) brightness(0.98);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm {
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.6), 0 6px 14px rgba(15,23,42,0.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .glass-btn {
      background: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.75) 0%,
        rgba(255, 255, 255, 0.35) 100%
      );
      color: #0f172a;
      border: 1px solid var(--theme-border);
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    button:not(.icon-btn) {
      border-radius: 999px;
      min-height: 40px;
      padding: 10px 16px;
      background: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.75) 0%,
        rgba(255, 255, 255, 0.35) 100%
      );
      color: #0f172a !important;
      border: 1px solid var(--theme-border) !important;
      box-shadow: none !important;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    button:not(.icon-btn):hover {
      filter: brightness(1.02);
    }
    button:not(.icon-btn):disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .pill-btn {
      border-radius: 999px;
      min-height: 44px;
      padding: 12px 18px;
      font-size: 15px;
    }
    .btn-compact {
      min-height: 30px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .btn-chip {
      min-height: 26px;
      padding: 4px 10px;
      font-size: 11px;
    }
    .settings-menu-btn {
      display: block;
      width: 100%;
      min-height: 56px;
      padding: 14px 16px;
    }
    body.mature-mode::before {
      opacity: 0.4;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid rgba(16, 185, 129, 0.5);
      outline-offset: 2px;
    }

    .app-title {
      font-family: "ZCOOL KuaiLe", "ZCOOL XiaoWei", serif;
      letter-spacing: 1px;
    }

    .soft-card {
      background: var(--glass);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
    }

    .soft-shadow {
      box-shadow: var(--shadow-card);
    }

    .lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .lift:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }
    .app-shell {
      background: #ffffff;
      border-radius: 0;
      filter: saturate(var(--ui-sat));
    }
    .build-debug-tag {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 10001;
      background: rgba(15, 23, 42, 0.92);
      color: #ffffff;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }
    .ios-compact-header {
      width: 100%;
      max-width: 56rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: linear-gradient(180deg, #def7ea 0%, #ffffff 100%);
      border-radius: 14px;
      min-height: 104px;
      max-height: 120px;
    }
    .compact-top-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .compact-mini-stats {
      display: none;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      background: rgba(236, 253, 245, 0.7);
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      color: #0f766e;
      white-space: nowrap;
    }
    .header-collapsed .compact-mini-stats {
      display: inline-flex;
    }
    .header-expanded .compact-mini-stats {
      display: none;
    }
    .header-collapsed .compact-progress-row,
    .header-collapsed .compact-progress-detail {
      display: none;
    }
    .btn-ghost.btn-mini {
      min-height: 24px !important;
      border-radius: 999px !important;
      padding: 3px 8px !important;
      font-size: 10px !important;
      background: rgba(255, 255, 255, 0.84) !important;
      border: 1px solid rgba(148, 163, 184, 0.35) !important;
      color: #475569 !important;
      box-shadow: none !important;
    }
    .compact-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .compact-profile-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      font-size: 11px;
      color: #334155;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 999px;
      padding: 4px 8px;
    }
    .compact-top-row .icon-btn {
      font-size: 12px;
      color: #64748b;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.8);
    }
    .compact-progress-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-height: 34px;
      cursor: pointer;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.84);
      border-radius: 12px;
      padding: 5px 8px;
    }
    .compact-progress-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .compact-progress-ring {
      width: 30px;
      height: 30px;
      flex-shrink: 0;
    }
    .compact-progress-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .compact-progress-text strong {
      font-size: 13px;
      color: #0f172a;
    }
    .compact-progress-text span {
      font-size: 10px;
      color: #64748b;
    }
    .compact-xp-chip {
      font-size: 10px;
      font-weight: 600;
      color: #0f766e;
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 999px;
      padding: 3px 8px;
      white-space: nowrap;
      background: rgba(236, 253, 245, 0.85);
    }
    .compact-expand-hint {
      font-size: 10px;
      color: #94a3b8;
      white-space: nowrap;
    }
    .compact-progress-detail {
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.75);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 10px;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .encourage-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 6px 9px;
      margin-bottom: 6px;
    }
    .line-clamp-1 {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .encourage-inline.encourage-collapsed .quote-line {
      display: inline-block;
      max-width: 100%;
    }
    .encourage-inline.encourage-collapsed {
      min-height: 32px;
      padding-top: 3px;
      padding-bottom: 3px;
    }
    .encourage-inline.encourage-collapsed .encourage-inline-main {
      font-size: 11px;
    }
    .encourage-inline.encourage-collapsed .text-slate-500 {
      font-size: 10px;
    }
    .encourage-inline-main {
      flex: 1 1 auto;
      min-width: 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #334155;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .encourage-inline-main .quote-line {
      color: #0f766e;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .ios-segmented-tabs {
      position: sticky;
      top: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(248, 250, 252, 0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom: 6px;
      min-height: var(--segmented-height);
    }
    .ios-segmented-tabs button {
      flex: 1 1 auto;
      min-height: 30px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 9px;
      border: 1px solid transparent !important;
      background: transparent !important;
      color: #64748b !important;
      box-shadow: none !important;
    }
    .ios-segmented-tabs button.segment-active {
      background: #ffffff !important;
      color: #0f172a !important;
      border-color: color-mix(in srgb, var(--accent-main-2) 36%, var(--border) 64%) !important;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.05), inset 0 0 0 1px color-mix(in srgb, var(--ring) 38%, transparent 62%) !important;
    }
    .daily-tools-inline {
      margin-top: 8px;
      margin-bottom: 6px;
      border: 1px solid rgba(148, 163, 184, 0.26);
      background: rgba(255, 255, 255, 0.86);
      border-radius: 11px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      white-space: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .daily-tools-inline .meta {
      font-size: 11px;
      color: #64748b;
    }
    .daily-tools-inline .actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .daily-tools-inline .actions .btn-chip {
      min-height: 24px;
      padding: 3px 8px;
      font-size: 10px;
    }
    .daily-tools-inline .actions select {
      min-height: 24px;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
    }
    .mobile-main-lift {
      padding-bottom: calc(env(safe-area-inset-bottom) + 84px);
    }
    .book {
      width: 100%;
      max-width: 56rem;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      position: relative;
      perspective: 1400px;
    }
    .book-page {
      width: 100%;
      flex: 1 1 auto;
      min-width: 0;
      transform-origin: left center;
      backface-visibility: hidden;
      transform-style: preserve-3d;
    }
    .page-enter,
    .page-leave {
      transition: transform 360ms cubic-bezier(0.24, 0.72, 0.2, 1), opacity 320ms ease, filter 320ms ease;
      will-change: transform, opacity, filter;
    }
    .page-from {
      opacity: 0;
      filter: blur(1px);
      transform: rotateY(-12deg) translateX(20px) scale(0.988);
    }
    .page-to {
      opacity: 0;
      filter: blur(1px);
      transform: rotateY(10deg) translateX(-16px) scale(0.988);
    }
    .cover-wrap {
      min-height: 72vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
    }
    .cover-card {
      width: 100%;
      max-width: 540px;
      position: relative;
      overflow: hidden;
      border-radius: var(--r-cover);
      border: 1px solid var(--border-cover);
      background: linear-gradient(165deg, var(--mint-a) 0%, var(--mint-b) 56%, #ffffff 100%);
      box-shadow: var(--shadow-cover);
      padding: 28px 22px 22px;
      text-align: center;
      isolation: isolate;
    }
    .age-senior .cover-card {
      background: linear-gradient(165deg, var(--ink-a) 0%, var(--ink-b) 58%, #f7f9fc 100%);
    }
    .cover-card::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0));
      opacity: 0.26;
      pointer-events: none;
    }
    .age-senior .cover-card::before {
      background: linear-gradient(104deg, rgba(255, 255, 255, 0.32) 0%, rgba(255, 255, 255, 0) 34%, rgba(100, 116, 139, 0.22) 54%, rgba(255, 255, 255, 0) 82%);
      opacity: var(--metal-gloss);
      mix-blend-mode: overlay;
    }
    .cover-card::after {
      content: "";
      position: absolute;
      inset: -2px;
      background: radial-gradient(100% 65% at 50% 0%, rgba(255, 255, 255, 0.56), rgba(255, 255, 255, 0)), radial-gradient(70% 45% at 100% 100%, rgba(15, 23, 42, 0.08), rgba(15, 23, 42, 0));
      opacity: 0.72;
      pointer-events: none;
    }
    .cover-kicker {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 24px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255, 255, 255, 0.72);
      color: #5f6b7a;
      font-size: 10px;
      letter-spacing: 0.15em;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    .cover-title {
      margin-top: 12px;
      color: #0f172a;
      font-size: clamp(30px, 7.2vw, 42px);
      line-height: 1.08;
      font-weight: 800;
      letter-spacing: 0.01em;
      position: relative;
      z-index: 1;
    }
    .cover-subtitle {
      margin-top: 6px;
      color: #5f6b7a;
      font-size: 12px;
      letter-spacing: 0.2em;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    .cover-strap {
      margin: 14px auto 0;
      max-width: 94%;
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px dashed rgba(15, 23, 42, 0.14);
      background: rgba(255, 255, 255, 0.66);
      color: #415063;
      font-size: 12px;
      line-height: 1.4;
      position: relative;
      z-index: 1;
    }
    .cover-strap-row {
      margin: 14px auto 0;
      max-width: 94%;
      display: flex;
      align-items: center;
      gap: 6px;
      position: relative;
      z-index: 1;
    }
    .cover-strap {
      margin: 0;
      flex: 1 1 auto;
      min-height: 31px;
    }
    .cover-strap-text {
      width: 100%;
      display: inline-block;
      line-height: 1.35;
    }
    .cover-strap-actions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }
    .cover-strap-mini {
      min-height: 28px;
      padding: 0 8px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(255, 255, 255, 0.78);
      color: #475569;
      font-size: 11px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .cover-strap-mini.icon {
      width: 28px;
      padding: 0;
    }
    .cover-enc-enter-active,
    .cover-enc-leave-active {
      transition: opacity 220ms ease, transform 220ms ease;
    }
    .cover-enc-enter-from,
    .cover-enc-leave-to {
      opacity: 0;
      transform: translateY(4px);
    }
    .cover-photo-strip {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }
    .cover-photo-tile {
      width: 48px;
      height: 48px;
      border-radius: var(--r-tile);
      border: 1px solid var(--border-cover);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.75), 0 3px 10px rgba(15, 23, 42, 0.1);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      color: #0f172a;
      font-size: 14px;
      font-weight: 700;
    }
    .age-junior .cover-photo-tile {
      border-color: rgba(93, 167, 160, 0.22);
    }
    .age-senior .cover-photo-tile {
      border-color: rgba(71, 85, 105, 0.32);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.42), 0 4px 12px rgba(30, 41, 59, 0.16);
    }
    .cover-photo-tile img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .cover-photo-empty {
      color: #94a3b8;
      font-weight: 600;
      background: rgba(248, 250, 252, 0.95);
      background-image: linear-gradient(150deg, rgba(166, 231, 226, 0.34), rgba(255, 255, 255, 0.95));
    }
    .age-senior .cover-photo-empty {
      background-image: linear-gradient(150deg, rgba(75, 88, 114, 0.25), rgba(255, 255, 255, 0.96));
      color: #718096;
    }
    .cover-date {
      margin-top: 10px;
      color: #64748b;
      font-size: 11px;
      position: relative;
      z-index: 1;
    }
    .cover-cta {
      margin-top: 16px;
      min-height: 44px;
      padding: 10px 18px;
      border-radius: var(--r-tile);
      border: 1px solid var(--cta-border);
      color: var(--cta-text);
      background: linear-gradient(180deg, var(--cta-bg-a), var(--cta-bg-b));
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
      position: relative;
      z-index: 1;
      box-shadow: var(--cta-shadow), inset 0 1px 0 var(--cta-gloss);
      transition: transform 140ms ease, box-shadow 140ms ease, filter 140ms ease;
    }
    .age-junior .cover-cta {
      background: linear-gradient(180deg, var(--mint-a), var(--mint-b));
      border-color: rgba(93, 167, 160, 0.24);
      box-shadow: 0 10px 18px -14px rgba(41, 128, 120, 0.28), inset 0 1px 0 rgba(255, 255, 255, 0.34);
    }
    .age-senior .cover-cta {
      background: linear-gradient(180deg, var(--ink-a), var(--ink-b));
      border-color: rgba(71, 85, 105, 0.34);
      letter-spacing: 0.005em;
      box-shadow: 0 8px 16px -14px rgba(31, 41, 55, 0.36), inset 0 1px 0 rgba(255, 255, 255, 0.14);
    }
    .cover-cta::before {
      content: "";
      position: absolute;
      inset: 1px 1px auto 1px;
      height: 42%;
      border-radius: calc(var(--r-tile) - 2px) calc(var(--r-tile) - 2px) calc(var(--r-tile) - 4px) calc(var(--r-tile) - 4px);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.36), rgba(255, 255, 255, 0));
      pointer-events: none;
    }
    .cover-cta:hover {
      filter: brightness(1.02);
    }
    .cover-cta:active {
      transform: translateY(1px) scale(0.995);
      box-shadow: 0 6px 10px -10px rgba(15, 23, 42, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.16);
    }
    .cover-photo-modal {
      z-index: 44;
    }
    .cover-photo-panel {
      width: min(94vw, 540px);
      border-radius: 24px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      box-shadow: 0 20px 34px -22px rgba(15, 23, 42, 0.45), 0 8px 20px rgba(15, 23, 42, 0.1);
      padding: 16px;
    }
    .cover-photo-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .cover-photo-slot {
      border: 1px solid rgba(15, 23, 42, 0.1);
      border-radius: 16px;
      background: rgba(248, 250, 252, 0.8);
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }
    .cover-photo-btn,
    .cover-photo-delete {
      width: 100%;
      min-height: 30px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #fff;
      color: #334155;
      text-align: center;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .cover-photo-delete[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }
    @media (min-width: 768px) {
      .cover-photo-tile {
        width: 60px;
        height: 60px;
        border-radius: 18px;
      }
      .cover-photo-slot {
        border-radius: 18px;
      }
    }
    .sticker-inline-hint {
      margin-bottom: 6px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      background: rgba(236, 253, 245, 0.72);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      color: #0f766e;
    }
    .variant-card {
      border-radius: var(--ui-radius-lg) !important;
    }
    .content-surface {
      background: #ffffff !important;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }
    .daily-main-card {
      background: #ffffff !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06) !important;
    }
    .daily-task-item {
      border-color: var(--task-border-soft) !important;
      box-shadow: 0 2px 7px rgba(15, 23, 42, 0.035);
      background: rgba(255, 255, 255, 0.97) !important;
    }
    .daily-task-head {
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    .daily-task-title {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: 0.1px;
    }
    .daily-completion-rate {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-muted);
    }
    .daily-task-head .daily-completion-rate {
      background: var(--pill-bg) !important;
      border-color: var(--pill-border) !important;
      color: var(--accent-muted) !important;
      box-shadow: none !important;
    }
    .daily-task-item .inline-flex.items-center.px-1\.5.py-0\.5.rounded-full {
      background: var(--pill-bg) !important;
      border-color: var(--pill-border) !important;
      color: var(--accent-muted) !important;
    }
    .variant-subcard {
      border-radius: var(--ui-radius-md) !important;
    }
    .bottom-nav {
      position: sticky;
      bottom: 0;
      width: 100%;
      max-width: 56rem;
      display: flex;
      gap: 0;
      padding: 0 10px calc(env(safe-area-inset-bottom) + 10px);
      z-index: 20;
      background: rgba(255,255,255,0.98);
      border: none;
      border-radius: 0;
      box-shadow: 0 -6px 18px rgba(15, 23, 42, 0.08);
      backdrop-filter: saturate(1.1) blur(10px);
      -webkit-backdrop-filter: saturate(1.1) blur(10px);
    }
    .bottom-nav button {
      flex: 1 1 0%;
      min-height: 56px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 0 !important;
      border: none !important;
      background: transparent !important;
      color: #6b7280 !important;
      box-shadow: none !important;
      position: relative;
      padding: 0 6px 8px;
    }
    .bottom-nav button.bottom-nav-active {
      font-weight: 700;
      color: color-mix(in srgb, var(--accent-main) 70%, #0f172a 30%) !important;
    }
    .bottom-nav button.bottom-nav-active::after {
      content: "";
      position: absolute;
      left: 20%;
      right: 20%;
      bottom: 4px;
      height: 2px;
      border-radius: 999px;
      background: var(--cta-bg-b);
    }
    .age-junior .bottom-nav button {
      min-height: 56px;
      font-size: 13px;
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .page-enter,
      .page-leave {
        transition: none !important;
      }
      .page-from,
      .page-to {
        transform: none !important;
        filter: none !important;
        opacity: 1 !important;
      }
      .cover-cta {
        transition: none !important;
      }
    }

    .btn-primary {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-primary:hover {
      filter: brightness(1.02);
    }

    .btn-accent {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-warm {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-main {
      padding: 14px 18px;
      border-radius: 999px;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    .add-task-primary {
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--cta-bg-a) 30%, var(--surface) 70%),
        color-mix(in srgb, var(--cta-bg-b) 32%, var(--surface) 68%)
      ) !important;
      color: var(--cta-text) !important;
      border: 1px solid color-mix(in srgb, var(--cta-border) 65%, rgba(255, 255, 255, 0.35) 35%) !important;
      box-shadow: 0 8px 14px -12px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.24) !important;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.18);
      min-height: var(--cta-h) !important;
      border-radius: var(--cta-radius) !important;
      font-weight: 650;
      letter-spacing: 0.12px;
      padding: 8px 14px !important;
      max-width: calc(100% - 32px);
      margin: 0 16px;
    }
    .add-task-primary:hover {
      filter: brightness(0.99);
      box-shadow: 0 6px 12px -12px rgba(0, 0, 0, 0.13), inset 0 1px 0 rgba(255, 255, 255, 0.22) !important;
    }
    .add-task-primary:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px -14px color-mix(in srgb, var(--ring) 65%, transparent 35%), inset 0 1px 0 rgba(255, 255, 255, 0.18) !important;
    }
    .add-task-primary:focus-visible {
      box-shadow: var(--cta-shadow), 0 0 0 3px color-mix(in srgb, var(--ring) 78%, transparent 22%), inset 0 1px 0 var(--cta-gloss) !important;
    }
    .mobile-chips button {
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.05);
    }
    .settings-menu-btn {
      border-width: 1px !important;
      border-color: rgba(100, 116, 139, 0.24) !important;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.05);
    }
    .task-delete-btn {
      background: color-mix(in srgb, var(--surface) 86%, #f5f7fa 14%) !important;
      border: 1px solid rgba(148, 163, 184, 0.32) !important;
      color: var(--text-muted) !important;
      box-shadow: none !important;
    }
    @media (max-width: 430px) {
      .app-shell {
        padding-top: calc(env(safe-area-inset-top) + 1px) !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
      }
      .ios-compact-header {
        margin-bottom: 2px;
        padding: 4px 7px;
        border-radius: 10px;
      }
      .header-collapsed.ios-compact-header {
        min-height: 44px;
        max-height: 52px;
      }
      .compact-top-row {
        gap: 5px;
      }
      .compact-profile-pill {
        font-size: 9px;
        padding: 2px 6px;
      }
      .compact-top-row .icon-btn {
        padding: 1px 5px;
        font-size: 10px;
      }
      .compact-mini-stats {
        font-size: 9px;
        padding: 1px 6px;
      }
      .btn-ghost.btn-mini {
        min-height: 20px !important;
        padding: 1px 6px !important;
        font-size: 9px !important;
      }
      .header-expanded .compact-progress-row {
        min-height: 28px;
        padding: 3px 6px;
        margin-top: 2px;
      }
      .header-expanded .compact-progress-ring {
        width: 22px;
        height: 22px;
      }
      .header-expanded .compact-progress-text strong {
        font-size: 11px;
      }
      .header-expanded .compact-progress-text span {
        font-size: 9px;
      }
      .header-expanded .compact-xp-chip {
        font-size: 9px;
        padding: 2px 6px;
      }
      .header-expanded .compact-expand-hint {
        display: none;
      }
      .header-expanded .compact-progress-detail {
        padding: 5px 7px;
        font-size: 9px;
      }
      .encourage-inline {
        margin-bottom: 2px;
        border-radius: 10px;
        padding: 3px 7px;
      }
      .encourage-inline-main {
        font-size: 10px;
      }
      .ios-segmented-tabs {
        min-height: 31px;
        padding: 1px;
        margin-bottom: 2px;
      }
      .ios-segmented-tabs button {
        min-height: 26px;
        font-size: 10px;
      }
      .mobile-main-lift {
        margin-top: -12px;
        gap: 3px !important;
      }
    }

    .glow-ring {
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.12);
    }

    /* 基础动画 & 自定义样式 */
    @keyframes coin-pop {
      0% {
        transform: translateY(0) scale(0.6);
        opacity: 0;
      }
      30% {
        transform: translateY(-20px) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-40px) scale(0.8);
        opacity: 0;
      }
    }
    .coin-anim {
      animation: coin-pop 0.6s ease-out forwards;
    }

    /* 任务完成打勾的小动画 */
    @keyframes check-bounce {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .check-anim {
      animation: check-bounce 0.25s ease-out;
    }

    @keyframes reward-pop {
      0% { transform: translateY(10px) scale(0.95); opacity: 0; }
      60% { transform: translateY(-4px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .reward-pop {
      animation: reward-pop 0.35s ease-out;
    }

    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      50% { transform: scale(1.06) rotate(4deg); filter: drop-shadow(0 0 8px rgba(59,130,246,0.6)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
    }
    .diamond-sparkle {
      animation: sparkle 2.2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .diamond-bg {
      background: linear-gradient(135deg, #60a5fa 0%, #a5f3fc 35%, #e0f2fe 65%, #93c5fd 100%);
      background-size: 200% 200%;
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes flag-wave {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(6deg); }
      100% { transform: rotate(0deg); }
    }
    .flag-wave {
      animation: flag-wave 1.6s ease-in-out infinite;
      transform-origin: left center;
    }
    @keyframes icon-float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }
    .icon-anim {
      animation: icon-float 2s ease-in-out infinite;
    }

    @keyframes fade-slide {
      0% { opacity: 0; transform: translateY(6px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .fade-slide {
      animation: fade-slide 0.25s ease-out;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(140px) rotate(260deg); opacity: 0; }
    }
    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 20;
    }
    .confetti-piece {
      position: absolute;
      width: 8px;
      height: 12px;
      border-radius: 2px;
      opacity: 0;
      animation: confetti-fall var(--dur) ease-out var(--delay) forwards;
      left: var(--x);
      background: var(--color);
    }
    .sticker-book-card {
      border: 1px solid rgba(16, 185, 129, 0.24);
      background: linear-gradient(135deg, rgba(236, 253, 245, 0.9), rgba(240, 249, 255, 0.86));
    }
    .sticker-chip {
      min-width: 72px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.85);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    @keyframes sticker-chip-pop {
      0% { transform: scale(0.92); opacity: 0.7; }
      60% { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .sticker-chip-new {
      animation: sticker-chip-pop 0.32s ease-out;
      border-color: rgba(16, 185, 129, 0.45);
      box-shadow: 0 6px 14px rgba(16, 185, 129, 0.2);
    }
    @keyframes sticker-hint-pop {
      0% { transform: translateY(6px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .sticker-hint-pop {
      animation: sticker-hint-pop 0.24s ease-out;
    }

    .drag-handle {
      cursor: grab;
      user-select: none;
    }
    .dragging {
      opacity: 0.6;
      transform: scale(0.98);
    }

    .theme-pill-active {
      color: #0f172a;
      border-color: rgba(15, 23, 42, 0.12);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }
    .theme-accent-text { color: var(--accent-start) !important; }
    .theme-accent-bg { background: color-mix(in srgb, var(--accent-start) 22%, #ffffff 78%) !important; }
    .theme-primary-text { color: var(--primary-start) !important; }
    .theme-primary-bg { background: color-mix(in srgb, var(--primary-start) 22%, #ffffff 78%) !important; }
    .theme-warm-text { color: var(--warm-start) !important; }
    .theme-warm-bg { background: color-mix(in srgb, var(--warm-start) 22%, #ffffff 78%) !important; }
    .theme-border { border-color: var(--theme-border) !important; }
    .theme-card {
      border-color: var(--theme-border) !important;
      background: color-mix(in srgb, var(--theme-tint) 18%, #ffffff 82%) !important;
    }

    .icon-badge {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.08) 70%);
      box-shadow:
        0 6px 16px rgba(15, 23, 42, 0.16),
        inset 0 2px 4px rgba(255, 255, 255, 0.7),
        inset 0 -3px 6px rgba(0, 0, 0, 0.12);
    }
    .logo-badge {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.1) 70%);
      box-shadow:
        0 8px 18px rgba(15, 23, 42, 0.18),
        inset 0 2px 5px rgba(255, 255, 255, 0.7),
        inset 0 -3px 8px rgba(0, 0, 0, 0.14);
    }
    .icon {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    .icon-badge .icon {
      width: 32px;
      height: 32px;
    }
    .logo-badge .icon {
      width: 38px;
      height: 38px;
    }

    /* 简单的浮层毛玻璃效果 */
    .glass {
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* 弹窗过渡动画 */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.2s ease;
    }
    .fade-enter-from, .fade-leave-to {
      opacity: 0;
    }

    /* 确保弹窗在最上层 */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <svg aria-hidden="true" class="hidden">
    <!-- candy: fairy tale princess -->
    <symbol id="icon-candy-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
      <path d="M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-diamond" viewBox="0 0 24 24">
      <path d="M4 9l4-5h8l4 5-8 10z"></path>
      <path d="M8 4l4 15 4-15" fill="white" opacity="0.6"></path>
      <path d="M4 9h16" fill="white" opacity="0.35"></path>
    </symbol>
    <symbol id="icon-checkered" viewBox="0 0 24 24">
      <rect x="5" y="4" width="2" height="16" rx="1"></rect>
      <rect x="8" y="6" width="10" height="10" rx="1"></rect>
      <rect x="8" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="8" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="9" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <circle cx="9.5" cy="11" r="1" fill="white"></circle>
      <circle cx="14.5" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="12" width="2.5" height="5" rx="1" fill="white"></rect>
      <rect x="11" y="9" width="2.5" height="8" rx="1" fill="white"></rect>
      <rect x="15" y="11" width="2.5" height="6" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
      <rect x="11" y="16" width="2" height="4" rx="1"></rect>
    </symbol>
    <symbol id="icon-candy-star" viewBox="0 0 24 24">
      <path d="M12 3l3.2 6.4 7.1 1-5.2 5 1.3 7.1L12 19l-6.4 3.5 1.3-7.1-5.2-5 7.1-1z"></path>
    </symbol>
    <symbol id="icon-candy-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- forest: animals -->
    <symbol id="icon-forest-book" viewBox="0 0 24 24">
      <rect x="5" y="5" width="14" height="14" rx="3"></rect>
      <circle cx="10" cy="10" r="1.5" fill="white"></circle>
      <circle cx="14" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-forest-brain" viewBox="0 0 24 24">
      <path d="M6 10a6 6 0 0 1 12 0c0 4-3 7-6 7s-6-3-6-7z"></path>
      <circle cx="9" cy="11" r="1" fill="white"></circle>
      <circle cx="15" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-3 3 2 4-4" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-forest-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-forest-star" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="7"></circle>
      <circle cx="12" cy="12" r="3" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-award" viewBox="0 0 24 24">
      <path d="M12 3l4 4-4 4-4-4z"></path>
      <rect x="8" y="11" width="8" height="8" rx="2"></rect>
    </symbol>

    <!-- storybook: classic tale -->
    <symbol id="icon-storybook-book" viewBox="0 0 24 24">
      <rect x="4" y="4" width="16" height="16" rx="3"></rect>
      <path d="M8 8h8M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M12 9l2 3-3 2" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-4 3 3 4-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-storybook-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
    </symbol>
    <symbol id="icon-storybook-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-storybook-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- ocean: sea life -->
    <symbol id="icon-ocean-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <circle cx="9" cy="12" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-ocean-brain" viewBox="0 0 24 24">
      <path d="M6 11a6 6 0 0 1 12 0c0 3-2 6-6 6s-6-3-6-6z"></path>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M6 14c2-2 4-2 6 0s4 2 6 0" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-ocean-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-ocean-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-ocean-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- space: blue robot vibe -->
    <symbol id="icon-space-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="8" width="10" height="2" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-space-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="14" cy="10" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-brain" viewBox="0 0 24 24">
      <rect x="6" y="6" width="12" height="12" rx="4"></rect>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l4-4 3 3 3-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-space-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-space-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-space-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- sunset: warm and simple -->
    <symbol id="icon-sunset-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="12" cy="11" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-sunset-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="8" y="10" width="8" height="6" rx="2" fill="white"></rect>
    </symbol>
    <symbol id="icon-sunset-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-sunset-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-sunset-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>
    <symbol id="icon-party" viewBox="0 0 24 24">
      <path d="M4 20l10-10 6 6-10 4z"></path>
      <circle cx="16" cy="6" r="2" fill="white"></circle>
      <circle cx="20" cy="8" r="1.5" fill="white"></circle>
      <circle cx="14" cy="3.5" r="1.2" fill="white"></circle>
    </symbol>
    <symbol id="icon-trophy" viewBox="0 0 24 24">
      <path d="M7 4h10v4a5 5 0 0 1-10 0z"></path>
      <path d="M7 6H4a3 3 0 0 0 3 3"></path>
      <path d="M17 6h3a3 3 0 0 1-3 3"></path>
      <rect x="10" y="13" width="4" height="3" rx="1"></rect>
      <rect x="8" y="16" width="8" height="4" rx="2"></rect>
    </symbol>
  </svg>
  <div id="app"
       :style="themeConfig.style"
       :class="[`theme-${theme}`, `age-${ageGroup}`, { 'mature-ui': isOlderKid }]"
       class="app-shell min-h-screen flex flex-col items-center py-2 px-3 sm:px-6 lg:px-10 transition-colors duration-300">

    <div v-if="showBuildTag" class="build-debug-tag">{{ buildLabel }}</div>

    <div class="book">
      <transition
        mode="out-in"
        enter-active-class="page-enter"
        leave-active-class="page-leave"
        enter-from-class="page-from"
        leave-to-class="page-to">
        <section :key="`page-${currentPage}`" class="book-page">
          <template v-if="currentPage === 0">
            <div class="cover-wrap">
              <article class="cover-card">
                <p class="cover-kicker">PAGE 0 · STUDYPLAN</p>
                <h1 class="cover-title">打卡小书</h1>
                <p class="cover-subtitle">STUDY PLAN</p>
                <div class="cover-strap-row">
                  <div class="cover-strap">
                    <transition v-if="!encourageReducedMotion" name="cover-enc" mode="out-in">
                      <span :key="`cover-quote-${encourageAnimKey}`" class="cover-strap-text">“{{ currentQuote || '今天也会很棒。' }}”</span>
                    </transition>
                    <span v-else class="cover-strap-text">“{{ currentQuote || '今天也会很棒。' }}”</span>
                  </div>
                  <div class="cover-strap-actions">
                    <button type="button" class="cover-strap-mini" @click="nextEncourage">换一句</button>
                    <button
                      type="button"
                      class="cover-strap-mini icon"
                      @click="encourageAutoPlay ? (encourageAutoPlay = false, stopEncourageAutoPlay()) : (encourageAutoPlay = true, startEncourageAutoPlay())">
                      {{ encourageAutoPlay ? '⏸' : '▶' }}
                    </button>
                  </div>
                </div>
                <div class="cover-photo-strip" aria-label="cover photo strip">
                  <span
                    v-for="slot in 3"
                    :key="`cover-photo-${slot}`"
                    class="cover-photo-tile"
                    :class="{ 'cover-photo-empty': !coverPhotoSlots[slot - 1] }">
                    <img v-if="coverPhotoSlots[slot - 1]" :src="coverPhotoSlots[slot - 1]" :alt="`cover photo ${slot}`" />
                    <template v-else>
                      {{ profiles[slot - 1] ? (profiles[slot - 1].name || '学').slice(0, 1) : '✦' }}
                    </template>
                  </span>
                </div>
                <button
                  type="button"
                  @click="activeTab = 'daily'; goPage(1)"
                  class="cover-cta">
                  翻开（开始今天）
                </button>
                <p class="cover-date">{{ todayLabel }}</p>
              </article>
            </div>
          </template>
          <template v-else>
    <!-- 顶部栏：iOS 紧凑两行 -->
    <header class="app-header ios-compact-header" :class="[{ 'header-collapsed': !headerExpanded, 'header-expanded': headerExpanded }]">
      <div class="compact-top-row">
        <div class="compact-profile-pill">
          <span class="inline-flex items-center justify-center logo-badge diamond-bg diamond-sparkle" style="width:22px;height:22px;">
            <svg class="icon text-sky-400" style="width:16px;height:16px;">
              <use href="#icon-diamond"></use>
            </svg>
          </span>
          <span class="truncate">{{ activeProfile.name }} · {{ activeProfile.age }}岁</span>
        </div>
        <div class="compact-mini-stats">
          <span>{{ todayProgress.done }}/{{ todayProgress.total }}</span>
          <span>XP {{ xp }}</span>
        </div>
        <div class="compact-top-actions">
          <button type="button" class="btn-ghost btn-mini" @click.stop="toggleHeaderExpanded">{{ headerExpanded ? '收起' : '展开' }}</button>
          <button @click="openSettings" class="icon-btn" title="设置">⚙️</button>
        </div>
      </div>

      <div class="compact-progress-row" @click="toggleHeaderExpanded">
        <div class="compact-progress-main">
          <svg class="compact-progress-ring" viewBox="0 0 40 40" aria-hidden="true">
            <circle cx="20" cy="20" r="14" stroke="#dbe2ea" stroke-width="4" fill="none"></circle>
            <circle
              cx="20"
              cy="20"
              r="14"
              stroke="var(--primary-start)"
              stroke-width="4"
              fill="none"
              stroke-linecap="round"
              stroke-dasharray="88"
              :stroke-dashoffset="88 * (1 - todayProgress.percent / 100)"
              transform="rotate(-90 20 20)"></circle>
          </svg>
          <div class="compact-progress-text">
            <strong>{{ todayProgress.done }}/{{ todayProgress.total }}</strong>
            <span>今日任务进度</span>
          </div>
        </div>
        <span class="compact-xp-chip">Lv.{{ levelDisplay.level }} · XP {{ xp }}</span>
        <span class="compact-expand-hint">{{ headerExpanded ? '收起' : '展开' }}</span>
      </div>
      <transition name="fade">
        <div v-if="headerExpanded" class="compact-progress-detail">
          <span>{{ levelDisplay.title }} · 完成率 {{ todayProgress.percent }}%</span>
          <span>下一阶 XP {{ levelDisplay.nextXp }}</span>
        </div>
      </transition>
    </header>

    <!-- 主体卡片：响应式布局，手机竖屏单列，平板横屏可并排 -->
    <main class="mobile-main-lift w-full max-w-5xl flex-1 flex flex-col lg:flex-row gap-2 lg:gap-4">
      <!-- 左侧：Tabs + 内容 -->
      <section class="flex-1 flex flex-col">
        <!-- 今日鼓励（默认一行） -->
        <div class="encourage-inline" :class="{ 'encourage-collapsed': encourageCollapsed }">
          <button type="button" class="icon-btn encourage-inline-main" @click="encourageCollapsed = !encourageCollapsed">
            <span class="text-slate-500">今日鼓励</span>
            <span class="quote-line line-clamp-1">“{{ currentQuote }}”</span>
          </button>
          <div class="flex items-center gap-1">
            <button
              type="button"
              class="text-[10px] px-2 py-1 rounded-full glass-btn btn-chip"
              @click.stop="refreshQuote">
              换一句
            </button>
            <button type="button" class="icon-btn text-[11px] text-slate-500 px-1" @click="encourageCollapsed = !encourageCollapsed">
              {{ encourageCollapsed ? '展开' : '收起' }}
            </button>
          </div>
        </div>
        <transition name="fade">
          <p v-if="!encourageCollapsed" class="text-[12px] text-emerald-700 leading-snug mb-1 px-2 theme-accent-text">
            “{{ currentQuote }}”
          </p>
        </transition>

        <!-- 标签页 -->
        <div v-if="currentPage !== 3" class="mobile-tabs ios-segmented-tabs">
          <button
            class="flex-1 transition"
            :class="currentPage === 1 && activeTab === 'daily' ? 'segment-active' : ''"
            @click="activeTab = 'daily'; goPage(1); collapseHeader()">
            今日
          </button>
          <button
            class="flex-1 transition"
            :class="currentPage === 2 ? 'segment-active' : ''"
            @click="goPage(2); collapseHeader()">
            记忆
          </button>
          <button
            v-if="ageGroup === 'senior'"
            class="flex-1 transition"
            :class="currentPage === 1 && activeTab === 'stats' ? 'segment-active' : ''"
            @click="activeTab = 'stats'; goPage(1); collapseHeader()">
            统计
          </button>
        </div>

        <!-- 内容卡片 -->
        <div class="flex-1 glass rounded-3xl soft-shadow p-2 sm:p-3 lg:p-4 flex flex-col overflow-hidden lift variant-card content-surface"
             :class="{ 'daily-main-card': activeTab === 'daily' }">
          <!-- 今日大冒险：每日计划 + 打卡 -->
          <div v-if="currentPage === 1 && activeTab === 'daily'" class="flex-1 flex flex-col fade-slide">
            <div class="daily-task-head relative mb-2 rounded-xl px-3 py-2 flex items-center justify-between">
              <p class="daily-task-title">今日任务</p>
              <span class="daily-completion-rate px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200">
                完成率 {{ todayProgress.percent }}%
              </span>
              <div v-if="showConfetti" class="confetti">
                <span v-for="n in confettiPieces"
                      :key="n"
                      class="confetti-piece"
                      :style="confettiStyle(n)"></span>
              </div>
            </div>

            <!-- 成就奖励卡 -->
            <transition name="fade">
              <div v-if="rewardToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-lime-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">🏆</span>
                    <div>
                      <p class="text-sm font-semibold">{{ rewardToast.title }}</p>
                      <p class="text-[11px] text-emerald-50">{{ rewardToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">+{{ rewardToast.xp }} XP</span>
                </div>
              </div>
            </transition>

            <transition name="fade">
              <div v-if="allDoneToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-amber-400 via-orange-400 to-rose-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">🎉</span>
                    <div>
                      <p class="text-sm font-semibold">{{ allDoneToast.title }}</p>
                      <p class="text-[11px] text-amber-50">{{ allDoneToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">今日全清</span>
                </div>
              </div>
            </transition>

            <!-- 任务列表 -->
            <div class="space-y-2 sm:space-y-2.5 overflow-y-auto pr-1 flex-1">
              <div v-if="tasks.length === 0"
                   class="text-xs sm:text-sm text-slate-500 bg-white/70 rounded-2xl px-3 py-2 border border-slate-200/60">
                还没有任务，先添加几个今天的小目标吧，比如：<br />
                <span class="text-emerald-700">阅读 15 分钟 · 完成数学练习 2 页 · 背古诗 1 首</span>
              </div>

              <div v-for="(task, index) in tasks"
                   :key="task.id"
                   class="daily-task-item flex items-center justify-between bg-white/95 rounded-2xl px-3 sm:px-4 py-2 sm:py-2.5 shadow-sm border border-slate-100"
                   :class="{ dragging: dragIndex === index }"
                   draggable="true"
                   @dragstart="onDragStart(index)"
                   @dragover.prevent
                   @drop="onDrop(index)"
                   @dragend="onDragEnd">
                  <div class="flex items-center gap-2 sm:gap-3 flex-1">
                  <span class="drag-handle text-slate-300 hover:text-slate-500">⋮⋮</span>
                  <!-- 打卡圆圈 + 动画层 -->
                  <div class="relative flex items-center justify-center">
                    <button
                      @click="toggleTask(task)"
                      class="h-7 w-7 sm:h-8 sm:w-8 rounded-full border-2 flex items-center justify-center transition bg-slate-50"
                      :class="task.done ? 'border-amber-400 bg-amber-100 shadow-inner' : 'border-slate-300 hover:border-emerald-400 hover:bg-emerald-50'">
                      <span v-if="task.done" class="text-amber-500 text-lg check-anim">✓</span>
                    </button>
                    <!-- 金币动画 -->
                    <div v-if="task.coinAnimating"
                         class="absolute -top-1 -right-2 text-base sm:text-lg coin-anim select-none">
                      🪙
                    </div>
                  </div>

                  <div class="flex flex-col flex-1">
                    <span
                      class="text-xs sm:text-sm font-medium"
                      :class="task.done ? 'line-through text-slate-400' : 'text-slate-800'">
                      {{ task.title }}
                    </span>
                    <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                      <span v-if="task.startTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-50 text-[11px] text-emerald-700 border border-emerald-200">
                        ⏰ 开始 {{ task.startTime }}
                      </span>
                      <span v-if="task.done && task.endTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-amber-50 text-[11px] text-amber-700 border border-amber-200">
                        ✅ 完成 {{ task.endTime }}
                      </span>
                      <span v-if="task.startTime && !task.done"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-[11px] text-blue-700 border border-blue-200">
                        🟢 进行中
                    </span>
                  </div>
                </div>

                  <!-- 操作按钮组 -->
                  <div class="flex items-center gap-1 sm:gap-2">
                    <button
                      v-if="!task.done && !task.startTime"
                      @click="startTask(task)"
                      class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition">
                      开始
                    </button>
                <button
                  @click="removeTask(index)"
                  :disabled="!isParentUnlocked"
                  class="task-delete-btn text-[10px] sm:text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100 disabled:opacity-40 disabled:cursor-not-allowed">
                  删除
                </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="daily-tools-inline">
              <p class="meta">今天：<span class="font-semibold text-slate-700">{{ todayLabel }}</span></p>
              <div class="actions">
                <button
                  @click="openTemplateManager"
                  class="btn-chip rounded-full border border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100 transition theme-primary-bg theme-primary-text theme-border">
                  模板
                </button>
                <select
                  v-model="selectedTemplateId"
                  @change="applyTemplate"
                  class="rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition theme-primary-bg theme-primary-text theme-border">
                  <option value="">选择模板...</option>
                  <option v-for="tpl in templates" :key="tpl.id" :value="tpl.id">
                    {{ tpl.name }}
                  </option>
                </select>
              </div>
            </div>

            <div v-if="ageGroup === 'junior'" class="mb-2 rounded-2xl px-3 py-2 sticker-book-card">
              <button type="button" class="icon-btn w-full flex items-center justify-between" @click="toggleStickerBook()">
                <span class="text-sm font-semibold text-slate-800">贴纸册 · 今日 {{ todayJuniorStickers.length }} 枚</span>
                <span class="text-[11px] text-slate-500">{{ stickerBookCollapsed ? '展开' : '收起' }}</span>
              </button>
              <div v-if="stickerBookCollapsed" class="sticker-inline-hint">
                {{ todayJuniorStickers.length === 0 ? '今天还没有新贴纸，先完成一项任务试试。' : '已折叠，点击展开查看今日贴纸。' }}
              </div>
              <div v-else class="mt-2 flex items-center gap-2 overflow-x-auto pb-1">
                <div v-for="sticker in todayJuniorStickers"
                     :key="sticker.id"
                     class="sticker-chip"
                     :class="{ 'sticker-chip-new': juniorStickers.hintVisible && juniorStickers.latestId === sticker.id }">
                  <span class="text-lg leading-none">{{ sticker.emoji }}</span>
                  <span class="text-[10px] text-slate-600">{{ sticker.name }}</span>
                </div>
                <div v-if="todayJuniorStickers.length === 0"
                     class="text-[11px] text-slate-500 bg-white/70 rounded-xl px-3 py-2 border border-white/60">
                  先完成一个任务，领取今天第 1 枚贴纸吧。
                </div>
              </div>
            </div>
            <transition name="fade">
              <div v-if="ageGroup === 'junior' && juniorStickers.hintVisible && latestJuniorSticker"
                   class="mb-2 rounded-xl bg-emerald-50 border border-emerald-200 px-3 py-2 text-[12px] text-emerald-700 sticker-hint-pop">
                🎁 获得新贴纸：{{ latestJuniorSticker.emoji }} {{ latestJuniorSticker.name }}
              </div>
            </transition>

            <!-- 添加任务 -->
            <div class="mt-3 pt-3 border-t border-slate-200/70">
              <form @submit.prevent="addTask" class="flex flex-col gap-2">
                <div class="mobile-stack flex flex-col sm:flex-row gap-2">
                <input v-model="newTaskTitle"
                       type="text"
                       placeholder="例如：朗读课文 2 遍"
                       class="mobile-input flex-1 rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm
                              focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400 bg-white/90" />
                <button
                  type="submit"
                  class="mobile-btn px-4 py-2 text-xs sm:text-sm font-semibold
                         active:scale-95 transition btn-main add-task-primary">
                  + 添加任务
                </button>
                </div>
                <p class="text-[11px] text-slate-400">
                  提示：添加任务后，点击"开始"按钮记录开始时间，完成后会自动记录结束时间。
                </p>
              </form>
            </div>
          </div>

          <!-- 艾宾浩斯记忆挑战 -->
          <div v-else-if="currentPage === 2 && activeTab === 'memory'" class="flex-1 flex flex-col gap-3 text-xs sm:text-sm overflow-hidden fade-slide">
            <!-- 模块标题 -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span v-if="!isOlderKid" class="icon-badge bg-sky-100 text-sky-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.brain}`" :xlink:href="`#${iconSet.brain}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">记忆挑战</p>
                  <p class="text-[11px] text-slate-500">跟随艾宾浩斯曲线巩固学习</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-sky-50 text-sky-600 border border-sky-200">复习计划</span>
            </div>
            <!-- 分类选择 -->
            <div class="mobile-chips flex items-center gap-2 bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="memoryCategory = 'poetry'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'poetry'
                  ? 'bg-amber-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                📜 古诗词
              </button>
              <button
                @click="memoryCategory = 'english'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'english'
                  ? 'bg-emerald-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                🔤 英语
              </button>
              <button
                @click="memoryCategory = 'science'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'science'
                  ? 'bg-sky-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                🧪 数理化
              </button>
              <span class="ml-auto text-[11px] text-slate-500">
                {{ memoryCategoryLabel }}
              </span>
            </div>

            <!-- 添加学习内容按钮 -->
            <div class="flex justify-end gap-2">
              <button
                @click="addTodayMemory"
                class="mobile-btn px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-primary">
                ➕ 添加{{ memoryCategoryLabel }}内容
              </button>
              <button
                @click="openMemoryManager"
                class="mobile-btn px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-accent">
                📚 批量导入记忆任务
              </button>
            </div>

            <!-- 周视图导航 -->
            <div class="flex items-center justify-between bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="prevWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                ← 上一周
              </button>
              <span class="font-semibold text-slate-800">{{ currentWeekLabel }}</span>
              <button
                @click="nextWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                下一周 →
              </button>
            </div>

            <!-- 周视图任务表格 -->
            <div class="flex-1 overflow-x-auto overflow-y-auto bg-white rounded-2xl border-2 border-slate-300 shadow-lg">
              <table class="text-xs border-collapse" style="table-layout: auto; width: 100%;">
                <colgroup>
                  <col style="width: 65px;">
                  <col>
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 60px;" v-for="n in 6" :key="n">
                </colgroup>
                <thead class="bg-gradient-to-r from-amber-100 to-yellow-50 border-b-2 border-amber-300 sticky top-0 z-10 shadow-sm">
                  <tr>
                    <th class="px-2 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">日期</th>
                    <th class="px-3 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">学习内容</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="3">学习计划</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="6">后续复习日期</th>
                  </tr>
                  <tr class="bg-gradient-to-r from-amber-50 to-yellow-50/50">
                    <th class="px-2 py-1.5 border-r border-amber-200"></th>
                    <th class="px-3 py-1.5 border-r border-amber-200"></th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">5分</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">30分</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">12时</th>
                    <th v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">
                      +{{ offset }}天
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, rowIdx) in weeklyMemoryItems" :key="item.id"
                      :class="rowIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'"
                      class="border-b border-slate-200 hover:bg-amber-50/50 transition-colors">
                    <td class="px-2 py-3 border-r border-slate-200 text-center">
                      <div class="flex flex-col items-center justify-center">
                        <span class="font-bold text-slate-900 text-sm leading-tight">{{ item.learnDate }}</span>
                        <span class="text-[9px] text-slate-500 mt-0.5 leading-tight">{{ item.learnYear }}</span>
                      </div>
                    </td>
                    <td class="px-3 py-3 border-r border-slate-200" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                      <div v-if="editingMemoryId !== item.id" 
                           class="flex flex-col justify-center min-h-[40px] group relative">
                        <span class="font-semibold text-slate-900 leading-snug text-center break-words">{{ item.title }}</span>
                        <div v-if="item.dynasty" class="mt-1 flex items-center justify-center">
                          <span class="px-1.5 py-0.5 rounded-full text-[9px] text-white"
                                :style="{ backgroundColor: dynastyColor(item.dynasty) }">
                            {{ item.dynasty }}
                          </span>
                          <span v-if="item.author" class="ml-1 text-[10px] text-slate-600">· {{ item.author }}</span>
                        </div>
                        <span v-else-if="item.content" class="text-[10px] text-slate-600 mt-1 leading-tight text-center break-words">{{ item.content }}</span>
                        <button
                          v-if="canEditMemoryItem(item)"
                          @click.stop="startEditMemory(item)"
                          class="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity
                                 px-1.5 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700 hover:bg-blue-200">
                          编辑
                        </button>
                      </div>
                      <div v-else class="flex flex-col gap-1.5">
              <input
                          v-model="editingMemoryTitle"
                type="text"
                          placeholder="标题"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <input
                          v-model="editingMemoryContent"
                          type="text"
                          placeholder="内容详情（可选）"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <div class="flex gap-1">
              <button
                            @click.stop="saveEditMemory(item)"
                            class="flex-1 px-2 py-1 rounded bg-emerald-500 text-white text-[10px] hover:bg-emerald-600">
                            保存
              </button>
                          <button
                            @click.stop="cancelEditMemory"
                            class="flex-1 px-2 py-1 rounded bg-slate-200 text-slate-700 text-[10px] hover:bg-slate-300">
                            取消
                          </button>
                        </div>
                      </div>
                    </td>
                    <!-- 即时复习时间点 -->
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '5min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['5min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['5min']?.done" class="text-sm font-bold">✓</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '30min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['30min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['30min']?.done" class="text-sm font-bold">✓</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '12h')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['12h']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['12h']?.done" class="text-sm font-bold">✓</span>
                      </button>
                    </td>
                    <!-- 艾宾浩斯复习日期 -->
                    <td v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <div class="flex flex-col items-center justify-center gap-1">
                        <span class="text-[8px] text-slate-500 leading-tight">{{ item.reviews[offset]?.date || '-' }}</span>
                        <button
                          v-if="item.reviews[offset]"
                          @click.stop="toggleReviewCheck(item.id, offset)"
                          class="h-7 w-7 rounded-lg border-2 flex items-center justify-center transition-all
                                 flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                          :class="item.reviews[offset].done
                            ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                            : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                          <span v-if="item.reviews[offset].done" class="text-sm font-bold">✓</span>
                        </button>
                        <span v-else class="text-slate-300 text-[8px]">-</span>
                      </div>
                    </td>
                  </tr>
                  <tr v-if="weeklyMemoryItems.length === 0">
                    <td colspan="10" class="px-4 py-12 text-center text-slate-400 text-sm bg-white">
                      <div class="flex flex-col items-center gap-2">
                        <span class="text-2xl">📚</span>
                        <span>本周暂无记忆任务</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            </div>

          <div v-else-if="currentPage === 1 && activeTab === 'stats' && ageGroup === 'senior'" class="flex-1 flex flex-col gap-3 text-xs sm:text-sm overflow-hidden fade-slide">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="icon-badge bg-indigo-100 text-indigo-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.chart}`" :xlink:href="`#${iconSet.chart}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">统计分析</p>
                  <p class="text-[11px] text-slate-500">仅 Senior 可见的数据洞察</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-200">Senior</span>
            </div>

            <div class="flex items-center gap-2 bg-white/85 rounded-xl p-1 border border-slate-200 w-fit">
              <button
                @click="seniorStatsRange = 'today'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="seniorStatsRange === 'today' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'">
                Today
              </button>
              <button
                @click="seniorStatsRange = 'week'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="seniorStatsRange === 'week' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'">
                This Week
              </button>
            </div>

            <div v-if="seniorStatsRange === 'today'" class="grid grid-cols-2 gap-2">
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">完成率</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.completedCount }} / {{ seniorTodaySummary.totalCount }}</p>
                <p class="text-[11px] text-indigo-600 mt-0.5">{{ seniorTodaySummary.completionRate }}%</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">专注分钟</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.focusMinutes }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">分钟</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">今日 XP 增量</p>
                <p class="text-base font-bold text-slate-800 mt-1">+{{ seniorTodaySummary.xpGained }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">fallback 估算</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">复习达标率</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.reviewDoneCount }} / {{ seniorTodaySummary.reviewTotalCount }}</p>
                <p class="text-[11px] text-emerald-600 mt-0.5">{{ seniorTodaySummary.reviewRate }}%</p>
              </div>
            </div>

            <div v-else class="grid grid-cols-2 gap-2">
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">本周完成率</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.completionRate }}%</p>
                <p class="text-[11px] text-slate-500 mt-0.5">{{ seniorWeekSummary.completedCount }} / {{ seniorWeekSummary.totalCount }}</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">本周专注分钟</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.focusMinutes }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">分钟</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">本周连续天数</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.streak }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">天（完成≥1）</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">本周复习达标率</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.reviewRate }}%</p>
                <p class="text-[11px] text-slate-500 mt-0.5">{{ seniorWeekSummary.reviewDoneCount }} / {{ seniorWeekSummary.reviewTotalCount }}</p>
              </div>
            </div>

            <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-slate-800">7 天游程</p>
                <p class="text-[11px] text-slate-500">折线=完成率 / 柱=专注分钟</p>
              </div>
              <svg viewBox="0 0 360 190" class="w-full h-48">
                <line x1="34" y1="16" x2="34" y2="144" stroke="#cbd5e1" stroke-width="1"></line>
                <line x1="34" y1="144" x2="346" y2="144" stroke="#cbd5e1" stroke-width="1"></line>
                <line x1="34" y1="16" x2="346" y2="16" stroke="#e2e8f0" stroke-dasharray="4 3" stroke-width="1"></line>
                <text x="6" y="20" font-size="10" fill="#64748b">100%</text>
                <text x="14" y="147" font-size="10" fill="#64748b">0%</text>

                <rect
                  v-for="bar in seniorChartModel.bars"
                  :key="bar.key"
                  :x="bar.x"
                  :y="bar.y"
                  :width="bar.width"
                  :height="bar.height"
                  rx="2"
                  fill="#93c5fd"
                  opacity="0.8"></rect>

                <polyline
                  :points="seniorChartModel.linePoints"
                  fill="none"
                  stroke="#4f46e5"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"></polyline>

                <circle
                  v-for="pt in seniorChartModel.points"
                  :key="`pt-${pt.key}`"
                  :cx="pt.x"
                  :cy="pt.y"
                  r="3"
                  fill="#4f46e5"></circle>

                <text
                  v-for="label in seniorChartModel.labels"
                  :key="`lb-${label.key}`"
                  :x="label.x"
                  y="162"
                  text-anchor="middle"
                  font-size="10"
                  fill="#64748b">
                  {{ label.text }}
                </text>
              </svg>
              <p class="text-[11px] text-slate-500 mt-1">专注分钟上限：{{ seniorChartModel.maxFocus }} 分钟</p>
            </div>
          </div>
          <div v-else-if="currentPage === 3" class="flex-1 flex items-center justify-center fade-slide">
            <div class="w-full max-w-md bg-white rounded-2xl border border-slate-200 p-4 text-center space-y-3">
              <p class="text-sm font-semibold text-slate-800">家长中心</p>
              <p class="text-xs text-slate-500">进入现有设置页中的「家长设置」进行 PIN 与权限操作。</p>
              <button @click="goPage(3)" class="btn-main add-task-primary px-4 py-2 text-xs font-semibold">打开家长设置</button>
              <button @click="openCoverPhotoManager" class="cover-photo-btn">封面照片（最多3张）</button>
            </div>
          </div>

        </div>
      </section>
    </main>

    <nav v-if="currentPage !== 0" class="bottom-nav mt-3">
      <button @click="activeTab = 'daily'; goPage(1)" :class="currentPage === 1 ? 'bottom-nav-active' : ''">今日</button>
      <button @click="goPage(2)" :class="currentPage === 2 ? 'bottom-nav-active' : ''">记忆</button>
      <button @click="goPage(3)" :class="currentPage === 3 ? 'bottom-nav-active' : ''">家长</button>
    </nav>

    <footer class="w-full max-w-5xl mt-4 text-center text-[11px] text-slate-400">
      © fabien Zhang · 快乐学习大冒险
    </footer>
          </template>
        </section>
      </transition>
    </div>

    <div v-if="showCoverPhotoManager"
         @click.self="showCoverPhotoManager = false"
         class="cover-photo-modal fixed inset-0 bg-black/40 flex items-center justify-center px-3">
      <div class="cover-photo-panel">
        <div class="flex items-center justify-between">
          <p class="text-sm font-semibold text-slate-800">封面照片（最多3张）</p>
          <button class="icon-btn text-slate-400 hover:text-slate-600 text-sm" @click="showCoverPhotoManager = false">✕</button>
        </div>
        <div class="cover-photo-grid">
          <div v-for="slot in 3" :key="`cover-modal-${slot}`" class="cover-photo-slot">
            <div class="cover-photo-tile" :class="{ 'cover-photo-empty': !coverPhotoSlots[slot - 1] }">
              <img v-if="coverPhotoSlots[slot - 1]" :src="coverPhotoSlots[slot - 1]" :alt="`cover slot ${slot}`" />
              <template v-else>{{ profiles[slot - 1] ? (profiles[slot - 1].name || '学').slice(0, 1) : '✦' }}</template>
            </div>
            <label class="cover-photo-btn cursor-pointer">
              <input type="file" accept="image/*" class="hidden" @change="onCoverPhotoPicked($event, slot - 1)" />
              {{ coverPhotoSlots[slot - 1] ? '更换照片' : '上传照片' }}
            </label>
            <button
              type="button"
              class="cover-photo-delete"
              :disabled="!coverPhotoSlots[slot - 1]"
              @click="clearCoverPhotoSlot(slot - 1)">
              删除
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 模板管理弹窗 -->
    <div v-if="showTemplateManager"
         class="fixed inset-0 z-30 flex items-center justify-center bg-black/40">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative max-h-[80vh] overflow-y-auto">
        <button
          class="icon-btn absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="showTemplateManager = false">
          ✕
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">📋 任务模板管理</h2>
          <p class="text-xs text-slate-500 mt-1">创建和管理你的任务模板</p>
        </div>

        <!-- 创建新模板 -->
        <div class="mb-4 p-3 bg-blue-50 rounded-2xl">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">创建新模板</h3>
          <div class="flex flex-col gap-2">
            <input
              v-model="newTemplateName"
              type="text"
              placeholder="模板名称，如：工作日模板、周末模板"
              class="rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm bg-white
                     focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-400" />
            <button
              @click="createTemplateFromCurrent"
              class="px-3 py-2 rounded-2xl bg-blue-500 text-white text-xs sm:text-sm font-semibold
                     hover:bg-blue-600 active:scale-95 transition">
              + 从当前任务创建模板
            </button>
          </div>
        </div>

        <!-- 模板列表 -->
        <div class="space-y-2">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">已有模板</h3>
          <div v-for="tpl in templates" :key="tpl.id"
               class="bg-white border border-slate-200 rounded-2xl p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <input
                  v-if="editingTemplateId === tpl.id"
                  v-model="tpl.name"
                  @blur="saveTemplates()"
                  @keyup.enter="saveTemplates()"
                  type="text"
                  class="font-medium text-sm text-slate-800 bg-white border border-blue-200 rounded-lg px-2 py-1 w-full
                         focus:outline-none focus:ring-2 focus:ring-blue-300"
                  placeholder="模板名称" />
                <p v-else class="font-medium text-sm text-slate-800">{{ tpl.name }}</p>
                <p class="text-xs text-slate-500 mt-0.5">{{ tpl.tasks.length }} 个任务</p>
              </div>
              <div class="flex items-center gap-2">
                <button
                  @click="editTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs hover:bg-blue-100">
                  {{ editingTemplateId === tpl.id ? '保存' : '编辑' }}
                </button>
                <button
                  @click="applyTemplateById(tpl.id)"
                  class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs hover:bg-emerald-100">
                  应用
                </button>
                <button
                  @click="deleteTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-rose-50 text-rose-700 text-xs hover:bg-rose-100">
                  删除
                </button>
              </div>
            </div>
            <!-- 编辑模板任务列表 -->
            <div v-if="editingTemplateId === tpl.id" class="mt-3 space-y-2 border-t pt-2">
              <div v-for="(task, idx) in tpl.tasks" :key="idx"
                   class="flex items-center gap-2 bg-slate-50 rounded-xl p-2">
                <input
                  v-model="task.title"
                  type="text"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300"
                  placeholder="任务名称" />
                <button
                  @click="removeTaskFromTemplate(tpl.id, idx)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  删除
                </button>
              </div>
              <div class="flex gap-2">
                <input
                  v-model="newTaskForTemplate[tpl.id]"
                  @keyup.enter="addTaskToTemplate(tpl.id)"
                  type="text"
                  placeholder="添加新任务..."
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300" />
                <button
                  @click="addTaskToTemplate(tpl.id)"
                  class="px-3 py-1 rounded-lg bg-blue-500 text-white text-xs hover:bg-blue-600">
                  + 添加
                </button>
              </div>
            </div>
          </div>
          <div v-if="templates.length === 0" class="text-center py-4 text-slate-400 text-sm">
            还没有模板，创建一个吧！
          </div>
        </div>
      </div>
    </div>

    <!-- 添加今天内容弹窗 -->
    <transition name="fade">
      <div v-if="showAddTodayModal"
           @click.self="showAddTodayModal = false"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="showAddTodayModal = false">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 relative"
             @click.stop>
          <button
            class="icon-btn absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
            @click="showAddTodayModal = false">
            ✕
          </button>
          <div class="text-center mb-4">
            <h2 class="text-lg font-bold text-slate-800">➕ 添加{{ memoryCategoryLabel }}内容</h2>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">选择日期</label>
              <input
                v-model="newTodayMemory.date"
                type="date"
                :min="todayKey"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
            </div>
            <div v-if="memoryCategory === 'poetry'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">诗名 *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="例如：《静夜思》"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">朝代 *</label>
                  <input
                    v-model="newTodayMemory.dynasty"
                    type="text"
                    placeholder="例如：唐"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">作者 *</label>
                  <input
                    v-model="newTodayMemory.author"
                    type="text"
                    placeholder="例如：李白"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
              </div>
            </div>
            <div v-else-if="memoryCategory === 'english'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">单词/句子 *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="例如：apple / I like apples"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">注释（可选）</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="例如：苹果 / 我喜欢苹果"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div v-else>
              <label class="block text-sm font-semibold text-slate-700 mb-1">公式 *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="例如：a² + b² = c²"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">类别 *</label>
              <input
                v-model="newTodayMemory.categoryName"
                type="text"
                placeholder="例如：几何 / 物理 / 化学"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">注释（可选）</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="例如：直角三角形勾股定理"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div class="flex gap-2 pt-2">
              <button
                @click="saveTodayMemory"
                class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                       active:scale-95 transition btn-primary">
                  保存
                </button>
              <button
                @click="showAddTodayModal = false"
                class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                       hover:bg-slate-200 active:scale-95 transition">
                取消
              </button>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- 记忆任务管理弹窗 -->
    <!-- 暂时禁用，防止自动打开 -->
    <transition name="fade">
      <div v-if="shouldShowMemoryManager && !shouldShowMonthlyReport"
           @click.self="closeMemoryManager"
           @mousedown.self="closeMemoryManager"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="closeMemoryManager">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-[95%] p-5 relative max-h-[85vh] flex flex-col"
             @click.stop>
        <button
          type="button"
          class="icon-btn absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
          @click.stop="closeMemoryManager">
          ✕
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">📚 添加/批量导入记忆任务</h2>
          <p class="text-xs text-slate-500 mt-1">每行一个任务，格式见下方提示</p>
        </div>
        <div class="flex-1 overflow-y-auto space-y-3 mb-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">选择起始日期（今天或以后）</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportStartDate"
                type="date"
                :min="todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <label class="block text-sm font-semibold text-slate-700 mb-1 mt-2">选择结束日期（不可早于起始日）</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportEndDate"
                type="date"
                :min="batchImportStartDate || todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <p class="text-[11px] text-slate-400 mt-1">
              规则：每一行对应一天，从起始日顺延到结束日
            </p>
            <p class="text-[11px] text-slate-500 mt-1">
              {{ batchImportRangeHint }}
            </p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">任务列表（每行一个任务）</label>
            <textarea
              v-model="batchImportData"
              rows="12"
              :placeholder="batchImportPlaceholder"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs font-mono bg-white
                     focus:outline-none focus:ring-2 focus:ring-sky-300 resize-none"></textarea>
            <p class="text-[11px] text-slate-400 mt-1">
              {{ batchImportTip }}
            </p>
          </div>
          <div v-if="previewTasks.length > 0" class="bg-slate-50 rounded-xl p-3">
            <p class="text-sm font-semibold text-slate-700 mb-2">预览（可编辑）：</p>
            <div class="space-y-2 max-h-40 overflow-y-auto">
              <div v-for="(task, idx) in previewTasks" :key="idx"
                   class="flex items-center gap-2 bg-white rounded-lg p-2">
                <input
                  v-model="task.title"
                  type="text"
                  placeholder="任务名称"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <input
                  v-model="task.content"
                  type="text"
                  placeholder="内容详情（可选）"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <button
                  @click="previewTasks.splice(idx, 1)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  删除
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex gap-2 border-t pt-3">
          <button
            @click="previewBatchImport"
            class="px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition btn-accent">
            预览
          </button>
          <button
            @click="processBatchImport"
            :disabled="previewTasks.length === 0"
            class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition disabled:bg-slate-300 disabled:cursor-not-allowed btn-accent">
            导入并生成复习计划
          </button>
          <button
            @click.stop="closeMemoryManager"
            class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            取消
          </button>
        </div>
        </div>
      </div>
    </transition>

    <!-- 表扬信弹窗 -->
    <div v-if="shouldShowMonthlyReport && !shouldShowMemoryManager"
         @click.self="closeMonthlyReport"
         @mousedown.self="closeMonthlyReport"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/40"
         @keyup.esc="closeMonthlyReport">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative">
        <button
          type="button"
          class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click.stop="closeMonthlyReport">
          ✕
        </button>
        <div class="text-center mb-3">
          <div class="text-3xl mb-1">🏅</div>
          <h2 class="text-lg font-bold text-slate-800">本月快乐学习表扬信</h2>
          <p class="text-xs text-slate-500 mt-1">
            自动统计本月完成情况，为你送上一封小小的表扬信。
          </p>
        </div>
        <div class="text-sm text-slate-700 space-y-2">
          <p>亲爱的 <span class="font-semibold">小小冒险家</span>：</p>
          <p>
            本月你一共完成了
            <span class="font-bold text-emerald-600">{{ monthlyStats.doneTasks }}</span>
            个学习任务，累计获得
            <span class="font-bold text-amber-500">{{ xp }}</span>
            点经验值，已经成为
            <span class="font-bold text-emerald-700">{{ levelDisplay.title }}</span> 啦！
          </p>
          <p>
            每一次认真完成任务，都是在为未来的自己铺一条闪闪发光的小路。
            请继续保持这份努力和勇气，老师和爸爸妈妈都为你骄傲！
          </p>
          <p class="text-right text-xs text-slate-500 mt-2">
            —— 快乐学习大冒险系统
          </p>
        </div>
        <div class="mt-4 flex gap-2">
          <button
            type="button"
            @click="printReport"
            class="flex-1 px-3 py-2 rounded-2xl text-white text-sm font-semibold
                   active:scale-95 transition btn-primary">
            🖨 打印表扬信
          </button>
          <button
            type="button"
            @click.stop="closeMonthlyReport"
            class="px-3 py-2 rounded-2xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- 设置中心 -->
    <div v-if="showSettings"
         @click.self="closeSettings"
         @keyup.esc="closeSettings"
         class="settings-overlay fixed inset-0 z-40 flex items-center justify-center bg-black/40">
    <div class="settings-modal bg-white rounded-3xl shadow-2xl max-w-lg w-[92%] p-5 relative glass" @click.stop>
        <button
          class="icon-btn absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="closeSettings">
          ✕
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">⚙️ 设置中心</h2>
          <p class="text-xs text-slate-500 mt-1">按菜单进入设置，保存会自动生效</p>
        </div>

        <div class="space-y-4" v-if="settingsSection === 'home'">
          <div class="bg-white/85 border border-slate-200 rounded-3xl p-3">
            <p class="text-sm font-semibold text-slate-800">当前模式</p>
            <p class="text-[12px] text-slate-600 mt-1">
              {{ activeProfile.name }} · {{ activeProfile.age }} 岁 ·
              <span class="font-semibold">{{ ageGroup === 'junior' ? 'Junior（童趣模式）' : 'Senior（进阶模式）' }}</span>
            </p>
            <p class="text-[11px] text-slate-500 mt-1">修改孩子年龄后，模式会立即切换。</p>
          </div>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'parent'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">家长授权</p>
                <p class="text-[11px] text-slate-500">PIN 与家长授权管理</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'profiles'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">孩子档案</p>
                <p class="text-[11px] text-slate-500">添加与切换孩子</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'theme'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">外观与皮肤</p>
                <p class="text-[11px] text-slate-500">主题与按钮颜色</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'parent-tools'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">家长工具</p>
                <p class="text-[11px] text-slate-500">表扬信等家长功能</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button v-if="ageGroup === 'senior'" class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'stats'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">统计报表</p>
                <p class="text-[11px] text-slate-500">查看学习数据</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'install'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">安装与设备</p>
                <p class="text-[11px] text-slate-500">安装到桌面与说明</p>
              </div>
              <span class="text-xs text-slate-400">进入</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-rose-200 rounded-3xl lift"
                  @click="settingsSection = 'danger'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-rose-700">危险操作</p>
                <p class="text-[11px] text-rose-500">清空全部数据</p>
              </div>
              <span class="text-xs text-rose-400">进入</span>
            </div>
          </button>
        </div>

        <div v-else class="space-y-4">
          <button class="glass-btn w-full text-sm font-semibold btn-compact"
                  @click="settingsSection = 'home'">
            ← 返回设置菜单
          </button>

          <div v-if="settingsSection === 'parent'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">家长授权</p>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-[11px] text-slate-500">状态：</span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="parentPinSet ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'">
                {{ parentPinSet ? '已设置 PIN' : '未设置 PIN' }}
              </span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="isParentUnlocked ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'">
                {{ isParentUnlocked ? '已授权' : '未授权' }}
              </span>
            </div>
          <div class="pin-actions flex gap-2">
            <button
              class="flex-1 px-3 py-2 rounded-xl text-white text-xs font-semibold btn-primary btn-compact"
              @click="setParentPin">
              设置/修改 PIN
            </button>
            <button
              class="flex-1 px-3 py-2 rounded-xl text-slate-700 text-xs font-semibold bg-slate-100 btn-compact"
              @click="resetParentPin">
              重置 PIN
            </button>
          </div>
            <p class="text-[11px] text-slate-500 mt-2">
              10 岁以下设置与管理需家长 PIN；10 岁以上也需家长授权。
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'profiles'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">孩子档案</p>
            <div class="space-y-2">
              <div v-for="p in profiles" :key="p.id" class="profile-item flex items-center gap-2 bg-white rounded-xl p-2 border border-slate-200">
                <div class="profile-fields w-full">
                  <input v-model="p.name"
                         @blur="onProfileEdited(p)"
                         class="profile-name rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                  <input v-model.number="p.age" type="number" min="3" max="18"
                         @change="onProfileEdited(p)"
                         class="profile-age rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                </div>
                <div class="profile-actions flex items-center gap-2">
                  <button class="px-3 py-2 text-xs rounded-full bg-emerald-50 text-emerald-700 btn-compact"
                          @click="setActiveProfile(p.id)">使用</button>
                  <button class="px-3 py-2 text-xs rounded-full bg-rose-50 text-rose-600 btn-compact"
                          @click="removeProfile(p.id)">删除</button>
                </div>
              </div>
            </div>
            <div class="profile-new flex gap-2 mt-2">
              <div class="profile-fields w-full">
                <input v-model="newProfileName" placeholder="新孩子名字"
                       class="profile-name rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                <input v-model.number="newProfileAge" type="number" min="3" max="18"
                       class="profile-age rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
              </div>
              <button class="px-3 py-2 rounded-lg bg-blue-500 text-white text-sm disabled:bg-slate-300 btn-compact"
                      :disabled="!newProfileName.trim()"
                      @click="addProfile">确认添加</button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              预览：{{ newProfileName || '孩子' }}（{{ newProfileAge || 8 }}岁）
            </p>
            <p class="text-[11px] text-slate-500">
              点击“使用”即可切换当前档案。
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'theme'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">外观与皮肤</p>
            <div class="flex flex-wrap gap-2">
              <button
                v-for="opt in themeOptions"
                :key="opt.value"
                @click="setTheme(opt.value)"
                class="px-3 py-1.5 rounded-full border text-[11px] sm:text-xs font-medium transition flex items-center gap-1 btn-chip"
                :class="theme === opt.value ? 'theme-pill-active' : 'bg-white/70 text-slate-700 border-transparent hover:bg-white/90'"
                :style="theme === opt.value ? { background: opt.swatch } : {}">
                <span v-if="opt.icon">{{ opt.icon }}</span>
                {{ opt.label }}
              </button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              主题会同步改变按钮颜色与整体氛围。
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'parent-tools'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <div class="flex items-center justify-between mb-2">
              <p class="text-sm font-semibold text-slate-800">家长工具</p>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-50 text-rose-600 border border-rose-200">家长区</span>
            </div>
            <p class="text-xs text-slate-600">
              表扬信由家长发出，记录孩子的努力与成长。
            </p>
            <button
              type="button"
              @click="openMonthlyReport"
              class="mt-2 px-3 py-2 rounded-2xl text-white font-semibold w-full btn-compact
                     active:scale-95 transition btn-warm">
              生成本月表扬信
            </button>
          </div>
          </div>

          <div v-if="settingsSection === 'stats' && ageGroup === 'senior'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="icon-badge bg-purple-100 text-purple-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.chart}`" :xlink:href="`#${iconSet.chart}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">统计报表</p>
                  <p class="text-[11px] text-slate-500">Senior 模式下可从主页面查看 Today / This Week</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-purple-50 text-purple-600 border border-purple-200">数据面板</span>
            </div>
            <button
              type="button"
              @click="openSeniorStats"
              class="mt-3 w-full px-3 py-2 rounded-xl text-white text-sm font-semibold btn-primary btn-compact">
              打开 Senior 统计页
            </button>

            <div class="mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-4 shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">🗄️</span>
                <h3 class="font-bold text-blue-900 text-sm sm:text-base">数据归档与空间清理</h3>
              </div>
              <p class="text-xs text-slate-600 mb-4">
                定期清理3个月前的旧数据，释放存储空间。数据会先备份为JSON文件下载到本地，确认后再从App中删除。
              </p>
              <div class="space-y-3">
                <button
                  @click="archiveOldData"
                  class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold btn-compact
                         active:scale-95 transition shadow-md btn-accent">
                  📦 清理旧数据（归档3个月前的数据）
                </button>
                <button
                  @click="importArchive"
                  class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold btn-compact
                         active:scale-95 transition shadow-md btn-warm">
                  📥 导入历史归档
                </button>
                <div class="text-[10px] text-slate-500 mt-2 pt-2 border-t border-blue-200">
                  💡 提示：归档文件会保存到您的下载文件夹，文件名格式为 backup_YYYY_QN.json
                </div>
              </div>
            </div>
          </div>
          </div>

          <div v-if="settingsSection === 'install'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">安装与设备</p>
            <div class="flex flex-col gap-2">
              <button
                v-if="showInstall"
                @click="handleInstall"
                class="px-3 py-2 rounded-xl text-white text-sm font-semibold btn-primary btn-compact">
                安装到桌面
              </button>
              <button
                type="button"
                @click="clearAppCache"
                class="px-3 py-2 rounded-xl text-slate-800 text-sm font-semibold btn-compact">
                一键清缓存
              </button>
              <button
                type="button"
                @click="toggleDebugBuild"
                class="px-3 py-2 rounded-xl text-slate-800 text-sm font-semibold btn-compact">
                {{ debugBuildEnabled ? '关闭 Debug BUILD 标签' : '开启 Debug BUILD 标签' }}
              </button>
              <div v-if="showIosInstallHint" class="text-xs text-slate-600 leading-snug bg-white/70 rounded-xl p-2 border border-slate-200">
                iPhone 请用 Safari 打开后，点击底部“分享”图标，再选择“添加到主屏幕”。
              </div>
            </div>
          </div>
          </div>

          <div v-if="settingsSection === 'danger'" class="space-y-4">
            <div class="danger-area bg-rose-50 rounded-2xl p-3 border border-rose-200">
              <p class="danger-title text-sm font-semibold text-rose-700 mb-2">危险操作</p>
              <div class="flex items-center gap-2">
                <button
                  @click="handleResetClick"
                  class="danger-btn px-3 py-1.5 rounded-xl bg-rose-500 text-white text-xs font-semibold btn-compact">
                  ⚠ 清空全部数据
                </button>
                <span class="text-[11px] text-rose-500">需要三次确认</span>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 确保 Vue 已加载
    if (typeof Vue === 'undefined') {
      document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>错误：Vue 未加载</h1><p>请检查网络连接和 CDN 链接</p></div>';
    } else {
      try {
        const { createApp } = Vue;

    createApp({
      data() {
        return {
          // 主题
          theme: 'forest',
          themeOptions: [
            { value: 'candy', label: '糖果梦', icon: '🍬', swatch: 'linear-gradient(135deg, #fbcfe8 0%, #fde68a 45%, #bfdbfe 100%)' },
            { value: 'forest', label: '森林探险', icon: '🌳', swatch: 'linear-gradient(135deg, #d1fae5 0%, #f0fdf4 40%, #bbf7d0 100%)' },
            { value: 'ocean', label: '深海蓝', icon: '🐠', swatch: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 45%, #a5f3fc 100%)' },
            { value: 'buddy', label: '蓝色伙伴', icon: '🤖', swatch: 'linear-gradient(135deg, #bfdbfe 0%, #e0f2fe 45%, #93c5fd 100%)' },
          ],

          // Tabs
          activeTab: 'daily',
          currentPage: 0,

          // 每日任务
          tasks: [],
          newTaskTitle: '',

          // 模板管理
          templates: [],
          selectedTemplateId: '',
          showTemplateManager: false,
          newTemplateName: '',
          editingTemplateId: '',
          editingTemplateName: {},
          newTaskForTemplate: {},

          // XP / 等级
          xp: 0,

          // 记忆挑战
          memoryDraft: {
            title: '',
            content: ''
          },
          memoryList: [],
          memorySchedule: [],
          memoryViewMode: 'list',
          memoryCategory: 'poetry', // 'poetry', 'english', 'science'
          currentWeekStart: null,
          showMemoryManager: false,
          batchImportStartDate: '',
          batchImportEndDate: '',
          
          batchImportData: '',
          previewTasks: [],
          reviewStatusCache: {}, // 缓存复习状态，提升性能
          editingMemoryId: null, // 正在编辑的记忆项ID
          editingMemoryTitle: '',
          editingMemoryContent: '',
          showAddTodayModal: false, // 添加今天内容的弹窗
          newTodayMemory: {
            title: '',
            content: '',
            date: '',
            dynasty: '',
            author: '',
            categoryName: ''
          },
          showResetConfirm: false, // 显示重置确认弹窗（已废弃，改用原生 confirm）

          // 语音鼓励
          isRecording: false,
          mediaRecorder: null,
          recordedChunks: [],
          audioUrl: '',
          recordingStream: null,

          // 表扬信
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false, // 标记用户是否主动打开记忆管理弹窗
          _userInitiatedMonthlyReport: false, // 标记用户是否主动打开表扬信弹窗
          monthlyStats: {
            doneTasks: 0
          },

          // 随机鼓励语
          quotes: [
            '你是最棒的！',
            '今天也是元气满满的一天～',
            '每一次坚持，都是在为未来的自己加油。',
            '认真完成一件小事，就是了不起的勇气。',
            '你的小脑袋瓜儿真聪明！',
            '再多一步，就比昨天更厉害了。',
            '学习就像升级打怪，你已经闯过好多关啦！'
          ],
          currentQuote: '',
          encourageCollapsed: true,
          headerExpanded: false,
          stickerBookCollapsed: true,
          debugBuildEnabled: false,
          buildLabel: 'BUILD 2026-02-22-1810 (a648afc)',

          // 家长与档案
          profiles: [],
          activeProfileId: '',
          newProfileName: '',
          newProfileAge: 8,
          showSettings: false,
          settingsSection: 'home',
          isParentUnlocked: false,
          parentPinSet: false,
          deferredPrompt: null,
          showInstall: false,
          showIosInstallHint: false,
          // Senior 统计视图状态
          seniorStatsRange: 'today', // 'today' | 'week'
          seniorStatsTick: 0,
          rewardToast: {
            visible: false,
            title: '',
            subtitle: '',
            xp: 0
          },
          allDoneToast: {
            visible: false,
            title: '',
            subtitle: ''
          },
          dragIndex: null,
          showConfetti: false,
          confettiSeed: 0,
          confettiPieces: 18,
          juniorStickers: {
            items: [],
            hintVisible: false,
            latestId: ''
          },
          showCoverPhotoManager: false,
          coverPhotoSlots: ['', '', ''],
          encourageAutoPlay: true,
          encourageTimer: null,
          encourageAnimKey: 0,
          encourageReducedMotion: false
        };
      },
      computed: {
        // 控制弹窗显示的计算属性（额外保护层）
        shouldShowMemoryManager() {
          return this.showMemoryManager && this._userInitiatedMemoryManager;
        },
        shouldShowMonthlyReport() {
          return this.showMonthlyReport && this._userInitiatedMonthlyReport;
        },
        showBuildTag() {
          return this.debugBuildEnabled;
        },
        activeProfile() {
          return this.profiles.find(p => p.id === this.activeProfileId) || { name: '孩子', age: 8 };
        },
        ageGroup() {
          return (Number(this.activeProfile.age) || 8) >= 10 ? 'senior' : 'junior';
        },
        isOlderKid() {
          return this.ageGroup === 'senior';
        },
        iconSet() {
          const map = {
            candy: {
              book: 'icon-candy-book', map: 'icon-candy-map', brain: 'icon-candy-brain',
              chart: 'icon-candy-chart', mic: 'icon-candy-mic', star: 'icon-candy-star', award: 'icon-candy-award'
            },
            forest: {
              book: 'icon-forest-book', map: 'icon-forest-map', brain: 'icon-forest-brain',
              chart: 'icon-forest-chart', mic: 'icon-forest-mic', star: 'icon-forest-star', award: 'icon-forest-award'
            },
            ocean: {
              book: 'icon-ocean-book', map: 'icon-ocean-map', brain: 'icon-ocean-brain',
              chart: 'icon-ocean-chart', mic: 'icon-ocean-mic', star: 'icon-ocean-star', award: 'icon-ocean-award'
            },
            buddy: {
              book: 'icon-ocean-book', map: 'icon-ocean-map', brain: 'icon-ocean-brain',
              chart: 'icon-ocean-chart', mic: 'icon-ocean-mic', star: 'icon-ocean-star', award: 'icon-ocean-award'
            }
          };
          return map[this.theme] || map.forest;
        },
        // 当前主题的背景样式（使用内联 style，避免 Tailwind CDN 扫描不到动态类）
        themeConfig() {
            const map = {
              forest: {
                style: {
                '--theme-bg': 'linear-gradient(135deg, #c9f7dc 0%, #ecfff4 45%, #c1f2b6 100%), radial-gradient(120px 80px at 12% 18%, rgba(34, 197, 94, 0.14), transparent 60%), radial-gradient(140px 90px at 85% 12%, rgba(16, 185, 129, 0.12), transparent 62%), radial-gradient(120px 80px at 78% 78%, rgba(34, 197, 94, 0.12), transparent 60%)',
                '--theme-border': 'rgba(16, 185, 129, 0.65)',
                '--theme-tint': '#d8ffe8',
                '--primary-start': '#00A699',
                '--primary-end': '#00C1AE',
                '--accent-start': '#FF385C',
                '--accent-end': '#FF5A5F',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              ocean: {
                style: {
                '--theme-bg': 'linear-gradient(145deg, #b5ecff 0%, #e3f7ff 45%, #9ccfff 100%), radial-gradient(140px 90px at 18% 20%, rgba(59, 130, 246, 0.14), transparent 62%), radial-gradient(160px 100px at 82% 18%, rgba(14, 165, 233, 0.12), transparent 62%), radial-gradient(140px 90px at 80% 78%, rgba(59, 130, 246, 0.12), transparent 60%)',
                '--theme-border': 'rgba(14, 165, 233, 0.65)',
                '--theme-tint': '#d6f4ff',
                '--primary-start': '#007A87',
                '--primary-end': '#00A699',
                '--accent-start': '#FF385C',
                '--accent-end': '#FF5A5F',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              candy: {
                style: {
                '--theme-bg': 'linear-gradient(135deg, #ffd9ea 0%, #fff1c8 45%, #d7e9ff 100%), radial-gradient(140px 90px at 16% 18%, rgba(244, 114, 182, 0.16), transparent 62%), radial-gradient(160px 100px at 82% 16%, rgba(59, 130, 246, 0.12), transparent 62%), radial-gradient(140px 90px at 78% 78%, rgba(251, 191, 36, 0.12), transparent 62%)',
                '--theme-border': 'rgba(255, 56, 92, 0.7)',
                '--theme-tint': '#ffe4ef',
                '--primary-start': '#FF385C',
                '--primary-end': '#FF5A5F',
                '--accent-start': '#00A699',
                '--accent-end': '#00C1AE',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              buddy: {
                style: {
                '--theme-bg': 'linear-gradient(145deg, #bedaff 0%, #e7f1ff 45%, #9cc1ff 100%), radial-gradient(150px 100px at 22% 20%, rgba(59, 130, 246, 0.16), transparent 62%), radial-gradient(170px 110px at 78% 18%, rgba(14, 165, 233, 0.14), transparent 62%), radial-gradient(150px 100px at 72% 78%, rgba(59, 130, 246, 0.12), transparent 60%)',
                '--theme-border': 'rgba(59, 130, 246, 0.7)',
                '--theme-tint': '#dbeafe',
                '--primary-start': '#3B82F6',
                '--primary-end': '#60A5FA',
                '--accent-start': '#06B6D4',
                '--accent-end': '#22D3EE',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              }
            };
          return map[this.theme] || map.forest;
        },
        // 今天日期字符串
        todayKey() {
          const d = new Date();
          return this.toLocalDateKey(d); // YYYY-MM-DD (local)
        },
        todayLabel() {
          const d = new Date();
          const weekNames = ['日', '一', '二', '三', '四', '五', '六'];
          return `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日（周${weekNames[d.getDay()]}）`;
        },
        // 模板提示文案
        templateInfo() {
          if (!this.tasks.length) return '';
          return '今天的任务列表会作为“默认模板”保存，明天自动加载。';
        },
        // 等级/称号计算
        levelDisplay() {
          const xp = this.xp;
          let level = 1;
          let nextXp = 50;

          if (xp < 50) {
            level = 1; nextXp = 50;
          } else if (xp < 150) {
            level = 2; nextXp = 150;
          } else if (xp < 300) {
            level = 3; nextXp = 300;
          } else if (xp < 500) {
            level = 4; nextXp = 500;
          } else {
            level = 5; nextXp = 800;
          }

          let title = '书童';
          if (level === 2) title = '学徒';
          if (level === 3) title = '小才子';
          if (level === 4) title = '秀才';
          if (level >= 5) title = '小状元';

          const prevXp = level === 1 ? 0 :
            level === 2 ? 50 :
            level === 3 ? 150 :
            level === 4 ? 300 : 500;
          const range = nextXp - prevXp;
          const progress = Math.min(100, Math.max(0, ((xp - prevXp) / range) * 100));

          return { level, title, nextXp, progress: progress.toFixed(1) };
        },
        todayProgress() {
          const total = this.tasks.length;
          const done = this.tasks.filter(t => t.done).length;
          const percent = total === 0 ? 0 : Math.round((done / total) * 100);
          return { total, done, percent };
        },
        progressRing() {
          const radius = 28;
          const circumference = 2 * Math.PI * radius;
          const percent = this.todayProgress.percent / 100;
          return {
            circumference,
            offset: circumference * (1 - percent)
          };
        },
        todayJuniorStickers() {
          return this.juniorStickers.items.filter(item => item.dayKey === this.todayKey);
        },
        latestJuniorSticker() {
          if (!this.juniorStickers.latestId) return null;
          return this.juniorStickers.items.find(item => item.id === this.juniorStickers.latestId) || null;
        },
        seniorStatsSource() {
          // 依赖触发：任务/复习/档案切换后重算
          const reactiveTick = `${this.activeProfileId}|${this.seniorStatsTick}|${this.tasks.length}|${this.memorySchedule.length}|${this.xp}`;
          if (!reactiveTick && reactiveTick !== '0') {
            return { tasksByDay: {}, scheduleByDay: {} };
          }
          let tasksByDay = {};
          const rawTasks = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (rawTasks) {
            try {
              const parsed = JSON.parse(rawTasks);
              tasksByDay = parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) {
              tasksByDay = {};
            }
          }

          const scheduleByDay = {};
          const rawSchedule = localStorage.getItem(this.getStorageKey('memory_schedule'));
          if (rawSchedule) {
            try {
              const parsedSchedule = JSON.parse(rawSchedule);
              if (Array.isArray(parsedSchedule)) {
                parsedSchedule.forEach(item => {
                  if (!item || !item.dayKey) return;
                  if (!scheduleByDay[item.dayKey]) {
                    scheduleByDay[item.dayKey] = [];
                  }
                  scheduleByDay[item.dayKey].push(item);
                });
              }
            } catch (e) {
              // ignore parse error and use empty schedule
            }
          }
          return { tasksByDay, scheduleByDay };
        },
        seniorTodaySummary() {
          return this.getSeniorSummaryByDay(this.todayKey);
        },
        seniorWeekDayKeys() {
          return this.getCurrentWeekDayKeys();
        },
        seniorWeekSummary() {
          const weekToDateKeys = this.seniorWeekDayKeys.filter(dayKey => dayKey <= this.todayKey);
          const summary = this.getSeniorRangeSummary(weekToDateKeys);
          return {
            ...summary,
            streak: this.getSeniorWeekStreak(weekToDateKeys)
          };
        },
        seniorSevenDayStats() {
          return this.getRecentDayKeys(7).map(dayKey => {
            const summary = this.getSeniorSummaryByDay(dayKey);
            return {
              dayKey,
              label: this.getShortDayLabel(dayKey),
              completionRate: summary.completionRate,
              focusMinutes: summary.focusMinutes
            };
          });
        },
        seniorChartModel() {
          const days = this.seniorSevenDayStats;
          const width = 360;
          const height = 190;
          const left = 34;
          const right = 14;
          const top = 16;
          const bottom = 46;
          const plotW = width - left - right;
          const plotH = height - top - bottom;
          const maxFocus = Math.max(1, ...days.map(d => d.focusMinutes || 0));
          const step = days.length > 1 ? plotW / (days.length - 1) : plotW;
          const barW = Math.min(22, Math.max(10, step * 0.5));

          const points = days.map((d, idx) => {
            const x = left + step * idx;
            const y = top + plotH - (Math.max(0, Math.min(100, d.completionRate)) / 100) * plotH;
            return { key: d.dayKey, x, y };
          });
          const bars = days.map((d, idx) => {
            const centerX = left + step * idx;
            const barH = Math.max(1, (Math.max(0, d.focusMinutes) / maxFocus) * plotH);
            return {
              key: d.dayKey,
              x: centerX - barW / 2,
              y: top + plotH - barH,
              width: barW,
              height: barH
            };
          });
          const labels = days.map((d, idx) => ({
            key: d.dayKey,
            x: left + step * idx,
            text: d.label
          }));
          return {
            maxFocus,
            points,
            bars,
            labels,
            linePoints: points.map(p => `${p.x},${p.y}`).join(' ')
          };
        },
        memoryCategoryLabel() {
          const map = {
            poetry: '古诗词',
            english: '英语',
            science: '数理化'
          };
          return map[this.memoryCategory] || '记忆';
        },
        batchImportPlaceholder() {
          if (this.memoryCategory === 'poetry') {
            return '例如：\\n静夜思,唐,李白\\n登鹳雀楼,唐,王之涣';
          }
          if (this.memoryCategory === 'english') {
            return '例如：\\napple,苹果\\nI like apples,我喜欢苹果';
          }
          return '例如：\\n几何,a² + b² = c²,直角三角形勾股定理\\n化学,NaCl + AgNO₃ = AgCl↓ + NaNO₃,沉淀反应';
        },
        batchImportTip() {
          if (this.memoryCategory === 'poetry') {
            return '格式：诗名,朝代,作者（逗号分隔）';
          }
          if (this.memoryCategory === 'english') {
            return '格式：单词/句子,注释（逗号分隔）';
          }
          return '格式：类别,公式,注释（逗号分隔）';
        },
        batchImportRangeHint() {
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            return '提示：选好起止日期后，会显示可用天数';
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          const days = Math.floor((end - start) / (24 * 60 * 60 * 1000)) + 1;
          if (days <= 0) return '日期范围不合法，请检查';
          const lineCount = this.previewTasks.length || 0;
          return `可用 ${days} 天 · 已输入 ${lineCount} 行`;
        },
        // 当前周的开始日期
        currentWeekLabel() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          return `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
        },
        // 当前周的所有日期（保留用于其他功能）
        currentWeekDays() {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          const weekDays = [];
          const start = this.getWeekStart();
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(start);
            date.setDate(start.getDate() + i);
            const dayKey = this.toLocalDateKey(date);
            const weekNames = ['日', '一', '二', '三', '四', '五', '六'];
            const tasks = this.memorySchedule
              .filter(s => s.dayKey === dayKey)
              .map(s => {
                const base = this.memoryList.find(m => m.id === s.baseId);
                return base && base.category === this.memoryCategory ? {
                  ...s,
                  content: base ? base.content : s.content || ''
                } : null;
              });
            const filteredTasks = tasks.filter(Boolean);
            
            weekDays.push({
              key: dayKey,
              label: `周${weekNames[date.getDay()]}`,
              date: `${date.getMonth() + 1}月${date.getDate()}日`,
              isToday: dayKey === todayKey,
              tasks: filteredTasks
            });
          }
          return weekDays;
        },

        // 周视图记忆项（按学习项分组，显示所有复习时间点）
        weeklyMemoryItems() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          const startKey = this.toLocalDateKey(start);
          const endKey = this.toLocalDateKey(end);
          const todayKey = this.toLocalDateKey(new Date());
          
          // 找出本周内初始学习的所有记忆项，以及本周需要复习的任务
          const learnedThisWeek = [];
          const reviewThisWeek = [];
          
          // 本周学习的项目
          this.memoryList.forEach(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            if (learnKey >= startKey && learnKey <= endKey) {
              learnedThisWeek.push(m);
            }
          });
          
          // 本周需要复习的项目（包括之前学习但本周需要复习的）
          const scheduleMap = {};
          this.memorySchedule.forEach(s => {
            if (s.dayKey >= startKey && s.dayKey <= endKey) {
              if (!scheduleMap[s.baseId]) {
                scheduleMap[s.baseId] = [];
              }
              scheduleMap[s.baseId].push(s);
            }
          });
          
          // 合并所有需要显示的项目
          const allItems = new Map();
          
          // 添加本周学习的项目
          learnedThisWeek.forEach(m => {
            allItems.set(m.id, m);
          });
          
          // 添加本周需要复习的项目（如果不在本周学习列表中）
          Object.keys(scheduleMap).forEach(baseId => {
            if (!allItems.has(baseId)) {
              const base = this.memoryList.find(m => m.id === baseId);
              if (base) {
                allItems.set(baseId, base);
              }
            }
          });
          
          // 按分类过滤（使用显式分类字段）
          let filteredItems = Array.from(allItems.values()).filter(m => m.category === this.memoryCategory);
          
          // 转换为显示格式
          const items = filteredItems.map(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            
            // 使用缓存优化性能
            const cacheKey = `${m.id}_${this.currentWeekStart?.getTime() || 0}`;
            if (this.reviewStatusCache[cacheKey]) {
              return this.reviewStatusCache[cacheKey];
            }
            
            // 计算所有复习时间点
            const reviews = {};
            
            // 即时复习时间点（5分钟、30分钟、12小时）
            const learnTime = learnDate.getTime();
            
            // 5分钟后
            const fiveMinLater = new Date(learnTime + 5 * 60 * 1000);
            reviews['5min'] = {
              done: this.getReviewStatus(m.id, '5min'),
              date: this.formatReviewTime(fiveMinLater),
              timestamp: fiveMinLater.getTime()
            };
            
            // 30分钟后
            const thirtyMinLater = new Date(learnTime + 30 * 60 * 1000);
            reviews['30min'] = {
              done: this.getReviewStatus(m.id, '30min'),
              date: this.formatReviewTime(thirtyMinLater),
              timestamp: thirtyMinLater.getTime()
            };
            
            // 12小时后
            const twelveHLater = new Date(learnTime + 12 * 60 * 60 * 1000);
            reviews['12h'] = {
              done: this.getReviewStatus(m.id, '12h'),
              date: this.formatReviewTime(twelveHLater),
              timestamp: twelveHLater.getTime()
            };
            
            // 艾宾浩斯复习日期（+1, +2, +4, +7, +15, +30天）
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(learnDate);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewKey = this.toLocalDateKey(reviewDate);
              
              // 查找对应的复习计划
              const scheduleItem = this.memorySchedule.find(s => 
                s.baseId === m.id && s.offsetDay === offset && s.dayKey === reviewKey
              );
              
              reviews[offset] = {
                done: scheduleItem ? scheduleItem.done : false,
                date: `${reviewDate.getMonth() + 1}/${reviewDate.getDate()}`,
                scheduleId: scheduleItem ? scheduleItem.id : null,
                dayKey: reviewKey,
                isThisWeek: reviewKey >= startKey && reviewKey <= endKey
              };
            });
            
            const relatedSchedules = scheduleMap[m.id] || [];
            const fallbackContent = relatedSchedules.find(s => s && s.content)?.content || '';
            const item = {
              id: m.id,
              title: m.title,
              content: m.content || fallbackContent,
              dynasty: m.dynasty || '',
              author: m.author || '',
              learnDate: `${learnDate.getMonth() + 1}/${learnDate.getDate()}`,
              learnYear: String(learnDate.getFullYear()),
              learnKey,
              reviews,
              isLearnedThisWeek: learnKey >= startKey && learnKey <= endKey
            };
            
            // 缓存结果
            this.reviewStatusCache[cacheKey] = item;
            return item;
          })
          .sort((a, b) => {
            // 优先显示本周学习的，然后按日期排序
            if (a.isLearnedThisWeek !== b.isLearnedThisWeek) {
              return a.isLearnedThisWeek ? -1 : 1;
            }
            return a.learnKey.localeCompare(b.learnKey);
          });
          
          return items;
        }
      },
      methods: {
        goPage(n) {
          const target = Math.max(0, Math.min(3, Number(n) || 0));
          if (target === 3) {
            if (!this.requireParentIfNeeded(true)) return;
            this.currentPage = 3;
            this.showSettings = true;
            this.settingsSection = 'parent';
            return;
          }
          this.currentPage = target;
          if (target === 2) {
            this.activeTab = 'memory';
          } else if (target === 1 && this.activeTab === 'memory') {
            this.activeTab = 'daily';
          }
          if (this.showSettings) {
            this.showSettings = false;
            this.settingsSection = 'home';
          }
        },
        loadCoverPhotoSlots() {
          const key = 'studyplan.coverPhotoSlots.v1';
          const raw = localStorage.getItem(key);
          if (!raw) {
            this.coverPhotoSlots = ['', '', ''];
            return;
          }
          try {
            const parsed = JSON.parse(raw);
            if (Array.isArray(parsed)) {
              const normalized = parsed.slice(0, 3).map(item => typeof item === 'string' ? item : '');
              while (normalized.length < 3) normalized.push('');
              this.coverPhotoSlots = normalized;
              return;
            }
          } catch (e) {
            // ignore parse errors and reset
          }
          this.coverPhotoSlots = ['', '', ''];
        },
        saveCoverPhotoSlots() {
          const key = 'studyplan.coverPhotoSlots.v1';
          const slots = this.coverPhotoSlots.slice(0, 3).map(item => typeof item === 'string' ? item : '');
          while (slots.length < 3) slots.push('');
          this.coverPhotoSlots = slots;
          localStorage.setItem(key, JSON.stringify(slots));
        },
        openCoverPhotoManager() {
          if (!this.requireParentIfNeeded(true)) return;
          this.showCoverPhotoManager = true;
        },
        async onCoverPhotoPicked(event, index) {
          const file = event && event.target && event.target.files ? event.target.files[0] : null;
          if (!file) return;
          try {
            const compressed = await this.compressImageToJpegDataURL(file, 384, 0.78);
            const slots = this.coverPhotoSlots.slice(0, 3);
            while (slots.length < 3) slots.push('');
            slots[index] = compressed;
            this.coverPhotoSlots = slots;
            this.saveCoverPhotoSlots();
          } catch (e) {
            alert('图片处理失败，请重试。');
          } finally {
            if (event && event.target) event.target.value = '';
          }
        },
        clearCoverPhotoSlot(index) {
          const slots = this.coverPhotoSlots.slice(0, 3);
          while (slots.length < 3) slots.push('');
          slots[index] = '';
          this.coverPhotoSlots = slots;
          this.saveCoverPhotoSlots();
        },
        compressImageToJpegDataURL(file, maxEdge = 384, quality = 0.78) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onerror = () => reject(new Error('read failed'));
            reader.onload = () => {
              const img = new Image();
              img.onerror = () => reject(new Error('decode failed'));
              img.onload = () => {
                const square = Math.min(img.width, img.height);
                const sx = Math.floor((img.width - square) / 2);
                const sy = Math.floor((img.height - square) / 2);
                const target = Math.max(1, Math.min(maxEdge, square));
                const canvas = document.createElement('canvas');
                canvas.width = target;
                canvas.height = target;
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                  reject(new Error('canvas failed'));
                  return;
                }
                ctx.drawImage(img, sx, sy, square, square, 0, 0, target, target);
                resolve(canvas.toDataURL('image/jpeg', quality));
              };
              img.src = reader.result;
            };
            reader.readAsDataURL(file);
          });
        },
        // 主题切换
        setTheme(value) {
          this.theme = value;
          localStorage.setItem(this.getStorageKey('theme'), value);
          this.applyBodyTheme();
        },
        normalizeAge(age) {
          const n = Number(age);
          if (!Number.isFinite(n)) return 8;
          return Math.max(3, Math.min(18, Math.round(n)));
        },
        onProfileEdited(profile) {
          profile.age = this.normalizeAge(profile.age);
          profile.name = (profile.name || '').trim() || '孩子';
          this.saveProfiles();
          if (profile.id === this.activeProfileId) {
            this.onAgeGroupChanged();
          }
        },
        onAgeGroupChanged() {
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
          this.applyBodyTheme();
        },
        ensureActiveTabForAgeGroup() {
          const allowedTabs = this.ageGroup === 'senior'
            ? ['daily', 'memory', 'stats']
            : ['daily', 'memory'];
          if (!allowedTabs.includes(this.activeTab)) {
            this.activeTab = 'daily';
          }
          if (this.ageGroup !== 'senior' && this.settingsSection === 'stats') {
            this.settingsSection = 'home';
          }
        },
        openSeniorStats() {
          if (this.ageGroup !== 'senior') return;
          this.currentPage = 1;
          this.activeTab = 'stats';
          this.showSettings = false;
          this.settingsSection = 'home';
        },
        initDebugMode() {
          const params = new URLSearchParams(window.location.search);
          const queryValue = params.get('debug');
          const stored = localStorage.getItem(this.getStorageKey('debug_build_tag'));
          if (queryValue === '1') {
            this.debugBuildEnabled = true;
            localStorage.setItem(this.getStorageKey('debug_build_tag'), '1');
            return;
          }
          if (queryValue === '0') {
            this.debugBuildEnabled = false;
            localStorage.removeItem(this.getStorageKey('debug_build_tag'));
            return;
          }
          this.debugBuildEnabled = stored === '1';
        },
        toggleDebugBuild() {
          this.debugBuildEnabled = !this.debugBuildEnabled;
          if (this.debugBuildEnabled) {
            localStorage.setItem(this.getStorageKey('debug_build_tag'), '1');
          } else {
            localStorage.removeItem(this.getStorageKey('debug_build_tag'));
          }
        },
        toggleHeaderExpanded() {
          this.headerExpanded = !this.headerExpanded;
        },
        collapseHeader() {
          this.headerExpanded = false;
        },
        syncStickerBookCollapse() {
          this.stickerBookCollapsed = this.todayJuniorStickers.length === 0;
        },
        toggleStickerBook() {
          this.stickerBookCollapsed = !this.stickerBookCollapsed;
        },

        // 一键清缓存（Service Worker + Cache Storage）
        clearAppCache() {
          const confirmed = confirm('将清除离线缓存并刷新页面，确定继续吗？');
          if (!confirmed) return;
          if ('caches' in window) {
            caches.keys()
              .then(keys => Promise.all(keys.map(key => caches.delete(key))))
              .then(() => {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                  navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                location.reload();
              })
              .catch(() => location.reload());
          } else {
            location.reload();
          }
        },

        // 加载今日任务
        loadTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          const localKey = this.todayKey;
          const utcKey = this.toUTCDateKey(new Date());
          const todayTasks = byDay[localKey] || byDay[utcKey];

          if (todayTasks && Array.isArray(todayTasks)) {
            // 为旧数据添加时间戳（向后兼容）
            this.tasks = todayTasks.map(task => {
              if (!task.createdAt) {
                task.createdAt = new Date().toISOString();
              }
              if (!task.updatedAt) {
                task.updatedAt = new Date().toISOString();
              }
              return task;
            });
            // 兼容迁移：将 UTC key 的数据映射到本地 key
            if (!byDay[localKey] && byDay[utcKey]) {
              byDay[localKey] = todayTasks;
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            }
            } else {
              this.tasks = [];
          }
          this.syncStickerBookCollapse();
        },

        saveTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          byDay[this.todayKey] = this.tasks;
          localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
        },
        loadJuniorStickers() {
          const raw = localStorage.getItem(this.getStorageKey('junior_stickers'));
          if (!raw) {
            this.juniorStickers.items = [];
            this.juniorStickers.hintVisible = false;
            this.juniorStickers.latestId = '';
            return;
          }
          try {
            const parsed = JSON.parse(raw);
            this.juniorStickers.items = Array.isArray(parsed) ? parsed : [];
          } catch (e) {
            this.juniorStickers.items = [];
          }
          this.juniorStickers.hintVisible = false;
          this.juniorStickers.latestId = '';
        },
        saveJuniorStickers() {
          localStorage.setItem(this.getStorageKey('junior_stickers'), JSON.stringify(this.juniorStickers.items));
        },
        pickJuniorSticker(task) {
          const pool = [
            { emoji: '⭐', name: '闪亮星' },
            { emoji: '🚀', name: '冲刺火箭' },
            { emoji: '🦁', name: '勇气狮子' },
            { emoji: '🌈', name: '彩虹能量' },
            { emoji: '🐬', name: '海豚伙伴' },
            { emoji: '🎯', name: '命中目标' },
            { emoji: '🍀', name: '幸运四叶草' },
            { emoji: '🧠', name: '聪明大脑' }
          ];
          const seed = `${task.id || ''}-${task.title || ''}-${this.todayKey}`;
          let hash = 0;
          for (let i = 0; i < seed.length; i += 1) {
            hash = (hash * 31 + seed.charCodeAt(i)) | 0;
          }
          return pool[Math.abs(hash) % pool.length];
        },
        awardJuniorSticker(task) {
          if (this.ageGroup !== 'junior') return;
          if (!task || !task.id) return;
          const alreadyAwarded = this.juniorStickers.items.some(item =>
            item.taskId === task.id && item.dayKey === this.todayKey
          );
          if (alreadyAwarded) return;
          const sticker = this.pickJuniorSticker(task);
          const entry = {
            id: `${task.id}_${Date.now()}`,
            taskId: task.id,
            dayKey: this.todayKey,
            awardedAt: new Date().toISOString(),
            emoji: sticker.emoji,
            name: sticker.name
          };
          this.juniorStickers.items.push(entry);
          this.juniorStickers.latestId = entry.id;
          this.juniorStickers.hintVisible = true;
          this.stickerBookCollapsed = false;
          clearTimeout(this._stickerHintTimer);
          this._stickerHintTimer = setTimeout(() => {
            this.juniorStickers.hintVisible = false;
          }, 1600);
          this.saveJuniorStickers();
        },

        // 模板管理
        loadTemplates() {
          const raw = localStorage.getItem(this.getStorageKey('templates'));
          if (raw) {
            try {
              this.templates = JSON.parse(raw);
            } catch (e) {
              this.templates = [];
            }
          } else {
            this.templates = [];
          }
        },

        saveTemplates() {
          localStorage.setItem(this.getStorageKey('templates'), JSON.stringify(this.templates));
        },

        createTemplateFromCurrent() {
          if (!this.newTemplateName.trim()) {
            alert('请输入模板名称');
            return;
          }
          if (this.tasks.length === 0) {
            alert('当前没有任务，无法创建模板');
            return;
          }
          const template = {
            id: this.uuid(),
            name: this.newTemplateName.trim(),
            tasks: this.tasks.map(t => ({
              title: t.title,
              note: t.note || ''
              // 模板不保存时间信息，因为每次应用模板时都是新的开始
            })),
            createdAt: new Date().toISOString()
          };
          this.templates.push(template);
          this.saveTemplates();
          this.newTemplateName = '';
          alert('模板创建成功！');
        },

        applyTemplate() {
          if (!this.selectedTemplateId) return;
          this.applyTemplateById(this.selectedTemplateId);
        },

        applyTemplateById(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          
          // 确认是否覆盖当前任务
          if (this.tasks.length > 0) {
            if (!confirm(`应用模板"${template.name}"将覆盖当前任务，确定继续吗？`)) {
              return;
            }
          }

          this.tasks = template.tasks.map(t => ({
            id: this.uuid(),
            title: t.title,
            note: t.note || '',
            startTime: '',
            endTime: '',
            done: false,
            coinAnimating: false
          }));
          this.saveTodayTasks();
          this.selectedTemplateId = '';
          this.showTemplateManager = false;
        },

        openTemplateManager() {
          if (!this.requireParentIfNeeded()) return;
          this.showTemplateManager = true;
        },

        deleteTemplate(templateId) {
          if (!confirm('确定要删除这个模板吗？')) return;
          this.templates = this.templates.filter(t => t.id !== templateId);
          this.saveTemplates();
        },

        editTemplate(templateId) {
          if (this.editingTemplateId === templateId) {
            // 保存编辑
            this.saveTemplates();
            this.editingTemplateId = '';
            this.newTaskForTemplate = {};
            this.editingTemplateName = {};
          } else {
            // 开始编辑
            this.editingTemplateId = templateId;
            const template = this.templates.find(t => t.id === templateId);
            if (template) {
              this.editingTemplateName = { ...this.editingTemplateName, [templateId]: template.name };
            }
            if (!this.newTaskForTemplate[templateId]) {
              this.newTaskForTemplate = { ...this.newTaskForTemplate, [templateId]: '' };
            }
          }
        },

        saveTemplateName(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (template && this.editingTemplateName[templateId]) {
            template.name = this.editingTemplateName[templateId].trim() || template.name;
            this.saveTemplates();
          }
        },

        addTaskToTemplate(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          const taskTitle = this.newTaskForTemplate[templateId]?.trim();
          if (!taskTitle) return;
          template.tasks.push({ title: taskTitle, note: '' });
          this.newTaskForTemplate[templateId] = '';
          this.saveTemplates();
        },

        removeTaskFromTemplate(templateId, taskIndex) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          template.tasks.splice(taskIndex, 1);
          this.saveTemplates();
        },

        // 任务操作
        addTask() {
          if (!this.newTaskTitle.trim()) return;
          this.tasks.push({
            id: this.uuid(),
            title: this.newTaskTitle.trim(),
            note: '',
            startTime: '', // 开始时间通过"开始"按钮记录
            endTime: '', // 结束时间在任务完成时自动记录
            done: false,
            coinAnimating: false,
            createdAt: new Date().toISOString(), // 添加创建时间戳
            updatedAt: new Date().toISOString() // 添加更新时间戳
          });
          this.newTaskTitle = '';
          this.saveTodayTasks();
        },
        startTask(task) {
          if (task.done || task.startTime) return;
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          task.startTime = `${hours}:${minutes}`;
          this.saveTodayTasks();
        },
        removeTask(index) {
          if (!this.requireParentIfNeeded(true)) return;
          this.tasks.splice(index, 1);
          this.saveTodayTasks();
        },
        toggleTask(task) {
          if (!task.startTime && !task.done) {
            alert('请先点击“开始”再完成任务。');
            return;
          }
          const wasDone = task.done;
          task.done = !task.done;
          if (task.done) {
            // XP 奖励（只奖励一次，避免重复刷分）
            if (!task.completedAt) {
              this.gainXp(10);
              this.awardJuniorSticker(task);
              const doneCount = this.tasks.filter(t => t.done).length;
              if (doneCount === 1) {
                this.showRewardToast({
                  title: '首个任务完成！',
                  subtitle: '开局就很棒，继续保持～',
                  xp: 10
                });
              } else if (doneCount % 5 === 0) {
                this.showRewardToast({
                  title: `完成 ${doneCount} 个任务！`,
                  subtitle: '持续努力，进度飞起～',
                  xp: 10
                });
              } else {
                this.showRewardToast({
                  title: '完成打卡！',
                  subtitle: '每一步都算数～',
                  xp: 10
                });
              }
            }
            // 今日全部完成奖励（每天一次）
            if (this.tasks.length > 0 && this.tasks.every(t => t.done)) {
              const todayKey = this.todayKey;
              const lastKey = localStorage.getItem(this.getStorageKey('all_done_key'));
              if (lastKey !== todayKey) {
                this.showAllDoneToast();
                this.triggerConfetti();
                localStorage.setItem(this.getStorageKey('all_done_key'), todayKey);
              }
            }
            // 金币动画
            task.coinAnimating = true;
            setTimeout(() => {
              task.coinAnimating = false;
            }, 600);
            // 自动记录结束时间（如果还没有记录）
            if (!task.endTime) {
              const now = new Date();
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              task.endTime = `${hours}:${minutes}`;
            }
            // 记录完成时间戳
            task.completedAt = new Date().toISOString();
          } else if (wasDone) {
            // 取消完成：保留已奖励标记，清空结束时间方便重新完成
            task.endTime = '';
          }
          // 更新修改时间
          task.updatedAt = new Date().toISOString();
          this.saveTodayTasks();
        },

        // XP
        gainXp(amount) {
          this.xp += amount;
          localStorage.setItem(this.getStorageKey('xp'), String(this.xp));
        },

        // 成就奖励卡
        showRewardToast({ title, subtitle, xp }) {
          this.rewardToast = {
            visible: true,
            title,
            subtitle,
            xp
          };
          clearTimeout(this._rewardTimer);
          this._rewardTimer = setTimeout(() => {
            this.rewardToast.visible = false;
          }, 2200);
        },

        showAllDoneToast() {
          this.allDoneToast = {
            visible: true,
            title: '今天任务全部完成！',
            subtitle: '为坚持点个大大的赞～'
          };
          clearTimeout(this._allDoneTimer);
          this._allDoneTimer = setTimeout(() => {
            this.allDoneToast.visible = false;
          }, 2600);
        },

        triggerConfetti() {
          this.confettiSeed = Date.now();
          this.showConfetti = true;
          clearTimeout(this._confettiTimer);
          this._confettiTimer = setTimeout(() => {
            this.showConfetti = false;
          }, 1800);
        },

        confettiStyle(i) {
          const rand = (seed) => {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
          };
          const base = this.confettiSeed + i * 17;
          const left = Math.round(rand(base) * 90 + 5);
          const delay = (rand(base + 1) * 0.3).toFixed(2);
          const dur = (0.9 + rand(base + 2) * 0.9).toFixed(2);
          const colors = ['#f59e0b', '#10b981', '#38bdf8', '#f97316', '#ec4899', '#a855f7'];
          const color = colors[Math.floor(rand(base + 3) * colors.length)];
          return {
            '--x': `${left}%`,
            '--delay': `${delay}s`,
            '--dur': `${dur}s`,
            '--color': color
          };
        },

        // 拖拽排序
        onDragStart(index) {
          this.dragIndex = index;
        },
        onDrop(index) {
          if (this.dragIndex === null || this.dragIndex === index) return;
          const moved = this.tasks.splice(this.dragIndex, 1)[0];
          this.tasks.splice(index, 0, moved);
          this.dragIndex = null;
          this.saveTodayTasks();
        },
        onDragEnd() {
          this.dragIndex = null;
        },

        // 记忆挑战：保存草稿并基于艾宾浩斯曲线生成排期
        saveMemoryDraft() {
          if (!this.memoryDraft.title.trim()) return;
          const list = [...this.memoryList];
          const base = {
            id: this.uuid(),
            title: this.memoryDraft.title.trim(),
            content: this.memoryDraft.content.trim(),
            createdAt: new Date().toISOString()
          };
          list.push(base);
          this.memoryList = list;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(list));

          // 生成艾宾浩斯复习计划：+1 / +2 / +4 / +7 / +15 / +30 天
          const offsets = [1, 2, 4, 7, 15, 30];
          const now = new Date();
          const schedule = [...this.memorySchedule];
          offsets.forEach(d => {
            const dt = new Date(now);
            dt.setDate(dt.getDate() + d);
            const dayKey = this.toLocalDateKey(dt);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              dayKey,
              offsetDay: d,
              done: false
            });
          });
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          this.memoryDraft.title = '';
          this.memoryDraft.content = '';
        },

        // 打开记忆管理窗口（用户主动打开）
        openMemoryManager() {
          if (!this.requireParentIfNeeded()) return;
          this._userInitiatedMemoryManager = true;
          this.showMemoryManager = true;
        },

        // 关闭记忆管理窗口
        closeMemoryManager(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMemoryManager = false;
          this.showMemoryManager = false;
          // 立即强制更新
          this.$forceUpdate();
          // 再次确保关闭（防止异步问题）
          this.$nextTick(() => {
            this.showMemoryManager = false;
            this.$forceUpdate();
          });
          // 延迟清理数据，避免关闭动画卡顿
          setTimeout(() => {
            if (!this.showMemoryManager) {
              this.batchImportData = '';
              this.previewTasks = [];
              this.batchImportStartDate = '';
              this.batchImportEndDate = '';
            }
          }, 300);
        },

        // 预览批量导入
        previewBatchImport() {
          if (!this.batchImportData.trim()) {
            alert('请填写任务数据');
            return;
          }
          const lines = this.batchImportData.trim().split('\n').filter(l => l.trim());
          this.previewTasks = lines.map(line => {
            const parts = line.split(/,|，/).map(s => s.trim());
            if (this.memoryCategory === 'poetry') {
              return {
                title: parts[0] || '',
                dynasty: parts[1] || '',
                author: parts[2] || '',
                content: parts[1] && parts[2] ? `${parts[1]} · ${parts[2]}` : ''
              };
            }
            if (this.memoryCategory === 'english') {
              return {
                title: parts[0] || '',
                content: parts[1] || ''
              };
            }
            return {
              title: parts[1] || '',
              categoryName: parts[0] || '',
              content: parts[2] ? `${parts[0] ? parts[0] + ' · ' : ''}${parts[2]}` : ''
            };
          }).filter(t => t.title);
        },

        // 批量导入记忆任务
        processBatchImport() {
          if (this.previewTasks.length === 0) {
            alert('请先预览任务或填写任务数据');
            return;
          }
          const range = this.getBatchImportDateRange();
          if (!range) return;
          const startDate = range.start;
          const endDate = range.end;
          const daysAvailable = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;
          if (this.previewTasks.length > daysAvailable) {
            alert(`输入行数超过日期范围（可用 ${daysAvailable} 天）。请减少行数或延长结束日期。`);
            return;
          }

          const schedule = [...this.memorySchedule];
          
          // 从起始日期开始，每行顺延一天
          this.previewTasks.forEach((task, idx) => {
            const date = new Date(startDate);
            date.setDate(date.getDate() + idx);
            const dayKey = this.toLocalDateKey(date);
            
            const base = {
              id: this.uuid(),
              title: task.title,
              content: task.content,
              category: this.memoryCategory,
              dynasty: task.dynasty || '',
              author: task.author || '',
              categoryName: task.categoryName || '',
              createdAt: date.toISOString()
            };
            this.memoryList.push(base);
            
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(date);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewDayKey = this.toLocalDateKey(reviewDate);
              schedule.push({
                id: this.uuid(),
                baseId: base.id,
                title: base.title,
                content: base.content,
                category: base.category,
                dynasty: base.dynasty,
                author: base.author,
                categoryName: base.categoryName,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              });
            });
          });
          
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));
          
          alert('批量导入成功！');
          this.closeMemoryManager();
        },

        // 获取周开始日期
        getWeekStart() {
          if (!this.currentWeekStart) {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(diff);
            this.currentWeekStart = new Date(monday);
          }
          return new Date(this.currentWeekStart);
        },

        // 周视图导航
        prevWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() - 7);
          this.currentWeekStart = new Date(start);
          // 清除缓存，强制重新计算
          this.reviewStatusCache = {};
        },

        nextWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() + 7);
          this.currentWeekStart = new Date(start);
          // 清除缓存，强制重新计算
          this.reviewStatusCache = {};
        },

        // 切换记忆任务完成状态
        toggleMemoryTask(task) {
          task.done = !task.done;
          this.memorySchedule = [...this.memorySchedule];
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
        },

        // 切换复习检查状态（优化性能）
        toggleReviewCheck(baseId, reviewKey) {
          const base = this.memoryList.find(m => m.id === baseId);
          if (!base) return;
          
          // 清除缓存，强制重新计算
          const cacheKey = `${baseId}_${this.currentWeekStart?.getTime() || 0}`;
          delete this.reviewStatusCache[cacheKey];
          
          const learnDate = new Date(base.createdAt);
          
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            // 即时复习时间点，使用localStorage存储
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            const currentStatus = localStorage.getItem(key) === 'true';
            localStorage.setItem(key, String(!currentStatus));
            // 直接更新视图，不需要重新计算整个列表
            this.$forceUpdate();
          } else {
            // 艾宾浩斯复习日期
            const offset = parseInt(reviewKey);
            const reviewDate = new Date(learnDate);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            
            let scheduleItem = this.memorySchedule.find(s => 
              s.baseId === baseId && s.offsetDay === offset && s.dayKey === reviewDayKey
            );
            
            if (!scheduleItem) {
              // 如果不存在，创建一个新的复习计划
              scheduleItem = {
                id: this.uuid(),
                baseId: baseId,
                title: base.title,
                content: base.content,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              };
              this.memorySchedule.push(scheduleItem);
            }
            
            scheduleItem.done = !scheduleItem.done;
            // Vue 3: 使用 splice 触发响应式更新
            const idx = this.memorySchedule.indexOf(scheduleItem);
            if (idx !== -1) {
              this.memorySchedule.splice(idx, 1, scheduleItem);
            }
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
          }
        },

        // 获取复习状态
        getReviewStatus(baseId, reviewKey) {
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            return localStorage.getItem(key) === 'true';
          }
          return false;
        },

        // 格式化复习时间
        formatReviewTime(date) {
          const now = new Date();
          const diff = date.getTime() - now.getTime();
          
          if (diff < 0) {
            return '已过';
          } else if (diff < 60 * 60 * 1000) {
            const minutes = Math.floor(diff / (60 * 1000));
            return `${minutes}分钟后`;
          } else if (diff < 24 * 60 * 60 * 1000) {
            const hours = Math.floor(diff / (60 * 60 * 1000));
            return `${hours}小时后`;
          } else {
            return `${date.getMonth() + 1}/${date.getDate()}`;
          }
        },

        // 检查是否可以编辑记忆项（只能编辑当天及以后的内容）
        canEditMemoryItem(item) {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          return item.learnKey >= todayKey;
        },

        // 开始编辑记忆项
        startEditMemory(item) {
          if (!this.canEditMemoryItem(item)) {
            alert('只能编辑当天及以后的内容，无法编辑过去的内容。');
            return;
          }
          this.editingMemoryId = item.id;
          this.editingMemoryTitle = item.title;
          this.editingMemoryContent = item.content || '';
        },

        // 保存编辑的记忆项
        saveEditMemory(item) {
          if (!this.editingMemoryTitle.trim()) {
            alert('标题不能为空');
            return;
          }

          const memoryItem = this.memoryList.find(m => m.id === item.id);
          if (memoryItem) {
            memoryItem.title = this.editingMemoryTitle.trim();
            memoryItem.content = this.editingMemoryContent.trim();
            memoryItem.updatedAt = new Date().toISOString();
            
            // 更新相关的复习计划
            this.memorySchedule.forEach(schedule => {
              if (schedule.baseId === item.id) {
                schedule.title = memoryItem.title;
                schedule.content = memoryItem.content;
              }
            });

            localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
            
            // 清除缓存
            this.reviewStatusCache = {};
          }

          this.cancelEditMemory();
        },

        // 取消编辑
        cancelEditMemory() {
          this.editingMemoryId = null;
          this.editingMemoryTitle = '';
          this.editingMemoryContent = '';
        },

        // 朝代颜色
        dynastyColor(dynasty) {
          const map = {
            '先秦': '#64748b',
            '秦': '#92400e',
            '汉': '#b91c1c',
            '魏': '#2563eb',
            '晋': '#0f766e',
            '南北朝': '#6d28d9',
            '隋': '#ea580c',
            '唐': '#f59e0b',
            '宋': '#10b981',
            '元': '#3b82f6',
            '明': '#ef4444',
            '清': '#8b5cf6',
            '近现代': '#0ea5e9'
          };
          return map[dynasty] || '#64748b';
        },

        // 添加今天的内容
        addTodayMemory() {
          if (!this.requireParentIfNeeded()) return;
          const today = new Date();
          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(today),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = true;
        },

        // 保存今天的内容
        saveTodayMemory() {
          if (!this.newTodayMemory.title.trim()) {
            alert('请输入标题');
            return;
          }
          if (this.memoryCategory === 'poetry') {
            if (!this.newTodayMemory.dynasty.trim() || !this.newTodayMemory.author.trim()) {
              alert('请输入朝代和作者');
              return;
            }
          }
          if (this.memoryCategory === 'science') {
            if (!this.newTodayMemory.categoryName.trim()) {
              alert('请输入类别');
              return;
            }
          }

          if (!this.newTodayMemory.date) {
            alert('请选择日期');
            return;
          }

          const date = this.parseDateInputToLocalDate(this.newTodayMemory.date);
          const contentForPoetry = this.memoryCategory === 'poetry' && !this.newTodayMemory.content.trim()
            ? `${this.newTodayMemory.dynasty.trim()} · ${this.newTodayMemory.author.trim()}`
            : this.newTodayMemory.content.trim();
          const base = {
            id: this.uuid(),
            title: this.newTodayMemory.title.trim(),
            content: contentForPoetry,
            category: this.memoryCategory,
            dynasty: this.newTodayMemory.dynasty.trim(),
            author: this.newTodayMemory.author.trim(),
            categoryName: this.newTodayMemory.categoryName.trim(),
            createdAt: date.toISOString()
          };
          
          this.memoryList.push(base);
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));

          // 生成艾宾浩斯复习计划
          const offsets = [1, 2, 4, 7, 15, 30];
          const schedule = [...this.memorySchedule];
          offsets.forEach(offset => {
            const reviewDate = new Date(date);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              category: base.category,
              dynasty: base.dynasty,
              author: base.author,
              categoryName: base.categoryName,
              dayKey: reviewDayKey,
              offsetDay: offset,
              done: false
            });
          });

          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          // 清除缓存
          this.reviewStatusCache = {};

          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(new Date()),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = false;
          alert('添加成功！');
        },

        // 处理重置按钮点击 - 使用原生 confirm
        handleResetClick() {
          if (!this.requireParentIfNeeded(true)) return;
          // 先关闭所有其他弹窗
          this.showMemoryManager = false;
          this.showAddTodayModal = false;
          this.showTemplateManager = false;
          this.showMonthlyReport = false;
          this.editingMemoryId = null;
          this.showResetConfirm = false;
          this.$forceUpdate();
          
          // 使用原生 confirm 对话框（避免自定义弹窗的关闭问题）
          setTimeout(() => {
            const confirmed1 = window.confirm(
              '⚠️ 第一步确认\n\n' +
              '即将清空全部数据，确定继续吗？'
            );
            if (!confirmed1) return;
            const confirmed2 = window.confirm(
              '⚠️ 第二步确认\n\n' +
              '清空后无法找回，是否真的要清空？'
            );
            if (!confirmed2) return;
            const confirmed3 = window.confirm(
              '⚠️ 第三步确认\n\n' +
              '最后一次确认：确定清空全部数据？'
            );
            if (confirmed3) {
              this.resetAllData();
            }
          }, 100);
        },

        // 打开重置确认弹窗（先关闭其他弹窗）
        openResetConfirm() {
          this.handleResetClick();
        },

        // 关闭重置确认弹窗（已废弃，改用原生 confirm）
        closeResetConfirm(event) {
          // 直接设置为 false（虽然不再使用自定义弹窗，但保留方法以防万一）
          this.showResetConfirm = false;
          this.$forceUpdate();
        },

        // 恢复出厂设置 - 重置所有数据
        resetAllData() {
          // 清空所有 localStorage 数据
          localStorage.clear();
          
          // 刷新页面
          location.reload();
        },

        // 数据归档功能
        archiveOldData() {
          const now = new Date();
          const threeMonthsAgo = new Date(now);
          threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
          const cutoffDate = this.toLocalDateKey(threeMonthsAgo);
          
          // 收集需要归档的数据
          const archive = {
            version: '1.0',
            archiveDate: now.toISOString(),
            cutoffDate: cutoffDate,
            tasks: [],
            memoryItems: [],
            memorySchedule: [],
            stats: {
              totalTasks: 0,
              totalMemoryItems: 0,
              totalScheduleItems: 0
            }
          };

          // 归档任务数据
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const archivedTasks = {};
              
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // 只归档已完成的任务
                    const completedTasks = tasks.filter(t => {
                      if (!t.done) return false;
                      // 如果有completedAt，使用它；否则使用dayKey作为日期
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate < cutoffDate;
                    });
                    
                    if (completedTasks.length > 0) {
                      archivedTasks[dayKey] = completedTasks;
                      archive.stats.totalTasks += completedTasks.length;
                    }
                  }
                }
              });
              
              archive.tasks = archivedTasks;
            } catch (e) {
              console.error('归档任务数据时出错:', e);
            }
          }

          // 归档记忆项和复习计划
          const memoryList = [...this.memoryList];
          const memorySchedule = [...this.memorySchedule];
          
          // 找出3个月前的记忆项（已完成所有复习的）
          const oldMemoryItems = memoryList.filter(m => {
            const learnDate = this.toLocalDateKey(new Date(m.createdAt));
            if (learnDate >= cutoffDate) return false;
            
            // 检查是否所有复习都已完成
            const relatedSchedules = memorySchedule.filter(s => s.baseId === m.id);
            if (relatedSchedules.length === 0) return false;
            
            // 检查所有复习是否都在3个月前且已完成
            const allOldAndDone = relatedSchedules.every(s => {
              const scheduleDate = this.toLocalDateKey(new Date(s.dayKey));
              return scheduleDate < cutoffDate && s.done;
            });
            
            return allOldAndDone;
          });

          oldMemoryItems.forEach(item => {
            archive.memoryItems.push(item);
            archive.stats.totalMemoryItems++;
            
            // 收集相关的复习计划
            const relatedSchedules = memorySchedule.filter(s => s.baseId === item.id);
            relatedSchedules.forEach(schedule => {
              archive.memorySchedule.push(schedule);
              archive.stats.totalScheduleItems++;
            });
          });

          // 检查是否有数据需要归档
          if (archive.stats.totalTasks === 0 && archive.stats.totalMemoryItems === 0) {
            alert('没有找到需要归档的数据（3个月前的已完成任务和已结束复习的记忆条目）。');
            return;
          }

          // 生成文件名
          const year = now.getFullYear();
          const quarter = Math.floor(now.getMonth() / 3) + 1;
          const prevQuarter = quarter === 1 ? 4 : quarter - 1;
          const prevYear = quarter === 1 ? year - 1 : year;
          const filename = `backup_${prevYear}_Q${prevQuarter}.json`;

          // 下载归档文件
          const dataStr = JSON.stringify(archive, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          // 询问是否删除旧数据
          setTimeout(() => {
            const confirmDelete = confirm(
              `归档完成！\n\n` +
              `已归档数据：\n` +
              `- 已完成任务：${archive.stats.totalTasks} 个\n` +
              `- 记忆条目：${archive.stats.totalMemoryItems} 个\n` +
              `- 复习计划：${archive.stats.totalScheduleItems} 个\n\n` +
              `文件已保存为：${filename}\n\n` +
              `是否从 App 中删除这些旧数据以释放空间？`
            );

            if (confirmDelete) {
              this.deleteArchivedData(archive, cutoffDate);
            }
          }, 500);
        },

        // 删除已归档的数据
        deleteArchivedData(archive, cutoffDate) {
          // 删除任务数据
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // 只删除已完成的任务
                    const remainingTasks = tasks.filter(t => {
                      if (!t.done) return true;
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate >= cutoffDate;
                    });
                    
                    if (remainingTasks.length === 0) {
                      delete byDay[dayKey];
                    } else {
                      byDay[dayKey] = remainingTasks;
                    }
                  }
                }
              });
              
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            } catch (e) {
              console.error('删除任务数据时出错:', e);
            }
          }

          // 删除记忆项和复习计划
          const archivedIds = archive.memoryItems.map(m => m.id);
          this.memoryList = this.memoryList.filter(m => !archivedIds.includes(m.id));
          this.memorySchedule = this.memorySchedule.filter(s => !archivedIds.includes(s.baseId));
          
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));

          alert('旧数据已成功删除，存储空间已释放！');
          
          // 刷新当前任务列表
          this.loadTodayTasks();
        },

        // 导入历史归档
        importArchive() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const archive = JSON.parse(event.target.result);
                
                if (!archive.version || !archive.archiveDate) {
                  alert('这不是一个有效的归档文件。');
                  return;
                }

                // 显示归档信息
                const info = `归档信息：\n` +
                  `- 归档日期：${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
                  `- 截止日期：${archive.cutoffDate}\n` +
                  `- 已完成任务：${archive.stats.totalTasks} 个\n` +
                  `- 记忆条目：${archive.stats.totalMemoryItems} 个\n` +
                  `- 复习计划：${archive.stats.totalScheduleItems} 个\n\n` +
                  `是否导入查看这些历史数据？\n（导入后可以查看，但不会覆盖当前数据）`;

                if (confirm(info)) {
                  this.viewArchive(archive);
                }
              } catch (e) {
                alert('读取归档文件失败：' + e.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        },

        // 查看归档数据
        viewArchive(archive) {
          // 创建查看归档的弹窗
          const archiveInfo = `📦 历史归档数据\n\n` +
            `归档日期：${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
            `截止日期：${archive.cutoffDate}\n\n` +
            `数据统计：\n` +
            `- 已完成任务：${archive.stats.totalTasks} 个\n` +
            `- 记忆条目：${archive.stats.totalMemoryItems} 个\n` +
            `- 复习计划：${archive.stats.totalScheduleItems} 个\n\n` +
            `详细数据已显示在下方，您可以查看或导出。`;

          // 显示归档数据（可以扩展为更详细的视图）
          const dataStr = JSON.stringify(archive, null, 2);
          const newWindow = window.open('', '_blank');
          if (newWindow) {
            newWindow.document.write(`
              <html>
                <head>
                  <title>历史归档数据 - ${archive.cutoffDate}</title>
                  <style>
                    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                    pre { background: white; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    h1 { color: #333; }
                  </style>
                </head>
                <body>
                  <h1>📦 历史归档数据</h1>
                  <p><strong>归档日期：</strong>${new Date(archive.archiveDate).toLocaleString('zh-CN')}</p>
                  <p><strong>截止日期：</strong>${archive.cutoffDate}</p>
                  <h2>数据详情：</h2>
                  <pre>${dataStr}</pre>
                </body>
              </html>
            `);
          } else {
            alert(archiveInfo + '\n\n详细数据：\n' + dataStr.substring(0, 500) + '...');
          }
        },

        // 复习计划视图辅助
        groupedSchedule() {
          const groups = {};
          this.memorySchedule
            .slice()
            .sort((a, b) => a.dayKey.localeCompare(b.dayKey))
            .forEach(item => {
              if (!groups[item.dayKey]) groups[item.dayKey] = [];
              groups[item.dayKey].push(item);
            });
          return groups;
        },

        formatDate(iso) {
          const d = new Date(iso);
          if (Number.isNaN(d.getTime())) return iso;
          return `${d.getMonth() + 1}月${d.getDate()}日`;
        },

        // 统一生成本地日期 key（避免 UTC 偏移导致日期错乱）
        toLocalDateKey(date) {
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          return `${y}-${m}-${d}`;
        },

        // 保留 UTC key 用于兼容旧数据
        toUTCDateKey(date) {
          return date.toISOString().slice(0, 10);
        },

        // 将 date input 的 YYYY-MM-DD 转为本地时间（避免 UTC 解析偏移）
        parseDateInputToLocalDate(dateStr) {
          const [y, m, d] = dateStr.split('-').map(Number);
          if (!y || !m || !d) return new Date();
          return new Date(y, m - 1, d, 12, 0, 0);
        },

        // 批量导入起始日期：未选月份则从今天开始；选中月份则从该月开始（当前月从今天开始）
        getBatchImportDateRange() {
          const today = new Date();
          const minDateKey = this.toLocalDateKey(today);
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            alert('请选择起始日期和结束日期');
            return null;
          }
          if (this.batchImportStartDate < minDateKey) {
            alert('起始日期不能早于今天');
            return null;
          }
          if (this.batchImportEndDate < this.batchImportStartDate) {
            alert('结束日期不能早于起始日期');
            return null;
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          return { start, end };
        },

        // 鼓励语
        startEncourageAutoPlay() {
          if (!this.encourageAutoPlay || this.encourageTimer) return;
          this.encourageTimer = setInterval(() => {
            if (!this.encourageAutoPlay || this.currentPage !== 0) return;
            this.nextEncourage();
          }, 3500);
        },
        stopEncourageAutoPlay() {
          if (!this.encourageTimer) return;
          clearInterval(this.encourageTimer);
          this.encourageTimer = null;
        },
        nextEncourage() {
          if (!Array.isArray(this.quotes) || this.quotes.length === 0) return;
          let idx = Math.floor(Math.random() * this.quotes.length);
          if (this.quotes.length > 1 && this.currentQuote === this.quotes[idx]) {
            idx = (idx + 1) % this.quotes.length;
          }
          this.currentQuote = this.quotes[idx];
          this.encourageAnimKey += 1;
        },
        refreshQuote() {
          this.nextEncourage();
        },

        // 语音录制
        async toggleRecording() {
          if (this.isRecording) {
            if (this.mediaRecorder) {
              this.mediaRecorder.stop();
            }
            this.isRecording = false;
            return;
          }
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.recordingStream = stream;
            this.recordedChunks = [];
            const mr = new MediaRecorder(stream);
            this.mediaRecorder = mr;
            mr.ondataavailable = (e) => {
              if (e.data.size > 0) {
                this.recordedChunks.push(e.data);
              }
            };
            mr.onstop = () => {
              const blob = new Blob(this.recordedChunks, { type: 'audio/webm' });
              if (this.audioUrl) {
                URL.revokeObjectURL(this.audioUrl);
              }
              this.audioUrl = URL.createObjectURL(blob);
              if (this.recordingStream) {
                this.recordingStream.getTracks().forEach(t => t.stop());
                this.recordingStream = null;
              }
              // 简化处理：录音只在当前设备本次会话有效，不写入 localStorage
            };
            mr.start();
            this.isRecording = true;
          } catch (err) {
            alert('录音权限被拒绝，无法使用语音鼓励功能。');
          }
        },
        playAudio() {
          if (!this.audioUrl) return;
          const audio = new Audio(this.audioUrl);
          audio.play();
        },

        // 表扬信
        openMonthlyReport() {
          // 标记为用户主动打开
          this._userInitiatedMonthlyReport = true;
          // 统计本月完成任务数量
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          let done = 0;
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const now = new Date();
              const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
              Object.entries(byDay).forEach(([key, list]) => {
                if (key.startsWith(ym) && Array.isArray(list)) {
                  list.forEach(t => {
                    if (t && t.done) done += 1;
                  });
                }
              });
            } catch (e) {
              done = 0;
            }
          }
          this.monthlyStats.doneTasks = done;
          this.showMonthlyReport = true;
        },
        closeMonthlyReport(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMonthlyReport = false;
          this.showMonthlyReport = false;
          // 立即强制更新
          this.$forceUpdate();
          // 再次确保关闭（防止异步问题）
          this.$nextTick(() => {
            this.showMonthlyReport = false;
            this.$forceUpdate();
          });
        },
        printReport() {
          window.print();
        },

        getRecentDayKeys(days) {
          const result = [];
          for (let i = days - 1; i >= 0; i -= 1) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            result.push(this.toLocalDateKey(date));
          }
          return result;
        },
        getCurrentWeekDayKeys() {
          const today = new Date();
          const day = today.getDay();
          const diffToMonday = day === 0 ? -6 : 1 - day;
          const monday = new Date(today);
          monday.setDate(today.getDate() + diffToMonday);
          const keys = [];
          for (let i = 0; i < 7; i += 1) {
            const date = new Date(monday);
            date.setDate(monday.getDate() + i);
            keys.push(this.toLocalDateKey(date));
          }
          return keys;
        },
        getShortDayLabel(dayKey) {
          const [y, m, d] = dayKey.split('-').map(Number);
          if (!y || !m || !d) return dayKey;
          return `${m}/${d}`;
        },
        getSeniorSummaryByDay(dayKey) {
          const dayTasks = Array.isArray(this.seniorStatsSource.tasksByDay[dayKey])
            ? this.seniorStatsSource.tasksByDay[dayKey]
            : [];
          const completedCount = dayTasks.filter(task => task && task.done).length;
          const totalCount = dayTasks.length;
          const focusMinutes = dayTasks.reduce((sum, task) => {
            if (task && task.done && task.startTime && task.endTime) {
              return sum + this.calculateTimeDiff(task.startTime, task.endTime);
            }
            return sum;
          }, 0);

          const reviewItems = Array.isArray(this.seniorStatsSource.scheduleByDay[dayKey])
            ? this.seniorStatsSource.scheduleByDay[dayKey]
            : [];
          const reviewDoneCount = reviewItems.filter(item => !!item.done).length;
          const reviewTotalCount = reviewItems.length;

          const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
          const reviewRate = reviewTotalCount > 0 ? Math.round((reviewDoneCount / reviewTotalCount) * 100) : 0;

          // XP 历史未单独记录时，采用“完成任务数 * 10”的回退估算，不改现有 XP 结算逻辑。
          const xpGained = completedCount * 10;

          return {
            completedCount,
            totalCount,
            completionRate,
            focusMinutes,
            reviewDoneCount,
            reviewTotalCount,
            reviewRate,
            xpGained
          };
        },
        getSeniorRangeSummary(dayKeys) {
          const summary = {
            completedCount: 0,
            totalCount: 0,
            focusMinutes: 0,
            reviewDoneCount: 0,
            reviewTotalCount: 0,
            xpGained: 0,
            completionRate: 0,
            reviewRate: 0
          };
          dayKeys.forEach(dayKey => {
            const day = this.getSeniorSummaryByDay(dayKey);
            summary.completedCount += day.completedCount;
            summary.totalCount += day.totalCount;
            summary.focusMinutes += day.focusMinutes;
            summary.reviewDoneCount += day.reviewDoneCount;
            summary.reviewTotalCount += day.reviewTotalCount;
            summary.xpGained += day.xpGained;
          });
          summary.completionRate = summary.totalCount > 0
            ? Math.round((summary.completedCount / summary.totalCount) * 100)
            : 0;
          summary.reviewRate = summary.reviewTotalCount > 0
            ? Math.round((summary.reviewDoneCount / summary.reviewTotalCount) * 100)
            : 0;
          return summary;
        },
        getSeniorWeekStreak(weekDayKeys) {
          const todayKey = this.todayKey;
          const todayIndex = weekDayKeys.indexOf(todayKey);
          if (todayIndex < 0) return 0;
          let streak = 0;
          for (let i = todayIndex; i >= 0; i -= 1) {
            const daySummary = this.getSeniorSummaryByDay(weekDayKeys[i]);
            if (daySummary.completedCount >= 1) {
              streak += 1;
            } else {
              break;
            }
          }
          return streak;
        },

        // 统计功能：计算时间差（分钟）
        calculateTimeDiff(startTime, endTime) {
          if (!startTime || !endTime) return 0;
          const [sh, sm] = startTime.split(':').map(Number);
          const [eh, em] = endTime.split(':').map(Number);
          const start = sh * 60 + sm;
          const end = eh * 60 + em;
          return Math.max(0, end - start);
        },

        // 格式化时长为可读字符串
        formatDuration(minutes) {
          if (minutes < 60) {
            return `${minutes} 分钟`;
          }
          const h = Math.floor(minutes / 60);
          const m = minutes % 60;
          return m > 0 ? `${h} 小时 ${m} 分钟` : `${h} 小时`;
        },

        // 根据主题应用全局 CSS 变量与背景
        applyBodyTheme() {
          const appEl = document.getElementById('app');
          const root = document.documentElement;
          const source = appEl ? getComputedStyle(appEl) : getComputedStyle(root);
          const vars = ['--theme-bg', '--theme-border', '--theme-tint', '--primary-start', '--primary-end', '--accent-start', '--accent-end', '--warm-start', '--warm-end'];
          vars.forEach(v => {
            const val = source.getPropertyValue(v).trim();
            if (val) root.style.setProperty(v, val);
          });
          const themeBg = root.style.getPropertyValue('--theme-bg').trim();
          if (themeBg) {
            document.body.style.backgroundImage = themeBg;
            document.body.style.backgroundColor = '#ffffff';
            document.body.style.backgroundRepeat = 'no-repeat';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundBlendMode = 'soft-light';
            document.body.style.transition = 'background-image 0.4s ease, background-color 0.4s ease';
          }
        },

        updateBodyMode() {
          if ((this.activeProfile.age || 8) >= 10) {
            document.body.classList.add('mature-mode');
          } else {
            document.body.classList.remove('mature-mode');
          }
        },

        // 档案与授权
        getStorageKey(base) {
          return `kldx_${this.activeProfileId}_${base}`;
        },
        loadProfiles() {
          const raw = localStorage.getItem('kldx_profiles');
          if (raw) {
            try {
              this.profiles = JSON.parse(raw);
            } catch (e) {
              this.profiles = [];
            }
          }
          if (!this.profiles.length) {
            this.profiles = [{ id: this.uuid(), name: '孩子1', age: 8 }];
          }
          const active = localStorage.getItem('kldx_active_profile');
          this.activeProfileId = active || this.profiles[0].id;
          this.parentPinSet = !!localStorage.getItem('kldx_parent_pin');
          this.migrateOldDataIfNeeded();
          this.saveProfiles();
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
        },
        saveProfiles() {
          localStorage.setItem('kldx_profiles', JSON.stringify(this.profiles));
          localStorage.setItem('kldx_active_profile', this.activeProfileId);
        },
        setActiveProfile(id) {
          this.activeProfileId = id;
          this.saveProfiles();
          this.loadTodayTasks();
          this.loadJuniorStickers();
          this.loadTemplates();
          this.loadMemoryData();
          this.loadThemeAndXp();
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
          this.seniorStatsTick += 1;
        },
        addProfile() {
          if (!this.requireParentIfNeeded()) return;
          if (!this.newProfileName.trim()) return;
          const age = this.normalizeAge(this.newProfileAge);
          this.profiles.push({ id: this.uuid(), name: this.newProfileName.trim(), age });
          this.newProfileName = '';
          this.newProfileAge = 8;
          this.saveProfiles();
          this.setActiveProfile(this.profiles[this.profiles.length - 1].id);
        },
        removeProfile(id) {
          if (!this.requireParentIfNeeded()) return;
          if (this.profiles.length <= 1) {
            alert('至少保留一个档案');
            return;
          }
          if (!confirm('确定要删除这个孩子档案吗？')) return;
          this.profiles = this.profiles.filter(p => p.id !== id);
          if (this.activeProfileId === id) {
            this.activeProfileId = this.profiles[0].id;
          }
          this.saveProfiles();
          this.setActiveProfile(this.activeProfileId);
        },
        openSettings() {
          if (!this.requireParentIfNeeded(true)) return;
          this.showSettings = true;
          this.settingsSection = 'home';
        },
        closeSettings() {
          this.showSettings = false;
          this.settingsSection = 'home';
        },
        handleInstall() {
          if (!this.deferredPrompt) return;
          this.deferredPrompt.prompt();
          this.deferredPrompt.userChoice.then(() => {
            this.deferredPrompt = null;
            this.showInstall = false;
          });
        },
        requireParentIfNeeded(forSettings) {
          const age = this.activeProfile.age || 8;
          const pin = localStorage.getItem('kldx_parent_pin');
          this.parentPinSet = !!pin;
          if (!pin) {
            const setNow = confirm('尚未设置家长 PIN，是否现在设置？');
            if (setNow) this.setParentPin();
            return false;
          }
          if (this.isParentUnlocked) return true;
          const input = prompt('请输入 6 位家长 PIN');
          if (input && input === pin) {
            this.isParentUnlocked = true;
            return true;
          }
          alert('需要家长授权');
          return false;
        },
        setParentPin() {
          const pin = prompt('设置 6 位家长 PIN');
          if (!pin || !/^\d{6}$/.test(pin)) {
            alert('PIN 必须是 6 位数字');
            return;
          }
          localStorage.setItem('kldx_parent_pin', pin);
          this.parentPinSet = true;
          this.isParentUnlocked = true;
          alert('PIN 设置成功');
        },
        resetParentPin() {
          if (!confirm('重置 PIN 会清空家长授权记录，确定继续？')) return;
          localStorage.removeItem('kldx_parent_pin');
          this.parentPinSet = false;
          this.isParentUnlocked = false;
          alert('PIN 已重置');
        },
        migrateOldDataIfNeeded() {
          if (localStorage.getItem('kldx_migrated')) return;
          const pid = this.activeProfileId;
          const map = [
            'tasks_by_day', 'templates', 'xp', 'theme',
            'memory_list', 'memory_schedule'
          ];
          map.forEach(key => {
            const oldKey = `kldx_${key}`;
            const val = localStorage.getItem(oldKey);
            if (val !== null) {
              localStorage.setItem(`kldx_${pid}_${key}`, val);
            }
          });
          localStorage.setItem('kldx_migrated', 'true');
        },

        loadMemoryData() {
          const rawList = localStorage.getItem(this.getStorageKey('memory_list'));
          if (rawList) {
            try {
              const parsed = JSON.parse(rawList);
              this.memoryList = parsed.map(item => {
                if (!item.category) {
                  const title = item.title || '';
                  const content = item.content || '';
                  if (title.includes('《') || content.includes('诗') || content.includes('词')) {
                    item.category = 'poetry';
                  } else if (/[a-zA-Z]/.test(title) || /[a-zA-Z]/.test(content)) {
                    item.category = 'english';
                  } else {
                    item.category = 'science';
                  }
                }
                return item;
              });
            } catch (e) {
              this.memoryList = [];
            }
          } else {
            this.memoryList = [];
          }
          const rawSchedule = localStorage.getItem(this.getStorageKey('memory_schedule'));
          if (rawSchedule) {
            try {
              this.memorySchedule = JSON.parse(rawSchedule);
            } catch (e) {
              this.memorySchedule = [];
            }
          } else {
            this.memorySchedule = [];
          }
        },
        loadThemeAndXp() {
          const theme = localStorage.getItem(this.getStorageKey('theme'));
          const allowedThemes = this.themeOptions.map(opt => opt.value);
          if (theme && allowedThemes.includes(theme)) {
            this.theme = theme;
          } else {
            this.theme = 'forest';
            localStorage.setItem(this.getStorageKey('theme'), 'forest');
          }
          const storedXp = localStorage.getItem(this.getStorageKey('xp'));
          if (storedXp) this.xp = parseInt(storedXp, 10) || 0;
          this.applyBodyTheme();
        },

        // 工具
        uuid() {
          return 'xxxx-4xxx-yxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }
      },
      created() {
        // 在 created 钩子中设置初始值（比 mounted 更早）
        // 确保用户标记也为 false
        this.showResetConfirm = false;
        this.showMemoryManager = false;
        this.showAddTodayModal = false;
        this.showTemplateManager = false;
        this.showCoverPhotoManager = false;
        this.showMonthlyReport = false;
        this._userInitiatedMemoryManager = false;
        this._userInitiatedMonthlyReport = false;
        this.loadCoverPhotoSlots();
      },
      mounted() {
        try {
        const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
        this.encourageReducedMotion = !!(motionQuery && motionQuery.matches);
        if (this.encourageReducedMotion) {
          this.encourageAutoPlay = false;
          this.stopEncourageAutoPlay();
        } else {
          this.encourageAutoPlay = true;
          this.startEncourageAutoPlay();
        }
        // 强制清除可能存在的 localStorage 弹窗状态
        localStorage.removeItem('kldx_showMemoryManager');
        localStorage.removeItem('kldx_showMonthlyReport');
        
        // 确保所有弹窗初始状态为关闭（必须在最前面，防止其他代码打开弹窗）
        // 使用 Object.assign 强制设置所有弹窗为 false
        // 同时确保用户标记也为 false（必须在 watch 之前设置）
        Object.assign(this, {
          showResetConfirm: false,
          showMemoryManager: false,
          showAddTodayModal: false,
          showTemplateManager: false,
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false,
          _userInitiatedMonthlyReport: false
        });
        
        // 添加 watch 监听器，一旦检测到弹窗被打开，立即强制关闭
        // 使用 immediate: true 立即检查当前值
        this.$watch('showMemoryManager', (newVal, oldVal) => {
          // 强制关闭：如果为 true 且不是用户主动打开，立即关闭
          if (newVal === true) {
            if (!this._userInitiatedMemoryManager) {
              console.warn('⚠️ [watch] 检测到 showMemoryManager 被意外设置为 true，立即强制关闭');
              // 立即同步关闭
              this.showMemoryManager = false;
              this._userInitiatedMemoryManager = false;
              // 强制更新视图
              this.$forceUpdate();
              // 再次确保（延迟一点）
              setTimeout(() => {
                this.showMemoryManager = false;
                this._userInitiatedMemoryManager = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        this.$watch('showMonthlyReport', (newVal, oldVal) => {
          // 强制关闭：如果为 true 且不是用户主动打开，立即关闭
          if (newVal === true) {
            if (!this._userInitiatedMonthlyReport) {
              console.warn('⚠️ [watch] 检测到 showMonthlyReport 被意外设置为 true，立即强制关闭');
              // 立即同步关闭
              this.showMonthlyReport = false;
              this._userInitiatedMonthlyReport = false;
              // 强制更新视图
              this.$forceUpdate();
              // 再次确保（延迟一点）
              setTimeout(() => {
                this.showMonthlyReport = false;
                this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        // 立即强制更新视图，确保弹窗不会显示
        this.$forceUpdate();
        
        // 使用 nextTick 再次确保
        this.$nextTick(() => {
          Object.assign(this, {
            showResetConfirm: false,
            showMemoryManager: false,
            showAddTodayModal: false,
            showTemplateManager: false,
            showMonthlyReport: false
          });
          this.$forceUpdate();
        });
        
        // 初始化档案与数据
        this.initDebugMode();
        this.loadProfiles();
        this.loadJuniorStickers();
        this.loadThemeAndXp();
        this.loadMemoryData();
        if (this.applyBodyTheme) {
          this.applyBodyTheme();
        }
        this.updateBodyMode();

          // 初始化周视图
          const today = new Date();
          const day = today.getDay();
          const diff = today.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(today.setDate(diff));
          this.currentWeekStart = new Date(monday);

        // 载入模板列表
        if (this.loadTemplates) {
          this.loadTemplates();
        }

        // 载入今日任务 & 初始鼓励语
          if (this.loadTodayTasks) {
        this.loadTodayTasks();
          }
        if (this.refreshQuote) {
          this.refreshQuote();
        }

        // PWA 安装提示
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          this.deferredPrompt = e;
          this.showInstall = true;
        });
        window.addEventListener('appinstalled', () => {
          this.showInstall = false;
          this.deferredPrompt = null;
        });
        // iOS 安装提示（Safari）
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isIos && !isStandalone) {
          this.showIosInstallHint = true;
        }

        // 监听任务变化，自动保存（保险）
        this.$watch('tasks', () => {
          this.seniorStatsTick += 1;
          if (this.saveTodayTasks) {
            this.saveTodayTasks();
          }
        }, { deep: true });

        // 监听分类切换，清除缓存
        this.$watch('memoryCategory', () => {
          this.reviewStatusCache = {};
        });
        
        // 监听记忆数据变化，清除缓存，确保内容更新
        this.$watch('memoryList', () => {
          this.reviewStatusCache = {};
        }, { deep: true });
        this.$watch('memorySchedule', () => {
          this.reviewStatusCache = {};
          this.seniorStatsTick += 1;
        }, { deep: true });
          
          // 最后再次确保所有弹窗关闭（防止异步操作打开弹窗）
          // 使用多个延迟确保覆盖所有可能的异步操作
          [50, 100, 200, 500, 1000, 2000].forEach(delay => {
            setTimeout(() => {
              const shouldForceCloseMemory = this.showMemoryManager && !this._userInitiatedMemoryManager;
              const shouldForceCloseReport = this.showMonthlyReport && !this._userInitiatedMonthlyReport;
              if (shouldForceCloseMemory || shouldForceCloseReport) {
                console.log('⚠️ 检测到弹窗自动打开，强制关闭。延迟:', delay);
                this.showResetConfirm = false;
                if (shouldForceCloseMemory) this.showMemoryManager = false;
                this.showAddTodayModal = false;
                this.showTemplateManager = false;
                if (shouldForceCloseReport) this.showMonthlyReport = false;
                // 同时清除用户标记
                if (shouldForceCloseMemory) this._userInitiatedMemoryManager = false;
                if (shouldForceCloseReport) this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }
            }, delay);
          });
        } catch (error) {
          console.error('初始化时出错:', error);
        }
      },
      beforeUnmount() {
        this.stopEncourageAutoPlay();
      }
    }).mount('#app');
      } catch (error) {
        console.error('创建 Vue 应用时出错:', error);
        document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>错误：无法创建 Vue 应用</h1><p>' + error.message + '</p></div>';
      }
    }
  </script>
  <!-- Service Worker Registration -->
  <script>
    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(`sw.js?v=20260221-2355`)
          .then((registration) => {
            console.log('✅ Service Worker 注册成功:', registration.scope);
            
            // 检查更新
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // 新版本可用，提示用户刷新
                  if (confirm('发现新版本，是否立即刷新？')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.log('❌ Service Worker 注册失败:', error);
          });
        
        // 监听 Service Worker 更新
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('🔄 Service Worker 已更新');
        });
      });
    } else {
      console.log('⚠️ 浏览器不支持 Service Worker');
    }
  </script>
</body>
</html>
