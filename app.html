<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Âø´‰πêÂ≠¶‰π†Â§ßÂÜíÈô©</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="ÊØèÂ§©‰∏ÄÁÇπÁÇπÔºåÂùöÊåÅÂ∞±ÂæàÊ£íÔºÅÂ≠¶‰π†ÊâìÂç°Â∫îÁî®">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Âø´‰πêÂ≠¶‰π†Â§ßÂÜíÈô©">
  <meta name="apple-touch-fullscreen" content="yes">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Apple Touch Icons (iOS) -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png">
  <link rel="mask-icon" href="app-icon.svg" color="#4f46e5">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink-900: #0f172a;
      --ink-700: #1f2937;
      --glass: rgba(255, 255, 255, 0.6);
      --shadow-soft: 0 10px 24px rgba(15, 23, 42, 0.08);
      --shadow-card: 0 8px 18px rgba(15, 23, 42, 0.1);
      --border-soft: rgba(15, 23, 42, 0.18);
      --theme-bg: linear-gradient(135deg, #bff7d0 0%, #e8fff2 45%, #b7f2ad 100%);
      --theme-border: rgba(16, 185, 129, 0.65);
      --theme-tint: #d8ffe8;
      --primary-start: #10b981;
      --primary-end: #22c55e;
      --accent-start: #38bdf8;
      --accent-end: #3b82f6;
      --warm-start: #f59e0b;
      --warm-end: #f97316;
    }
    .theme-forest {
      --theme-bg: linear-gradient(135deg, #c9f7dc 0%, #ecfff4 45%, #c1f2b6 100%), radial-gradient(120px 80px at 12% 18%, rgba(34, 197, 94, 0.14), transparent 60%), radial-gradient(140px 90px at 85% 12%, rgba(16, 185, 129, 0.12), transparent 62%), radial-gradient(120px 80px at 78% 78%, rgba(34, 197, 94, 0.12), transparent 60%);
      --theme-border: rgba(16, 185, 129, 0.65);
      --theme-tint: #d8ffe8;
      --primary-start: #00A699;
      --primary-end: #00C1AE;
      --accent-start: #FF385C;
      --accent-end: #FF5A5F;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-ocean {
      --theme-bg: linear-gradient(145deg, #b5ecff 0%, #e3f7ff 45%, #9ccfff 100%), radial-gradient(140px 90px at 18% 20%, rgba(59, 130, 246, 0.14), transparent 62%), radial-gradient(160px 100px at 82% 18%, rgba(14, 165, 233, 0.12), transparent 62%), radial-gradient(140px 90px at 80% 78%, rgba(59, 130, 246, 0.12), transparent 60%);
      --theme-border: rgba(14, 165, 233, 0.65);
      --theme-tint: #d6f4ff;
      --primary-start: #007A87;
      --primary-end: #00A699;
      --accent-start: #FF385C;
      --accent-end: #FF5A5F;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-candy {
      --theme-bg: linear-gradient(135deg, #ffd9ea 0%, #fff1c8 45%, #d7e9ff 100%), radial-gradient(140px 90px at 16% 18%, rgba(244, 114, 182, 0.16), transparent 62%), radial-gradient(160px 100px at 82% 16%, rgba(59, 130, 246, 0.12), transparent 62%), radial-gradient(140px 90px at 78% 78%, rgba(251, 191, 36, 0.12), transparent 62%);
      --theme-border: rgba(255, 56, 92, 0.7);
      --theme-tint: #ffe4ef;
      --primary-start: #FF385C;
      --primary-end: #FF5A5F;
      --accent-start: #00A699;
      --accent-end: #00C1AE;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    .theme-buddy {
      --theme-bg: linear-gradient(145deg, #bedaff 0%, #e7f1ff 45%, #9cc1ff 100%), radial-gradient(150px 100px at 22% 20%, rgba(59, 130, 246, 0.16), transparent 62%), radial-gradient(170px 110px at 78% 18%, rgba(14, 165, 233, 0.14), transparent 62%), radial-gradient(150px 100px at 72% 78%, rgba(59, 130, 246, 0.12), transparent 60%);
      --theme-border: rgba(59, 130, 246, 0.7);
      --theme-tint: #dbeafe;
      --primary-start: #3B82F6;
      --primary-end: #60A5FA;
      --accent-start: #06B6D4;
      --accent-end: #22D3EE;
      --warm-start: #FF8A3D;
      --warm-end: #FFB457;
    }
    :root {
      --ui-radius-lg: 20px;
      --ui-radius-md: 14px;
      --ui-sat: 1;
      --ui-motion-scale: 1;
      --header-compact: 108px;
      --header-compact-gap: 6px;
      --segmented-height: 38px;
      --accent: #14b8a6;
      --accent-2: #2dd4bf;
      --accent-soft: #ecfeff;
      --shadow-soft: 0 6px 16px rgba(20, 184, 166, 0.22);
      --border-soft: rgba(20, 184, 166, 0.28);
      --task-border-soft: rgba(148, 163, 184, 0.18);
      --task-shadow-soft: 0 2px 8px rgba(15, 23, 42, 0.04);
    }
    .age-junior {
      --ui-radius-lg: 24px;
      --ui-radius-md: 16px;
      --ui-sat: 1.05;
      --ui-motion-scale: 1;
      --header-compact: 114px;
      --accent: #22c7b8;
      --accent-2: #5eead4;
      --accent-soft: #ecfffb;
      --shadow-soft: 0 8px 18px rgba(45, 212, 191, 0.24);
      --border-soft: rgba(45, 212, 191, 0.3);
    }
    .age-senior {
      --ui-radius-lg: 16px;
      --ui-radius-md: 12px;
      --ui-sat: 0.92;
      --ui-motion-scale: 0.7;
      --header-compact: 104px;
      --accent: #0f766e;
      --accent-2: #2a9d8f;
      --accent-soft: #f0fdfa;
      --shadow-soft: 0 5px 12px rgba(15, 118, 110, 0.16);
      --border-soft: rgba(15, 118, 110, 0.24);
    }

    body {
      font-family: "PingFang SC", "SF Pro Text", "SF Pro Display", "Noto Sans SC", sans-serif;
      font-size: 15px;
      letter-spacing: 0.2px;
      background-color: #f8fafc;
      color: var(--ink-900);
      padding-bottom: env(safe-area-inset-bottom);
    }

    body::before {
      content: none;
    }

    @media (max-width: 640px) {
      body {
        font-size: 16px;
        letter-spacing: 0.25px;
      }
      .text-xs {
        font-size: 12px;
      }
      .text-sm {
        font-size: 14px;
      }
      .app-header {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: var(--header-compact-gap);
      }
      .app-title {
        font-size: 18px;
        white-space: nowrap;
        width: auto;
      }
      .app-header > div:first-child {
        width: auto;
      }
      .header-right {
        align-items: center;
        width: auto;
        gap: 6px;
      }
      .profile-row {
        width: auto;
        justify-content: space-between;
      }
      .settings-modal {
        width: 92%;
        max-width: 92%;
        max-height: 85vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .settings-modal .pin-actions {
        flex-direction: column;
      }
      .settings-modal .pin-actions button {
        width: 100%;
        font-size: 14px;
        padding: 10px 14px;
      }
      .settings-modal .profile-item {
        flex-direction: column;
        align-items: stretch;
      }
      .settings-modal .profile-fields {
        display: grid;
        grid-template-columns: minmax(160px, 1fr) 72px;
        gap: 8px;
        align-items: center;
        max-width: 320px;
        margin: 0 auto;
      }
      .settings-modal .profile-name {
        width: 100%;
      }
      .settings-modal .profile-age {
        width: 100%;
      }
      .settings-modal .profile-actions {
        flex-direction: row;
        justify-content: space-between;
        gap: 8px;
      }
      .settings-modal .profile-actions button {
        flex: 1 1 auto;
        font-size: 12px;
        padding: 8px 10px;
      }
      .settings-modal .profile-new {
        flex-direction: column;
      }
      .settings-modal .profile-new button {
        width: 100%;
        padding: 10px 14px;
        font-size: 14px;
      }
      .settings-modal .danger-btn {
        font-size: 13px;
        padding: 8px 10px;
      }
      .settings-modal .danger-area {
        padding: 10px;
      }
      .settings-modal .danger-title {
        font-size: 12px;
      }
      .mobile-center {
        text-align: center;
      }
      .mobile-stack {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      .settings-overlay {
        align-items: flex-start;
        padding: 16px 12px 24px;
      }
      .mobile-tabs button {
        font-size: 13px;
        padding: 8px 0;
      }
      .mobile-full {
        width: 100%;
      }
      .mobile-btn {
        width: 100%;
        font-size: 14px;
        padding: 10px 14px;
      }
      .mobile-input {
        width: 100%;
        font-size: 14px;
        padding: 10px 12px;
      }
      .mobile-tabs {
        font-size: 13px;
      }
      .mobile-tabs button {
        padding: 8px 0;
      }
      .mobile-chips {
        width: 100%;
        justify-content: center;
      }
      .mobile-chips button {
        padding: 8px 12px;
        font-size: 13px;
      }
      .mobile-actions {
        flex-direction: row;
        align-items: center;
        gap: 6px;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .ios-compact-header {
        max-height: var(--header-compact);
      }
      .ios-segmented-tabs {
        top: 0;
      }
    }

    .mature-ui {
      filter: saturate(0.92);
    }
    .mature-ui .app-title {
      font-family: "Noto Sans SC", sans-serif;
      letter-spacing: 0.4px;
    }
    .mature-ui .soft-shadow {
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .mature-ui .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm,
    .mature-ui .theme-pill-active {
      filter: saturate(0.85) brightness(0.98);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm {
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.6), 0 6px 14px rgba(15,23,42,0.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .glass-btn {
      background: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.75) 0%,
        rgba(255, 255, 255, 0.35) 100%
      );
      color: #0f172a;
      border: 1px solid var(--theme-border);
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    button:not(.icon-btn) {
      border-radius: 999px;
      min-height: 40px;
      padding: 10px 16px;
      background: linear-gradient(
        145deg,
        rgba(255, 255, 255, 0.75) 0%,
        rgba(255, 255, 255, 0.35) 100%
      );
      color: #0f172a !important;
      border: 1px solid var(--theme-border) !important;
      box-shadow: none !important;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }
    button:not(.icon-btn):hover {
      filter: brightness(1.02);
    }
    button:not(.icon-btn):disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .pill-btn {
      border-radius: 999px;
      min-height: 44px;
      padding: 12px 18px;
      font-size: 15px;
    }
    .btn-compact {
      min-height: 30px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .btn-chip {
      min-height: 26px;
      padding: 4px 10px;
      font-size: 11px;
    }
    .settings-menu-btn {
      display: block;
      width: 100%;
      min-height: 56px;
      padding: 14px 16px;
    }
    body.mature-mode::before {
      opacity: 0.4;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid rgba(16, 185, 129, 0.5);
      outline-offset: 2px;
    }

    .app-title {
      font-family: "ZCOOL KuaiLe", "ZCOOL XiaoWei", serif;
      letter-spacing: 1px;
    }

    .soft-card {
      background: var(--glass);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
    }

    .soft-shadow {
      box-shadow: var(--shadow-card);
    }

    .lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .lift:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }
    .app-shell {
      background: #ffffff;
      border-radius: 0;
      filter: saturate(var(--ui-sat));
    }
    .build-debug-tag {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 10001;
      background: rgba(15, 23, 42, 0.92);
      color: #ffffff;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }
    .ios-compact-header {
      width: 100%;
      max-width: 56rem;
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: linear-gradient(180deg, #def7ea 0%, #ffffff 100%);
      border-radius: 14px;
      min-height: 104px;
      max-height: 120px;
    }
    .compact-top-actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .compact-mini-stats {
      display: none;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      background: rgba(236, 253, 245, 0.7);
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      color: #0f766e;
      white-space: nowrap;
    }
    .header-collapsed .compact-mini-stats {
      display: inline-flex;
    }
    .header-expanded .compact-mini-stats {
      display: none;
    }
    .header-collapsed .compact-progress-row,
    .header-collapsed .compact-progress-detail {
      display: none;
    }
    .btn-ghost.btn-mini {
      min-height: 24px !important;
      border-radius: 999px !important;
      padding: 3px 8px !important;
      font-size: 10px !important;
      background: rgba(255, 255, 255, 0.84) !important;
      border: 1px solid rgba(148, 163, 184, 0.35) !important;
      color: #475569 !important;
      box-shadow: none !important;
    }
    .compact-top-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .compact-profile-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-width: 0;
      font-size: 11px;
      color: #334155;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 999px;
      padding: 4px 8px;
    }
    .compact-top-row .icon-btn {
      font-size: 12px;
      color: #64748b;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.8);
    }
    .compact-progress-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-height: 34px;
      cursor: pointer;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.84);
      border-radius: 12px;
      padding: 5px 8px;
    }
    .compact-progress-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
    }
    .compact-progress-ring {
      width: 30px;
      height: 30px;
      flex-shrink: 0;
    }
    .compact-progress-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .compact-progress-text strong {
      font-size: 13px;
      color: #0f172a;
    }
    .compact-progress-text span {
      font-size: 10px;
      color: #64748b;
    }
    .compact-xp-chip {
      font-size: 10px;
      font-weight: 600;
      color: #0f766e;
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 999px;
      padding: 3px 8px;
      white-space: nowrap;
      background: rgba(236, 253, 245, 0.85);
    }
    .compact-expand-hint {
      font-size: 10px;
      color: #94a3b8;
      white-space: nowrap;
    }
    .compact-progress-detail {
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(255, 255, 255, 0.75);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 10px;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .encourage-inline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      border: 1px solid rgba(15, 23, 42, 0.1);
      background: rgba(255, 255, 255, 0.8);
      border-radius: 12px;
      padding: 6px 9px;
      margin-bottom: 6px;
    }
    .line-clamp-1 {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .encourage-inline.encourage-collapsed .quote-line {
      display: inline-block;
      max-width: 100%;
    }
    .encourage-inline.encourage-collapsed {
      min-height: 32px;
      padding-top: 3px;
      padding-bottom: 3px;
    }
    .encourage-inline.encourage-collapsed .encourage-inline-main {
      font-size: 11px;
    }
    .encourage-inline.encourage-collapsed .text-slate-500 {
      font-size: 10px;
    }
    .encourage-inline-main {
      flex: 1 1 auto;
      min-width: 0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #334155;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .encourage-inline-main .quote-line {
      color: #0f766e;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .ios-segmented-tabs {
      position: sticky;
      top: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: rgba(248, 250, 252, 0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      margin-bottom: 6px;
      min-height: var(--segmented-height);
    }
    .ios-segmented-tabs button {
      flex: 1 1 auto;
      min-height: 30px;
      padding: 5px 10px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 9px;
      border: 1px solid transparent !important;
      background: transparent !important;
      color: #64748b !important;
      box-shadow: none !important;
    }
    .ios-segmented-tabs button.segment-active {
      background: #ffffff !important;
      color: #0f172a !important;
      border-color: rgba(15, 23, 42, 0.12) !important;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08) !important;
    }
    .daily-tools-inline {
      margin-top: 8px;
      margin-bottom: 6px;
      border: 1px solid rgba(148, 163, 184, 0.26);
      background: rgba(255, 255, 255, 0.86);
      border-radius: 11px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      white-space: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .daily-tools-inline .meta {
      font-size: 11px;
      color: #64748b;
    }
    .daily-tools-inline .actions {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }
    .daily-tools-inline .actions .btn-chip {
      min-height: 24px;
      padding: 3px 8px;
      font-size: 10px;
    }
    .daily-tools-inline .actions select {
      min-height: 24px;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
    }
    .mobile-main-lift {
      padding-bottom: calc(env(safe-area-inset-bottom) + 84px);
    }
    .sticker-inline-hint {
      margin-bottom: 6px;
      border: 1px solid rgba(16, 185, 129, 0.2);
      background: rgba(236, 253, 245, 0.72);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 11px;
      color: #0f766e;
    }
    .variant-card {
      border-radius: var(--ui-radius-lg) !important;
    }
    .content-surface {
      background: #ffffff !important;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }
    .daily-main-card {
      background: #ffffff !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06) !important;
    }
    .daily-task-item {
      border-color: var(--task-border-soft) !important;
      box-shadow: var(--task-shadow-soft);
      background: rgba(255, 255, 255, 0.97) !important;
    }
    .daily-task-head {
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }
    .daily-task-title {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: 0.1px;
    }
    .daily-completion-rate {
      font-size: 14px;
      font-weight: 800;
      color: #047857;
    }
    .variant-subcard {
      border-radius: var(--ui-radius-md) !important;
    }
    .bottom-nav {
      position: sticky;
      bottom: 0;
      width: 100%;
      max-width: 56rem;
      display: flex;
      gap: 0;
      padding: 0 10px calc(env(safe-area-inset-bottom) + 10px);
      z-index: 20;
      background: rgba(255,255,255,0.98);
      border: none;
      border-radius: 0;
      box-shadow: 0 -6px 18px rgba(15, 23, 42, 0.08);
      backdrop-filter: saturate(1.1) blur(10px);
      -webkit-backdrop-filter: saturate(1.1) blur(10px);
    }
    .bottom-nav button {
      flex: 1 1 0%;
      min-height: 56px;
      font-size: 13px;
      font-weight: 500;
      border-radius: 0 !important;
      border: none !important;
      background: transparent !important;
      color: #6b7280 !important;
      box-shadow: none !important;
      position: relative;
      padding: 0 6px 8px;
    }
    .bottom-nav button.bottom-nav-active {
      font-weight: 700;
      color: #0f172a !important;
    }
    .bottom-nav button.bottom-nav-active::after {
      content: "";
      position: absolute;
      left: 20%;
      right: 20%;
      bottom: 4px;
      height: 2px;
      border-radius: 999px;
      background: #16a34a;
    }
    .age-junior .bottom-nav button {
      min-height: 56px;
      font-size: 13px;
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation: none !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    .btn-primary {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-primary:hover {
      filter: brightness(1.02);
    }

    .btn-accent {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-warm {
      background: rgba(255, 255, 255, 0.35);
      color: #0f172a;
      border: 1px solid #0f172a;
      box-shadow: none;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .btn-main {
      padding: 14px 18px;
      border-radius: 999px;
      font-size: 16px;
      letter-spacing: 0.2px;
    }
    .add-task-primary {
      background: linear-gradient(160deg, var(--accent-2) 0%, var(--accent) 100%) !important;
      color: #ffffff !important;
      border: 1px solid var(--border-soft) !important;
      box-shadow: var(--shadow-soft) !important;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.18);
      min-height: 52px !important;
      border-radius: 16px !important;
      font-weight: 700;
    }
    .add-task-primary:hover {
      filter: brightness(1.02);
      box-shadow: 0 10px 20px rgba(15, 118, 110, 0.2) !important;
    }
    @media (max-width: 430px) {
      .app-shell {
        padding-top: calc(env(safe-area-inset-top) + 1px) !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
      }
      .ios-compact-header {
        margin-bottom: 2px;
        padding: 4px 7px;
        border-radius: 10px;
      }
      .header-collapsed.ios-compact-header {
        min-height: 44px;
        max-height: 52px;
      }
      .compact-top-row {
        gap: 5px;
      }
      .compact-profile-pill {
        font-size: 9px;
        padding: 2px 6px;
      }
      .compact-top-row .icon-btn {
        padding: 1px 5px;
        font-size: 10px;
      }
      .compact-mini-stats {
        font-size: 9px;
        padding: 1px 6px;
      }
      .btn-ghost.btn-mini {
        min-height: 20px !important;
        padding: 1px 6px !important;
        font-size: 9px !important;
      }
      .header-expanded .compact-progress-row {
        min-height: 28px;
        padding: 3px 6px;
        margin-top: 2px;
      }
      .header-expanded .compact-progress-ring {
        width: 22px;
        height: 22px;
      }
      .header-expanded .compact-progress-text strong {
        font-size: 11px;
      }
      .header-expanded .compact-progress-text span {
        font-size: 9px;
      }
      .header-expanded .compact-xp-chip {
        font-size: 9px;
        padding: 2px 6px;
      }
      .header-expanded .compact-expand-hint {
        display: none;
      }
      .header-expanded .compact-progress-detail {
        padding: 5px 7px;
        font-size: 9px;
      }
      .encourage-inline {
        margin-bottom: 2px;
        border-radius: 10px;
        padding: 3px 7px;
      }
      .encourage-inline-main {
        font-size: 10px;
      }
      .ios-segmented-tabs {
        min-height: 31px;
        padding: 1px;
        margin-bottom: 2px;
      }
      .ios-segmented-tabs button {
        min-height: 26px;
        font-size: 10px;
      }
      .mobile-main-lift {
        margin-top: -12px;
        gap: 3px !important;
      }
    }

    .glow-ring {
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.12);
    }

    /* Âü∫Á°ÄÂä®Áîª & Ëá™ÂÆö‰πâÊ†∑Âºè */
    @keyframes coin-pop {
      0% {
        transform: translateY(0) scale(0.6);
        opacity: 0;
      }
      30% {
        transform: translateY(-20px) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-40px) scale(0.8);
        opacity: 0;
      }
    }
    .coin-anim {
      animation: coin-pop 0.6s ease-out forwards;
    }

    /* ‰ªªÂä°ÂÆåÊàêÊâìÂãæÁöÑÂ∞èÂä®Áîª */
    @keyframes check-bounce {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .check-anim {
      animation: check-bounce 0.25s ease-out;
    }

    @keyframes reward-pop {
      0% { transform: translateY(10px) scale(0.95); opacity: 0; }
      60% { transform: translateY(-4px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .reward-pop {
      animation: reward-pop 0.35s ease-out;
    }

    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      50% { transform: scale(1.06) rotate(4deg); filter: drop-shadow(0 0 8px rgba(59,130,246,0.6)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
    }
    .diamond-sparkle {
      animation: sparkle 2.2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .diamond-bg {
      background: linear-gradient(135deg, #60a5fa 0%, #a5f3fc 35%, #e0f2fe 65%, #93c5fd 100%);
      background-size: 200% 200%;
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes flag-wave {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(6deg); }
      100% { transform: rotate(0deg); }
    }
    .flag-wave {
      animation: flag-wave 1.6s ease-in-out infinite;
      transform-origin: left center;
    }
    @keyframes icon-float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }
    .icon-anim {
      animation: icon-float 2s ease-in-out infinite;
    }

    @keyframes fade-slide {
      0% { opacity: 0; transform: translateY(6px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .fade-slide {
      animation: fade-slide 0.25s ease-out;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(140px) rotate(260deg); opacity: 0; }
    }
    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 20;
    }
    .confetti-piece {
      position: absolute;
      width: 8px;
      height: 12px;
      border-radius: 2px;
      opacity: 0;
      animation: confetti-fall var(--dur) ease-out var(--delay) forwards;
      left: var(--x);
      background: var(--color);
    }
    .sticker-book-card {
      border: 1px solid rgba(16, 185, 129, 0.24);
      background: linear-gradient(135deg, rgba(236, 253, 245, 0.9), rgba(240, 249, 255, 0.86));
    }
    .sticker-chip {
      min-width: 72px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(255, 255, 255, 0.85);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    @keyframes sticker-chip-pop {
      0% { transform: scale(0.92); opacity: 0.7; }
      60% { transform: scale(1.06); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .sticker-chip-new {
      animation: sticker-chip-pop 0.32s ease-out;
      border-color: rgba(16, 185, 129, 0.45);
      box-shadow: 0 6px 14px rgba(16, 185, 129, 0.2);
    }
    @keyframes sticker-hint-pop {
      0% { transform: translateY(6px); opacity: 0; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .sticker-hint-pop {
      animation: sticker-hint-pop 0.24s ease-out;
    }

    .drag-handle {
      cursor: grab;
      user-select: none;
    }
    .dragging {
      opacity: 0.6;
      transform: scale(0.98);
    }

    .theme-pill-active {
      color: #0f172a;
      border-color: rgba(15, 23, 42, 0.12);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }
    .theme-accent-text { color: var(--accent-start) !important; }
    .theme-accent-bg { background: color-mix(in srgb, var(--accent-start) 22%, #ffffff 78%) !important; }
    .theme-primary-text { color: var(--primary-start) !important; }
    .theme-primary-bg { background: color-mix(in srgb, var(--primary-start) 22%, #ffffff 78%) !important; }
    .theme-warm-text { color: var(--warm-start) !important; }
    .theme-warm-bg { background: color-mix(in srgb, var(--warm-start) 22%, #ffffff 78%) !important; }
    .theme-border { border-color: var(--theme-border) !important; }
    .theme-card {
      border-color: var(--theme-border) !important;
      background: color-mix(in srgb, var(--theme-tint) 18%, #ffffff 82%) !important;
    }

    .icon-badge {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.08) 70%);
      box-shadow:
        0 6px 16px rgba(15, 23, 42, 0.16),
        inset 0 2px 4px rgba(255, 255, 255, 0.7),
        inset 0 -3px 6px rgba(0, 0, 0, 0.12);
    }
    .logo-badge {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.1) 70%);
      box-shadow:
        0 8px 18px rgba(15, 23, 42, 0.18),
        inset 0 2px 5px rgba(255, 255, 255, 0.7),
        inset 0 -3px 8px rgba(0, 0, 0, 0.14);
    }
    .icon {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    .icon-badge .icon {
      width: 32px;
      height: 32px;
    }
    .logo-badge .icon {
      width: 38px;
      height: 38px;
    }

    /* ÁÆÄÂçïÁöÑÊµÆÂ±ÇÊØõÁéªÁíÉÊïàÊûú */
    .glass {
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* ÂºπÁ™óËøáÊ∏°Âä®Áîª */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.2s ease;
    }
    .fade-enter-from, .fade-leave-to {
      opacity: 0;
    }

    /* Á°Æ‰øùÂºπÁ™óÂú®ÊúÄ‰∏äÂ±Ç */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <svg aria-hidden="true" class="hidden">
    <!-- candy: fairy tale princess -->
    <symbol id="icon-candy-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
      <path d="M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-diamond" viewBox="0 0 24 24">
      <path d="M4 9l4-5h8l4 5-8 10z"></path>
      <path d="M8 4l4 15 4-15" fill="white" opacity="0.6"></path>
      <path d="M4 9h16" fill="white" opacity="0.35"></path>
    </symbol>
    <symbol id="icon-checkered" viewBox="0 0 24 24">
      <rect x="5" y="4" width="2" height="16" rx="1"></rect>
      <rect x="8" y="6" width="10" height="10" rx="1"></rect>
      <rect x="8" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="8" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="9" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <circle cx="9.5" cy="11" r="1" fill="white"></circle>
      <circle cx="14.5" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="12" width="2.5" height="5" rx="1" fill="white"></rect>
      <rect x="11" y="9" width="2.5" height="8" rx="1" fill="white"></rect>
      <rect x="15" y="11" width="2.5" height="6" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
      <rect x="11" y="16" width="2" height="4" rx="1"></rect>
    </symbol>
    <symbol id="icon-candy-star" viewBox="0 0 24 24">
      <path d="M12 3l3.2 6.4 7.1 1-5.2 5 1.3 7.1L12 19l-6.4 3.5 1.3-7.1-5.2-5 7.1-1z"></path>
    </symbol>
    <symbol id="icon-candy-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- forest: animals -->
    <symbol id="icon-forest-book" viewBox="0 0 24 24">
      <rect x="5" y="5" width="14" height="14" rx="3"></rect>
      <circle cx="10" cy="10" r="1.5" fill="white"></circle>
      <circle cx="14" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-forest-brain" viewBox="0 0 24 24">
      <path d="M6 10a6 6 0 0 1 12 0c0 4-3 7-6 7s-6-3-6-7z"></path>
      <circle cx="9" cy="11" r="1" fill="white"></circle>
      <circle cx="15" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-3 3 2 4-4" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-forest-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-forest-star" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="7"></circle>
      <circle cx="12" cy="12" r="3" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-award" viewBox="0 0 24 24">
      <path d="M12 3l4 4-4 4-4-4z"></path>
      <rect x="8" y="11" width="8" height="8" rx="2"></rect>
    </symbol>

    <!-- storybook: classic tale -->
    <symbol id="icon-storybook-book" viewBox="0 0 24 24">
      <rect x="4" y="4" width="16" height="16" rx="3"></rect>
      <path d="M8 8h8M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M12 9l2 3-3 2" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-4 3 3 4-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-storybook-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
    </symbol>
    <symbol id="icon-storybook-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-storybook-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- ocean: sea life -->
    <symbol id="icon-ocean-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <circle cx="9" cy="12" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-ocean-brain" viewBox="0 0 24 24">
      <path d="M6 11a6 6 0 0 1 12 0c0 3-2 6-6 6s-6-3-6-6z"></path>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M6 14c2-2 4-2 6 0s4 2 6 0" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-ocean-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-ocean-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-ocean-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- space: blue robot vibe -->
    <symbol id="icon-space-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="8" width="10" height="2" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-space-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="14" cy="10" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-brain" viewBox="0 0 24 24">
      <rect x="6" y="6" width="12" height="12" rx="4"></rect>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l4-4 3 3 3-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-space-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-space-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-space-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- sunset: warm and simple -->
    <symbol id="icon-sunset-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="12" cy="11" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-sunset-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="8" y="10" width="8" height="6" rx="2" fill="white"></rect>
    </symbol>
    <symbol id="icon-sunset-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-sunset-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-sunset-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>
    <symbol id="icon-party" viewBox="0 0 24 24">
      <path d="M4 20l10-10 6 6-10 4z"></path>
      <circle cx="16" cy="6" r="2" fill="white"></circle>
      <circle cx="20" cy="8" r="1.5" fill="white"></circle>
      <circle cx="14" cy="3.5" r="1.2" fill="white"></circle>
    </symbol>
    <symbol id="icon-trophy" viewBox="0 0 24 24">
      <path d="M7 4h10v4a5 5 0 0 1-10 0z"></path>
      <path d="M7 6H4a3 3 0 0 0 3 3"></path>
      <path d="M17 6h3a3 3 0 0 1-3 3"></path>
      <rect x="10" y="13" width="4" height="3" rx="1"></rect>
      <rect x="8" y="16" width="8" height="4" rx="2"></rect>
    </symbol>
  </svg>
  <div id="app"
       :style="themeConfig.style"
       :class="[`theme-${theme}`, `age-${ageGroup}`, { 'mature-ui': isOlderKid }]"
       class="app-shell min-h-screen flex flex-col items-center py-2 px-3 sm:px-6 lg:px-10 transition-colors duration-300">

    <div v-if="showBuildTag" class="build-debug-tag">{{ buildLabel }}</div>

    <!-- È°∂ÈÉ®Ê†èÔºöiOS Á¥ßÂáë‰∏§Ë°å -->
    <header class="app-header ios-compact-header" :class="[{ 'header-collapsed': !headerExpanded, 'header-expanded': headerExpanded }]">
      <div class="compact-top-row">
        <div class="compact-profile-pill">
          <span class="inline-flex items-center justify-center logo-badge diamond-bg diamond-sparkle" style="width:22px;height:22px;">
            <svg class="icon text-sky-400" style="width:16px;height:16px;">
              <use href="#icon-diamond"></use>
            </svg>
          </span>
          <span class="truncate">{{ activeProfile.name }} ¬∑ {{ activeProfile.age }}Â≤Å</span>
        </div>
        <div class="compact-mini-stats">
          <span>{{ todayProgress.done }}/{{ todayProgress.total }}</span>
          <span>XP {{ xp }}</span>
        </div>
        <div class="compact-top-actions">
          <button type="button" class="btn-ghost btn-mini" @click.stop="toggleHeaderExpanded">{{ headerExpanded ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' }}</button>
          <button @click="openSettings" class="icon-btn" title="ËÆæÁΩÆ">‚öôÔ∏è</button>
        </div>
      </div>

      <div class="compact-progress-row" @click="toggleHeaderExpanded">
        <div class="compact-progress-main">
          <svg class="compact-progress-ring" viewBox="0 0 40 40" aria-hidden="true">
            <circle cx="20" cy="20" r="14" stroke="#dbe2ea" stroke-width="4" fill="none"></circle>
            <circle
              cx="20"
              cy="20"
              r="14"
              stroke="var(--primary-start)"
              stroke-width="4"
              fill="none"
              stroke-linecap="round"
              stroke-dasharray="88"
              :stroke-dashoffset="88 * (1 - todayProgress.percent / 100)"
              transform="rotate(-90 20 20)"></circle>
          </svg>
          <div class="compact-progress-text">
            <strong>{{ todayProgress.done }}/{{ todayProgress.total }}</strong>
            <span>‰ªäÊó•‰ªªÂä°ËøõÂ∫¶</span>
          </div>
        </div>
        <span class="compact-xp-chip">Lv.{{ levelDisplay.level }} ¬∑ XP {{ xp }}</span>
        <span class="compact-expand-hint">{{ headerExpanded ? 'Êî∂Ëµ∑' : 'Â±ïÂºÄ' }}</span>
      </div>
      <transition name="fade">
        <div v-if="headerExpanded" class="compact-progress-detail">
          <span>{{ levelDisplay.title }} ¬∑ ÂÆåÊàêÁéá {{ todayProgress.percent }}%</span>
          <span>‰∏ã‰∏ÄÈò∂ XP {{ levelDisplay.nextXp }}</span>
        </div>
      </transition>
    </header>

    <!-- ‰∏ª‰ΩìÂç°ÁâáÔºöÂìçÂ∫îÂºèÂ∏ÉÂ±ÄÔºåÊâãÊú∫Á´ñÂ±èÂçïÂàóÔºåÂπ≥ÊùøÊ®™Â±èÂèØÂπ∂Êéí -->
    <main class="mobile-main-lift w-full max-w-5xl flex-1 flex flex-col lg:flex-row gap-2 lg:gap-4">
      <!-- Â∑¶‰æßÔºöTabs + ÂÜÖÂÆπ -->
      <section class="flex-1 flex flex-col">
        <!-- ‰ªäÊó•ÈºìÂä±ÔºàÈªòËÆ§‰∏ÄË°åÔºâ -->
        <div class="encourage-inline" :class="{ 'encourage-collapsed': encourageCollapsed }">
          <button type="button" class="icon-btn encourage-inline-main" @click="encourageCollapsed = !encourageCollapsed">
            <span class="text-slate-500">‰ªäÊó•ÈºìÂä±</span>
            <span class="quote-line line-clamp-1">‚Äú{{ currentQuote }}‚Äù</span>
          </button>
          <div class="flex items-center gap-1">
            <button
              type="button"
              class="text-[10px] px-2 py-1 rounded-full glass-btn btn-chip"
              @click.stop="refreshQuote">
              Êç¢‰∏ÄÂè•
            </button>
            <button type="button" class="icon-btn text-[11px] text-slate-500 px-1" @click="encourageCollapsed = !encourageCollapsed">
              {{ encourageCollapsed ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}
            </button>
          </div>
        </div>
        <transition name="fade">
          <p v-if="!encourageCollapsed" class="text-[12px] text-emerald-700 leading-snug mb-1 px-2 theme-accent-text">
            ‚Äú{{ currentQuote }}‚Äù
          </p>
        </transition>

        <!-- Ê†áÁ≠æÈ°µ -->
        <div class="mobile-tabs ios-segmented-tabs">
          <button
            class="flex-1 transition"
            :class="activeTab === 'daily' ? 'segment-active' : ''"
            @click="activeTab = 'daily'; collapseHeader()">
            ‰ªäÊó•
          </button>
          <button
            class="flex-1 transition"
            :class="activeTab === 'memory' ? 'segment-active' : ''"
            @click="activeTab = 'memory'; collapseHeader()">
            ËÆ∞ÂøÜ
          </button>
          <button
            v-if="ageGroup === 'senior'"
            class="flex-1 transition"
            :class="activeTab === 'stats' ? 'segment-active' : ''"
            @click="activeTab = 'stats'; collapseHeader()">
            ÁªüËÆ°
          </button>
        </div>

        <!-- ÂÜÖÂÆπÂç°Áâá -->
        <div class="flex-1 glass rounded-3xl soft-shadow p-2 sm:p-3 lg:p-4 flex flex-col overflow-hidden lift variant-card content-surface"
             :class="{ 'daily-main-card': activeTab === 'daily' }">
          <!-- ‰ªäÊó•Â§ßÂÜíÈô©ÔºöÊØèÊó•ËÆ°Âàí + ÊâìÂç° -->
          <div v-if="activeTab === 'daily'" class="flex-1 flex flex-col fade-slide">
            <div class="daily-task-head relative mb-2 rounded-xl px-3 py-2 flex items-center justify-between">
              <p class="daily-task-title">‰ªäÊó•‰ªªÂä°</p>
              <span class="daily-completion-rate px-2 py-0.5 rounded-full bg-emerald-50 border border-emerald-200">
                ÂÆåÊàêÁéá {{ todayProgress.percent }}%
              </span>
              <div v-if="showConfetti" class="confetti">
                <span v-for="n in confettiPieces"
                      :key="n"
                      class="confetti-piece"
                      :style="confettiStyle(n)"></span>
              </div>
            </div>

            <!-- ÊàêÂ∞±Â•ñÂä±Âç° -->
            <transition name="fade">
              <div v-if="rewardToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-lime-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üèÜ</span>
                    <div>
                      <p class="text-sm font-semibold">{{ rewardToast.title }}</p>
                      <p class="text-[11px] text-emerald-50">{{ rewardToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">+{{ rewardToast.xp }} XP</span>
                </div>
              </div>
            </transition>

            <transition name="fade">
              <div v-if="allDoneToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-amber-400 via-orange-400 to-rose-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">üéâ</span>
                    <div>
                      <p class="text-sm font-semibold">{{ allDoneToast.title }}</p>
                      <p class="text-[11px] text-amber-50">{{ allDoneToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">‰ªäÊó•ÂÖ®Ê∏Ö</span>
                </div>
              </div>
            </transition>

            <!-- ‰ªªÂä°ÂàóË°® -->
            <div class="space-y-2 sm:space-y-2.5 overflow-y-auto pr-1 flex-1">
              <div v-if="tasks.length === 0"
                   class="text-xs sm:text-sm text-slate-500 bg-white/70 rounded-2xl px-3 py-2 border border-slate-200/60">
                ËøòÊ≤°Êúâ‰ªªÂä°ÔºåÂÖàÊ∑ªÂä†Âá†‰∏™‰ªäÂ§©ÁöÑÂ∞èÁõÆÊ†áÂêßÔºåÊØîÂ¶ÇÔºö<br />
                <span class="text-emerald-700">ÈòÖËØª 15 ÂàÜÈíü ¬∑ ÂÆåÊàêÊï∞Â≠¶ÁªÉ‰π† 2 È°µ ¬∑ ËÉåÂè§ËØó 1 È¶ñ</span>
              </div>

              <div v-for="(task, index) in tasks"
                   :key="task.id"
                   class="daily-task-item flex items-center justify-between bg-white/95 rounded-2xl px-3 sm:px-4 py-2 sm:py-2.5 shadow-sm border border-slate-100"
                   :class="{ dragging: dragIndex === index }"
                   draggable="true"
                   @dragstart="onDragStart(index)"
                   @dragover.prevent
                   @drop="onDrop(index)"
                   @dragend="onDragEnd">
                  <div class="flex items-center gap-2 sm:gap-3 flex-1">
                  <span class="drag-handle text-slate-300 hover:text-slate-500">‚ãÆ‚ãÆ</span>
                  <!-- ÊâìÂç°ÂúÜÂúà + Âä®ÁîªÂ±Ç -->
                  <div class="relative flex items-center justify-center">
                    <button
                      @click="toggleTask(task)"
                      class="h-7 w-7 sm:h-8 sm:w-8 rounded-full border-2 flex items-center justify-center transition bg-slate-50"
                      :class="task.done ? 'border-amber-400 bg-amber-100 shadow-inner' : 'border-slate-300 hover:border-emerald-400 hover:bg-emerald-50'">
                      <span v-if="task.done" class="text-amber-500 text-lg check-anim">‚úì</span>
                    </button>
                    <!-- ÈáëÂ∏ÅÂä®Áîª -->
                    <div v-if="task.coinAnimating"
                         class="absolute -top-1 -right-2 text-base sm:text-lg coin-anim select-none">
                      ü™ô
                    </div>
                  </div>

                  <div class="flex flex-col flex-1">
                    <span
                      class="text-xs sm:text-sm font-medium"
                      :class="task.done ? 'line-through text-slate-400' : 'text-slate-800'">
                      {{ task.title }}
                    </span>
                    <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                      <span v-if="task.startTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-50 text-[11px] text-emerald-700 border border-emerald-200">
                        ‚è∞ ÂºÄÂßã {{ task.startTime }}
                      </span>
                      <span v-if="task.done && task.endTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-amber-50 text-[11px] text-amber-700 border border-amber-200">
                        ‚úÖ ÂÆåÊàê {{ task.endTime }}
                      </span>
                      <span v-if="task.startTime && !task.done"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-[11px] text-blue-700 border border-blue-200">
                        üü¢ ËøõË°å‰∏≠
                    </span>
                  </div>
                </div>

                  <!-- Êìç‰ΩúÊåâÈíÆÁªÑ -->
                  <div class="flex items-center gap-1 sm:gap-2">
                    <button
                      v-if="!task.done && !task.startTime"
                      @click="startTask(task)"
                      class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition">
                      ÂºÄÂßã
                    </button>
                <button
                  @click="removeTask(index)"
                  :disabled="!isParentUnlocked"
                  class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100 disabled:opacity-40 disabled:cursor-not-allowed">
                  Âà†Èô§
                </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="daily-tools-inline">
              <p class="meta">‰ªäÂ§©Ôºö<span class="font-semibold text-slate-700">{{ todayLabel }}</span></p>
              <div class="actions">
                <button
                  @click="openTemplateManager"
                  class="btn-chip rounded-full border border-blue-200 bg-blue-50 text-blue-700 hover:bg-blue-100 transition theme-primary-bg theme-primary-text theme-border">
                  Ê®°Êùø
                </button>
                <select
                  v-model="selectedTemplateId"
                  @change="applyTemplate"
                  class="rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition theme-primary-bg theme-primary-text theme-border">
                  <option value="">ÈÄâÊã©Ê®°Êùø...</option>
                  <option v-for="tpl in templates" :key="tpl.id" :value="tpl.id">
                    {{ tpl.name }}
                  </option>
                </select>
              </div>
            </div>

            <div v-if="ageGroup === 'junior'" class="mb-2 rounded-2xl px-3 py-2 sticker-book-card">
              <button type="button" class="icon-btn w-full flex items-center justify-between" @click="toggleStickerBook()">
                <span class="text-sm font-semibold text-slate-800">Ë¥¥Á∫∏ÂÜå ¬∑ ‰ªäÊó• {{ todayJuniorStickers.length }} Êûö</span>
                <span class="text-[11px] text-slate-500">{{ stickerBookCollapsed ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑' }}</span>
              </button>
              <div v-if="stickerBookCollapsed" class="sticker-inline-hint">
                {{ todayJuniorStickers.length === 0 ? '‰ªäÂ§©ËøòÊ≤°ÊúâÊñ∞Ë¥¥Á∫∏ÔºåÂÖàÂÆåÊàê‰∏ÄÈ°π‰ªªÂä°ËØïËØï„ÄÇ' : 'Â∑≤ÊäòÂè†ÔºåÁÇπÂáªÂ±ïÂºÄÊü•Áúã‰ªäÊó•Ë¥¥Á∫∏„ÄÇ' }}
              </div>
              <div v-else class="mt-2 flex items-center gap-2 overflow-x-auto pb-1">
                <div v-for="sticker in todayJuniorStickers"
                     :key="sticker.id"
                     class="sticker-chip"
                     :class="{ 'sticker-chip-new': juniorStickers.hintVisible && juniorStickers.latestId === sticker.id }">
                  <span class="text-lg leading-none">{{ sticker.emoji }}</span>
                  <span class="text-[10px] text-slate-600">{{ sticker.name }}</span>
                </div>
                <div v-if="todayJuniorStickers.length === 0"
                     class="text-[11px] text-slate-500 bg-white/70 rounded-xl px-3 py-2 border border-white/60">
                  ÂÖàÂÆåÊàê‰∏Ä‰∏™‰ªªÂä°ÔºåÈ¢ÜÂèñ‰ªäÂ§©Á¨¨ 1 ÊûöË¥¥Á∫∏Âêß„ÄÇ
                </div>
              </div>
            </div>
            <transition name="fade">
              <div v-if="ageGroup === 'junior' && juniorStickers.hintVisible && latestJuniorSticker"
                   class="mb-2 rounded-xl bg-emerald-50 border border-emerald-200 px-3 py-2 text-[12px] text-emerald-700 sticker-hint-pop">
                üéÅ Ëé∑ÂæóÊñ∞Ë¥¥Á∫∏Ôºö{{ latestJuniorSticker.emoji }} {{ latestJuniorSticker.name }}
              </div>
            </transition>

            <!-- Ê∑ªÂä†‰ªªÂä° -->
            <div class="mt-3 pt-3 border-t border-slate-200/70">
              <form @submit.prevent="addTask" class="flex flex-col gap-2">
                <div class="mobile-stack flex flex-col sm:flex-row gap-2">
                <input v-model="newTaskTitle"
                       type="text"
                       placeholder="‰æãÂ¶ÇÔºöÊúóËØªËØæÊñá 2 ÈÅç"
                       class="mobile-input flex-1 rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm
                              focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400 bg-white/90" />
                <button
                  type="submit"
                  class="mobile-btn px-4 py-2 text-xs sm:text-sm font-semibold
                         active:scale-95 transition btn-main add-task-primary">
                  + Ê∑ªÂä†‰ªªÂä°
                </button>
                </div>
                <p class="text-[11px] text-slate-400">
                  ÊèêÁ§∫ÔºöÊ∑ªÂä†‰ªªÂä°ÂêéÔºåÁÇπÂáª"ÂºÄÂßã"ÊåâÈíÆËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥ÔºåÂÆåÊàêÂêé‰ºöËá™Âä®ËÆ∞ÂΩïÁªìÊùüÊó∂Èó¥„ÄÇ
                </p>
              </form>
            </div>
          </div>

          <!-- ËâæÂÆæÊµ©ÊñØËÆ∞ÂøÜÊåëÊàò -->
          <div v-else-if="activeTab === 'memory'" class="flex-1 flex flex-col gap-3 text-xs sm:text-sm overflow-hidden fade-slide">
            <!-- Ê®°ÂùóÊ†áÈ¢ò -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span v-if="!isOlderKid" class="icon-badge bg-sky-100 text-sky-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.brain}`" :xlink:href="`#${iconSet.brain}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ËÆ∞ÂøÜÊåëÊàò</p>
                  <p class="text-[11px] text-slate-500">Ë∑üÈöèËâæÂÆæÊµ©ÊñØÊõ≤Á∫øÂ∑©Âõ∫Â≠¶‰π†</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-sky-50 text-sky-600 border border-sky-200">Â§ç‰π†ËÆ°Âàí</span>
            </div>
            <!-- ÂàÜÁ±ªÈÄâÊã© -->
            <div class="mobile-chips flex items-center gap-2 bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="memoryCategory = 'poetry'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'poetry'
                  ? 'bg-amber-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                üìú Âè§ËØóËØç
              </button>
              <button
                @click="memoryCategory = 'english'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'english'
                  ? 'bg-emerald-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                üî§ Ëã±ËØ≠
              </button>
              <button
                @click="memoryCategory = 'science'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'science'
                  ? 'bg-sky-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                üß™ Êï∞ÁêÜÂåñ
              </button>
              <span class="ml-auto text-[11px] text-slate-500">
                {{ memoryCategoryLabel }}
              </span>
            </div>

            <!-- Ê∑ªÂä†Â≠¶‰π†ÂÜÖÂÆπÊåâÈíÆ -->
            <div class="flex justify-end gap-2">
              <button
                @click="addTodayMemory"
                class="mobile-btn px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-primary">
                ‚ûï Ê∑ªÂä†{{ memoryCategoryLabel }}ÂÜÖÂÆπ
              </button>
              <button
                @click="openMemoryManager"
                class="mobile-btn px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-accent">
                üìö ÊâπÈáèÂØºÂÖ•ËÆ∞ÂøÜ‰ªªÂä°
              </button>
            </div>

            <!-- Âë®ËßÜÂõæÂØºËà™ -->
            <div class="flex items-center justify-between bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="prevWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                ‚Üê ‰∏ä‰∏ÄÂë®
              </button>
              <span class="font-semibold text-slate-800">{{ currentWeekLabel }}</span>
              <button
                @click="nextWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                ‰∏ã‰∏ÄÂë® ‚Üí
              </button>
            </div>

            <!-- Âë®ËßÜÂõæ‰ªªÂä°Ë°®Ê†º -->
            <div class="flex-1 overflow-x-auto overflow-y-auto bg-white rounded-2xl border-2 border-slate-300 shadow-lg">
              <table class="text-xs border-collapse" style="table-layout: auto; width: 100%;">
                <colgroup>
                  <col style="width: 65px;">
                  <col>
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 60px;" v-for="n in 6" :key="n">
                </colgroup>
                <thead class="bg-gradient-to-r from-amber-100 to-yellow-50 border-b-2 border-amber-300 sticky top-0 z-10 shadow-sm">
                  <tr>
                    <th class="px-2 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">Êó•Êúü</th>
                    <th class="px-3 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">Â≠¶‰π†ÂÜÖÂÆπ</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="3">Â≠¶‰π†ËÆ°Âàí</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="6">ÂêéÁª≠Â§ç‰π†Êó•Êúü</th>
                  </tr>
                  <tr class="bg-gradient-to-r from-amber-50 to-yellow-50/50">
                    <th class="px-2 py-1.5 border-r border-amber-200"></th>
                    <th class="px-3 py-1.5 border-r border-amber-200"></th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">5ÂàÜ</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">30ÂàÜ</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">12Êó∂</th>
                    <th v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">
                      +{{ offset }}Â§©
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, rowIdx) in weeklyMemoryItems" :key="item.id"
                      :class="rowIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'"
                      class="border-b border-slate-200 hover:bg-amber-50/50 transition-colors">
                    <td class="px-2 py-3 border-r border-slate-200 text-center">
                      <div class="flex flex-col items-center justify-center">
                        <span class="font-bold text-slate-900 text-sm leading-tight">{{ item.learnDate }}</span>
                        <span class="text-[9px] text-slate-500 mt-0.5 leading-tight">{{ item.learnYear }}</span>
                      </div>
                    </td>
                    <td class="px-3 py-3 border-r border-slate-200" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                      <div v-if="editingMemoryId !== item.id" 
                           class="flex flex-col justify-center min-h-[40px] group relative">
                        <span class="font-semibold text-slate-900 leading-snug text-center break-words">{{ item.title }}</span>
                        <div v-if="item.dynasty" class="mt-1 flex items-center justify-center">
                          <span class="px-1.5 py-0.5 rounded-full text-[9px] text-white"
                                :style="{ backgroundColor: dynastyColor(item.dynasty) }">
                            {{ item.dynasty }}
                          </span>
                          <span v-if="item.author" class="ml-1 text-[10px] text-slate-600">¬∑ {{ item.author }}</span>
                        </div>
                        <span v-else-if="item.content" class="text-[10px] text-slate-600 mt-1 leading-tight text-center break-words">{{ item.content }}</span>
                        <button
                          v-if="canEditMemoryItem(item)"
                          @click.stop="startEditMemory(item)"
                          class="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity
                                 px-1.5 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700 hover:bg-blue-200">
                          ÁºñËæë
                        </button>
                      </div>
                      <div v-else class="flex flex-col gap-1.5">
              <input
                          v-model="editingMemoryTitle"
                type="text"
                          placeholder="Ê†áÈ¢ò"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <input
                          v-model="editingMemoryContent"
                          type="text"
                          placeholder="ÂÜÖÂÆπËØ¶ÊÉÖÔºàÂèØÈÄâÔºâ"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <div class="flex gap-1">
              <button
                            @click.stop="saveEditMemory(item)"
                            class="flex-1 px-2 py-1 rounded bg-emerald-500 text-white text-[10px] hover:bg-emerald-600">
                            ‰øùÂ≠ò
              </button>
                          <button
                            @click.stop="cancelEditMemory"
                            class="flex-1 px-2 py-1 rounded bg-slate-200 text-slate-700 text-[10px] hover:bg-slate-300">
                            ÂèñÊ∂à
                          </button>
                        </div>
                      </div>
                    </td>
                    <!-- Âç≥Êó∂Â§ç‰π†Êó∂Èó¥ÁÇπ -->
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '5min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['5min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['5min']?.done" class="text-sm font-bold">‚úì</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '30min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['30min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['30min']?.done" class="text-sm font-bold">‚úì</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '12h')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['12h']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['12h']?.done" class="text-sm font-bold">‚úì</span>
                      </button>
                    </td>
                    <!-- ËâæÂÆæÊµ©ÊñØÂ§ç‰π†Êó•Êúü -->
                    <td v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <div class="flex flex-col items-center justify-center gap-1">
                        <span class="text-[8px] text-slate-500 leading-tight">{{ item.reviews[offset]?.date || '-' }}</span>
                        <button
                          v-if="item.reviews[offset]"
                          @click.stop="toggleReviewCheck(item.id, offset)"
                          class="h-7 w-7 rounded-lg border-2 flex items-center justify-center transition-all
                                 flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                          :class="item.reviews[offset].done
                            ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                            : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                          <span v-if="item.reviews[offset].done" class="text-sm font-bold">‚úì</span>
                        </button>
                        <span v-else class="text-slate-300 text-[8px]">-</span>
                      </div>
                    </td>
                  </tr>
                  <tr v-if="weeklyMemoryItems.length === 0">
                    <td colspan="10" class="px-4 py-12 text-center text-slate-400 text-sm bg-white">
                      <div class="flex flex-col items-center gap-2">
                        <span class="text-2xl">üìö</span>
                        <span>Êú¨Âë®ÊöÇÊó†ËÆ∞ÂøÜ‰ªªÂä°</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            </div>

          <div v-else-if="activeTab === 'stats' && ageGroup === 'senior'" class="flex-1 flex flex-col gap-3 text-xs sm:text-sm overflow-hidden fade-slide">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="icon-badge bg-indigo-100 text-indigo-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.chart}`" :xlink:href="`#${iconSet.chart}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ÁªüËÆ°ÂàÜÊûê</p>
                  <p class="text-[11px] text-slate-500">‰ªÖ Senior ÂèØËßÅÁöÑÊï∞ÊçÆÊ¥ûÂØü</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-600 border border-indigo-200">Senior</span>
            </div>

            <div class="flex items-center gap-2 bg-white/85 rounded-xl p-1 border border-slate-200 w-fit">
              <button
                @click="seniorStatsRange = 'today'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="seniorStatsRange === 'today' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'">
                Today
              </button>
              <button
                @click="seniorStatsRange = 'week'"
                class="px-3 py-1.5 rounded-lg text-xs font-semibold transition"
                :class="seniorStatsRange === 'week' ? 'bg-indigo-100 text-indigo-700' : 'text-slate-600 hover:bg-slate-100'">
                This Week
              </button>
            </div>

            <div v-if="seniorStatsRange === 'today'" class="grid grid-cols-2 gap-2">
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">ÂÆåÊàêÁéá</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.completedCount }} / {{ seniorTodaySummary.totalCount }}</p>
                <p class="text-[11px] text-indigo-600 mt-0.5">{{ seniorTodaySummary.completionRate }}%</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">‰∏ìÊ≥®ÂàÜÈíü</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.focusMinutes }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">ÂàÜÈíü</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">‰ªäÊó• XP Â¢ûÈáè</p>
                <p class="text-base font-bold text-slate-800 mt-1">+{{ seniorTodaySummary.xpGained }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">fallback ‰º∞ÁÆó</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">Â§ç‰π†ËææÊ†áÁéá</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorTodaySummary.reviewDoneCount }} / {{ seniorTodaySummary.reviewTotalCount }}</p>
                <p class="text-[11px] text-emerald-600 mt-0.5">{{ seniorTodaySummary.reviewRate }}%</p>
              </div>
            </div>

            <div v-else class="grid grid-cols-2 gap-2">
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">Êú¨Âë®ÂÆåÊàêÁéá</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.completionRate }}%</p>
                <p class="text-[11px] text-slate-500 mt-0.5">{{ seniorWeekSummary.completedCount }} / {{ seniorWeekSummary.totalCount }}</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">Êú¨Âë®‰∏ìÊ≥®ÂàÜÈíü</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.focusMinutes }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">ÂàÜÈíü</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">Êú¨Âë®ËøûÁª≠Â§©Êï∞</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.streak }}</p>
                <p class="text-[11px] text-slate-500 mt-0.5">Â§©ÔºàÂÆåÊàê‚â•1Ôºâ</p>
              </div>
              <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
                <p class="text-[11px] text-slate-500">Êú¨Âë®Â§ç‰π†ËææÊ†áÁéá</p>
                <p class="text-base font-bold text-slate-800 mt-1">{{ seniorWeekSummary.reviewRate }}%</p>
                <p class="text-[11px] text-slate-500 mt-0.5">{{ seniorWeekSummary.reviewDoneCount }} / {{ seniorWeekSummary.reviewTotalCount }}</p>
              </div>
            </div>

            <div class="bg-white/90 border border-slate-200 rounded-2xl p-3">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm font-semibold text-slate-800">7 Â§©Ê∏∏Á®ã</p>
                <p class="text-[11px] text-slate-500">ÊäòÁ∫ø=ÂÆåÊàêÁéá / Êü±=‰∏ìÊ≥®ÂàÜÈíü</p>
              </div>
              <svg viewBox="0 0 360 190" class="w-full h-48">
                <line x1="34" y1="16" x2="34" y2="144" stroke="#cbd5e1" stroke-width="1"></line>
                <line x1="34" y1="144" x2="346" y2="144" stroke="#cbd5e1" stroke-width="1"></line>
                <line x1="34" y1="16" x2="346" y2="16" stroke="#e2e8f0" stroke-dasharray="4 3" stroke-width="1"></line>
                <text x="6" y="20" font-size="10" fill="#64748b">100%</text>
                <text x="14" y="147" font-size="10" fill="#64748b">0%</text>

                <rect
                  v-for="bar in seniorChartModel.bars"
                  :key="bar.key"
                  :x="bar.x"
                  :y="bar.y"
                  :width="bar.width"
                  :height="bar.height"
                  rx="2"
                  fill="#93c5fd"
                  opacity="0.8"></rect>

                <polyline
                  :points="seniorChartModel.linePoints"
                  fill="none"
                  stroke="#4f46e5"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"></polyline>

                <circle
                  v-for="pt in seniorChartModel.points"
                  :key="`pt-${pt.key}`"
                  :cx="pt.x"
                  :cy="pt.y"
                  r="3"
                  fill="#4f46e5"></circle>

                <text
                  v-for="label in seniorChartModel.labels"
                  :key="`lb-${label.key}`"
                  :x="label.x"
                  y="162"
                  text-anchor="middle"
                  font-size="10"
                  fill="#64748b">
                  {{ label.text }}
                </text>
              </svg>
              <p class="text-[11px] text-slate-500 mt-1">‰∏ìÊ≥®ÂàÜÈíü‰∏äÈôêÔºö{{ seniorChartModel.maxFocus }} ÂàÜÈíü</p>
            </div>
          </div>

        </div>
      </section>
    </main>

    <nav class="bottom-nav mt-3">
      <template v-if="ageGroup === 'junior'">
        <button @click="activeTab = 'daily'" :class="activeTab === 'daily' ? 'bottom-nav-active' : ''">‰ªäÊó•</button>
        <button @click="activeTab = 'memory'" :class="activeTab === 'memory' ? 'bottom-nav-active' : ''">ËÆ∞ÂøÜ</button>
        <button @click="openSettings">ËÆæÁΩÆ</button>
      </template>
      <template v-else>
        <button @click="activeTab = 'daily'" :class="activeTab === 'daily' ? 'bottom-nav-active' : ''">‰ªäÊó•</button>
        <button @click="activeTab = 'memory'" :class="activeTab === 'memory' ? 'bottom-nav-active' : ''">ËÆ∞ÂøÜ</button>
        <button @click="activeTab = 'stats'" :class="activeTab === 'stats' ? 'bottom-nav-active' : ''">ÁªüËÆ°</button>
        <button @click="openTemplateManager">Ê®°Êùø</button>
        <button @click="openSettings">ËÆæÁΩÆ</button>
      </template>
    </nav>

    <footer class="w-full max-w-5xl mt-4 text-center text-[11px] text-slate-400">
      ¬© fabien Zhang ¬∑ Âø´‰πêÂ≠¶‰π†Â§ßÂÜíÈô©
    </footer>

    <!-- Ê®°ÊùøÁÆ°ÁêÜÂºπÁ™ó -->
    <div v-if="showTemplateManager"
         class="fixed inset-0 z-30 flex items-center justify-center bg-black/40">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative max-h-[80vh] overflow-y-auto">
        <button
          class="icon-btn absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="showTemplateManager = false">
          ‚úï
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">üìã ‰ªªÂä°Ê®°ÊùøÁÆ°ÁêÜ</h2>
          <p class="text-xs text-slate-500 mt-1">ÂàõÂª∫ÂíåÁÆ°ÁêÜ‰Ω†ÁöÑ‰ªªÂä°Ê®°Êùø</p>
        </div>

        <!-- ÂàõÂª∫Êñ∞Ê®°Êùø -->
        <div class="mb-4 p-3 bg-blue-50 rounded-2xl">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">ÂàõÂª∫Êñ∞Ê®°Êùø</h3>
          <div class="flex flex-col gap-2">
            <input
              v-model="newTemplateName"
              type="text"
              placeholder="Ê®°ÊùøÂêçÁß∞ÔºåÂ¶ÇÔºöÂ∑•‰ΩúÊó•Ê®°Êùø„ÄÅÂë®Êú´Ê®°Êùø"
              class="rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm bg-white
                     focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-400" />
            <button
              @click="createTemplateFromCurrent"
              class="px-3 py-2 rounded-2xl bg-blue-500 text-white text-xs sm:text-sm font-semibold
                     hover:bg-blue-600 active:scale-95 transition">
              + ‰ªéÂΩìÂâç‰ªªÂä°ÂàõÂª∫Ê®°Êùø
            </button>
          </div>
        </div>

        <!-- Ê®°ÊùøÂàóË°® -->
        <div class="space-y-2">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">Â∑≤ÊúâÊ®°Êùø</h3>
          <div v-for="tpl in templates" :key="tpl.id"
               class="bg-white border border-slate-200 rounded-2xl p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <input
                  v-if="editingTemplateId === tpl.id"
                  v-model="tpl.name"
                  @blur="saveTemplates()"
                  @keyup.enter="saveTemplates()"
                  type="text"
                  class="font-medium text-sm text-slate-800 bg-white border border-blue-200 rounded-lg px-2 py-1 w-full
                         focus:outline-none focus:ring-2 focus:ring-blue-300"
                  placeholder="Ê®°ÊùøÂêçÁß∞" />
                <p v-else class="font-medium text-sm text-slate-800">{{ tpl.name }}</p>
                <p class="text-xs text-slate-500 mt-0.5">{{ tpl.tasks.length }} ‰∏™‰ªªÂä°</p>
              </div>
              <div class="flex items-center gap-2">
                <button
                  @click="editTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs hover:bg-blue-100">
                  {{ editingTemplateId === tpl.id ? '‰øùÂ≠ò' : 'ÁºñËæë' }}
                </button>
                <button
                  @click="applyTemplateById(tpl.id)"
                  class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs hover:bg-emerald-100">
                  Â∫îÁî®
                </button>
                <button
                  @click="deleteTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-rose-50 text-rose-700 text-xs hover:bg-rose-100">
                  Âà†Èô§
                </button>
              </div>
            </div>
            <!-- ÁºñËæëÊ®°Êùø‰ªªÂä°ÂàóË°® -->
            <div v-if="editingTemplateId === tpl.id" class="mt-3 space-y-2 border-t pt-2">
              <div v-for="(task, idx) in tpl.tasks" :key="idx"
                   class="flex items-center gap-2 bg-slate-50 rounded-xl p-2">
                <input
                  v-model="task.title"
                  type="text"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300"
                  placeholder="‰ªªÂä°ÂêçÁß∞" />
                <button
                  @click="removeTaskFromTemplate(tpl.id, idx)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  Âà†Èô§
                </button>
              </div>
              <div class="flex gap-2">
                <input
                  v-model="newTaskForTemplate[tpl.id]"
                  @keyup.enter="addTaskToTemplate(tpl.id)"
                  type="text"
                  placeholder="Ê∑ªÂä†Êñ∞‰ªªÂä°..."
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300" />
                <button
                  @click="addTaskToTemplate(tpl.id)"
                  class="px-3 py-1 rounded-lg bg-blue-500 text-white text-xs hover:bg-blue-600">
                  + Ê∑ªÂä†
                </button>
              </div>
            </div>
          </div>
          <div v-if="templates.length === 0" class="text-center py-4 text-slate-400 text-sm">
            ËøòÊ≤°ÊúâÊ®°ÊùøÔºåÂàõÂª∫‰∏Ä‰∏™ÂêßÔºÅ
          </div>
        </div>
      </div>
    </div>

    <!-- Ê∑ªÂä†‰ªäÂ§©ÂÜÖÂÆπÂºπÁ™ó -->
    <transition name="fade">
      <div v-if="showAddTodayModal"
           @click.self="showAddTodayModal = false"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="showAddTodayModal = false">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 relative"
             @click.stop>
          <button
            class="icon-btn absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
            @click="showAddTodayModal = false">
            ‚úï
          </button>
          <div class="text-center mb-4">
            <h2 class="text-lg font-bold text-slate-800">‚ûï Ê∑ªÂä†{{ memoryCategoryLabel }}ÂÜÖÂÆπ</h2>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">ÈÄâÊã©Êó•Êúü</label>
              <input
                v-model="newTodayMemory.date"
                type="date"
                :min="todayKey"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
            </div>
            <div v-if="memoryCategory === 'poetry'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">ËØóÂêç *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="‰æãÂ¶ÇÔºö„ÄäÈùôÂ§úÊÄù„Äã"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">Êúù‰ª£ *</label>
                  <input
                    v-model="newTodayMemory.dynasty"
                    type="text"
                    placeholder="‰æãÂ¶ÇÔºöÂîê"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">‰ΩúËÄÖ *</label>
                  <input
                    v-model="newTodayMemory.author"
                    type="text"
                    placeholder="‰æãÂ¶ÇÔºöÊùéÁôΩ"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
              </div>
            </div>
            <div v-else-if="memoryCategory === 'english'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">ÂçïËØç/Âè•Â≠ê *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="‰æãÂ¶ÇÔºöapple / I like apples"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">Ê≥®ÈáäÔºàÂèØÈÄâÔºâ</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="‰æãÂ¶ÇÔºöËãπÊûú / ÊàëÂñúÊ¨¢ËãπÊûú"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div v-else>
              <label class="block text-sm font-semibold text-slate-700 mb-1">ÂÖ¨Âºè *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="‰æãÂ¶ÇÔºöa¬≤ + b¬≤ = c¬≤"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">Á±ªÂà´ *</label>
              <input
                v-model="newTodayMemory.categoryName"
                type="text"
                placeholder="‰æãÂ¶ÇÔºöÂá†‰Ωï / Áâ©ÁêÜ / ÂåñÂ≠¶"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">Ê≥®ÈáäÔºàÂèØÈÄâÔºâ</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="‰æãÂ¶ÇÔºöÁõ¥Ëßí‰∏âËßíÂΩ¢ÂãæËÇ°ÂÆöÁêÜ"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div class="flex gap-2 pt-2">
              <button
                @click="saveTodayMemory"
                class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                       active:scale-95 transition btn-primary">
                  ‰øùÂ≠ò
                </button>
              <button
                @click="showAddTodayModal = false"
                class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                       hover:bg-slate-200 active:scale-95 transition">
                ÂèñÊ∂à
              </button>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- ËÆ∞ÂøÜ‰ªªÂä°ÁÆ°ÁêÜÂºπÁ™ó -->
    <!-- ÊöÇÊó∂Á¶ÅÁî®ÔºåÈò≤Ê≠¢Ëá™Âä®ÊâìÂºÄ -->
    <transition name="fade">
      <div v-if="shouldShowMemoryManager && !shouldShowMonthlyReport"
           @click.self="closeMemoryManager"
           @mousedown.self="closeMemoryManager"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="closeMemoryManager">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-[95%] p-5 relative max-h-[85vh] flex flex-col"
             @click.stop>
        <button
          type="button"
          class="icon-btn absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
          @click.stop="closeMemoryManager">
          ‚úï
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">üìö Ê∑ªÂä†/ÊâπÈáèÂØºÂÖ•ËÆ∞ÂøÜ‰ªªÂä°</h2>
          <p class="text-xs text-slate-500 mt-1">ÊØèË°å‰∏Ä‰∏™‰ªªÂä°ÔºåÊ†ºÂºèËßÅ‰∏ãÊñπÊèêÁ§∫</p>
        </div>
        <div class="flex-1 overflow-y-auto space-y-3 mb-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">ÈÄâÊã©Ëµ∑ÂßãÊó•ÊúüÔºà‰ªäÂ§©Êàñ‰ª•ÂêéÔºâ</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportStartDate"
                type="date"
                :min="todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <label class="block text-sm font-semibold text-slate-700 mb-1 mt-2">ÈÄâÊã©ÁªìÊùüÊó•ÊúüÔºà‰∏çÂèØÊó©‰∫éËµ∑ÂßãÊó•Ôºâ</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportEndDate"
                type="date"
                :min="batchImportStartDate || todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <p class="text-[11px] text-slate-400 mt-1">
              ËßÑÂàôÔºöÊØè‰∏ÄË°åÂØπÂ∫î‰∏ÄÂ§©Ôºå‰ªéËµ∑ÂßãÊó•È°∫Âª∂Âà∞ÁªìÊùüÊó•
            </p>
            <p class="text-[11px] text-slate-500 mt-1">
              {{ batchImportRangeHint }}
            </p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">‰ªªÂä°ÂàóË°®ÔºàÊØèË°å‰∏Ä‰∏™‰ªªÂä°Ôºâ</label>
            <textarea
              v-model="batchImportData"
              rows="12"
              :placeholder="batchImportPlaceholder"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs font-mono bg-white
                     focus:outline-none focus:ring-2 focus:ring-sky-300 resize-none"></textarea>
            <p class="text-[11px] text-slate-400 mt-1">
              {{ batchImportTip }}
            </p>
          </div>
          <div v-if="previewTasks.length > 0" class="bg-slate-50 rounded-xl p-3">
            <p class="text-sm font-semibold text-slate-700 mb-2">È¢ÑËßàÔºàÂèØÁºñËæëÔºâÔºö</p>
            <div class="space-y-2 max-h-40 overflow-y-auto">
              <div v-for="(task, idx) in previewTasks" :key="idx"
                   class="flex items-center gap-2 bg-white rounded-lg p-2">
                <input
                  v-model="task.title"
                  type="text"
                  placeholder="‰ªªÂä°ÂêçÁß∞"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <input
                  v-model="task.content"
                  type="text"
                  placeholder="ÂÜÖÂÆπËØ¶ÊÉÖÔºàÂèØÈÄâÔºâ"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <button
                  @click="previewTasks.splice(idx, 1)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  Âà†Èô§
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex gap-2 border-t pt-3">
          <button
            @click="previewBatchImport"
            class="px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition btn-accent">
            È¢ÑËßà
          </button>
          <button
            @click="processBatchImport"
            :disabled="previewTasks.length === 0"
            class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition disabled:bg-slate-300 disabled:cursor-not-allowed btn-accent">
            ÂØºÂÖ•Âπ∂ÁîüÊàêÂ§ç‰π†ËÆ°Âàí
          </button>
          <button
            @click.stop="closeMemoryManager"
            class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            ÂèñÊ∂à
          </button>
        </div>
        </div>
      </div>
    </transition>

    <!-- Ë°®Êâ¨‰ø°ÂºπÁ™ó -->
    <div v-if="shouldShowMonthlyReport && !shouldShowMemoryManager"
         @click.self="closeMonthlyReport"
         @mousedown.self="closeMonthlyReport"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/40"
         @keyup.esc="closeMonthlyReport">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative">
        <button
          type="button"
          class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click.stop="closeMonthlyReport">
          ‚úï
        </button>
        <div class="text-center mb-3">
          <div class="text-3xl mb-1">üèÖ</div>
          <h2 class="text-lg font-bold text-slate-800">Êú¨ÊúàÂø´‰πêÂ≠¶‰π†Ë°®Êâ¨‰ø°</h2>
          <p class="text-xs text-slate-500 mt-1">
            Ëá™Âä®ÁªüËÆ°Êú¨ÊúàÂÆåÊàêÊÉÖÂÜµÔºå‰∏∫‰Ω†ÈÄÅ‰∏ä‰∏ÄÂ∞ÅÂ∞èÂ∞èÁöÑË°®Êâ¨‰ø°„ÄÇ
          </p>
        </div>
        <div class="text-sm text-slate-700 space-y-2">
          <p>‰∫≤Áà±ÁöÑ <span class="font-semibold">Â∞èÂ∞èÂÜíÈô©ÂÆ∂</span>Ôºö</p>
          <p>
            Êú¨Êúà‰Ω†‰∏ÄÂÖ±ÂÆåÊàê‰∫Ü
            <span class="font-bold text-emerald-600">{{ monthlyStats.doneTasks }}</span>
            ‰∏™Â≠¶‰π†‰ªªÂä°ÔºåÁ¥ØËÆ°Ëé∑Âæó
            <span class="font-bold text-amber-500">{{ xp }}</span>
            ÁÇπÁªèÈ™åÂÄºÔºåÂ∑≤ÁªèÊàê‰∏∫
            <span class="font-bold text-emerald-700">{{ levelDisplay.title }}</span> Âï¶ÔºÅ
          </p>
          <p>
            ÊØè‰∏ÄÊ¨°ËÆ§ÁúüÂÆåÊàê‰ªªÂä°ÔºåÈÉΩÊòØÂú®‰∏∫Êú™Êù•ÁöÑËá™Â∑±Èì∫‰∏ÄÊù°Èó™Èó™ÂèëÂÖâÁöÑÂ∞èË∑Ø„ÄÇ
            ËØ∑ÁªßÁª≠‰øùÊåÅËøô‰ªΩÂä™ÂäõÂíåÂãáÊ∞îÔºåËÄÅÂ∏àÂíåÁà∏Áà∏Â¶àÂ¶àÈÉΩ‰∏∫‰Ω†È™ÑÂÇ≤ÔºÅ
          </p>
          <p class="text-right text-xs text-slate-500 mt-2">
            ‚Äî‚Äî Âø´‰πêÂ≠¶‰π†Â§ßÂÜíÈô©Á≥ªÁªü
          </p>
        </div>
        <div class="mt-4 flex gap-2">
          <button
            type="button"
            @click="printReport"
            class="flex-1 px-3 py-2 rounded-2xl text-white text-sm font-semibold
                   active:scale-95 transition btn-primary">
            üñ® ÊâìÂç∞Ë°®Êâ¨‰ø°
          </button>
          <button
            type="button"
            @click.stop="closeMonthlyReport"
            class="px-3 py-2 rounded-2xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <!-- ËÆæÁΩÆ‰∏≠ÂøÉ -->
    <div v-if="showSettings"
         @click.self="closeSettings"
         @keyup.esc="closeSettings"
         class="settings-overlay fixed inset-0 z-40 flex items-center justify-center bg-black/40">
    <div class="settings-modal bg-white rounded-3xl shadow-2xl max-w-lg w-[92%] p-5 relative glass" @click.stop>
        <button
          class="icon-btn absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="closeSettings">
          ‚úï
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">‚öôÔ∏è ËÆæÁΩÆ‰∏≠ÂøÉ</h2>
          <p class="text-xs text-slate-500 mt-1">ÊåâËèúÂçïËøõÂÖ•ËÆæÁΩÆÔºå‰øùÂ≠ò‰ºöËá™Âä®ÁîüÊïà</p>
        </div>

        <div class="space-y-4" v-if="settingsSection === 'home'">
          <div class="bg-white/85 border border-slate-200 rounded-3xl p-3">
            <p class="text-sm font-semibold text-slate-800">ÂΩìÂâçÊ®°Âºè</p>
            <p class="text-[12px] text-slate-600 mt-1">
              {{ activeProfile.name }} ¬∑ {{ activeProfile.age }} Â≤Å ¬∑
              <span class="font-semibold">{{ ageGroup === 'junior' ? 'JuniorÔºàÁ´•Ë∂£Ê®°ÂºèÔºâ' : 'SeniorÔºàËøõÈò∂Ê®°ÂºèÔºâ' }}</span>
            </p>
            <p class="text-[11px] text-slate-500 mt-1">‰øÆÊîπÂ≠©Â≠êÂπ¥ÈæÑÂêéÔºåÊ®°Âºè‰ºöÁ´ãÂç≥ÂàáÊç¢„ÄÇ</p>
          </div>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'parent'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">ÂÆ∂ÈïøÊéàÊùÉ</p>
                <p class="text-[11px] text-slate-500">PIN ‰∏éÂÆ∂ÈïøÊéàÊùÉÁÆ°ÁêÜ</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'profiles'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">Â≠©Â≠êÊ°£Ê°à</p>
                <p class="text-[11px] text-slate-500">Ê∑ªÂä†‰∏éÂàáÊç¢Â≠©Â≠ê</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'theme'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">Â§ñËßÇ‰∏éÁöÆËÇ§</p>
                <p class="text-[11px] text-slate-500">‰∏ªÈ¢ò‰∏éÊåâÈíÆÈ¢úËâ≤</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'parent-tools'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">ÂÆ∂ÈïøÂ∑•ÂÖ∑</p>
                <p class="text-[11px] text-slate-500">Ë°®Êâ¨‰ø°Á≠âÂÆ∂ÈïøÂäüËÉΩ</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button v-if="ageGroup === 'senior'" class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'stats'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">ÁªüËÆ°Êä•Ë°®</p>
                <p class="text-[11px] text-slate-500">Êü•ÁúãÂ≠¶‰π†Êï∞ÊçÆ</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-slate-200 rounded-3xl lift"
                  @click="settingsSection = 'install'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-slate-800">ÂÆâË£Ö‰∏éËÆæÂ§á</p>
                <p class="text-[11px] text-slate-500">ÂÆâË£ÖÂà∞Ê°åÈù¢‰∏éËØ¥Êòé</p>
              </div>
              <span class="text-xs text-slate-400">ËøõÂÖ•</span>
            </div>
          </button>
          <button class="settings-menu-btn text-left bg-white/80 border border-rose-200 rounded-3xl lift"
                  @click="settingsSection = 'danger'">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm font-semibold text-rose-700">Âç±Èô©Êìç‰Ωú</p>
                <p class="text-[11px] text-rose-500">Ê∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆ</p>
              </div>
              <span class="text-xs text-rose-400">ËøõÂÖ•</span>
            </div>
          </button>
        </div>

        <div v-else class="space-y-4">
          <button class="glass-btn w-full text-sm font-semibold btn-compact"
                  @click="settingsSection = 'home'">
            ‚Üê ËøîÂõûËÆæÁΩÆËèúÂçï
          </button>

          <div v-if="settingsSection === 'parent'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">ÂÆ∂ÈïøÊéàÊùÉ</p>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-[11px] text-slate-500">Áä∂ÊÄÅÔºö</span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="parentPinSet ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'">
                {{ parentPinSet ? 'Â∑≤ËÆæÁΩÆ PIN' : 'Êú™ËÆæÁΩÆ PIN' }}
              </span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="isParentUnlocked ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'">
                {{ isParentUnlocked ? 'Â∑≤ÊéàÊùÉ' : 'Êú™ÊéàÊùÉ' }}
              </span>
            </div>
          <div class="pin-actions flex gap-2">
            <button
              class="flex-1 px-3 py-2 rounded-xl text-white text-xs font-semibold btn-primary btn-compact"
              @click="setParentPin">
              ËÆæÁΩÆ/‰øÆÊîπ PIN
            </button>
            <button
              class="flex-1 px-3 py-2 rounded-xl text-slate-700 text-xs font-semibold bg-slate-100 btn-compact"
              @click="resetParentPin">
              ÈáçÁΩÆ PIN
            </button>
          </div>
            <p class="text-[11px] text-slate-500 mt-2">
              10 Â≤Å‰ª•‰∏ãËÆæÁΩÆ‰∏éÁÆ°ÁêÜÈúÄÂÆ∂Èïø PINÔºõ10 Â≤Å‰ª•‰∏ä‰πüÈúÄÂÆ∂ÈïøÊéàÊùÉ„ÄÇ
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'profiles'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">Â≠©Â≠êÊ°£Ê°à</p>
            <div class="space-y-2">
              <div v-for="p in profiles" :key="p.id" class="profile-item flex items-center gap-2 bg-white rounded-xl p-2 border border-slate-200">
                <div class="profile-fields w-full">
                  <input v-model="p.name"
                         @blur="onProfileEdited(p)"
                         class="profile-name rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                  <input v-model.number="p.age" type="number" min="3" max="18"
                         @change="onProfileEdited(p)"
                         class="profile-age rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                </div>
                <div class="profile-actions flex items-center gap-2">
                  <button class="px-3 py-2 text-xs rounded-full bg-emerald-50 text-emerald-700 btn-compact"
                          @click="setActiveProfile(p.id)">‰ΩøÁî®</button>
                  <button class="px-3 py-2 text-xs rounded-full bg-rose-50 text-rose-600 btn-compact"
                          @click="removeProfile(p.id)">Âà†Èô§</button>
                </div>
              </div>
            </div>
            <div class="profile-new flex gap-2 mt-2">
              <div class="profile-fields w-full">
                <input v-model="newProfileName" placeholder="Êñ∞Â≠©Â≠êÂêçÂ≠ó"
                       class="profile-name rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
                <input v-model.number="newProfileAge" type="number" min="3" max="18"
                       class="profile-age rounded-lg border border-slate-200 px-2 py-2 text-sm text-center" />
              </div>
              <button class="px-3 py-2 rounded-lg bg-blue-500 text-white text-sm disabled:bg-slate-300 btn-compact"
                      :disabled="!newProfileName.trim()"
                      @click="addProfile">Á°ÆËÆ§Ê∑ªÂä†</button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              È¢ÑËßàÔºö{{ newProfileName || 'Â≠©Â≠ê' }}Ôºà{{ newProfileAge || 8 }}Â≤ÅÔºâ
            </p>
            <p class="text-[11px] text-slate-500">
              ÁÇπÂáª‚Äú‰ΩøÁî®‚ÄùÂç≥ÂèØÂàáÊç¢ÂΩìÂâçÊ°£Ê°à„ÄÇ
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'theme'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">Â§ñËßÇ‰∏éÁöÆËÇ§</p>
            <div class="flex flex-wrap gap-2">
              <button
                v-for="opt in themeOptions"
                :key="opt.value"
                @click="setTheme(opt.value)"
                class="px-3 py-1.5 rounded-full border text-[11px] sm:text-xs font-medium transition flex items-center gap-1 btn-chip"
                :class="theme === opt.value ? 'theme-pill-active' : 'bg-white/70 text-slate-700 border-transparent hover:bg-white/90'"
                :style="theme === opt.value ? { background: opt.swatch } : {}">
                <span v-if="opt.icon">{{ opt.icon }}</span>
                {{ opt.label }}
              </button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              ‰∏ªÈ¢ò‰ºöÂêåÊ≠•ÊîπÂèòÊåâÈíÆÈ¢úËâ≤‰∏éÊï¥‰ΩìÊ∞õÂõ¥„ÄÇ
            </p>
          </div>
          </div>

          <div v-if="settingsSection === 'parent-tools'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <div class="flex items-center justify-between mb-2">
              <p class="text-sm font-semibold text-slate-800">ÂÆ∂ÈïøÂ∑•ÂÖ∑</p>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-50 text-rose-600 border border-rose-200">ÂÆ∂ÈïøÂå∫</span>
            </div>
            <p class="text-xs text-slate-600">
              Ë°®Êâ¨‰ø°Áî±ÂÆ∂ÈïøÂèëÂá∫ÔºåËÆ∞ÂΩïÂ≠©Â≠êÁöÑÂä™Âäõ‰∏éÊàêÈïø„ÄÇ
            </p>
            <button
              type="button"
              @click="openMonthlyReport"
              class="mt-2 px-3 py-2 rounded-2xl text-white font-semibold w-full btn-compact
                     active:scale-95 transition btn-warm">
              ÁîüÊàêÊú¨ÊúàË°®Êâ¨‰ø°
            </button>
          </div>
          </div>

          <div v-if="settingsSection === 'stats' && ageGroup === 'senior'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="icon-badge bg-purple-100 text-purple-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.chart}`" :xlink:href="`#${iconSet.chart}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ÁªüËÆ°Êä•Ë°®</p>
                  <p class="text-[11px] text-slate-500">Senior Ê®°Âºè‰∏ãÂèØ‰ªé‰∏ªÈ°µÈù¢Êü•Áúã Today / This Week</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-purple-50 text-purple-600 border border-purple-200">Êï∞ÊçÆÈù¢Êùø</span>
            </div>
            <button
              type="button"
              @click="openSeniorStats"
              class="mt-3 w-full px-3 py-2 rounded-xl text-white text-sm font-semibold btn-primary btn-compact">
              ÊâìÂºÄ Senior ÁªüËÆ°È°µ
            </button>

            <div class="mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-4 shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">üóÑÔ∏è</span>
                <h3 class="font-bold text-blue-900 text-sm sm:text-base">Êï∞ÊçÆÂΩíÊ°£‰∏éÁ©∫Èó¥Ê∏ÖÁêÜ</h3>
              </div>
              <p class="text-xs text-slate-600 mb-4">
                ÂÆöÊúüÊ∏ÖÁêÜ3‰∏™ÊúàÂâçÁöÑÊóßÊï∞ÊçÆÔºåÈáäÊîæÂ≠òÂÇ®Á©∫Èó¥„ÄÇÊï∞ÊçÆ‰ºöÂÖàÂ§á‰ªΩ‰∏∫JSONÊñá‰ª∂‰∏ãËΩΩÂà∞Êú¨Âú∞ÔºåÁ°ÆËÆ§ÂêéÂÜç‰ªéApp‰∏≠Âà†Èô§„ÄÇ
              </p>
              <div class="space-y-3">
                <button
                  @click="archiveOldData"
                  class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold btn-compact
                         active:scale-95 transition shadow-md btn-accent">
                  üì¶ Ê∏ÖÁêÜÊóßÊï∞ÊçÆÔºàÂΩíÊ°£3‰∏™ÊúàÂâçÁöÑÊï∞ÊçÆÔºâ
                </button>
                <button
                  @click="importArchive"
                  class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold btn-compact
                         active:scale-95 transition shadow-md btn-warm">
                  üì• ÂØºÂÖ•ÂéÜÂè≤ÂΩíÊ°£
                </button>
                <div class="text-[10px] text-slate-500 mt-2 pt-2 border-t border-blue-200">
                  üí° ÊèêÁ§∫ÔºöÂΩíÊ°£Êñá‰ª∂‰ºö‰øùÂ≠òÂà∞ÊÇ®ÁöÑ‰∏ãËΩΩÊñá‰ª∂Â§πÔºåÊñá‰ª∂ÂêçÊ†ºÂºè‰∏∫ backup_YYYY_QN.json
                </div>
              </div>
            </div>
          </div>
          </div>

          <div v-if="settingsSection === 'install'" class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">ÂÆâË£Ö‰∏éËÆæÂ§á</p>
            <div class="flex flex-col gap-2">
              <button
                v-if="showInstall"
                @click="handleInstall"
                class="px-3 py-2 rounded-xl text-white text-sm font-semibold btn-primary btn-compact">
                ÂÆâË£ÖÂà∞Ê°åÈù¢
              </button>
              <button
                type="button"
                @click="clearAppCache"
                class="px-3 py-2 rounded-xl text-slate-800 text-sm font-semibold btn-compact">
                ‰∏ÄÈîÆÊ∏ÖÁºìÂ≠ò
              </button>
              <button
                type="button"
                @click="toggleDebugBuild"
                class="px-3 py-2 rounded-xl text-slate-800 text-sm font-semibold btn-compact">
                {{ debugBuildEnabled ? 'ÂÖ≥Èó≠ Debug BUILD Ê†áÁ≠æ' : 'ÂºÄÂêØ Debug BUILD Ê†áÁ≠æ' }}
              </button>
              <div v-if="showIosInstallHint" class="text-xs text-slate-600 leading-snug bg-white/70 rounded-xl p-2 border border-slate-200">
                iPhone ËØ∑Áî® Safari ÊâìÂºÄÂêéÔºåÁÇπÂáªÂ∫ïÈÉ®‚ÄúÂàÜ‰∫´‚ÄùÂõæÊ†áÔºåÂÜçÈÄâÊã©‚ÄúÊ∑ªÂä†Âà∞‰∏ªÂ±èÂπï‚Äù„ÄÇ
              </div>
            </div>
          </div>
          </div>

          <div v-if="settingsSection === 'danger'" class="space-y-4">
            <div class="danger-area bg-rose-50 rounded-2xl p-3 border border-rose-200">
              <p class="danger-title text-sm font-semibold text-rose-700 mb-2">Âç±Èô©Êìç‰Ωú</p>
              <div class="flex items-center gap-2">
                <button
                  @click="handleResetClick"
                  class="danger-btn px-3 py-1.5 rounded-xl bg-rose-500 text-white text-xs font-semibold btn-compact">
                  ‚ö† Ê∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆ
                </button>
                <span class="text-[11px] text-rose-500">ÈúÄË¶Å‰∏âÊ¨°Á°ÆËÆ§</span>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Á°Æ‰øù Vue Â∑≤Âä†ËΩΩ
    if (typeof Vue === 'undefined') {
      document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>ÈîôËØØÔºöVue Êú™Âä†ËΩΩ</h1><p>ËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Âíå CDN ÈìæÊé•</p></div>';
    } else {
      try {
        const { createApp } = Vue;

    createApp({
      data() {
        return {
          // ‰∏ªÈ¢ò
          theme: 'forest',
          themeOptions: [
            { value: 'candy', label: 'Á≥ñÊûúÊ¢¶', icon: 'üç¨', swatch: 'linear-gradient(135deg, #fbcfe8 0%, #fde68a 45%, #bfdbfe 100%)' },
            { value: 'forest', label: 'Ê£ÆÊûóÊé¢Èô©', icon: 'üå≥', swatch: 'linear-gradient(135deg, #d1fae5 0%, #f0fdf4 40%, #bbf7d0 100%)' },
            { value: 'ocean', label: 'Ê∑±Êµ∑Ëìù', icon: 'üê†', swatch: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 45%, #a5f3fc 100%)' },
            { value: 'buddy', label: 'ËìùËâ≤‰ºô‰º¥', icon: 'ü§ñ', swatch: 'linear-gradient(135deg, #bfdbfe 0%, #e0f2fe 45%, #93c5fd 100%)' },
          ],

          // Tabs
          activeTab: 'daily',

          // ÊØèÊó•‰ªªÂä°
          tasks: [],
          newTaskTitle: '',

          // Ê®°ÊùøÁÆ°ÁêÜ
          templates: [],
          selectedTemplateId: '',
          showTemplateManager: false,
          newTemplateName: '',
          editingTemplateId: '',
          editingTemplateName: {},
          newTaskForTemplate: {},

          // XP / Á≠âÁ∫ß
          xp: 0,

          // ËÆ∞ÂøÜÊåëÊàò
          memoryDraft: {
            title: '',
            content: ''
          },
          memoryList: [],
          memorySchedule: [],
          memoryViewMode: 'list',
          memoryCategory: 'poetry', // 'poetry', 'english', 'science'
          currentWeekStart: null,
          showMemoryManager: false,
          batchImportStartDate: '',
          batchImportEndDate: '',
          
          batchImportData: '',
          previewTasks: [],
          reviewStatusCache: {}, // ÁºìÂ≠òÂ§ç‰π†Áä∂ÊÄÅÔºåÊèêÂçáÊÄßËÉΩ
          editingMemoryId: null, // Ê≠£Âú®ÁºñËæëÁöÑËÆ∞ÂøÜÈ°πID
          editingMemoryTitle: '',
          editingMemoryContent: '',
          showAddTodayModal: false, // Ê∑ªÂä†‰ªäÂ§©ÂÜÖÂÆπÁöÑÂºπÁ™ó
          newTodayMemory: {
            title: '',
            content: '',
            date: '',
            dynasty: '',
            author: '',
            categoryName: ''
          },
          showResetConfirm: false, // ÊòæÁ§∫ÈáçÁΩÆÁ°ÆËÆ§ÂºπÁ™óÔºàÂ∑≤Â∫üÂºÉÔºåÊîπÁî®ÂéüÁîü confirmÔºâ

          // ËØ≠Èü≥ÈºìÂä±
          isRecording: false,
          mediaRecorder: null,
          recordedChunks: [],
          audioUrl: '',
          recordingStream: null,

          // Ë°®Êâ¨‰ø°
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false, // Ê†áËÆ∞Áî®Êà∑ÊòØÂê¶‰∏ªÂä®ÊâìÂºÄËÆ∞ÂøÜÁÆ°ÁêÜÂºπÁ™ó
          _userInitiatedMonthlyReport: false, // Ê†áËÆ∞Áî®Êà∑ÊòØÂê¶‰∏ªÂä®ÊâìÂºÄË°®Êâ¨‰ø°ÂºπÁ™ó
          monthlyStats: {
            doneTasks: 0
          },

          // ÈöèÊú∫ÈºìÂä±ËØ≠
          quotes: [
            '‰Ω†ÊòØÊúÄÊ£íÁöÑÔºÅ',
            '‰ªäÂ§©‰πüÊòØÂÖÉÊ∞îÊª°Êª°ÁöÑ‰∏ÄÂ§©ÔΩû',
            'ÊØè‰∏ÄÊ¨°ÂùöÊåÅÔºåÈÉΩÊòØÂú®‰∏∫Êú™Êù•ÁöÑËá™Â∑±Âä†Ê≤π„ÄÇ',
            'ËÆ§ÁúüÂÆåÊàê‰∏Ä‰ª∂Â∞è‰∫ãÔºåÂ∞±ÊòØ‰∫Ü‰∏çËµ∑ÁöÑÂãáÊ∞î„ÄÇ',
            '‰Ω†ÁöÑÂ∞èËÑëË¢ãÁìúÂÑøÁúüËÅ™ÊòéÔºÅ',
            'ÂÜçÂ§ö‰∏ÄÊ≠•ÔºåÂ∞±ÊØîÊò®Â§©Êõ¥ÂéâÂÆ≥‰∫Ü„ÄÇ',
            'Â≠¶‰π†Â∞±ÂÉèÂçáÁ∫ßÊâìÊÄ™Ôºå‰Ω†Â∑≤ÁªèÈóØËøáÂ•ΩÂ§öÂÖ≥Âï¶ÔºÅ'
          ],
          currentQuote: '',
          encourageCollapsed: true,
          headerExpanded: false,
          stickerBookCollapsed: true,
          debugBuildEnabled: false,
          buildLabel: 'BUILD 2026-02-22-0001',

          // ÂÆ∂Èïø‰∏éÊ°£Ê°à
          profiles: [],
          activeProfileId: '',
          newProfileName: '',
          newProfileAge: 8,
          showSettings: false,
          settingsSection: 'home',
          isParentUnlocked: false,
          parentPinSet: false,
          deferredPrompt: null,
          showInstall: false,
          showIosInstallHint: false,
          // Senior ÁªüËÆ°ËßÜÂõæÁä∂ÊÄÅ
          seniorStatsRange: 'today', // 'today' | 'week'
          seniorStatsTick: 0,
          rewardToast: {
            visible: false,
            title: '',
            subtitle: '',
            xp: 0
          },
          allDoneToast: {
            visible: false,
            title: '',
            subtitle: ''
          },
          dragIndex: null,
          showConfetti: false,
          confettiSeed: 0,
          confettiPieces: 18,
          juniorStickers: {
            items: [],
            hintVisible: false,
            latestId: ''
          }
        };
      },
      computed: {
        // ÊéßÂà∂ÂºπÁ™óÊòæÁ§∫ÁöÑËÆ°ÁÆóÂ±ûÊÄßÔºàÈ¢ùÂ§ñ‰øùÊä§Â±ÇÔºâ
        shouldShowMemoryManager() {
          return this.showMemoryManager && this._userInitiatedMemoryManager;
        },
        shouldShowMonthlyReport() {
          return this.showMonthlyReport && this._userInitiatedMonthlyReport;
        },
        showBuildTag() {
          return this.debugBuildEnabled;
        },
        activeProfile() {
          return this.profiles.find(p => p.id === this.activeProfileId) || { name: 'Â≠©Â≠ê', age: 8 };
        },
        ageGroup() {
          return (Number(this.activeProfile.age) || 8) >= 10 ? 'senior' : 'junior';
        },
        isOlderKid() {
          return this.ageGroup === 'senior';
        },
        iconSet() {
          const map = {
            candy: {
              book: 'icon-candy-book', map: 'icon-candy-map', brain: 'icon-candy-brain',
              chart: 'icon-candy-chart', mic: 'icon-candy-mic', star: 'icon-candy-star', award: 'icon-candy-award'
            },
            forest: {
              book: 'icon-forest-book', map: 'icon-forest-map', brain: 'icon-forest-brain',
              chart: 'icon-forest-chart', mic: 'icon-forest-mic', star: 'icon-forest-star', award: 'icon-forest-award'
            },
            ocean: {
              book: 'icon-ocean-book', map: 'icon-ocean-map', brain: 'icon-ocean-brain',
              chart: 'icon-ocean-chart', mic: 'icon-ocean-mic', star: 'icon-ocean-star', award: 'icon-ocean-award'
            },
            buddy: {
              book: 'icon-ocean-book', map: 'icon-ocean-map', brain: 'icon-ocean-brain',
              chart: 'icon-ocean-chart', mic: 'icon-ocean-mic', star: 'icon-ocean-star', award: 'icon-ocean-award'
            }
          };
          return map[this.theme] || map.forest;
        },
        // ÂΩìÂâç‰∏ªÈ¢òÁöÑËÉåÊôØÊ†∑ÂºèÔºà‰ΩøÁî®ÂÜÖËÅî styleÔºåÈÅøÂÖç Tailwind CDN Êâ´Êèè‰∏çÂà∞Âä®ÊÄÅÁ±ªÔºâ
        themeConfig() {
            const map = {
              forest: {
                style: {
                '--theme-bg': 'linear-gradient(135deg, #c9f7dc 0%, #ecfff4 45%, #c1f2b6 100%), radial-gradient(120px 80px at 12% 18%, rgba(34, 197, 94, 0.14), transparent 60%), radial-gradient(140px 90px at 85% 12%, rgba(16, 185, 129, 0.12), transparent 62%), radial-gradient(120px 80px at 78% 78%, rgba(34, 197, 94, 0.12), transparent 60%)',
                '--theme-border': 'rgba(16, 185, 129, 0.65)',
                '--theme-tint': '#d8ffe8',
                '--primary-start': '#00A699',
                '--primary-end': '#00C1AE',
                '--accent-start': '#FF385C',
                '--accent-end': '#FF5A5F',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              ocean: {
                style: {
                '--theme-bg': 'linear-gradient(145deg, #b5ecff 0%, #e3f7ff 45%, #9ccfff 100%), radial-gradient(140px 90px at 18% 20%, rgba(59, 130, 246, 0.14), transparent 62%), radial-gradient(160px 100px at 82% 18%, rgba(14, 165, 233, 0.12), transparent 62%), radial-gradient(140px 90px at 80% 78%, rgba(59, 130, 246, 0.12), transparent 60%)',
                '--theme-border': 'rgba(14, 165, 233, 0.65)',
                '--theme-tint': '#d6f4ff',
                '--primary-start': '#007A87',
                '--primary-end': '#00A699',
                '--accent-start': '#FF385C',
                '--accent-end': '#FF5A5F',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              candy: {
                style: {
                '--theme-bg': 'linear-gradient(135deg, #ffd9ea 0%, #fff1c8 45%, #d7e9ff 100%), radial-gradient(140px 90px at 16% 18%, rgba(244, 114, 182, 0.16), transparent 62%), radial-gradient(160px 100px at 82% 16%, rgba(59, 130, 246, 0.12), transparent 62%), radial-gradient(140px 90px at 78% 78%, rgba(251, 191, 36, 0.12), transparent 62%)',
                '--theme-border': 'rgba(255, 56, 92, 0.7)',
                '--theme-tint': '#ffe4ef',
                '--primary-start': '#FF385C',
                '--primary-end': '#FF5A5F',
                '--accent-start': '#00A699',
                '--accent-end': '#00C1AE',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              },
              buddy: {
                style: {
                '--theme-bg': 'linear-gradient(145deg, #bedaff 0%, #e7f1ff 45%, #9cc1ff 100%), radial-gradient(150px 100px at 22% 20%, rgba(59, 130, 246, 0.16), transparent 62%), radial-gradient(170px 110px at 78% 18%, rgba(14, 165, 233, 0.14), transparent 62%), radial-gradient(150px 100px at 72% 78%, rgba(59, 130, 246, 0.12), transparent 60%)',
                '--theme-border': 'rgba(59, 130, 246, 0.7)',
                '--theme-tint': '#dbeafe',
                '--primary-start': '#3B82F6',
                '--primary-end': '#60A5FA',
                '--accent-start': '#06B6D4',
                '--accent-end': '#22D3EE',
                '--warm-start': '#FF8A3D',
                '--warm-end': '#FFB457'
                }
              }
            };
          return map[this.theme] || map.forest;
        },
        // ‰ªäÂ§©Êó•ÊúüÂ≠óÁ¨¶‰∏≤
        todayKey() {
          const d = new Date();
          return this.toLocalDateKey(d); // YYYY-MM-DD (local)
        },
        todayLabel() {
          const d = new Date();
          const weekNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
          return `${d.getFullYear()}Âπ¥${d.getMonth() + 1}Êúà${d.getDate()}Êó•ÔºàÂë®${weekNames[d.getDay()]}Ôºâ`;
        },
        // Ê®°ÊùøÊèêÁ§∫ÊñáÊ°à
        templateInfo() {
          if (!this.tasks.length) return '';
          return '‰ªäÂ§©ÁöÑ‰ªªÂä°ÂàóË°®‰ºö‰Ωú‰∏∫‚ÄúÈªòËÆ§Ê®°Êùø‚Äù‰øùÂ≠òÔºåÊòéÂ§©Ëá™Âä®Âä†ËΩΩ„ÄÇ';
        },
        // Á≠âÁ∫ß/Áß∞Âè∑ËÆ°ÁÆó
        levelDisplay() {
          const xp = this.xp;
          let level = 1;
          let nextXp = 50;

          if (xp < 50) {
            level = 1; nextXp = 50;
          } else if (xp < 150) {
            level = 2; nextXp = 150;
          } else if (xp < 300) {
            level = 3; nextXp = 300;
          } else if (xp < 500) {
            level = 4; nextXp = 500;
          } else {
            level = 5; nextXp = 800;
          }

          let title = '‰π¶Á´•';
          if (level === 2) title = 'Â≠¶Âæí';
          if (level === 3) title = 'Â∞èÊâçÂ≠ê';
          if (level === 4) title = 'ÁßÄÊâç';
          if (level >= 5) title = 'Â∞èÁä∂ÂÖÉ';

          const prevXp = level === 1 ? 0 :
            level === 2 ? 50 :
            level === 3 ? 150 :
            level === 4 ? 300 : 500;
          const range = nextXp - prevXp;
          const progress = Math.min(100, Math.max(0, ((xp - prevXp) / range) * 100));

          return { level, title, nextXp, progress: progress.toFixed(1) };
        },
        todayProgress() {
          const total = this.tasks.length;
          const done = this.tasks.filter(t => t.done).length;
          const percent = total === 0 ? 0 : Math.round((done / total) * 100);
          return { total, done, percent };
        },
        progressRing() {
          const radius = 28;
          const circumference = 2 * Math.PI * radius;
          const percent = this.todayProgress.percent / 100;
          return {
            circumference,
            offset: circumference * (1 - percent)
          };
        },
        todayJuniorStickers() {
          return this.juniorStickers.items.filter(item => item.dayKey === this.todayKey);
        },
        latestJuniorSticker() {
          if (!this.juniorStickers.latestId) return null;
          return this.juniorStickers.items.find(item => item.id === this.juniorStickers.latestId) || null;
        },
        seniorStatsSource() {
          // ‰æùËµñËß¶ÂèëÔºö‰ªªÂä°/Â§ç‰π†/Ê°£Ê°àÂàáÊç¢ÂêéÈáçÁÆó
          const reactiveTick = `${this.activeProfileId}|${this.seniorStatsTick}|${this.tasks.length}|${this.memorySchedule.length}|${this.xp}`;
          if (!reactiveTick && reactiveTick !== '0') {
            return { tasksByDay: {}, scheduleByDay: {} };
          }
          let tasksByDay = {};
          const rawTasks = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (rawTasks) {
            try {
              const parsed = JSON.parse(rawTasks);
              tasksByDay = parsed && typeof parsed === 'object' ? parsed : {};
            } catch (e) {
              tasksByDay = {};
            }
          }

          const scheduleByDay = {};
          const rawSchedule = localStorage.getItem(this.getStorageKey('memory_schedule'));
          if (rawSchedule) {
            try {
              const parsedSchedule = JSON.parse(rawSchedule);
              if (Array.isArray(parsedSchedule)) {
                parsedSchedule.forEach(item => {
                  if (!item || !item.dayKey) return;
                  if (!scheduleByDay[item.dayKey]) {
                    scheduleByDay[item.dayKey] = [];
                  }
                  scheduleByDay[item.dayKey].push(item);
                });
              }
            } catch (e) {
              // ignore parse error and use empty schedule
            }
          }
          return { tasksByDay, scheduleByDay };
        },
        seniorTodaySummary() {
          return this.getSeniorSummaryByDay(this.todayKey);
        },
        seniorWeekDayKeys() {
          return this.getCurrentWeekDayKeys();
        },
        seniorWeekSummary() {
          const weekToDateKeys = this.seniorWeekDayKeys.filter(dayKey => dayKey <= this.todayKey);
          const summary = this.getSeniorRangeSummary(weekToDateKeys);
          return {
            ...summary,
            streak: this.getSeniorWeekStreak(weekToDateKeys)
          };
        },
        seniorSevenDayStats() {
          return this.getRecentDayKeys(7).map(dayKey => {
            const summary = this.getSeniorSummaryByDay(dayKey);
            return {
              dayKey,
              label: this.getShortDayLabel(dayKey),
              completionRate: summary.completionRate,
              focusMinutes: summary.focusMinutes
            };
          });
        },
        seniorChartModel() {
          const days = this.seniorSevenDayStats;
          const width = 360;
          const height = 190;
          const left = 34;
          const right = 14;
          const top = 16;
          const bottom = 46;
          const plotW = width - left - right;
          const plotH = height - top - bottom;
          const maxFocus = Math.max(1, ...days.map(d => d.focusMinutes || 0));
          const step = days.length > 1 ? plotW / (days.length - 1) : plotW;
          const barW = Math.min(22, Math.max(10, step * 0.5));

          const points = days.map((d, idx) => {
            const x = left + step * idx;
            const y = top + plotH - (Math.max(0, Math.min(100, d.completionRate)) / 100) * plotH;
            return { key: d.dayKey, x, y };
          });
          const bars = days.map((d, idx) => {
            const centerX = left + step * idx;
            const barH = Math.max(1, (Math.max(0, d.focusMinutes) / maxFocus) * plotH);
            return {
              key: d.dayKey,
              x: centerX - barW / 2,
              y: top + plotH - barH,
              width: barW,
              height: barH
            };
          });
          const labels = days.map((d, idx) => ({
            key: d.dayKey,
            x: left + step * idx,
            text: d.label
          }));
          return {
            maxFocus,
            points,
            bars,
            labels,
            linePoints: points.map(p => `${p.x},${p.y}`).join(' ')
          };
        },
        memoryCategoryLabel() {
          const map = {
            poetry: 'Âè§ËØóËØç',
            english: 'Ëã±ËØ≠',
            science: 'Êï∞ÁêÜÂåñ'
          };
          return map[this.memoryCategory] || 'ËÆ∞ÂøÜ';
        },
        batchImportPlaceholder() {
          if (this.memoryCategory === 'poetry') {
            return '‰æãÂ¶ÇÔºö\\nÈùôÂ§úÊÄù,Âîê,ÊùéÁôΩ\\nÁôªÈπ≥ÈõÄÊ•º,Âîê,Áéã‰πãÊ∂£';
          }
          if (this.memoryCategory === 'english') {
            return '‰æãÂ¶ÇÔºö\\napple,ËãπÊûú\\nI like apples,ÊàëÂñúÊ¨¢ËãπÊûú';
          }
          return '‰æãÂ¶ÇÔºö\\nÂá†‰Ωï,a¬≤ + b¬≤ = c¬≤,Áõ¥Ëßí‰∏âËßíÂΩ¢ÂãæËÇ°ÂÆöÁêÜ\\nÂåñÂ≠¶,NaCl + AgNO‚ÇÉ = AgCl‚Üì + NaNO‚ÇÉ,Ê≤âÊ∑ÄÂèçÂ∫î';
        },
        batchImportTip() {
          if (this.memoryCategory === 'poetry') {
            return 'Ê†ºÂºèÔºöËØóÂêç,Êúù‰ª£,‰ΩúËÄÖÔºàÈÄóÂè∑ÂàÜÈöîÔºâ';
          }
          if (this.memoryCategory === 'english') {
            return 'Ê†ºÂºèÔºöÂçïËØç/Âè•Â≠ê,Ê≥®ÈáäÔºàÈÄóÂè∑ÂàÜÈöîÔºâ';
          }
          return 'Ê†ºÂºèÔºöÁ±ªÂà´,ÂÖ¨Âºè,Ê≥®ÈáäÔºàÈÄóÂè∑ÂàÜÈöîÔºâ';
        },
        batchImportRangeHint() {
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            return 'ÊèêÁ§∫ÔºöÈÄâÂ•ΩËµ∑Ê≠¢Êó•ÊúüÂêéÔºå‰ºöÊòæÁ§∫ÂèØÁî®Â§©Êï∞';
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          const days = Math.floor((end - start) / (24 * 60 * 60 * 1000)) + 1;
          if (days <= 0) return 'Êó•ÊúüËåÉÂõ¥‰∏çÂêàÊ≥ïÔºåËØ∑Ê£ÄÊü•';
          const lineCount = this.previewTasks.length || 0;
          return `ÂèØÁî® ${days} Â§© ¬∑ Â∑≤ËæìÂÖ• ${lineCount} Ë°å`;
        },
        // ÂΩìÂâçÂë®ÁöÑÂºÄÂßãÊó•Êúü
        currentWeekLabel() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          return `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
        },
        // ÂΩìÂâçÂë®ÁöÑÊâÄÊúâÊó•ÊúüÔºà‰øùÁïôÁî®‰∫éÂÖ∂‰ªñÂäüËÉΩÔºâ
        currentWeekDays() {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          const weekDays = [];
          const start = this.getWeekStart();
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(start);
            date.setDate(start.getDate() + i);
            const dayKey = this.toLocalDateKey(date);
            const weekNames = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
            const tasks = this.memorySchedule
              .filter(s => s.dayKey === dayKey)
              .map(s => {
                const base = this.memoryList.find(m => m.id === s.baseId);
                return base && base.category === this.memoryCategory ? {
                  ...s,
                  content: base ? base.content : s.content || ''
                } : null;
              });
            const filteredTasks = tasks.filter(Boolean);
            
            weekDays.push({
              key: dayKey,
              label: `Âë®${weekNames[date.getDay()]}`,
              date: `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`,
              isToday: dayKey === todayKey,
              tasks: filteredTasks
            });
          }
          return weekDays;
        },

        // Âë®ËßÜÂõæËÆ∞ÂøÜÈ°πÔºàÊåâÂ≠¶‰π†È°πÂàÜÁªÑÔºåÊòæÁ§∫ÊâÄÊúâÂ§ç‰π†Êó∂Èó¥ÁÇπÔºâ
        weeklyMemoryItems() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          const startKey = this.toLocalDateKey(start);
          const endKey = this.toLocalDateKey(end);
          const todayKey = this.toLocalDateKey(new Date());
          
          // ÊâæÂá∫Êú¨Âë®ÂÜÖÂàùÂßãÂ≠¶‰π†ÁöÑÊâÄÊúâËÆ∞ÂøÜÈ°πÔºå‰ª•ÂèäÊú¨Âë®ÈúÄË¶ÅÂ§ç‰π†ÁöÑ‰ªªÂä°
          const learnedThisWeek = [];
          const reviewThisWeek = [];
          
          // Êú¨Âë®Â≠¶‰π†ÁöÑÈ°πÁõÆ
          this.memoryList.forEach(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            if (learnKey >= startKey && learnKey <= endKey) {
              learnedThisWeek.push(m);
            }
          });
          
          // Êú¨Âë®ÈúÄË¶ÅÂ§ç‰π†ÁöÑÈ°πÁõÆÔºàÂåÖÊã¨‰πãÂâçÂ≠¶‰π†‰ΩÜÊú¨Âë®ÈúÄË¶ÅÂ§ç‰π†ÁöÑÔºâ
          const scheduleMap = {};
          this.memorySchedule.forEach(s => {
            if (s.dayKey >= startKey && s.dayKey <= endKey) {
              if (!scheduleMap[s.baseId]) {
                scheduleMap[s.baseId] = [];
              }
              scheduleMap[s.baseId].push(s);
            }
          });
          
          // ÂêàÂπ∂ÊâÄÊúâÈúÄË¶ÅÊòæÁ§∫ÁöÑÈ°πÁõÆ
          const allItems = new Map();
          
          // Ê∑ªÂä†Êú¨Âë®Â≠¶‰π†ÁöÑÈ°πÁõÆ
          learnedThisWeek.forEach(m => {
            allItems.set(m.id, m);
          });
          
          // Ê∑ªÂä†Êú¨Âë®ÈúÄË¶ÅÂ§ç‰π†ÁöÑÈ°πÁõÆÔºàÂ¶ÇÊûú‰∏çÂú®Êú¨Âë®Â≠¶‰π†ÂàóË°®‰∏≠Ôºâ
          Object.keys(scheduleMap).forEach(baseId => {
            if (!allItems.has(baseId)) {
              const base = this.memoryList.find(m => m.id === baseId);
              if (base) {
                allItems.set(baseId, base);
              }
            }
          });
          
          // ÊåâÂàÜÁ±ªËøáÊª§Ôºà‰ΩøÁî®ÊòæÂºèÂàÜÁ±ªÂ≠óÊÆµÔºâ
          let filteredItems = Array.from(allItems.values()).filter(m => m.category === this.memoryCategory);
          
          // ËΩ¨Êç¢‰∏∫ÊòæÁ§∫Ê†ºÂºè
          const items = filteredItems.map(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            
            // ‰ΩøÁî®ÁºìÂ≠ò‰ºòÂåñÊÄßËÉΩ
            const cacheKey = `${m.id}_${this.currentWeekStart?.getTime() || 0}`;
            if (this.reviewStatusCache[cacheKey]) {
              return this.reviewStatusCache[cacheKey];
            }
            
            // ËÆ°ÁÆóÊâÄÊúâÂ§ç‰π†Êó∂Èó¥ÁÇπ
            const reviews = {};
            
            // Âç≥Êó∂Â§ç‰π†Êó∂Èó¥ÁÇπÔºà5ÂàÜÈíü„ÄÅ30ÂàÜÈíü„ÄÅ12Â∞èÊó∂Ôºâ
            const learnTime = learnDate.getTime();
            
            // 5ÂàÜÈíüÂêé
            const fiveMinLater = new Date(learnTime + 5 * 60 * 1000);
            reviews['5min'] = {
              done: this.getReviewStatus(m.id, '5min'),
              date: this.formatReviewTime(fiveMinLater),
              timestamp: fiveMinLater.getTime()
            };
            
            // 30ÂàÜÈíüÂêé
            const thirtyMinLater = new Date(learnTime + 30 * 60 * 1000);
            reviews['30min'] = {
              done: this.getReviewStatus(m.id, '30min'),
              date: this.formatReviewTime(thirtyMinLater),
              timestamp: thirtyMinLater.getTime()
            };
            
            // 12Â∞èÊó∂Âêé
            const twelveHLater = new Date(learnTime + 12 * 60 * 60 * 1000);
            reviews['12h'] = {
              done: this.getReviewStatus(m.id, '12h'),
              date: this.formatReviewTime(twelveHLater),
              timestamp: twelveHLater.getTime()
            };
            
            // ËâæÂÆæÊµ©ÊñØÂ§ç‰π†Êó•ÊúüÔºà+1, +2, +4, +7, +15, +30Â§©Ôºâ
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(learnDate);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewKey = this.toLocalDateKey(reviewDate);
              
              // Êü•ÊâæÂØπÂ∫îÁöÑÂ§ç‰π†ËÆ°Âàí
              const scheduleItem = this.memorySchedule.find(s => 
                s.baseId === m.id && s.offsetDay === offset && s.dayKey === reviewKey
              );
              
              reviews[offset] = {
                done: scheduleItem ? scheduleItem.done : false,
                date: `${reviewDate.getMonth() + 1}/${reviewDate.getDate()}`,
                scheduleId: scheduleItem ? scheduleItem.id : null,
                dayKey: reviewKey,
                isThisWeek: reviewKey >= startKey && reviewKey <= endKey
              };
            });
            
            const relatedSchedules = scheduleMap[m.id] || [];
            const fallbackContent = relatedSchedules.find(s => s && s.content)?.content || '';
            const item = {
              id: m.id,
              title: m.title,
              content: m.content || fallbackContent,
              dynasty: m.dynasty || '',
              author: m.author || '',
              learnDate: `${learnDate.getMonth() + 1}/${learnDate.getDate()}`,
              learnYear: String(learnDate.getFullYear()),
              learnKey,
              reviews,
              isLearnedThisWeek: learnKey >= startKey && learnKey <= endKey
            };
            
            // ÁºìÂ≠òÁªìÊûú
            this.reviewStatusCache[cacheKey] = item;
            return item;
          })
          .sort((a, b) => {
            // ‰ºòÂÖàÊòæÁ§∫Êú¨Âë®Â≠¶‰π†ÁöÑÔºåÁÑ∂ÂêéÊåâÊó•ÊúüÊéíÂ∫è
            if (a.isLearnedThisWeek !== b.isLearnedThisWeek) {
              return a.isLearnedThisWeek ? -1 : 1;
            }
            return a.learnKey.localeCompare(b.learnKey);
          });
          
          return items;
        }
      },
      methods: {
        // ‰∏ªÈ¢òÂàáÊç¢
        setTheme(value) {
          this.theme = value;
          localStorage.setItem(this.getStorageKey('theme'), value);
          this.applyBodyTheme();
        },
        normalizeAge(age) {
          const n = Number(age);
          if (!Number.isFinite(n)) return 8;
          return Math.max(3, Math.min(18, Math.round(n)));
        },
        onProfileEdited(profile) {
          profile.age = this.normalizeAge(profile.age);
          profile.name = (profile.name || '').trim() || 'Â≠©Â≠ê';
          this.saveProfiles();
          if (profile.id === this.activeProfileId) {
            this.onAgeGroupChanged();
          }
        },
        onAgeGroupChanged() {
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
          this.applyBodyTheme();
        },
        ensureActiveTabForAgeGroup() {
          const allowedTabs = this.ageGroup === 'senior'
            ? ['daily', 'memory', 'stats']
            : ['daily', 'memory'];
          if (!allowedTabs.includes(this.activeTab)) {
            this.activeTab = 'daily';
          }
          if (this.ageGroup !== 'senior' && this.settingsSection === 'stats') {
            this.settingsSection = 'home';
          }
        },
        openSeniorStats() {
          if (this.ageGroup !== 'senior') return;
          this.activeTab = 'stats';
          this.showSettings = false;
          this.settingsSection = 'home';
        },
        initDebugMode() {
          const params = new URLSearchParams(window.location.search);
          const queryValue = params.get('debug');
          const stored = localStorage.getItem(this.getStorageKey('debug_build_tag'));
          if (queryValue === '1') {
            this.debugBuildEnabled = true;
            localStorage.setItem(this.getStorageKey('debug_build_tag'), '1');
            return;
          }
          if (queryValue === '0') {
            this.debugBuildEnabled = false;
            localStorage.removeItem(this.getStorageKey('debug_build_tag'));
            return;
          }
          this.debugBuildEnabled = stored === '1';
        },
        toggleDebugBuild() {
          this.debugBuildEnabled = !this.debugBuildEnabled;
          if (this.debugBuildEnabled) {
            localStorage.setItem(this.getStorageKey('debug_build_tag'), '1');
          } else {
            localStorage.removeItem(this.getStorageKey('debug_build_tag'));
          }
        },
        toggleHeaderExpanded() {
          this.headerExpanded = !this.headerExpanded;
        },
        collapseHeader() {
          this.headerExpanded = false;
        },
        syncStickerBookCollapse() {
          this.stickerBookCollapsed = this.todayJuniorStickers.length === 0;
        },
        toggleStickerBook() {
          this.stickerBookCollapsed = !this.stickerBookCollapsed;
        },

        // ‰∏ÄÈîÆÊ∏ÖÁºìÂ≠òÔºàService Worker + Cache StorageÔºâ
        clearAppCache() {
          const confirmed = confirm('Â∞ÜÊ∏ÖÈô§Á¶ªÁ∫øÁºìÂ≠òÂπ∂Âà∑Êñ∞È°µÈù¢ÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü');
          if (!confirmed) return;
          if ('caches' in window) {
            caches.keys()
              .then(keys => Promise.all(keys.map(key => caches.delete(key))))
              .then(() => {
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                  navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
                }
                location.reload();
              })
              .catch(() => location.reload());
          } else {
            location.reload();
          }
        },

        // Âä†ËΩΩ‰ªäÊó•‰ªªÂä°
        loadTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          const localKey = this.todayKey;
          const utcKey = this.toUTCDateKey(new Date());
          const todayTasks = byDay[localKey] || byDay[utcKey];

          if (todayTasks && Array.isArray(todayTasks)) {
            // ‰∏∫ÊóßÊï∞ÊçÆÊ∑ªÂä†Êó∂Èó¥Êà≥ÔºàÂêëÂêéÂÖºÂÆπÔºâ
            this.tasks = todayTasks.map(task => {
              if (!task.createdAt) {
                task.createdAt = new Date().toISOString();
              }
              if (!task.updatedAt) {
                task.updatedAt = new Date().toISOString();
              }
              return task;
            });
            // ÂÖºÂÆπËøÅÁßªÔºöÂ∞Ü UTC key ÁöÑÊï∞ÊçÆÊò†Â∞ÑÂà∞Êú¨Âú∞ key
            if (!byDay[localKey] && byDay[utcKey]) {
              byDay[localKey] = todayTasks;
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            }
            } else {
              this.tasks = [];
          }
          this.syncStickerBookCollapse();
        },

        saveTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          byDay[this.todayKey] = this.tasks;
          localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
        },
        loadJuniorStickers() {
          const raw = localStorage.getItem(this.getStorageKey('junior_stickers'));
          if (!raw) {
            this.juniorStickers.items = [];
            this.juniorStickers.hintVisible = false;
            this.juniorStickers.latestId = '';
            return;
          }
          try {
            const parsed = JSON.parse(raw);
            this.juniorStickers.items = Array.isArray(parsed) ? parsed : [];
          } catch (e) {
            this.juniorStickers.items = [];
          }
          this.juniorStickers.hintVisible = false;
          this.juniorStickers.latestId = '';
        },
        saveJuniorStickers() {
          localStorage.setItem(this.getStorageKey('junior_stickers'), JSON.stringify(this.juniorStickers.items));
        },
        pickJuniorSticker(task) {
          const pool = [
            { emoji: '‚≠ê', name: 'Èó™‰∫ÆÊòü' },
            { emoji: 'üöÄ', name: 'ÂÜ≤Âà∫ÁÅ´ÁÆ≠' },
            { emoji: 'ü¶Å', name: 'ÂãáÊ∞îÁãÆÂ≠ê' },
            { emoji: 'üåà', name: 'ÂΩ©ËôπËÉΩÈáè' },
            { emoji: 'üê¨', name: 'Êµ∑Ë±ö‰ºô‰º¥' },
            { emoji: 'üéØ', name: 'ÂëΩ‰∏≠ÁõÆÊ†á' },
            { emoji: 'üçÄ', name: 'Âπ∏ËøêÂõõÂè∂Ëçâ' },
            { emoji: 'üß†', name: 'ËÅ™ÊòéÂ§ßËÑë' }
          ];
          const seed = `${task.id || ''}-${task.title || ''}-${this.todayKey}`;
          let hash = 0;
          for (let i = 0; i < seed.length; i += 1) {
            hash = (hash * 31 + seed.charCodeAt(i)) | 0;
          }
          return pool[Math.abs(hash) % pool.length];
        },
        awardJuniorSticker(task) {
          if (this.ageGroup !== 'junior') return;
          if (!task || !task.id) return;
          const alreadyAwarded = this.juniorStickers.items.some(item =>
            item.taskId === task.id && item.dayKey === this.todayKey
          );
          if (alreadyAwarded) return;
          const sticker = this.pickJuniorSticker(task);
          const entry = {
            id: `${task.id}_${Date.now()}`,
            taskId: task.id,
            dayKey: this.todayKey,
            awardedAt: new Date().toISOString(),
            emoji: sticker.emoji,
            name: sticker.name
          };
          this.juniorStickers.items.push(entry);
          this.juniorStickers.latestId = entry.id;
          this.juniorStickers.hintVisible = true;
          this.stickerBookCollapsed = false;
          clearTimeout(this._stickerHintTimer);
          this._stickerHintTimer = setTimeout(() => {
            this.juniorStickers.hintVisible = false;
          }, 1600);
          this.saveJuniorStickers();
        },

        // Ê®°ÊùøÁÆ°ÁêÜ
        loadTemplates() {
          const raw = localStorage.getItem(this.getStorageKey('templates'));
          if (raw) {
            try {
              this.templates = JSON.parse(raw);
            } catch (e) {
              this.templates = [];
            }
          } else {
            this.templates = [];
          }
        },

        saveTemplates() {
          localStorage.setItem(this.getStorageKey('templates'), JSON.stringify(this.templates));
        },

        createTemplateFromCurrent() {
          if (!this.newTemplateName.trim()) {
            alert('ËØ∑ËæìÂÖ•Ê®°ÊùøÂêçÁß∞');
            return;
          }
          if (this.tasks.length === 0) {
            alert('ÂΩìÂâçÊ≤°Êúâ‰ªªÂä°ÔºåÊó†Ê≥ïÂàõÂª∫Ê®°Êùø');
            return;
          }
          const template = {
            id: this.uuid(),
            name: this.newTemplateName.trim(),
            tasks: this.tasks.map(t => ({
              title: t.title,
              note: t.note || ''
              // Ê®°Êùø‰∏ç‰øùÂ≠òÊó∂Èó¥‰ø°ÊÅØÔºåÂõ†‰∏∫ÊØèÊ¨°Â∫îÁî®Ê®°ÊùøÊó∂ÈÉΩÊòØÊñ∞ÁöÑÂºÄÂßã
            })),
            createdAt: new Date().toISOString()
          };
          this.templates.push(template);
          this.saveTemplates();
          this.newTemplateName = '';
          alert('Ê®°ÊùøÂàõÂª∫ÊàêÂäüÔºÅ');
        },

        applyTemplate() {
          if (!this.selectedTemplateId) return;
          this.applyTemplateById(this.selectedTemplateId);
        },

        applyTemplateById(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          
          // Á°ÆËÆ§ÊòØÂê¶Ë¶ÜÁõñÂΩìÂâç‰ªªÂä°
          if (this.tasks.length > 0) {
            if (!confirm(`Â∫îÁî®Ê®°Êùø"${template.name}"Â∞ÜË¶ÜÁõñÂΩìÂâç‰ªªÂä°ÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü`)) {
              return;
            }
          }

          this.tasks = template.tasks.map(t => ({
            id: this.uuid(),
            title: t.title,
            note: t.note || '',
            startTime: '',
            endTime: '',
            done: false,
            coinAnimating: false
          }));
          this.saveTodayTasks();
          this.selectedTemplateId = '';
          this.showTemplateManager = false;
        },

        openTemplateManager() {
          if (!this.requireParentIfNeeded()) return;
          this.showTemplateManager = true;
        },

        deleteTemplate(templateId) {
          if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê®°ÊùøÂêóÔºü')) return;
          this.templates = this.templates.filter(t => t.id !== templateId);
          this.saveTemplates();
        },

        editTemplate(templateId) {
          if (this.editingTemplateId === templateId) {
            // ‰øùÂ≠òÁºñËæë
            this.saveTemplates();
            this.editingTemplateId = '';
            this.newTaskForTemplate = {};
            this.editingTemplateName = {};
          } else {
            // ÂºÄÂßãÁºñËæë
            this.editingTemplateId = templateId;
            const template = this.templates.find(t => t.id === templateId);
            if (template) {
              this.editingTemplateName = { ...this.editingTemplateName, [templateId]: template.name };
            }
            if (!this.newTaskForTemplate[templateId]) {
              this.newTaskForTemplate = { ...this.newTaskForTemplate, [templateId]: '' };
            }
          }
        },

        saveTemplateName(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (template && this.editingTemplateName[templateId]) {
            template.name = this.editingTemplateName[templateId].trim() || template.name;
            this.saveTemplates();
          }
        },

        addTaskToTemplate(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          const taskTitle = this.newTaskForTemplate[templateId]?.trim();
          if (!taskTitle) return;
          template.tasks.push({ title: taskTitle, note: '' });
          this.newTaskForTemplate[templateId] = '';
          this.saveTemplates();
        },

        removeTaskFromTemplate(templateId, taskIndex) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          template.tasks.splice(taskIndex, 1);
          this.saveTemplates();
        },

        // ‰ªªÂä°Êìç‰Ωú
        addTask() {
          if (!this.newTaskTitle.trim()) return;
          this.tasks.push({
            id: this.uuid(),
            title: this.newTaskTitle.trim(),
            note: '',
            startTime: '', // ÂºÄÂßãÊó∂Èó¥ÈÄöËøá"ÂºÄÂßã"ÊåâÈíÆËÆ∞ÂΩï
            endTime: '', // ÁªìÊùüÊó∂Èó¥Âú®‰ªªÂä°ÂÆåÊàêÊó∂Ëá™Âä®ËÆ∞ÂΩï
            done: false,
            coinAnimating: false,
            createdAt: new Date().toISOString(), // Ê∑ªÂä†ÂàõÂª∫Êó∂Èó¥Êà≥
            updatedAt: new Date().toISOString() // Ê∑ªÂä†Êõ¥Êñ∞Êó∂Èó¥Êà≥
          });
          this.newTaskTitle = '';
          this.saveTodayTasks();
        },
        startTask(task) {
          if (task.done || task.startTime) return;
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          task.startTime = `${hours}:${minutes}`;
          this.saveTodayTasks();
        },
        removeTask(index) {
          if (!this.requireParentIfNeeded(true)) return;
          this.tasks.splice(index, 1);
          this.saveTodayTasks();
        },
        toggleTask(task) {
          if (!task.startTime && !task.done) {
            alert('ËØ∑ÂÖàÁÇπÂáª‚ÄúÂºÄÂßã‚ÄùÂÜçÂÆåÊàê‰ªªÂä°„ÄÇ');
            return;
          }
          const wasDone = task.done;
          task.done = !task.done;
          if (task.done) {
            // XP Â•ñÂä±ÔºàÂè™Â•ñÂä±‰∏ÄÊ¨°ÔºåÈÅøÂÖçÈáçÂ§çÂà∑ÂàÜÔºâ
            if (!task.completedAt) {
              this.gainXp(10);
              this.awardJuniorSticker(task);
              const doneCount = this.tasks.filter(t => t.done).length;
              if (doneCount === 1) {
                this.showRewardToast({
                  title: 'È¶ñ‰∏™‰ªªÂä°ÂÆåÊàêÔºÅ',
                  subtitle: 'ÂºÄÂ±ÄÂ∞±ÂæàÊ£íÔºåÁªßÁª≠‰øùÊåÅÔΩû',
                  xp: 10
                });
              } else if (doneCount % 5 === 0) {
                this.showRewardToast({
                  title: `ÂÆåÊàê ${doneCount} ‰∏™‰ªªÂä°ÔºÅ`,
                  subtitle: 'ÊåÅÁª≠Âä™ÂäõÔºåËøõÂ∫¶È£ûËµ∑ÔΩû',
                  xp: 10
                });
              } else {
                this.showRewardToast({
                  title: 'ÂÆåÊàêÊâìÂç°ÔºÅ',
                  subtitle: 'ÊØè‰∏ÄÊ≠•ÈÉΩÁÆóÊï∞ÔΩû',
                  xp: 10
                });
              }
            }
            // ‰ªäÊó•ÂÖ®ÈÉ®ÂÆåÊàêÂ•ñÂä±ÔºàÊØèÂ§©‰∏ÄÊ¨°Ôºâ
            if (this.tasks.length > 0 && this.tasks.every(t => t.done)) {
              const todayKey = this.todayKey;
              const lastKey = localStorage.getItem(this.getStorageKey('all_done_key'));
              if (lastKey !== todayKey) {
                this.showAllDoneToast();
                this.triggerConfetti();
                localStorage.setItem(this.getStorageKey('all_done_key'), todayKey);
              }
            }
            // ÈáëÂ∏ÅÂä®Áîª
            task.coinAnimating = true;
            setTimeout(() => {
              task.coinAnimating = false;
            }, 600);
            // Ëá™Âä®ËÆ∞ÂΩïÁªìÊùüÊó∂Èó¥ÔºàÂ¶ÇÊûúËøòÊ≤°ÊúâËÆ∞ÂΩïÔºâ
            if (!task.endTime) {
              const now = new Date();
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              task.endTime = `${hours}:${minutes}`;
            }
            // ËÆ∞ÂΩïÂÆåÊàêÊó∂Èó¥Êà≥
            task.completedAt = new Date().toISOString();
          } else if (wasDone) {
            // ÂèñÊ∂àÂÆåÊàêÔºö‰øùÁïôÂ∑≤Â•ñÂä±Ê†áËÆ∞ÔºåÊ∏ÖÁ©∫ÁªìÊùüÊó∂Èó¥Êñπ‰æøÈáçÊñ∞ÂÆåÊàê
            task.endTime = '';
          }
          // Êõ¥Êñ∞‰øÆÊîπÊó∂Èó¥
          task.updatedAt = new Date().toISOString();
          this.saveTodayTasks();
        },

        // XP
        gainXp(amount) {
          this.xp += amount;
          localStorage.setItem(this.getStorageKey('xp'), String(this.xp));
        },

        // ÊàêÂ∞±Â•ñÂä±Âç°
        showRewardToast({ title, subtitle, xp }) {
          this.rewardToast = {
            visible: true,
            title,
            subtitle,
            xp
          };
          clearTimeout(this._rewardTimer);
          this._rewardTimer = setTimeout(() => {
            this.rewardToast.visible = false;
          }, 2200);
        },

        showAllDoneToast() {
          this.allDoneToast = {
            visible: true,
            title: '‰ªäÂ§©‰ªªÂä°ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ',
            subtitle: '‰∏∫ÂùöÊåÅÁÇπ‰∏™Â§ßÂ§ßÁöÑËµûÔΩû'
          };
          clearTimeout(this._allDoneTimer);
          this._allDoneTimer = setTimeout(() => {
            this.allDoneToast.visible = false;
          }, 2600);
        },

        triggerConfetti() {
          this.confettiSeed = Date.now();
          this.showConfetti = true;
          clearTimeout(this._confettiTimer);
          this._confettiTimer = setTimeout(() => {
            this.showConfetti = false;
          }, 1800);
        },

        confettiStyle(i) {
          const rand = (seed) => {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
          };
          const base = this.confettiSeed + i * 17;
          const left = Math.round(rand(base) * 90 + 5);
          const delay = (rand(base + 1) * 0.3).toFixed(2);
          const dur = (0.9 + rand(base + 2) * 0.9).toFixed(2);
          const colors = ['#f59e0b', '#10b981', '#38bdf8', '#f97316', '#ec4899', '#a855f7'];
          const color = colors[Math.floor(rand(base + 3) * colors.length)];
          return {
            '--x': `${left}%`,
            '--delay': `${delay}s`,
            '--dur': `${dur}s`,
            '--color': color
          };
        },

        // ÊãñÊãΩÊéíÂ∫è
        onDragStart(index) {
          this.dragIndex = index;
        },
        onDrop(index) {
          if (this.dragIndex === null || this.dragIndex === index) return;
          const moved = this.tasks.splice(this.dragIndex, 1)[0];
          this.tasks.splice(index, 0, moved);
          this.dragIndex = null;
          this.saveTodayTasks();
        },
        onDragEnd() {
          this.dragIndex = null;
        },

        // ËÆ∞ÂøÜÊåëÊàòÔºö‰øùÂ≠òËçâÁ®øÂπ∂Âü∫‰∫éËâæÂÆæÊµ©ÊñØÊõ≤Á∫øÁîüÊàêÊéíÊúü
        saveMemoryDraft() {
          if (!this.memoryDraft.title.trim()) return;
          const list = [...this.memoryList];
          const base = {
            id: this.uuid(),
            title: this.memoryDraft.title.trim(),
            content: this.memoryDraft.content.trim(),
            createdAt: new Date().toISOString()
          };
          list.push(base);
          this.memoryList = list;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(list));

          // ÁîüÊàêËâæÂÆæÊµ©ÊñØÂ§ç‰π†ËÆ°ÂàíÔºö+1 / +2 / +4 / +7 / +15 / +30 Â§©
          const offsets = [1, 2, 4, 7, 15, 30];
          const now = new Date();
          const schedule = [...this.memorySchedule];
          offsets.forEach(d => {
            const dt = new Date(now);
            dt.setDate(dt.getDate() + d);
            const dayKey = this.toLocalDateKey(dt);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              dayKey,
              offsetDay: d,
              done: false
            });
          });
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          this.memoryDraft.title = '';
          this.memoryDraft.content = '';
        },

        // ÊâìÂºÄËÆ∞ÂøÜÁÆ°ÁêÜÁ™óÂè£ÔºàÁî®Êà∑‰∏ªÂä®ÊâìÂºÄÔºâ
        openMemoryManager() {
          if (!this.requireParentIfNeeded()) return;
          this._userInitiatedMemoryManager = true;
          this.showMemoryManager = true;
        },

        // ÂÖ≥Èó≠ËÆ∞ÂøÜÁÆ°ÁêÜÁ™óÂè£
        closeMemoryManager(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMemoryManager = false;
          this.showMemoryManager = false;
          // Á´ãÂç≥Âº∫Âà∂Êõ¥Êñ∞
          this.$forceUpdate();
          // ÂÜçÊ¨°Á°Æ‰øùÂÖ≥Èó≠ÔºàÈò≤Ê≠¢ÂºÇÊ≠•ÈóÆÈ¢òÔºâ
          this.$nextTick(() => {
            this.showMemoryManager = false;
            this.$forceUpdate();
          });
          // Âª∂ËøüÊ∏ÖÁêÜÊï∞ÊçÆÔºåÈÅøÂÖçÂÖ≥Èó≠Âä®ÁîªÂç°È°ø
          setTimeout(() => {
            if (!this.showMemoryManager) {
              this.batchImportData = '';
              this.previewTasks = [];
              this.batchImportStartDate = '';
              this.batchImportEndDate = '';
            }
          }, 300);
        },

        // È¢ÑËßàÊâπÈáèÂØºÂÖ•
        previewBatchImport() {
          if (!this.batchImportData.trim()) {
            alert('ËØ∑Â°´ÂÜô‰ªªÂä°Êï∞ÊçÆ');
            return;
          }
          const lines = this.batchImportData.trim().split('\n').filter(l => l.trim());
          this.previewTasks = lines.map(line => {
            const parts = line.split(/,|Ôºå/).map(s => s.trim());
            if (this.memoryCategory === 'poetry') {
              return {
                title: parts[0] || '',
                dynasty: parts[1] || '',
                author: parts[2] || '',
                content: parts[1] && parts[2] ? `${parts[1]} ¬∑ ${parts[2]}` : ''
              };
            }
            if (this.memoryCategory === 'english') {
              return {
                title: parts[0] || '',
                content: parts[1] || ''
              };
            }
            return {
              title: parts[1] || '',
              categoryName: parts[0] || '',
              content: parts[2] ? `${parts[0] ? parts[0] + ' ¬∑ ' : ''}${parts[2]}` : ''
            };
          }).filter(t => t.title);
        },

        // ÊâπÈáèÂØºÂÖ•ËÆ∞ÂøÜ‰ªªÂä°
        processBatchImport() {
          if (this.previewTasks.length === 0) {
            alert('ËØ∑ÂÖàÈ¢ÑËßà‰ªªÂä°ÊàñÂ°´ÂÜô‰ªªÂä°Êï∞ÊçÆ');
            return;
          }
          const range = this.getBatchImportDateRange();
          if (!range) return;
          const startDate = range.start;
          const endDate = range.end;
          const daysAvailable = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;
          if (this.previewTasks.length > daysAvailable) {
            alert(`ËæìÂÖ•Ë°åÊï∞Ë∂ÖËøáÊó•ÊúüËåÉÂõ¥ÔºàÂèØÁî® ${daysAvailable} Â§©Ôºâ„ÄÇËØ∑ÂáèÂ∞ëË°åÊï∞ÊàñÂª∂ÈïøÁªìÊùüÊó•Êúü„ÄÇ`);
            return;
          }

          const schedule = [...this.memorySchedule];
          
          // ‰ªéËµ∑ÂßãÊó•ÊúüÂºÄÂßãÔºåÊØèË°åÈ°∫Âª∂‰∏ÄÂ§©
          this.previewTasks.forEach((task, idx) => {
            const date = new Date(startDate);
            date.setDate(date.getDate() + idx);
            const dayKey = this.toLocalDateKey(date);
            
            const base = {
              id: this.uuid(),
              title: task.title,
              content: task.content,
              category: this.memoryCategory,
              dynasty: task.dynasty || '',
              author: task.author || '',
              categoryName: task.categoryName || '',
              createdAt: date.toISOString()
            };
            this.memoryList.push(base);
            
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(date);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewDayKey = this.toLocalDateKey(reviewDate);
              schedule.push({
                id: this.uuid(),
                baseId: base.id,
                title: base.title,
                content: base.content,
                category: base.category,
                dynasty: base.dynasty,
                author: base.author,
                categoryName: base.categoryName,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              });
            });
          });
          
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));
          
          alert('ÊâπÈáèÂØºÂÖ•ÊàêÂäüÔºÅ');
          this.closeMemoryManager();
        },

        // Ëé∑ÂèñÂë®ÂºÄÂßãÊó•Êúü
        getWeekStart() {
          if (!this.currentWeekStart) {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(diff);
            this.currentWeekStart = new Date(monday);
          }
          return new Date(this.currentWeekStart);
        },

        // Âë®ËßÜÂõæÂØºËà™
        prevWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() - 7);
          this.currentWeekStart = new Date(start);
          // Ê∏ÖÈô§ÁºìÂ≠òÔºåÂº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆó
          this.reviewStatusCache = {};
        },

        nextWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() + 7);
          this.currentWeekStart = new Date(start);
          // Ê∏ÖÈô§ÁºìÂ≠òÔºåÂº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆó
          this.reviewStatusCache = {};
        },

        // ÂàáÊç¢ËÆ∞ÂøÜ‰ªªÂä°ÂÆåÊàêÁä∂ÊÄÅ
        toggleMemoryTask(task) {
          task.done = !task.done;
          this.memorySchedule = [...this.memorySchedule];
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
        },

        // ÂàáÊç¢Â§ç‰π†Ê£ÄÊü•Áä∂ÊÄÅÔºà‰ºòÂåñÊÄßËÉΩÔºâ
        toggleReviewCheck(baseId, reviewKey) {
          const base = this.memoryList.find(m => m.id === baseId);
          if (!base) return;
          
          // Ê∏ÖÈô§ÁºìÂ≠òÔºåÂº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆó
          const cacheKey = `${baseId}_${this.currentWeekStart?.getTime() || 0}`;
          delete this.reviewStatusCache[cacheKey];
          
          const learnDate = new Date(base.createdAt);
          
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            // Âç≥Êó∂Â§ç‰π†Êó∂Èó¥ÁÇπÔºå‰ΩøÁî®localStorageÂ≠òÂÇ®
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            const currentStatus = localStorage.getItem(key) === 'true';
            localStorage.setItem(key, String(!currentStatus));
            // Áõ¥Êé•Êõ¥Êñ∞ËßÜÂõæÔºå‰∏çÈúÄË¶ÅÈáçÊñ∞ËÆ°ÁÆóÊï¥‰∏™ÂàóË°®
            this.$forceUpdate();
          } else {
            // ËâæÂÆæÊµ©ÊñØÂ§ç‰π†Êó•Êúü
            const offset = parseInt(reviewKey);
            const reviewDate = new Date(learnDate);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            
            let scheduleItem = this.memorySchedule.find(s => 
              s.baseId === baseId && s.offsetDay === offset && s.dayKey === reviewDayKey
            );
            
            if (!scheduleItem) {
              // Â¶ÇÊûú‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂ§ç‰π†ËÆ°Âàí
              scheduleItem = {
                id: this.uuid(),
                baseId: baseId,
                title: base.title,
                content: base.content,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              };
              this.memorySchedule.push(scheduleItem);
            }
            
            scheduleItem.done = !scheduleItem.done;
            // Vue 3: ‰ΩøÁî® splice Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
            const idx = this.memorySchedule.indexOf(scheduleItem);
            if (idx !== -1) {
              this.memorySchedule.splice(idx, 1, scheduleItem);
            }
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
          }
        },

        // Ëé∑ÂèñÂ§ç‰π†Áä∂ÊÄÅ
        getReviewStatus(baseId, reviewKey) {
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            return localStorage.getItem(key) === 'true';
          }
          return false;
        },

        // Ê†ºÂºèÂåñÂ§ç‰π†Êó∂Èó¥
        formatReviewTime(date) {
          const now = new Date();
          const diff = date.getTime() - now.getTime();
          
          if (diff < 0) {
            return 'Â∑≤Ëøá';
          } else if (diff < 60 * 60 * 1000) {
            const minutes = Math.floor(diff / (60 * 1000));
            return `${minutes}ÂàÜÈíüÂêé`;
          } else if (diff < 24 * 60 * 60 * 1000) {
            const hours = Math.floor(diff / (60 * 60 * 1000));
            return `${hours}Â∞èÊó∂Âêé`;
          } else {
            return `${date.getMonth() + 1}/${date.getDate()}`;
          }
        },

        // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÁºñËæëËÆ∞ÂøÜÈ°πÔºàÂè™ËÉΩÁºñËæëÂΩìÂ§©Âèä‰ª•ÂêéÁöÑÂÜÖÂÆπÔºâ
        canEditMemoryItem(item) {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          return item.learnKey >= todayKey;
        },

        // ÂºÄÂßãÁºñËæëËÆ∞ÂøÜÈ°π
        startEditMemory(item) {
          if (!this.canEditMemoryItem(item)) {
            alert('Âè™ËÉΩÁºñËæëÂΩìÂ§©Âèä‰ª•ÂêéÁöÑÂÜÖÂÆπÔºåÊó†Ê≥ïÁºñËæëËøáÂéªÁöÑÂÜÖÂÆπ„ÄÇ');
            return;
          }
          this.editingMemoryId = item.id;
          this.editingMemoryTitle = item.title;
          this.editingMemoryContent = item.content || '';
        },

        // ‰øùÂ≠òÁºñËæëÁöÑËÆ∞ÂøÜÈ°π
        saveEditMemory(item) {
          if (!this.editingMemoryTitle.trim()) {
            alert('Ê†áÈ¢ò‰∏çËÉΩ‰∏∫Á©∫');
            return;
          }

          const memoryItem = this.memoryList.find(m => m.id === item.id);
          if (memoryItem) {
            memoryItem.title = this.editingMemoryTitle.trim();
            memoryItem.content = this.editingMemoryContent.trim();
            memoryItem.updatedAt = new Date().toISOString();
            
            // Êõ¥Êñ∞Áõ∏ÂÖ≥ÁöÑÂ§ç‰π†ËÆ°Âàí
            this.memorySchedule.forEach(schedule => {
              if (schedule.baseId === item.id) {
                schedule.title = memoryItem.title;
                schedule.content = memoryItem.content;
              }
            });

            localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
            
            // Ê∏ÖÈô§ÁºìÂ≠ò
            this.reviewStatusCache = {};
          }

          this.cancelEditMemory();
        },

        // ÂèñÊ∂àÁºñËæë
        cancelEditMemory() {
          this.editingMemoryId = null;
          this.editingMemoryTitle = '';
          this.editingMemoryContent = '';
        },

        // Êúù‰ª£È¢úËâ≤
        dynastyColor(dynasty) {
          const map = {
            'ÂÖàÁß¶': '#64748b',
            'Áß¶': '#92400e',
            'Ê±â': '#b91c1c',
            'È≠è': '#2563eb',
            'Êôã': '#0f766e',
            'ÂçóÂåóÊúù': '#6d28d9',
            'Èöã': '#ea580c',
            'Âîê': '#f59e0b',
            'ÂÆã': '#10b981',
            'ÂÖÉ': '#3b82f6',
            'Êòé': '#ef4444',
            'Ê∏Ö': '#8b5cf6',
            'ËøëÁé∞‰ª£': '#0ea5e9'
          };
          return map[dynasty] || '#64748b';
        },

        // Ê∑ªÂä†‰ªäÂ§©ÁöÑÂÜÖÂÆπ
        addTodayMemory() {
          if (!this.requireParentIfNeeded()) return;
          const today = new Date();
          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(today),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = true;
        },

        // ‰øùÂ≠ò‰ªäÂ§©ÁöÑÂÜÖÂÆπ
        saveTodayMemory() {
          if (!this.newTodayMemory.title.trim()) {
            alert('ËØ∑ËæìÂÖ•Ê†áÈ¢ò');
            return;
          }
          if (this.memoryCategory === 'poetry') {
            if (!this.newTodayMemory.dynasty.trim() || !this.newTodayMemory.author.trim()) {
              alert('ËØ∑ËæìÂÖ•Êúù‰ª£Âíå‰ΩúËÄÖ');
              return;
            }
          }
          if (this.memoryCategory === 'science') {
            if (!this.newTodayMemory.categoryName.trim()) {
              alert('ËØ∑ËæìÂÖ•Á±ªÂà´');
              return;
            }
          }

          if (!this.newTodayMemory.date) {
            alert('ËØ∑ÈÄâÊã©Êó•Êúü');
            return;
          }

          const date = this.parseDateInputToLocalDate(this.newTodayMemory.date);
          const contentForPoetry = this.memoryCategory === 'poetry' && !this.newTodayMemory.content.trim()
            ? `${this.newTodayMemory.dynasty.trim()} ¬∑ ${this.newTodayMemory.author.trim()}`
            : this.newTodayMemory.content.trim();
          const base = {
            id: this.uuid(),
            title: this.newTodayMemory.title.trim(),
            content: contentForPoetry,
            category: this.memoryCategory,
            dynasty: this.newTodayMemory.dynasty.trim(),
            author: this.newTodayMemory.author.trim(),
            categoryName: this.newTodayMemory.categoryName.trim(),
            createdAt: date.toISOString()
          };
          
          this.memoryList.push(base);
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));

          // ÁîüÊàêËâæÂÆæÊµ©ÊñØÂ§ç‰π†ËÆ°Âàí
          const offsets = [1, 2, 4, 7, 15, 30];
          const schedule = [...this.memorySchedule];
          offsets.forEach(offset => {
            const reviewDate = new Date(date);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              category: base.category,
              dynasty: base.dynasty,
              author: base.author,
              categoryName: base.categoryName,
              dayKey: reviewDayKey,
              offsetDay: offset,
              done: false
            });
          });

          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          // Ê∏ÖÈô§ÁºìÂ≠ò
          this.reviewStatusCache = {};

          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(new Date()),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = false;
          alert('Ê∑ªÂä†ÊàêÂäüÔºÅ');
        },

        // Â§ÑÁêÜÈáçÁΩÆÊåâÈíÆÁÇπÂáª - ‰ΩøÁî®ÂéüÁîü confirm
        handleResetClick() {
          if (!this.requireParentIfNeeded(true)) return;
          // ÂÖàÂÖ≥Èó≠ÊâÄÊúâÂÖ∂‰ªñÂºπÁ™ó
          this.showMemoryManager = false;
          this.showAddTodayModal = false;
          this.showTemplateManager = false;
          this.showMonthlyReport = false;
          this.editingMemoryId = null;
          this.showResetConfirm = false;
          this.$forceUpdate();
          
          // ‰ΩøÁî®ÂéüÁîü confirm ÂØπËØùÊ°ÜÔºàÈÅøÂÖçËá™ÂÆö‰πâÂºπÁ™óÁöÑÂÖ≥Èó≠ÈóÆÈ¢òÔºâ
          setTimeout(() => {
            const confirmed1 = window.confirm(
              '‚ö†Ô∏è Á¨¨‰∏ÄÊ≠•Á°ÆËÆ§\n\n' +
              'Âç≥Â∞ÜÊ∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆÔºåÁ°ÆÂÆöÁªßÁª≠ÂêóÔºü'
            );
            if (!confirmed1) return;
            const confirmed2 = window.confirm(
              '‚ö†Ô∏è Á¨¨‰∫åÊ≠•Á°ÆËÆ§\n\n' +
              'Ê∏ÖÁ©∫ÂêéÊó†Ê≥ïÊâæÂõûÔºåÊòØÂê¶ÁúüÁöÑË¶ÅÊ∏ÖÁ©∫Ôºü'
            );
            if (!confirmed2) return;
            const confirmed3 = window.confirm(
              '‚ö†Ô∏è Á¨¨‰∏âÊ≠•Á°ÆËÆ§\n\n' +
              'ÊúÄÂêé‰∏ÄÊ¨°Á°ÆËÆ§ÔºöÁ°ÆÂÆöÊ∏ÖÁ©∫ÂÖ®ÈÉ®Êï∞ÊçÆÔºü'
            );
            if (confirmed3) {
              this.resetAllData();
            }
          }, 100);
        },

        // ÊâìÂºÄÈáçÁΩÆÁ°ÆËÆ§ÂºπÁ™óÔºàÂÖàÂÖ≥Èó≠ÂÖ∂‰ªñÂºπÁ™óÔºâ
        openResetConfirm() {
          this.handleResetClick();
        },

        // ÂÖ≥Èó≠ÈáçÁΩÆÁ°ÆËÆ§ÂºπÁ™óÔºàÂ∑≤Â∫üÂºÉÔºåÊîπÁî®ÂéüÁîü confirmÔºâ
        closeResetConfirm(event) {
          // Áõ¥Êé•ËÆæÁΩÆ‰∏∫ falseÔºàËôΩÁÑ∂‰∏çÂÜç‰ΩøÁî®Ëá™ÂÆö‰πâÂºπÁ™óÔºå‰ΩÜ‰øùÁïôÊñπÊ≥ï‰ª•Èò≤‰∏á‰∏ÄÔºâ
          this.showResetConfirm = false;
          this.$forceUpdate();
        },

        // ÊÅ¢Â§çÂá∫ÂéÇËÆæÁΩÆ - ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆ
        resetAllData() {
          // Ê∏ÖÁ©∫ÊâÄÊúâ localStorage Êï∞ÊçÆ
          localStorage.clear();
          
          // Âà∑Êñ∞È°µÈù¢
          location.reload();
        },

        // Êï∞ÊçÆÂΩíÊ°£ÂäüËÉΩ
        archiveOldData() {
          const now = new Date();
          const threeMonthsAgo = new Date(now);
          threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
          const cutoffDate = this.toLocalDateKey(threeMonthsAgo);
          
          // Êî∂ÈõÜÈúÄË¶ÅÂΩíÊ°£ÁöÑÊï∞ÊçÆ
          const archive = {
            version: '1.0',
            archiveDate: now.toISOString(),
            cutoffDate: cutoffDate,
            tasks: [],
            memoryItems: [],
            memorySchedule: [],
            stats: {
              totalTasks: 0,
              totalMemoryItems: 0,
              totalScheduleItems: 0
            }
          };

          // ÂΩíÊ°£‰ªªÂä°Êï∞ÊçÆ
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const archivedTasks = {};
              
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // Âè™ÂΩíÊ°£Â∑≤ÂÆåÊàêÁöÑ‰ªªÂä°
                    const completedTasks = tasks.filter(t => {
                      if (!t.done) return false;
                      // Â¶ÇÊûúÊúâcompletedAtÔºå‰ΩøÁî®ÂÆÉÔºõÂê¶Âàô‰ΩøÁî®dayKey‰Ωú‰∏∫Êó•Êúü
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate < cutoffDate;
                    });
                    
                    if (completedTasks.length > 0) {
                      archivedTasks[dayKey] = completedTasks;
                      archive.stats.totalTasks += completedTasks.length;
                    }
                  }
                }
              });
              
              archive.tasks = archivedTasks;
            } catch (e) {
              console.error('ÂΩíÊ°£‰ªªÂä°Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
            }
          }

          // ÂΩíÊ°£ËÆ∞ÂøÜÈ°πÂíåÂ§ç‰π†ËÆ°Âàí
          const memoryList = [...this.memoryList];
          const memorySchedule = [...this.memorySchedule];
          
          // ÊâæÂá∫3‰∏™ÊúàÂâçÁöÑËÆ∞ÂøÜÈ°πÔºàÂ∑≤ÂÆåÊàêÊâÄÊúâÂ§ç‰π†ÁöÑÔºâ
          const oldMemoryItems = memoryList.filter(m => {
            const learnDate = this.toLocalDateKey(new Date(m.createdAt));
            if (learnDate >= cutoffDate) return false;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâÂ§ç‰π†ÈÉΩÂ∑≤ÂÆåÊàê
            const relatedSchedules = memorySchedule.filter(s => s.baseId === m.id);
            if (relatedSchedules.length === 0) return false;
            
            // Ê£ÄÊü•ÊâÄÊúâÂ§ç‰π†ÊòØÂê¶ÈÉΩÂú®3‰∏™ÊúàÂâç‰∏îÂ∑≤ÂÆåÊàê
            const allOldAndDone = relatedSchedules.every(s => {
              const scheduleDate = this.toLocalDateKey(new Date(s.dayKey));
              return scheduleDate < cutoffDate && s.done;
            });
            
            return allOldAndDone;
          });

          oldMemoryItems.forEach(item => {
            archive.memoryItems.push(item);
            archive.stats.totalMemoryItems++;
            
            // Êî∂ÈõÜÁõ∏ÂÖ≥ÁöÑÂ§ç‰π†ËÆ°Âàí
            const relatedSchedules = memorySchedule.filter(s => s.baseId === item.id);
            relatedSchedules.forEach(schedule => {
              archive.memorySchedule.push(schedule);
              archive.stats.totalScheduleItems++;
            });
          });

          // Ê£ÄÊü•ÊòØÂê¶ÊúâÊï∞ÊçÆÈúÄË¶ÅÂΩíÊ°£
          if (archive.stats.totalTasks === 0 && archive.stats.totalMemoryItems === 0) {
            alert('Ê≤°ÊúâÊâæÂà∞ÈúÄË¶ÅÂΩíÊ°£ÁöÑÊï∞ÊçÆÔºà3‰∏™ÊúàÂâçÁöÑÂ∑≤ÂÆåÊàê‰ªªÂä°ÂíåÂ∑≤ÁªìÊùüÂ§ç‰π†ÁöÑËÆ∞ÂøÜÊù°ÁõÆÔºâ„ÄÇ');
            return;
          }

          // ÁîüÊàêÊñá‰ª∂Âêç
          const year = now.getFullYear();
          const quarter = Math.floor(now.getMonth() / 3) + 1;
          const prevQuarter = quarter === 1 ? 4 : quarter - 1;
          const prevYear = quarter === 1 ? year - 1 : year;
          const filename = `backup_${prevYear}_Q${prevQuarter}.json`;

          // ‰∏ãËΩΩÂΩíÊ°£Êñá‰ª∂
          const dataStr = JSON.stringify(archive, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          // ËØ¢ÈóÆÊòØÂê¶Âà†Èô§ÊóßÊï∞ÊçÆ
          setTimeout(() => {
            const confirmDelete = confirm(
              `ÂΩíÊ°£ÂÆåÊàêÔºÅ\n\n` +
              `Â∑≤ÂΩíÊ°£Êï∞ÊçÆÔºö\n` +
              `- Â∑≤ÂÆåÊàê‰ªªÂä°Ôºö${archive.stats.totalTasks} ‰∏™\n` +
              `- ËÆ∞ÂøÜÊù°ÁõÆÔºö${archive.stats.totalMemoryItems} ‰∏™\n` +
              `- Â§ç‰π†ËÆ°ÂàíÔºö${archive.stats.totalScheduleItems} ‰∏™\n\n` +
              `Êñá‰ª∂Â∑≤‰øùÂ≠ò‰∏∫Ôºö${filename}\n\n` +
              `ÊòØÂê¶‰ªé App ‰∏≠Âà†Èô§Ëøô‰∫õÊóßÊï∞ÊçÆ‰ª•ÈáäÊîæÁ©∫Èó¥Ôºü`
            );

            if (confirmDelete) {
              this.deleteArchivedData(archive, cutoffDate);
            }
          }, 500);
        },

        // Âà†Èô§Â∑≤ÂΩíÊ°£ÁöÑÊï∞ÊçÆ
        deleteArchivedData(archive, cutoffDate) {
          // Âà†Èô§‰ªªÂä°Êï∞ÊçÆ
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // Âè™Âà†Èô§Â∑≤ÂÆåÊàêÁöÑ‰ªªÂä°
                    const remainingTasks = tasks.filter(t => {
                      if (!t.done) return true;
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate >= cutoffDate;
                    });
                    
                    if (remainingTasks.length === 0) {
                      delete byDay[dayKey];
                    } else {
                      byDay[dayKey] = remainingTasks;
                    }
                  }
                }
              });
              
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            } catch (e) {
              console.error('Âà†Èô§‰ªªÂä°Êï∞ÊçÆÊó∂Âá∫Èîô:', e);
            }
          }

          // Âà†Èô§ËÆ∞ÂøÜÈ°πÂíåÂ§ç‰π†ËÆ°Âàí
          const archivedIds = archive.memoryItems.map(m => m.id);
          this.memoryList = this.memoryList.filter(m => !archivedIds.includes(m.id));
          this.memorySchedule = this.memorySchedule.filter(s => !archivedIds.includes(s.baseId));
          
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));

          alert('ÊóßÊï∞ÊçÆÂ∑≤ÊàêÂäüÂà†Èô§ÔºåÂ≠òÂÇ®Á©∫Èó¥Â∑≤ÈáäÊîæÔºÅ');
          
          // Âà∑Êñ∞ÂΩìÂâç‰ªªÂä°ÂàóË°®
          this.loadTodayTasks();
        },

        // ÂØºÂÖ•ÂéÜÂè≤ÂΩíÊ°£
        importArchive() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const archive = JSON.parse(event.target.result);
                
                if (!archive.version || !archive.archiveDate) {
                  alert('Ëøô‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÂΩíÊ°£Êñá‰ª∂„ÄÇ');
                  return;
                }

                // ÊòæÁ§∫ÂΩíÊ°£‰ø°ÊÅØ
                const info = `ÂΩíÊ°£‰ø°ÊÅØÔºö\n` +
                  `- ÂΩíÊ°£Êó•ÊúüÔºö${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
                  `- Êà™Ê≠¢Êó•ÊúüÔºö${archive.cutoffDate}\n` +
                  `- Â∑≤ÂÆåÊàê‰ªªÂä°Ôºö${archive.stats.totalTasks} ‰∏™\n` +
                  `- ËÆ∞ÂøÜÊù°ÁõÆÔºö${archive.stats.totalMemoryItems} ‰∏™\n` +
                  `- Â§ç‰π†ËÆ°ÂàíÔºö${archive.stats.totalScheduleItems} ‰∏™\n\n` +
                  `ÊòØÂê¶ÂØºÂÖ•Êü•ÁúãËøô‰∫õÂéÜÂè≤Êï∞ÊçÆÔºü\nÔºàÂØºÂÖ•ÂêéÂèØ‰ª•Êü•ÁúãÔºå‰ΩÜ‰∏ç‰ºöË¶ÜÁõñÂΩìÂâçÊï∞ÊçÆÔºâ`;

                if (confirm(info)) {
                  this.viewArchive(archive);
                }
              } catch (e) {
                alert('ËØªÂèñÂΩíÊ°£Êñá‰ª∂Â§±Ë¥•Ôºö' + e.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        },

        // Êü•ÁúãÂΩíÊ°£Êï∞ÊçÆ
        viewArchive(archive) {
          // ÂàõÂª∫Êü•ÁúãÂΩíÊ°£ÁöÑÂºπÁ™ó
          const archiveInfo = `üì¶ ÂéÜÂè≤ÂΩíÊ°£Êï∞ÊçÆ\n\n` +
            `ÂΩíÊ°£Êó•ÊúüÔºö${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
            `Êà™Ê≠¢Êó•ÊúüÔºö${archive.cutoffDate}\n\n` +
            `Êï∞ÊçÆÁªüËÆ°Ôºö\n` +
            `- Â∑≤ÂÆåÊàê‰ªªÂä°Ôºö${archive.stats.totalTasks} ‰∏™\n` +
            `- ËÆ∞ÂøÜÊù°ÁõÆÔºö${archive.stats.totalMemoryItems} ‰∏™\n` +
            `- Â§ç‰π†ËÆ°ÂàíÔºö${archive.stats.totalScheduleItems} ‰∏™\n\n` +
            `ËØ¶ÁªÜÊï∞ÊçÆÂ∑≤ÊòæÁ§∫Âú®‰∏ãÊñπÔºåÊÇ®ÂèØ‰ª•Êü•ÁúãÊàñÂØºÂá∫„ÄÇ`;

          // ÊòæÁ§∫ÂΩíÊ°£Êï∞ÊçÆÔºàÂèØ‰ª•Êâ©Â±ï‰∏∫Êõ¥ËØ¶ÁªÜÁöÑËßÜÂõæÔºâ
          const dataStr = JSON.stringify(archive, null, 2);
          const newWindow = window.open('', '_blank');
          if (newWindow) {
            newWindow.document.write(`
              <html>
                <head>
                  <title>ÂéÜÂè≤ÂΩíÊ°£Êï∞ÊçÆ - ${archive.cutoffDate}</title>
                  <style>
                    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                    pre { background: white; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    h1 { color: #333; }
                  </style>
                </head>
                <body>
                  <h1>üì¶ ÂéÜÂè≤ÂΩíÊ°£Êï∞ÊçÆ</h1>
                  <p><strong>ÂΩíÊ°£Êó•ÊúüÔºö</strong>${new Date(archive.archiveDate).toLocaleString('zh-CN')}</p>
                  <p><strong>Êà™Ê≠¢Êó•ÊúüÔºö</strong>${archive.cutoffDate}</p>
                  <h2>Êï∞ÊçÆËØ¶ÊÉÖÔºö</h2>
                  <pre>${dataStr}</pre>
                </body>
              </html>
            `);
          } else {
            alert(archiveInfo + '\n\nËØ¶ÁªÜÊï∞ÊçÆÔºö\n' + dataStr.substring(0, 500) + '...');
          }
        },

        // Â§ç‰π†ËÆ°ÂàíËßÜÂõæËæÖÂä©
        groupedSchedule() {
          const groups = {};
          this.memorySchedule
            .slice()
            .sort((a, b) => a.dayKey.localeCompare(b.dayKey))
            .forEach(item => {
              if (!groups[item.dayKey]) groups[item.dayKey] = [];
              groups[item.dayKey].push(item);
            });
          return groups;
        },

        formatDate(iso) {
          const d = new Date(iso);
          if (Number.isNaN(d.getTime())) return iso;
          return `${d.getMonth() + 1}Êúà${d.getDate()}Êó•`;
        },

        // Áªü‰∏ÄÁîüÊàêÊú¨Âú∞Êó•Êúü keyÔºàÈÅøÂÖç UTC ÂÅèÁßªÂØºËá¥Êó•ÊúüÈîô‰π±Ôºâ
        toLocalDateKey(date) {
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          return `${y}-${m}-${d}`;
        },

        // ‰øùÁïô UTC key Áî®‰∫éÂÖºÂÆπÊóßÊï∞ÊçÆ
        toUTCDateKey(date) {
          return date.toISOString().slice(0, 10);
        },

        // Â∞Ü date input ÁöÑ YYYY-MM-DD ËΩ¨‰∏∫Êú¨Âú∞Êó∂Èó¥ÔºàÈÅøÂÖç UTC Ëß£ÊûêÂÅèÁßªÔºâ
        parseDateInputToLocalDate(dateStr) {
          const [y, m, d] = dateStr.split('-').map(Number);
          if (!y || !m || !d) return new Date();
          return new Date(y, m - 1, d, 12, 0, 0);
        },

        // ÊâπÈáèÂØºÂÖ•Ëµ∑ÂßãÊó•ÊúüÔºöÊú™ÈÄâÊúà‰ªΩÂàô‰ªé‰ªäÂ§©ÂºÄÂßãÔºõÈÄâ‰∏≠Êúà‰ªΩÂàô‰ªéËØ•ÊúàÂºÄÂßãÔºàÂΩìÂâçÊúà‰ªé‰ªäÂ§©ÂºÄÂßãÔºâ
        getBatchImportDateRange() {
          const today = new Date();
          const minDateKey = this.toLocalDateKey(today);
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            alert('ËØ∑ÈÄâÊã©Ëµ∑ÂßãÊó•ÊúüÂíåÁªìÊùüÊó•Êúü');
            return null;
          }
          if (this.batchImportStartDate < minDateKey) {
            alert('Ëµ∑ÂßãÊó•Êúü‰∏çËÉΩÊó©‰∫é‰ªäÂ§©');
            return null;
          }
          if (this.batchImportEndDate < this.batchImportStartDate) {
            alert('ÁªìÊùüÊó•Êúü‰∏çËÉΩÊó©‰∫éËµ∑ÂßãÊó•Êúü');
            return null;
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          return { start, end };
        },

        // ÈºìÂä±ËØ≠
        refreshQuote() {
          const idx = Math.floor(Math.random() * this.quotes.length);
          this.currentQuote = this.quotes[idx];
        },

        // ËØ≠Èü≥ÂΩïÂà∂
        async toggleRecording() {
          if (this.isRecording) {
            if (this.mediaRecorder) {
              this.mediaRecorder.stop();
            }
            this.isRecording = false;
            return;
          }
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.recordingStream = stream;
            this.recordedChunks = [];
            const mr = new MediaRecorder(stream);
            this.mediaRecorder = mr;
            mr.ondataavailable = (e) => {
              if (e.data.size > 0) {
                this.recordedChunks.push(e.data);
              }
            };
            mr.onstop = () => {
              const blob = new Blob(this.recordedChunks, { type: 'audio/webm' });
              if (this.audioUrl) {
                URL.revokeObjectURL(this.audioUrl);
              }
              this.audioUrl = URL.createObjectURL(blob);
              if (this.recordingStream) {
                this.recordingStream.getTracks().forEach(t => t.stop());
                this.recordingStream = null;
              }
              // ÁÆÄÂåñÂ§ÑÁêÜÔºöÂΩïÈü≥Âè™Âú®ÂΩìÂâçËÆæÂ§áÊú¨Ê¨°‰ºöËØùÊúâÊïàÔºå‰∏çÂÜôÂÖ• localStorage
            };
            mr.start();
            this.isRecording = true;
          } catch (err) {
            alert('ÂΩïÈü≥ÊùÉÈôêË¢´ÊãíÁªùÔºåÊó†Ê≥ï‰ΩøÁî®ËØ≠Èü≥ÈºìÂä±ÂäüËÉΩ„ÄÇ');
          }
        },
        playAudio() {
          if (!this.audioUrl) return;
          const audio = new Audio(this.audioUrl);
          audio.play();
        },

        // Ë°®Êâ¨‰ø°
        openMonthlyReport() {
          // Ê†áËÆ∞‰∏∫Áî®Êà∑‰∏ªÂä®ÊâìÂºÄ
          this._userInitiatedMonthlyReport = true;
          // ÁªüËÆ°Êú¨ÊúàÂÆåÊàê‰ªªÂä°Êï∞Èáè
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          let done = 0;
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const now = new Date();
              const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
              Object.entries(byDay).forEach(([key, list]) => {
                if (key.startsWith(ym) && Array.isArray(list)) {
                  list.forEach(t => {
                    if (t && t.done) done += 1;
                  });
                }
              });
            } catch (e) {
              done = 0;
            }
          }
          this.monthlyStats.doneTasks = done;
          this.showMonthlyReport = true;
        },
        closeMonthlyReport(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMonthlyReport = false;
          this.showMonthlyReport = false;
          // Á´ãÂç≥Âº∫Âà∂Êõ¥Êñ∞
          this.$forceUpdate();
          // ÂÜçÊ¨°Á°Æ‰øùÂÖ≥Èó≠ÔºàÈò≤Ê≠¢ÂºÇÊ≠•ÈóÆÈ¢òÔºâ
          this.$nextTick(() => {
            this.showMonthlyReport = false;
            this.$forceUpdate();
          });
        },
        printReport() {
          window.print();
        },

        getRecentDayKeys(days) {
          const result = [];
          for (let i = days - 1; i >= 0; i -= 1) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            result.push(this.toLocalDateKey(date));
          }
          return result;
        },
        getCurrentWeekDayKeys() {
          const today = new Date();
          const day = today.getDay();
          const diffToMonday = day === 0 ? -6 : 1 - day;
          const monday = new Date(today);
          monday.setDate(today.getDate() + diffToMonday);
          const keys = [];
          for (let i = 0; i < 7; i += 1) {
            const date = new Date(monday);
            date.setDate(monday.getDate() + i);
            keys.push(this.toLocalDateKey(date));
          }
          return keys;
        },
        getShortDayLabel(dayKey) {
          const [y, m, d] = dayKey.split('-').map(Number);
          if (!y || !m || !d) return dayKey;
          return `${m}/${d}`;
        },
        getSeniorSummaryByDay(dayKey) {
          const dayTasks = Array.isArray(this.seniorStatsSource.tasksByDay[dayKey])
            ? this.seniorStatsSource.tasksByDay[dayKey]
            : [];
          const completedCount = dayTasks.filter(task => task && task.done).length;
          const totalCount = dayTasks.length;
          const focusMinutes = dayTasks.reduce((sum, task) => {
            if (task && task.done && task.startTime && task.endTime) {
              return sum + this.calculateTimeDiff(task.startTime, task.endTime);
            }
            return sum;
          }, 0);

          const reviewItems = Array.isArray(this.seniorStatsSource.scheduleByDay[dayKey])
            ? this.seniorStatsSource.scheduleByDay[dayKey]
            : [];
          const reviewDoneCount = reviewItems.filter(item => !!item.done).length;
          const reviewTotalCount = reviewItems.length;

          const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
          const reviewRate = reviewTotalCount > 0 ? Math.round((reviewDoneCount / reviewTotalCount) * 100) : 0;

          // XP ÂéÜÂè≤Êú™ÂçïÁã¨ËÆ∞ÂΩïÊó∂ÔºåÈááÁî®‚ÄúÂÆåÊàê‰ªªÂä°Êï∞ * 10‚ÄùÁöÑÂõûÈÄÄ‰º∞ÁÆóÔºå‰∏çÊîπÁé∞Êúâ XP ÁªìÁÆóÈÄªËæë„ÄÇ
          const xpGained = completedCount * 10;

          return {
            completedCount,
            totalCount,
            completionRate,
            focusMinutes,
            reviewDoneCount,
            reviewTotalCount,
            reviewRate,
            xpGained
          };
        },
        getSeniorRangeSummary(dayKeys) {
          const summary = {
            completedCount: 0,
            totalCount: 0,
            focusMinutes: 0,
            reviewDoneCount: 0,
            reviewTotalCount: 0,
            xpGained: 0,
            completionRate: 0,
            reviewRate: 0
          };
          dayKeys.forEach(dayKey => {
            const day = this.getSeniorSummaryByDay(dayKey);
            summary.completedCount += day.completedCount;
            summary.totalCount += day.totalCount;
            summary.focusMinutes += day.focusMinutes;
            summary.reviewDoneCount += day.reviewDoneCount;
            summary.reviewTotalCount += day.reviewTotalCount;
            summary.xpGained += day.xpGained;
          });
          summary.completionRate = summary.totalCount > 0
            ? Math.round((summary.completedCount / summary.totalCount) * 100)
            : 0;
          summary.reviewRate = summary.reviewTotalCount > 0
            ? Math.round((summary.reviewDoneCount / summary.reviewTotalCount) * 100)
            : 0;
          return summary;
        },
        getSeniorWeekStreak(weekDayKeys) {
          const todayKey = this.todayKey;
          const todayIndex = weekDayKeys.indexOf(todayKey);
          if (todayIndex < 0) return 0;
          let streak = 0;
          for (let i = todayIndex; i >= 0; i -= 1) {
            const daySummary = this.getSeniorSummaryByDay(weekDayKeys[i]);
            if (daySummary.completedCount >= 1) {
              streak += 1;
            } else {
              break;
            }
          }
          return streak;
        },

        // ÁªüËÆ°ÂäüËÉΩÔºöËÆ°ÁÆóÊó∂Èó¥Â∑ÆÔºàÂàÜÈíüÔºâ
        calculateTimeDiff(startTime, endTime) {
          if (!startTime || !endTime) return 0;
          const [sh, sm] = startTime.split(':').map(Number);
          const [eh, em] = endTime.split(':').map(Number);
          const start = sh * 60 + sm;
          const end = eh * 60 + em;
          return Math.max(0, end - start);
        },

        // Ê†ºÂºèÂåñÊó∂Èïø‰∏∫ÂèØËØªÂ≠óÁ¨¶‰∏≤
        formatDuration(minutes) {
          if (minutes < 60) {
            return `${minutes} ÂàÜÈíü`;
          }
          const h = Math.floor(minutes / 60);
          const m = minutes % 60;
          return m > 0 ? `${h} Â∞èÊó∂ ${m} ÂàÜÈíü` : `${h} Â∞èÊó∂`;
        },

        // Ê†πÊçÆ‰∏ªÈ¢òÂ∫îÁî®ÂÖ®Â±Ä CSS ÂèòÈáè‰∏éËÉåÊôØ
        applyBodyTheme() {
          const appEl = document.getElementById('app');
          const root = document.documentElement;
          const source = appEl ? getComputedStyle(appEl) : getComputedStyle(root);
          const vars = ['--theme-bg', '--theme-border', '--theme-tint', '--primary-start', '--primary-end', '--accent-start', '--accent-end', '--warm-start', '--warm-end'];
          vars.forEach(v => {
            const val = source.getPropertyValue(v).trim();
            if (val) root.style.setProperty(v, val);
          });
          const themeBg = root.style.getPropertyValue('--theme-bg').trim();
          if (themeBg) {
            document.body.style.backgroundImage = themeBg;
            document.body.style.backgroundColor = '#ffffff';
            document.body.style.backgroundRepeat = 'no-repeat';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundBlendMode = 'soft-light';
            document.body.style.transition = 'background-image 0.4s ease, background-color 0.4s ease';
          }
        },

        updateBodyMode() {
          if ((this.activeProfile.age || 8) >= 10) {
            document.body.classList.add('mature-mode');
          } else {
            document.body.classList.remove('mature-mode');
          }
        },

        // Ê°£Ê°à‰∏éÊéàÊùÉ
        getStorageKey(base) {
          return `kldx_${this.activeProfileId}_${base}`;
        },
        loadProfiles() {
          const raw = localStorage.getItem('kldx_profiles');
          if (raw) {
            try {
              this.profiles = JSON.parse(raw);
            } catch (e) {
              this.profiles = [];
            }
          }
          if (!this.profiles.length) {
            this.profiles = [{ id: this.uuid(), name: 'Â≠©Â≠ê1', age: 8 }];
          }
          const active = localStorage.getItem('kldx_active_profile');
          this.activeProfileId = active || this.profiles[0].id;
          this.parentPinSet = !!localStorage.getItem('kldx_parent_pin');
          this.migrateOldDataIfNeeded();
          this.saveProfiles();
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
        },
        saveProfiles() {
          localStorage.setItem('kldx_profiles', JSON.stringify(this.profiles));
          localStorage.setItem('kldx_active_profile', this.activeProfileId);
        },
        setActiveProfile(id) {
          this.activeProfileId = id;
          this.saveProfiles();
          this.loadTodayTasks();
          this.loadJuniorStickers();
          this.loadTemplates();
          this.loadMemoryData();
          this.loadThemeAndXp();
          this.updateBodyMode();
          this.ensureActiveTabForAgeGroup();
          this.seniorStatsTick += 1;
        },
        addProfile() {
          if (!this.requireParentIfNeeded()) return;
          if (!this.newProfileName.trim()) return;
          const age = this.normalizeAge(this.newProfileAge);
          this.profiles.push({ id: this.uuid(), name: this.newProfileName.trim(), age });
          this.newProfileName = '';
          this.newProfileAge = 8;
          this.saveProfiles();
          this.setActiveProfile(this.profiles[this.profiles.length - 1].id);
        },
        removeProfile(id) {
          if (!this.requireParentIfNeeded()) return;
          if (this.profiles.length <= 1) {
            alert('Ëá≥Â∞ë‰øùÁïô‰∏Ä‰∏™Ê°£Ê°à');
            return;
          }
          if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â≠©Â≠êÊ°£Ê°àÂêóÔºü')) return;
          this.profiles = this.profiles.filter(p => p.id !== id);
          if (this.activeProfileId === id) {
            this.activeProfileId = this.profiles[0].id;
          }
          this.saveProfiles();
          this.setActiveProfile(this.activeProfileId);
        },
        openSettings() {
          if (!this.requireParentIfNeeded(true)) return;
          this.showSettings = true;
          this.settingsSection = 'home';
        },
        closeSettings() {
          this.showSettings = false;
          this.settingsSection = 'home';
        },
        handleInstall() {
          if (!this.deferredPrompt) return;
          this.deferredPrompt.prompt();
          this.deferredPrompt.userChoice.then(() => {
            this.deferredPrompt = null;
            this.showInstall = false;
          });
        },
        requireParentIfNeeded(forSettings) {
          const age = this.activeProfile.age || 8;
          const pin = localStorage.getItem('kldx_parent_pin');
          this.parentPinSet = !!pin;
          if (!pin) {
            const setNow = confirm('Â∞öÊú™ËÆæÁΩÆÂÆ∂Èïø PINÔºåÊòØÂê¶Áé∞Âú®ËÆæÁΩÆÔºü');
            if (setNow) this.setParentPin();
            return false;
          }
          if (this.isParentUnlocked) return true;
          const input = prompt('ËØ∑ËæìÂÖ• 6 ‰ΩçÂÆ∂Èïø PIN');
          if (input && input === pin) {
            this.isParentUnlocked = true;
            return true;
          }
          alert('ÈúÄË¶ÅÂÆ∂ÈïøÊéàÊùÉ');
          return false;
        },
        setParentPin() {
          const pin = prompt('ËÆæÁΩÆ 6 ‰ΩçÂÆ∂Èïø PIN');
          if (!pin || !/^\d{6}$/.test(pin)) {
            alert('PIN ÂøÖÈ°ªÊòØ 6 ‰ΩçÊï∞Â≠ó');
            return;
          }
          localStorage.setItem('kldx_parent_pin', pin);
          this.parentPinSet = true;
          this.isParentUnlocked = true;
          alert('PIN ËÆæÁΩÆÊàêÂäü');
        },
        resetParentPin() {
          if (!confirm('ÈáçÁΩÆ PIN ‰ºöÊ∏ÖÁ©∫ÂÆ∂ÈïøÊéàÊùÉËÆ∞ÂΩïÔºåÁ°ÆÂÆöÁªßÁª≠Ôºü')) return;
          localStorage.removeItem('kldx_parent_pin');
          this.parentPinSet = false;
          this.isParentUnlocked = false;
          alert('PIN Â∑≤ÈáçÁΩÆ');
        },
        migrateOldDataIfNeeded() {
          if (localStorage.getItem('kldx_migrated')) return;
          const pid = this.activeProfileId;
          const map = [
            'tasks_by_day', 'templates', 'xp', 'theme',
            'memory_list', 'memory_schedule'
          ];
          map.forEach(key => {
            const oldKey = `kldx_${key}`;
            const val = localStorage.getItem(oldKey);
            if (val !== null) {
              localStorage.setItem(`kldx_${pid}_${key}`, val);
            }
          });
          localStorage.setItem('kldx_migrated', 'true');
        },

        loadMemoryData() {
          const rawList = localStorage.getItem(this.getStorageKey('memory_list'));
          if (rawList) {
            try {
              const parsed = JSON.parse(rawList);
              this.memoryList = parsed.map(item => {
                if (!item.category) {
                  const title = item.title || '';
                  const content = item.content || '';
                  if (title.includes('„Ää') || content.includes('ËØó') || content.includes('ËØç')) {
                    item.category = 'poetry';
                  } else if (/[a-zA-Z]/.test(title) || /[a-zA-Z]/.test(content)) {
                    item.category = 'english';
                  } else {
                    item.category = 'science';
                  }
                }
                return item;
              });
            } catch (e) {
              this.memoryList = [];
            }
          } else {
            this.memoryList = [];
          }
          const rawSchedule = localStorage.getItem(this.getStorageKey('memory_schedule'));
          if (rawSchedule) {
            try {
              this.memorySchedule = JSON.parse(rawSchedule);
            } catch (e) {
              this.memorySchedule = [];
            }
          } else {
            this.memorySchedule = [];
          }
        },
        loadThemeAndXp() {
          const theme = localStorage.getItem(this.getStorageKey('theme'));
          const allowedThemes = this.themeOptions.map(opt => opt.value);
          if (theme && allowedThemes.includes(theme)) {
            this.theme = theme;
          } else {
            this.theme = 'forest';
            localStorage.setItem(this.getStorageKey('theme'), 'forest');
          }
          const storedXp = localStorage.getItem(this.getStorageKey('xp'));
          if (storedXp) this.xp = parseInt(storedXp, 10) || 0;
          this.applyBodyTheme();
        },

        // Â∑•ÂÖ∑
        uuid() {
          return 'xxxx-4xxx-yxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }
      },
      created() {
        // Âú® created Èí©Â≠ê‰∏≠ËÆæÁΩÆÂàùÂßãÂÄºÔºàÊØî mounted Êõ¥Êó©Ôºâ
        // Á°Æ‰øùÁî®Êà∑Ê†áËÆ∞‰πü‰∏∫ false
        this.showResetConfirm = false;
        this.showMemoryManager = false;
        this.showAddTodayModal = false;
        this.showTemplateManager = false;
        this.showMonthlyReport = false;
        this._userInitiatedMemoryManager = false;
        this._userInitiatedMonthlyReport = false;
      },
      mounted() {
        try {
        // Âº∫Âà∂Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑ localStorage ÂºπÁ™óÁä∂ÊÄÅ
        localStorage.removeItem('kldx_showMemoryManager');
        localStorage.removeItem('kldx_showMonthlyReport');
        
        // Á°Æ‰øùÊâÄÊúâÂºπÁ™óÂàùÂßãÁä∂ÊÄÅ‰∏∫ÂÖ≥Èó≠ÔºàÂøÖÈ°ªÂú®ÊúÄÂâçÈù¢ÔºåÈò≤Ê≠¢ÂÖ∂‰ªñ‰ª£Á†ÅÊâìÂºÄÂºπÁ™óÔºâ
        // ‰ΩøÁî® Object.assign Âº∫Âà∂ËÆæÁΩÆÊâÄÊúâÂºπÁ™ó‰∏∫ false
        // ÂêåÊó∂Á°Æ‰øùÁî®Êà∑Ê†áËÆ∞‰πü‰∏∫ falseÔºàÂøÖÈ°ªÂú® watch ‰πãÂâçËÆæÁΩÆÔºâ
        Object.assign(this, {
          showResetConfirm: false,
          showMemoryManager: false,
          showAddTodayModal: false,
          showTemplateManager: false,
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false,
          _userInitiatedMonthlyReport: false
        });
        
        // Ê∑ªÂä† watch ÁõëÂê¨Âô®Ôºå‰∏ÄÊó¶Ê£ÄÊµãÂà∞ÂºπÁ™óË¢´ÊâìÂºÄÔºåÁ´ãÂç≥Âº∫Âà∂ÂÖ≥Èó≠
        // ‰ΩøÁî® immediate: true Á´ãÂç≥Ê£ÄÊü•ÂΩìÂâçÂÄº
        this.$watch('showMemoryManager', (newVal, oldVal) => {
          // Âº∫Âà∂ÂÖ≥Èó≠ÔºöÂ¶ÇÊûú‰∏∫ true ‰∏î‰∏çÊòØÁî®Êà∑‰∏ªÂä®ÊâìÂºÄÔºåÁ´ãÂç≥ÂÖ≥Èó≠
          if (newVal === true) {
            if (!this._userInitiatedMemoryManager) {
              console.warn('‚ö†Ô∏è [watch] Ê£ÄÊµãÂà∞ showMemoryManager Ë¢´ÊÑèÂ§ñËÆæÁΩÆ‰∏∫ trueÔºåÁ´ãÂç≥Âº∫Âà∂ÂÖ≥Èó≠');
              // Á´ãÂç≥ÂêåÊ≠•ÂÖ≥Èó≠
              this.showMemoryManager = false;
              this._userInitiatedMemoryManager = false;
              // Âº∫Âà∂Êõ¥Êñ∞ËßÜÂõæ
              this.$forceUpdate();
              // ÂÜçÊ¨°Á°Æ‰øùÔºàÂª∂Ëøü‰∏ÄÁÇπÔºâ
              setTimeout(() => {
                this.showMemoryManager = false;
                this._userInitiatedMemoryManager = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        this.$watch('showMonthlyReport', (newVal, oldVal) => {
          // Âº∫Âà∂ÂÖ≥Èó≠ÔºöÂ¶ÇÊûú‰∏∫ true ‰∏î‰∏çÊòØÁî®Êà∑‰∏ªÂä®ÊâìÂºÄÔºåÁ´ãÂç≥ÂÖ≥Èó≠
          if (newVal === true) {
            if (!this._userInitiatedMonthlyReport) {
              console.warn('‚ö†Ô∏è [watch] Ê£ÄÊµãÂà∞ showMonthlyReport Ë¢´ÊÑèÂ§ñËÆæÁΩÆ‰∏∫ trueÔºåÁ´ãÂç≥Âº∫Âà∂ÂÖ≥Èó≠');
              // Á´ãÂç≥ÂêåÊ≠•ÂÖ≥Èó≠
              this.showMonthlyReport = false;
              this._userInitiatedMonthlyReport = false;
              // Âº∫Âà∂Êõ¥Êñ∞ËßÜÂõæ
              this.$forceUpdate();
              // ÂÜçÊ¨°Á°Æ‰øùÔºàÂª∂Ëøü‰∏ÄÁÇπÔºâ
              setTimeout(() => {
                this.showMonthlyReport = false;
                this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        // Á´ãÂç≥Âº∫Âà∂Êõ¥Êñ∞ËßÜÂõæÔºåÁ°Æ‰øùÂºπÁ™ó‰∏ç‰ºöÊòæÁ§∫
        this.$forceUpdate();
        
        // ‰ΩøÁî® nextTick ÂÜçÊ¨°Á°Æ‰øù
        this.$nextTick(() => {
          Object.assign(this, {
            showResetConfirm: false,
            showMemoryManager: false,
            showAddTodayModal: false,
            showTemplateManager: false,
            showMonthlyReport: false
          });
          this.$forceUpdate();
        });
        
        // ÂàùÂßãÂåñÊ°£Ê°à‰∏éÊï∞ÊçÆ
        this.initDebugMode();
        this.loadProfiles();
        this.loadJuniorStickers();
        this.loadThemeAndXp();
        this.loadMemoryData();
        if (this.applyBodyTheme) {
          this.applyBodyTheme();
        }
        this.updateBodyMode();

          // ÂàùÂßãÂåñÂë®ËßÜÂõæ
          const today = new Date();
          const day = today.getDay();
          const diff = today.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(today.setDate(diff));
          this.currentWeekStart = new Date(monday);

        // ËΩΩÂÖ•Ê®°ÊùøÂàóË°®
        if (this.loadTemplates) {
          this.loadTemplates();
        }

        // ËΩΩÂÖ•‰ªäÊó•‰ªªÂä° & ÂàùÂßãÈºìÂä±ËØ≠
          if (this.loadTodayTasks) {
        this.loadTodayTasks();
          }
        if (this.refreshQuote) {
          this.refreshQuote();
        }

        // PWA ÂÆâË£ÖÊèêÁ§∫
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          this.deferredPrompt = e;
          this.showInstall = true;
        });
        window.addEventListener('appinstalled', () => {
          this.showInstall = false;
          this.deferredPrompt = null;
        });
        // iOS ÂÆâË£ÖÊèêÁ§∫ÔºàSafariÔºâ
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isIos && !isStandalone) {
          this.showIosInstallHint = true;
        }

        // ÁõëÂê¨‰ªªÂä°ÂèòÂåñÔºåËá™Âä®‰øùÂ≠òÔºà‰øùÈô©Ôºâ
        this.$watch('tasks', () => {
          this.seniorStatsTick += 1;
          if (this.saveTodayTasks) {
            this.saveTodayTasks();
          }
        }, { deep: true });

        // ÁõëÂê¨ÂàÜÁ±ªÂàáÊç¢ÔºåÊ∏ÖÈô§ÁºìÂ≠ò
        this.$watch('memoryCategory', () => {
          this.reviewStatusCache = {};
        });
        
        // ÁõëÂê¨ËÆ∞ÂøÜÊï∞ÊçÆÂèòÂåñÔºåÊ∏ÖÈô§ÁºìÂ≠òÔºåÁ°Æ‰øùÂÜÖÂÆπÊõ¥Êñ∞
        this.$watch('memoryList', () => {
          this.reviewStatusCache = {};
        }, { deep: true });
        this.$watch('memorySchedule', () => {
          this.reviewStatusCache = {};
          this.seniorStatsTick += 1;
        }, { deep: true });
          
          // ÊúÄÂêéÂÜçÊ¨°Á°Æ‰øùÊâÄÊúâÂºπÁ™óÂÖ≥Èó≠ÔºàÈò≤Ê≠¢ÂºÇÊ≠•Êìç‰ΩúÊâìÂºÄÂºπÁ™óÔºâ
          // ‰ΩøÁî®Â§ö‰∏™Âª∂ËøüÁ°Æ‰øùË¶ÜÁõñÊâÄÊúâÂèØËÉΩÁöÑÂºÇÊ≠•Êìç‰Ωú
          [50, 100, 200, 500, 1000, 2000].forEach(delay => {
            setTimeout(() => {
              const shouldForceCloseMemory = this.showMemoryManager && !this._userInitiatedMemoryManager;
              const shouldForceCloseReport = this.showMonthlyReport && !this._userInitiatedMonthlyReport;
              if (shouldForceCloseMemory || shouldForceCloseReport) {
                console.log('‚ö†Ô∏è Ê£ÄÊµãÂà∞ÂºπÁ™óËá™Âä®ÊâìÂºÄÔºåÂº∫Âà∂ÂÖ≥Èó≠„ÄÇÂª∂Ëøü:', delay);
                this.showResetConfirm = false;
                if (shouldForceCloseMemory) this.showMemoryManager = false;
                this.showAddTodayModal = false;
                this.showTemplateManager = false;
                if (shouldForceCloseReport) this.showMonthlyReport = false;
                // ÂêåÊó∂Ê∏ÖÈô§Áî®Êà∑Ê†áËÆ∞
                if (shouldForceCloseMemory) this._userInitiatedMemoryManager = false;
                if (shouldForceCloseReport) this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }
            }, delay);
          });
        } catch (error) {
          console.error('ÂàùÂßãÂåñÊó∂Âá∫Èîô:', error);
        }
      }
    }).mount('#app');
      } catch (error) {
        console.error('ÂàõÂª∫ Vue Â∫îÁî®Êó∂Âá∫Èîô:', error);
        document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>ÈîôËØØÔºöÊó†Ê≥ïÂàõÂª∫ Vue Â∫îÁî®</h1><p>' + error.message + '</p></div>';
      }
    }
  </script>
  <!-- Service Worker Registration -->
  <script>
    // Ê≥®ÂÜå Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register(`sw.js?v=20260221-2355`)
          .then((registration) => {
            console.log('‚úÖ Service Worker Ê≥®ÂÜåÊàêÂäü:', registration.scope);
            
            // Ê£ÄÊü•Êõ¥Êñ∞
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Êñ∞ÁâàÊú¨ÂèØÁî®ÔºåÊèêÁ§∫Áî®Êà∑Âà∑Êñ∞
                  if (confirm('ÂèëÁé∞Êñ∞ÁâàÊú¨ÔºåÊòØÂê¶Á´ãÂç≥Âà∑Êñ∞Ôºü')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.log('‚ùå Service Worker Ê≥®ÂÜåÂ§±Ë¥•:', error);
          });
        
        // ÁõëÂê¨ Service Worker Êõ¥Êñ∞
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('üîÑ Service Worker Â∑≤Êõ¥Êñ∞');
        });
      });
    } else {
      console.log('‚ö†Ô∏è ÊµèËßàÂô®‰∏çÊîØÊåÅ Service Worker');
    }
  </script>
</body>
</html>
