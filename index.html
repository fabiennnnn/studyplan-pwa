<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¿«ä¹å­¦ä¹ å¤§å†’é™©</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="æ¯å¤©ä¸€ç‚¹ç‚¹ï¼ŒåšæŒå°±å¾ˆæ£’ï¼å­¦ä¹ æ‰“å¡åº”ç”¨">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="å­¦ä¹ å¤§å†’é™©">
  <meta name="apple-touch-fullscreen" content="yes">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Apple Touch Icons (iOS) -->
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png">
  <link rel="mask-icon" href="app-icon.svg" color="#4f46e5">
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --ink-900: #1f2937;
      --ink-700: #374151;
      --glass: rgba(255, 255, 255, 0.7);
      --shadow-soft: 0 16px 40px rgba(15, 23, 42, 0.08);
      --shadow-card: 0 12px 30px rgba(15, 23, 42, 0.12);
      --border-soft: rgba(148, 163, 184, 0.35);
      --primary-start: #10b981;
      --primary-end: #22c55e;
      --accent-start: #38bdf8;
      --accent-end: #3b82f6;
      --warm-start: #f59e0b;
      --warm-end: #f97316;
    }

    body {
      font-family: "Noto Sans SC", "ZCOOL XiaoWei", "ZCOOL KuaiLe", sans-serif;
      font-size: 15px;
      letter-spacing: 0.15px;
      background-color: #f8fafc;
      padding-bottom: env(safe-area-inset-bottom);
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        radial-gradient(circle at 12% 8%, rgba(56, 189, 248, 0.25), transparent 38%),
        radial-gradient(circle at 88% 16%, rgba(16, 185, 129, 0.25), transparent 40%),
        radial-gradient(circle at 80% 84%, rgba(251, 191, 36, 0.25), transparent 42%);
      opacity: 0.7;
      z-index: -1;
    }

    .mature-ui {
      filter: saturate(0.92);
    }
    .mature-ui .app-title {
      font-family: "Noto Sans SC", sans-serif;
      letter-spacing: 0.4px;
    }
    .mature-ui .soft-shadow {
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .mature-ui .glass {
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm,
    .mature-ui .theme-pill-active {
      filter: saturate(0.85) brightness(0.98);
    }
    .mature-ui .btn-primary,
    .mature-ui .btn-accent,
    .mature-ui .btn-warm {
      background: #0f172a;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.2);
    }
    .mature-ui .btn-accent {
      background: #1e293b;
    }
    .mature-ui .btn-warm {
      background: #334155;
    }
    body.mature-mode::before {
      opacity: 0.4;
    }

    * {
      -webkit-tap-highlight-color: transparent;
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid rgba(16, 185, 129, 0.5);
      outline-offset: 2px;
    }

    .app-title {
      font-family: "ZCOOL KuaiLe", "ZCOOL XiaoWei", serif;
      letter-spacing: 1px;
    }

    .soft-card {
      background: var(--glass);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-soft);
    }

    .soft-shadow {
      box-shadow: var(--shadow-card);
    }

    .lift {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .lift:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 38px rgba(15, 23, 42, 0.14);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
      box-shadow: 0 10px 20px rgba(16, 185, 129, 0.25);
    }

    .btn-primary:hover {
      filter: brightness(0.98);
    }

    .btn-accent {
      background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
      box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
    }

    .btn-warm {
      background: linear-gradient(135deg, var(--warm-start) 0%, var(--warm-end) 100%);
      box-shadow: 0 10px 20px rgba(249, 115, 22, 0.22);
    }

    .glow-ring {
      box-shadow: 0 0 0 6px rgba(16, 185, 129, 0.12);
    }

    /* åŸºç¡€åŠ¨ç”» & è‡ªå®šä¹‰æ ·å¼ */
    @keyframes coin-pop {
      0% {
        transform: translateY(0) scale(0.6);
        opacity: 0;
      }
      30% {
        transform: translateY(-20px) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-40px) scale(0.8);
        opacity: 0;
      }
    }
    .coin-anim {
      animation: coin-pop 0.6s ease-out forwards;
    }

    /* ä»»åŠ¡å®Œæˆæ‰“å‹¾çš„å°åŠ¨ç”» */
    @keyframes check-bounce {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .check-anim {
      animation: check-bounce 0.25s ease-out;
    }

    @keyframes reward-pop {
      0% { transform: translateY(10px) scale(0.95); opacity: 0; }
      60% { transform: translateY(-4px) scale(1.02); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }
    .reward-pop {
      animation: reward-pop 0.35s ease-out;
    }

    @keyframes sparkle {
      0% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
      50% { transform: scale(1.06) rotate(4deg); filter: drop-shadow(0 0 8px rgba(59,130,246,0.6)); }
      100% { transform: scale(1) rotate(0deg); filter: drop-shadow(0 0 0 rgba(255,255,255,0)); }
    }
    .diamond-sparkle {
      animation: sparkle 2.2s ease-in-out infinite;
    }
    @keyframes shimmer {
      0% { background-position: 0% 50%; }
      100% { background-position: 100% 50%; }
    }
    .diamond-bg {
      background: linear-gradient(135deg, #60a5fa 0%, #a5f3fc 35%, #e0f2fe 65%, #93c5fd 100%);
      background-size: 200% 200%;
      animation: shimmer 3.2s ease-in-out infinite;
    }
    @keyframes flag-wave {
      0% { transform: rotate(0deg); }
      50% { transform: rotate(6deg); }
      100% { transform: rotate(0deg); }
    }
    .flag-wave {
      animation: flag-wave 1.6s ease-in-out infinite;
      transform-origin: left center;
    }
    @keyframes icon-float {
      0% { transform: translateY(0); }
      50% { transform: translateY(-2px); }
      100% { transform: translateY(0); }
    }
    .icon-anim {
      animation: icon-float 2s ease-in-out infinite;
    }

    @keyframes fade-slide {
      0% { opacity: 0; transform: translateY(6px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .fade-slide {
      animation: fade-slide 0.25s ease-out;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 0; }
      15% { opacity: 1; }
      100% { transform: translateY(140px) rotate(260deg); opacity: 0; }
    }
    .confetti {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 20;
    }
    .confetti-piece {
      position: absolute;
      width: 8px;
      height: 12px;
      border-radius: 2px;
      opacity: 0;
      animation: confetti-fall var(--dur) ease-out var(--delay) forwards;
      left: var(--x);
      background: var(--color);
    }

    .drag-handle {
      cursor: grab;
      user-select: none;
    }
    .dragging {
      opacity: 0.6;
      transform: scale(0.98);
    }

    .theme-pill-active {
      color: #0f172a;
      border-color: rgba(15, 23, 42, 0.12);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.12);
    }

    .icon-badge {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.08) 70%);
      box-shadow:
        0 6px 16px rgba(15, 23, 42, 0.16),
        inset 0 2px 4px rgba(255, 255, 255, 0.7),
        inset 0 -3px 6px rgba(0, 0, 0, 0.12);
    }
    .logo-badge {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,0.9), rgba(255,255,255,0.2) 45%, rgba(0,0,0,0.1) 70%);
      box-shadow:
        0 8px 18px rgba(15, 23, 42, 0.18),
        inset 0 2px 5px rgba(255, 255, 255, 0.7),
        inset 0 -3px 8px rgba(0, 0, 0, 0.14);
    }
    .icon {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    .icon-badge .icon {
      width: 32px;
      height: 32px;
    }
    .logo-badge .icon {
      width: 38px;
      height: 38px;
    }

    /* ç®€å•çš„æµ®å±‚æ¯›ç»ç’ƒæ•ˆæœ */
    .glass {
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* å¼¹çª—è¿‡æ¸¡åŠ¨ç”» */
    .fade-enter-active, .fade-leave-active {
      transition: opacity 0.2s ease;
    }
    .fade-enter-from, .fade-leave-to {
      opacity: 0;
    }

    /* ç¡®ä¿å¼¹çª—åœ¨æœ€ä¸Šå±‚ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
    }
  </style>
</head>
<body class="min-h-screen text-slate-800">
  <svg aria-hidden="true" class="hidden">
    <!-- candy: fairy tale princess -->
    <symbol id="icon-candy-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
      <path d="M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-diamond" viewBox="0 0 24 24">
      <path d="M4 9l4-5h8l4 5-8 10z"></path>
      <path d="M8 4l4 15 4-15" fill="white" opacity="0.6"></path>
      <path d="M4 9h16" fill="white" opacity="0.35"></path>
    </symbol>
    <symbol id="icon-checkered" viewBox="0 0 24 24">
      <rect x="5" y="4" width="2" height="16" rx="1"></rect>
      <rect x="8" y="6" width="10" height="10" rx="1"></rect>
      <rect x="8" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="6" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="8.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="8" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="13" y="11" width="2.5" height="2.5" fill="white"></rect>
      <rect x="10.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
      <rect x="15.5" y="13.5" width="2.5" height="2.5" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="9" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <circle cx="9.5" cy="11" r="1" fill="white"></circle>
      <circle cx="14.5" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-candy-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="12" width="2.5" height="5" rx="1" fill="white"></rect>
      <rect x="11" y="9" width="2.5" height="8" rx="1" fill="white"></rect>
      <rect x="15" y="11" width="2.5" height="6" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-candy-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
      <rect x="11" y="16" width="2" height="4" rx="1"></rect>
    </symbol>
    <symbol id="icon-candy-star" viewBox="0 0 24 24">
      <path d="M12 3l3.2 6.4 7.1 1-5.2 5 1.3 7.1L12 19l-6.4 3.5 1.3-7.1-5.2-5 7.1-1z"></path>
    </symbol>
    <symbol id="icon-candy-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- forest: animals -->
    <symbol id="icon-forest-book" viewBox="0 0 24 24">
      <rect x="5" y="5" width="14" height="14" rx="3"></rect>
      <circle cx="10" cy="10" r="1.5" fill="white"></circle>
      <circle cx="14" cy="10" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-forest-brain" viewBox="0 0 24 24">
      <path d="M6 10a6 6 0 0 1 12 0c0 4-3 7-6 7s-6-3-6-7z"></path>
      <circle cx="9" cy="11" r="1" fill="white"></circle>
      <circle cx="15" cy="11" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-3 3 2 4-4" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-forest-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-forest-star" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="7"></circle>
      <circle cx="12" cy="12" r="3" fill="white"></circle>
    </symbol>
    <symbol id="icon-forest-award" viewBox="0 0 24 24">
      <path d="M12 3l4 4-4 4-4-4z"></path>
      <rect x="8" y="11" width="8" height="8" rx="2"></rect>
    </symbol>

    <!-- storybook: classic tale -->
    <symbol id="icon-storybook-book" viewBox="0 0 24 24">
      <rect x="4" y="4" width="16" height="16" rx="3"></rect>
      <path d="M8 8h8M8 11h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M12 9l2 3-3 2" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-storybook-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l3-4 3 3 4-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-storybook-mic" viewBox="0 0 24 24">
      <rect x="9" y="3" width="6" height="10" rx="3"></rect>
      <rect x="6" y="12" width="12" height="4" rx="2"></rect>
    </symbol>
    <symbol id="icon-storybook-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-storybook-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- ocean: sea life -->
    <symbol id="icon-ocean-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <circle cx="9" cy="12" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <path d="M8 12c2 1 4 1 6 0" fill="white"></path>
    </symbol>
    <symbol id="icon-ocean-brain" viewBox="0 0 24 24">
      <path d="M6 11a6 6 0 0 1 12 0c0 3-2 6-6 6s-6-3-6-6z"></path>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-ocean-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M6 14c2-2 4-2 6 0s4 2 6 0" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-ocean-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="7" y="13" width="10" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-ocean-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-ocean-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- space: blue robot vibe -->
    <symbol id="icon-space-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="7" y="8" width="10" height="2" rx="1" fill="white"></rect>
    </symbol>
    <symbol id="icon-space-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="14" cy="10" r="2" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-brain" viewBox="0 0 24 24">
      <rect x="6" y="6" width="12" height="12" rx="4"></rect>
      <circle cx="10" cy="12" r="1" fill="white"></circle>
      <circle cx="14" cy="12" r="1" fill="white"></circle>
    </symbol>
    <symbol id="icon-space-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M7 15l4-4 3 3 3-5" fill="none" stroke="white" stroke-width="2"></path>
    </symbol>
    <symbol id="icon-space-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-space-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-space-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>

    <!-- sunset: warm and simple -->
    <symbol id="icon-sunset-book" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <path d="M8 8h8" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-map" viewBox="0 0 24 24">
      <path d="M4 7l6-2 4 2 6-2v12l-6 2-4-2-6 2z"></path>
      <circle cx="12" cy="11" r="1.5" fill="white"></circle>
    </symbol>
    <symbol id="icon-sunset-brain" viewBox="0 0 24 24">
      <path d="M7 9a4 4 0 0 1 7-2 4 4 0 0 1 3 7 4 4 0 0 1-7 2 4 4 0 0 1-3-7z"></path>
      <path d="M9 13h6" fill="white"></path>
    </symbol>
    <symbol id="icon-sunset-chart" viewBox="0 0 24 24">
      <rect x="4" y="5" width="16" height="14" rx="3"></rect>
      <rect x="8" y="10" width="8" height="6" rx="2" fill="white"></rect>
    </symbol>
    <symbol id="icon-sunset-mic" viewBox="0 0 24 24">
      <rect x="9" y="4" width="6" height="9" rx="3"></rect>
      <rect x="6" y="13" width="12" height="3" rx="1.5"></rect>
    </symbol>
    <symbol id="icon-sunset-star" viewBox="0 0 24 24">
      <path d="M12 4l2 4 4 .6-3 3 .8 4.4L12 14l-3.8 2 1-4.4-3-3 4-.6z"></path>
    </symbol>
    <symbol id="icon-sunset-award" viewBox="0 0 24 24">
      <circle cx="12" cy="8" r="4"></circle>
      <path d="M8 12l-2 9 6-3 6 3-2-9z"></path>
    </symbol>
    <symbol id="icon-party" viewBox="0 0 24 24">
      <path d="M4 20l10-10 6 6-10 4z"></path>
      <circle cx="16" cy="6" r="2" fill="white"></circle>
      <circle cx="20" cy="8" r="1.5" fill="white"></circle>
      <circle cx="14" cy="3.5" r="1.2" fill="white"></circle>
    </symbol>
    <symbol id="icon-trophy" viewBox="0 0 24 24">
      <path d="M7 4h10v4a5 5 0 0 1-10 0z"></path>
      <path d="M7 6H4a3 3 0 0 0 3 3"></path>
      <path d="M17 6h3a3 3 0 0 1-3 3"></path>
      <rect x="10" y="13" width="4" height="3" rx="1"></rect>
      <rect x="8" y="16" width="8" height="4" rx="2"></rect>
    </symbol>
  </svg>
  <div id="app"
       :style="themeConfig.style"
       :class="{ 'mature-ui': isOlderKid }"
       class="min-h-screen flex flex-col items-center py-4 px-3 sm:px-6 lg:px-10 transition-colors duration-300">

    <!-- é¡¶éƒ¨æ ï¼šæ ‡é¢˜ + ä¸»é¢˜åˆ‡æ¢ + ç­‰çº§ä¿¡æ¯ -->
    <header class="w-full max-w-5xl flex items-center justify-between mb-3 sm:mb-4">
      <div>
        <h1 class="app-title text-2xl sm:text-3xl font-extrabold flex items-center gap-2 text-slate-900">
          <span class="inline-flex items-center justify-center logo-badge diamond-bg diamond-sparkle">
            <svg class="icon text-sky-400">
              <use href="#icon-diamond"></use>
            </svg>
          </span>
          å¿«ä¹å­¦ä¹ å¤§å†’é™©
        </h1>
        <p class="text-xs sm:text-sm text-slate-600 mt-1">
          æ¯å¤©ä¸€ç‚¹ç‚¹ï¼ŒåšæŒå°±å¾ˆæ£’ï¼ğŸ’ª
        </p>
      </div>

      <div class="flex flex-col items-end gap-2">
        <!-- è®¾ç½®/é‡ç½®æŒ‰é’® -->
        <button
          @click="openSettings"
          class="text-slate-400 hover:text-slate-600 text-xs px-2 py-1 rounded transition"
          title="æ¢å¤å‡ºå‚è®¾ç½®">
          âš™ï¸ è®¾ç½®
        </button>
        
        <div class="flex flex-col items-end gap-2">
          <!-- ä¸»é¢˜åˆ‡æ¢ -->
          <div class="flex items-center gap-1 sm:gap-2 text-xs sm:text-sm">
            <span class="text-slate-600">çš®è‚¤ï¼š</span>
            <button
              v-for="opt in themeOptions"
              :key="opt.value"
              @click="setTheme(opt.value)"
              class="px-2 sm:px-3 py-1 rounded-full border text-[11px] sm:text-xs font-medium transition flex items-center gap-1"
              :class="theme === opt.value ? 'theme-pill-active' : 'bg-white/50 text-slate-700 border-transparent hover:bg-white/90'"
              :style="theme === opt.value ? { background: opt.swatch } : {}">
              <span v-if="opt.icon">{{ opt.icon }}</span>
              {{ opt.label }}
            </button>
          </div>
          <div class="flex items-center gap-2 text-[11px] text-slate-600">
            <span class="px-2 py-0.5 rounded-full bg-white/70 border border-slate-200">
              ğŸ‘¤ {{ activeProfile.name }} Â· {{ activeProfile.age }}å²
            </span>
            <select
              v-model="activeProfileId"
              @change="setActiveProfile(activeProfileId)"
              class="text-[11px] px-2 py-1 rounded-full border border-slate-200 bg-white/80">
              <option v-for="p in profiles" :key="p.id" :value="p.id">
                {{ p.name }}ï¼ˆ{{ p.age }}å²ï¼‰
              </option>
            </select>
          </div>
          <button
            v-if="showInstall"
            @click="handleInstall"
            class="text-[11px] px-2 py-1 rounded-full bg-slate-900 text-white">
            å®‰è£…åˆ°æ¡Œé¢
          </button>
        </div>

        <!-- ç­‰çº§ / XP -->
        <div class="flex items-center gap-2 text-xs sm:text-sm bg-white/70 rounded-full px-3 py-1 soft-shadow">
          <span class="px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-[11px] sm:text-xs font-semibold">
            {{ levelDisplay.title }}
          </span>
          <span class="text-slate-600">
            Lv. {{ levelDisplay.level }} Â· XP {{ xp }} / {{ levelDisplay.nextXp }}
          </span>
          <div class="w-20 sm:w-32 h-2 bg-emerald-50 rounded-full overflow-hidden">
            <div class="h-full rounded-full bg-gradient-to-r from-emerald-400 to-lime-400"
                 :style="{ width: levelDisplay.progress + '%' }"></div>
          </div>
        </div>
      </div>
    </header>

    <!-- ä¸»ä½“å¡ç‰‡ï¼šå“åº”å¼å¸ƒå±€ï¼Œæ‰‹æœºç«–å±å•åˆ—ï¼Œå¹³æ¿æ¨ªå±å¯å¹¶æ’ -->
    <main class="w-full max-w-5xl flex-1 flex flex-col lg:flex-row gap-4 lg:gap-6">
      <!-- å·¦ä¾§ï¼šTabs + å†…å®¹ -->
      <section class="flex-1 flex flex-col">
        <!-- æ ‡ç­¾é¡µ -->
        <div class="flex rounded-2xl bg-white/85 soft-shadow overflow-hidden mb-3 text-sm lift">
          <button
            class="flex-1 py-2.5 sm:py-3 font-semibold transition"
            :class="activeTab === 'daily' ? 'bg-emerald-100 text-emerald-700' : 'bg-transparent text-slate-500 hover:bg-slate-100'"
            @click="activeTab = 'daily'">
            ä»Šæ—¥å¤§å†’é™©
          </button>
          <button
            class="flex-1 py-2.5 sm:py-3 font-semibold transition"
            :class="activeTab === 'memory' ? 'bg-sky-100 text-sky-700' : 'bg-transparent text-slate-500 hover:bg-slate-100'"
            @click="activeTab = 'memory'">
            è®°å¿†æŒ‘æˆ˜
          </button>
          <button
            class="flex-1 py-2.5 sm:py-3 font-semibold transition"
            :class="activeTab === 'stats' ? 'bg-purple-100 text-purple-700' : 'bg-transparent text-slate-500 hover:bg-slate-100'"
            @click="activeTab = 'stats'">
            ç»Ÿè®¡æŠ¥è¡¨
          </button>
        </div>

        <!-- å†…å®¹å¡ç‰‡ -->
        <div class="flex-1 glass rounded-3xl bg-white/80 soft-shadow p-3 sm:p-4 lg:p-5 flex flex-col overflow-hidden lift">
          <!-- ä»Šæ—¥å¤§å†’é™©ï¼šæ¯æ—¥è®¡åˆ’ + æ‰“å¡ -->
          <div v-if="activeTab === 'daily'" class="flex-1 flex flex-col fade-slide">
            <!-- æ¨¡å—æ ‡é¢˜ -->
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <span v-if="!isOlderKid" class="icon-badge bg-slate-100 text-slate-800">
                  <svg class="icon icon-anim flag-wave"><use href="#icon-checkered"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ä»Šæ—¥å¤§å†’é™©</p>
                  <p class="text-[11px] text-slate-500">å®Œæˆæ¯ä¸€ä¸ªå°ä»»åŠ¡ï¼Œå°±æ˜¯å‡çº§çš„ä¸€æ­¥</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200">æ¯æ—¥è®¡åˆ’</span>
            </div>

            <!-- ä»Šæ—¥è¿›åº¦ä»ªè¡¨ç›˜ -->
            <div class="relative mb-3 rounded-2xl bg-white/90 border border-emerald-100 px-3 py-2 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <svg class="w-14 h-14" viewBox="0 0 80 80">
                  <circle cx="40" cy="40" r="28" stroke="#e2e8f0" stroke-width="10" fill="none"></circle>
                  <circle
                    cx="40" cy="40" r="28" stroke="#10b981" stroke-width="10" fill="none"
                    stroke-linecap="round"
                    :stroke-dasharray="progressRing.circumference"
                    :stroke-dashoffset="progressRing.offset"
                    transform="rotate(-90 40 40)"></circle>
                </svg>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ä»Šæ—¥è¿›åº¦</p>
                  <p class="text-[11px] text-slate-500">
                    å·²å®Œæˆ {{ todayProgress.done }} / {{ todayProgress.total }} ä¸ªä»»åŠ¡
                  </p>
                </div>
              </div>
              <div class="text-right">
                <p class="text-xl font-bold text-emerald-600">{{ todayProgress.percent }}%</p>
                <p class="text-[11px] text-slate-400">å®Œæˆç‡</p>
              </div>

              <!-- å½©çº¸åŠ¨ç”» -->
              <div v-if="showConfetti" class="confetti">
                <span v-for="n in confettiPieces"
                      :key="n"
                      class="confetti-piece"
                      :style="confettiStyle(n)"></span>
              </div>
            </div>
            <!-- ä»Šæ—¥ä¿¡æ¯ + æ¨¡æ¿ç®¡ç† -->
            <div class="flex items-center justify-between mb-2 sm:mb-3 flex-wrap gap-2">
              <div>
                <p class="text-xs text-slate-500">
                  ä»Šå¤©æ˜¯ <span class="font-semibold text-slate-700">{{ todayLabel }}</span>
                </p>
              </div>
              <div class="flex items-center gap-2">
              <button
                @click="openTemplateManager"
                class="text-[11px] sm:text-xs px-2 py-1 rounded-full border border-blue-200
                       bg-blue-50 text-blue-700 hover:bg-blue-100 transition">
                  ğŸ“‹ ç®¡ç†æ¨¡æ¿
                </button>
                <select
                  v-model="selectedTemplateId"
                  @change="applyTemplate"
                class="text-[11px] sm:text-xs px-2 py-1 rounded-full border border-emerald-200
                       bg-emerald-50 text-emerald-700 hover:bg-emerald-100 transition">
                  <option value="">é€‰æ‹©æ¨¡æ¿...</option>
                  <option v-for="tpl in templates" :key="tpl.id" :value="tpl.id">
                    {{ tpl.name }}
                  </option>
                </select>
              </div>
            </div>

            <!-- æˆå°±å¥–åŠ±å¡ -->
            <transition name="fade">
              <div v-if="rewardToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-emerald-500 to-lime-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">ğŸ†</span>
                    <div>
                      <p class="text-sm font-semibold">{{ rewardToast.title }}</p>
                      <p class="text-[11px] text-emerald-50">{{ rewardToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">+{{ rewardToast.xp }} XP</span>
                </div>
              </div>
            </transition>

            <transition name="fade">
              <div v-if="allDoneToast.visible"
                   class="mb-2 rounded-2xl bg-gradient-to-r from-amber-400 via-orange-400 to-rose-400 text-white px-4 py-3 shadow-lg reward-pop">
                <div class="flex items-center justify-between gap-2">
                  <div class="flex items-center gap-2">
                    <span class="text-lg">ğŸ‰</span>
                    <div>
                      <p class="text-sm font-semibold">{{ allDoneToast.title }}</p>
                      <p class="text-[11px] text-amber-50">{{ allDoneToast.subtitle }}</p>
                    </div>
                  </div>
                  <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">ä»Šæ—¥å…¨æ¸…</span>
                </div>
              </div>
            </transition>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="space-y-2 sm:space-y-2.5 overflow-y-auto pr-1 flex-1">
              <div v-if="tasks.length === 0"
                   class="text-xs sm:text-sm text-slate-500 bg-white/70 rounded-2xl px-3 py-2 border border-slate-200/60">
                è¿˜æ²¡æœ‰ä»»åŠ¡ï¼Œå…ˆæ·»åŠ å‡ ä¸ªä»Šå¤©çš„å°ç›®æ ‡å§ï¼Œæ¯”å¦‚ï¼š<br />
                <span class="text-emerald-700">é˜…è¯» 15 åˆ†é’Ÿ Â· å®Œæˆæ•°å­¦ç»ƒä¹  2 é¡µ Â· èƒŒå¤è¯— 1 é¦–</span>
              </div>

              <div v-for="(task, index) in tasks"
                   :key="task.id"
                   class="flex items-center justify-between bg-white/95 rounded-2xl px-3 sm:px-4 py-2 sm:py-2.5 shadow-sm border border-slate-100"
                   :class="{ dragging: dragIndex === index }"
                   draggable="true"
                   @dragstart="onDragStart(index)"
                   @dragover.prevent
                   @drop="onDrop(index)"
                   @dragend="onDragEnd">
                  <div class="flex items-center gap-2 sm:gap-3 flex-1">
                  <span class="drag-handle text-slate-300 hover:text-slate-500">â‹®â‹®</span>
                  <!-- æ‰“å¡åœ†åœˆ + åŠ¨ç”»å±‚ -->
                  <div class="relative flex items-center justify-center">
                    <button
                      @click="toggleTask(task)"
                      class="h-7 w-7 sm:h-8 sm:w-8 rounded-full border-2 flex items-center justify-center transition bg-slate-50"
                      :class="task.done ? 'border-amber-400 bg-amber-100 shadow-inner' : 'border-slate-300 hover:border-emerald-400 hover:bg-emerald-50'">
                      <span v-if="task.done" class="text-amber-500 text-lg check-anim">âœ“</span>
                    </button>
                    <!-- é‡‘å¸åŠ¨ç”» -->
                    <div v-if="task.coinAnimating"
                         class="absolute -top-1 -right-2 text-base sm:text-lg coin-anim select-none">
                      ğŸª™
                    </div>
                  </div>

                  <div class="flex flex-col flex-1">
                    <span
                      class="text-xs sm:text-sm font-medium"
                      :class="task.done ? 'line-through text-slate-400' : 'text-slate-800'">
                      {{ task.title }}
                    </span>
                    <div class="flex items-center gap-2 mt-0.5 flex-wrap">
                      <span v-if="task.startTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-emerald-50 text-[11px] text-emerald-700 border border-emerald-200">
                        â° å¼€å§‹ {{ task.startTime }}
                      </span>
                      <span v-if="task.done && task.endTime"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-amber-50 text-[11px] text-amber-700 border border-amber-200">
                        âœ… å®Œæˆ {{ task.endTime }}
                      </span>
                      <span v-if="task.startTime && !task.done"
                            class="inline-flex items-center px-1.5 py-0.5 rounded-full bg-blue-50 text-[11px] text-blue-700 border border-blue-200">
                        ğŸŸ¢ è¿›è¡Œä¸­
                    </span>
                  </div>
                </div>

                  <!-- æ“ä½œæŒ‰é’®ç»„ -->
                  <div class="flex items-center gap-1 sm:gap-2">
                    <button
                      v-if="!task.done && !task.startTime"
                      @click="startTask(task)"
                      class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-emerald-500 text-white hover:bg-emerald-600 transition">
                      å¼€å§‹
                    </button>
                <button
                  @click="removeTask(index)"
                  class="text-[10px] sm:text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-500 hover:bg-rose-100">
                  åˆ é™¤
                </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- æ·»åŠ ä»»åŠ¡ -->
            <div class="mt-3 pt-3 border-t border-slate-200/70">
              <form @submit.prevent="addTask" class="flex flex-col gap-2">
                <div class="flex flex-col sm:flex-row gap-2">
                <input v-model="newTaskTitle"
                       type="text"
                       placeholder="ä¾‹å¦‚ï¼šæœ—è¯»è¯¾æ–‡ 2 é"
                       class="flex-1 rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm
                              focus:outline-none focus:ring-2 focus:ring-emerald-300 focus:border-emerald-400 bg-white/90" />
                <button
                  type="submit"
                  class="px-4 py-2 rounded-2xl text-white text-xs sm:text-sm font-semibold
                         shadow active:scale-95 transition btn-primary">
                  + æ·»åŠ ä»»åŠ¡
                </button>
                </div>
                <p class="text-[11px] text-slate-400">
                  æç¤ºï¼šæ·»åŠ ä»»åŠ¡åï¼Œç‚¹å‡»"å¼€å§‹"æŒ‰é’®è®°å½•å¼€å§‹æ—¶é—´ï¼Œå®Œæˆåä¼šè‡ªåŠ¨è®°å½•ç»“æŸæ—¶é—´ã€‚
                </p>
              </form>
            </div>
          </div>

          <!-- è‰¾å®¾æµ©æ–¯è®°å¿†æŒ‘æˆ˜ -->
          <div v-else-if="activeTab === 'memory'" class="flex-1 flex flex-col gap-3 text-xs sm:text-sm overflow-hidden fade-slide">
            <!-- æ¨¡å—æ ‡é¢˜ -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span v-if="!isOlderKid" class="icon-badge bg-sky-100 text-sky-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.brain}`" :xlink:href="`#${iconSet.brain}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">è®°å¿†æŒ‘æˆ˜</p>
                  <p class="text-[11px] text-slate-500">è·Ÿéšè‰¾å®¾æµ©æ–¯æ›²çº¿å·©å›ºå­¦ä¹ </p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-sky-50 text-sky-600 border border-sky-200">å¤ä¹ è®¡åˆ’</span>
            </div>
            <!-- åˆ†ç±»é€‰æ‹© -->
            <div class="flex items-center gap-2 bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="memoryCategory = 'poetry'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'poetry'
                  ? 'bg-amber-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                ğŸ“œ å¤è¯—è¯
              </button>
              <button
                @click="memoryCategory = 'english'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'english'
                  ? 'bg-emerald-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                ğŸ”¤ è‹±è¯­
              </button>
              <button
                @click="memoryCategory = 'science'"
                class="px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold transition"
                :class="memoryCategory === 'science'
                  ? 'bg-sky-500 text-white'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                ğŸ§ª æ•°ç†åŒ–
              </button>
              <span class="ml-auto text-[11px] text-slate-500">
                {{ memoryCategoryLabel }}
              </span>
            </div>

            <!-- æ·»åŠ è®°å¿†å†…å®¹æŒ‰é’® -->
            <div class="flex justify-end gap-2">
              <button
                @click="addTodayMemory"
                class="px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-primary">
                â• æ·»åŠ {{ memoryCategoryLabel }}å†…å®¹
              </button>
              <button
                @click="openMemoryManager"
                class="px-4 py-2 rounded-xl text-white text-xs sm:text-sm font-semibold
                       active:scale-95 transition shadow btn-accent">
                ğŸ“š æ‰¹é‡å¯¼å…¥è®°å¿†ä»»åŠ¡
              </button>
            </div>

            <!-- å‘¨è§†å›¾å¯¼èˆª -->
            <div class="flex items-center justify-between bg-white/90 rounded-2xl px-3 py-2">
              <button
                @click="prevWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                â† ä¸Šä¸€å‘¨
              </button>
              <span class="font-semibold text-slate-800">{{ currentWeekLabel }}</span>
              <button
                @click="nextWeek"
                class="px-2 py-1 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-xs">
                ä¸‹ä¸€å‘¨ â†’
              </button>
            </div>

            <!-- å‘¨è§†å›¾ä»»åŠ¡è¡¨æ ¼ -->
            <div class="flex-1 overflow-x-auto overflow-y-auto bg-white rounded-2xl border-2 border-slate-300 shadow-lg">
              <table class="text-xs border-collapse" style="table-layout: auto; width: 100%;">
                <colgroup>
                  <col style="width: 65px;">
                  <col>
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 40px;">
                  <col style="width: 60px;" v-for="n in 6" :key="n">
                </colgroup>
                <thead class="bg-gradient-to-r from-amber-100 to-yellow-50 border-b-2 border-amber-300 sticky top-0 z-10 shadow-sm">
                  <tr>
                    <th class="px-2 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">æ—¥æœŸ</th>
                    <th class="px-3 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200">å­¦ä¹ å†…å®¹</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="3">å­¦ä¹ è®¡åˆ’</th>
                    <th class="px-1.5 py-2.5 text-center font-bold text-slate-900 border-r border-amber-200" colspan="6">åç»­å¤ä¹ æ—¥æœŸ</th>
                  </tr>
                  <tr class="bg-gradient-to-r from-amber-50 to-yellow-50/50">
                    <th class="px-2 py-1.5 border-r border-amber-200"></th>
                    <th class="px-3 py-1.5 border-r border-amber-200"></th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">5åˆ†</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">30åˆ†</th>
                    <th class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">12æ—¶</th>
                    <th v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-1.5 text-center font-semibold text-slate-700 border-r border-amber-200">
                      +{{ offset }}å¤©
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(item, rowIdx) in weeklyMemoryItems" :key="item.id"
                      :class="rowIdx % 2 === 0 ? 'bg-white' : 'bg-slate-50/30'"
                      class="border-b border-slate-200 hover:bg-amber-50/50 transition-colors">
                    <td class="px-2 py-3 border-r border-slate-200 text-center">
                      <div class="flex flex-col items-center justify-center">
                        <span class="font-bold text-slate-900 text-sm leading-tight">{{ item.learnDate }}</span>
                        <span class="text-[9px] text-slate-500 mt-0.5 leading-tight">{{ item.learnYear }}</span>
                      </div>
                    </td>
                    <td class="px-3 py-3 border-r border-slate-200" style="word-wrap: break-word; word-break: break-word; overflow-wrap: break-word;">
                      <div v-if="editingMemoryId !== item.id" 
                           class="flex flex-col justify-center min-h-[40px] group relative">
                        <span class="font-semibold text-slate-900 leading-snug text-center break-words">{{ item.title }}</span>
                        <div v-if="item.dynasty" class="mt-1 flex items-center justify-center">
                          <span class="px-1.5 py-0.5 rounded-full text-[9px] text-white"
                                :style="{ backgroundColor: dynastyColor(item.dynasty) }">
                            {{ item.dynasty }}
                          </span>
                          <span v-if="item.author" class="ml-1 text-[10px] text-slate-600">Â· {{ item.author }}</span>
                        </div>
                        <span v-else-if="item.content" class="text-[10px] text-slate-600 mt-1 leading-tight text-center break-words">{{ item.content }}</span>
                        <button
                          v-if="canEditMemoryItem(item)"
                          @click.stop="startEditMemory(item)"
                          class="absolute right-0 top-0 opacity-0 group-hover:opacity-100 transition-opacity
                                 px-1.5 py-0.5 rounded text-[10px] bg-blue-100 text-blue-700 hover:bg-blue-200">
                          ç¼–è¾‘
                        </button>
                      </div>
                      <div v-else class="flex flex-col gap-1.5">
              <input
                          v-model="editingMemoryTitle"
                type="text"
                          placeholder="æ ‡é¢˜"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <input
                          v-model="editingMemoryContent"
                          type="text"
                          placeholder="å†…å®¹è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰"
                          class="px-2 py-1 rounded border border-blue-300 text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                          @keyup.enter="saveEditMemory(item)"
                          @keyup.esc="cancelEditMemory" />
                        <div class="flex gap-1">
              <button
                            @click.stop="saveEditMemory(item)"
                            class="flex-1 px-2 py-1 rounded bg-emerald-500 text-white text-[10px] hover:bg-emerald-600">
                            ä¿å­˜
              </button>
                          <button
                            @click.stop="cancelEditMemory"
                            class="flex-1 px-2 py-1 rounded bg-slate-200 text-slate-700 text-[10px] hover:bg-slate-300">
                            å–æ¶ˆ
                          </button>
                        </div>
                      </div>
                    </td>
                    <!-- å³æ—¶å¤ä¹ æ—¶é—´ç‚¹ -->
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '5min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['5min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['5min']?.done" class="text-sm font-bold">âœ“</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '30min')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['30min']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['30min']?.done" class="text-sm font-bold">âœ“</span>
                      </button>
                    </td>
                    <td class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <button
                        @click.stop="toggleReviewCheck(item.id, '12h')"
                        class="h-7 w-7 rounded-lg border-2 flex items-center justify-center mx-auto transition-all
                               flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                        :class="item.reviews['12h']?.done
                          ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                          : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                        <span v-if="item.reviews['12h']?.done" class="text-sm font-bold">âœ“</span>
                      </button>
                    </td>
                    <!-- è‰¾å®¾æµ©æ–¯å¤ä¹ æ—¥æœŸ -->
                    <td v-for="(offset, idx) in [1, 2, 4, 7, 15, 30]" :key="idx"
                        class="px-1.5 py-3 text-center border-r border-slate-200 align-middle">
                      <div class="flex flex-col items-center justify-center gap-1">
                        <span class="text-[8px] text-slate-500 leading-tight">{{ item.reviews[offset]?.date || '-' }}</span>
                        <button
                          v-if="item.reviews[offset]"
                          @click.stop="toggleReviewCheck(item.id, offset)"
                          class="h-7 w-7 rounded-lg border-2 flex items-center justify-center transition-all
                                 flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md"
                          :class="item.reviews[offset].done
                            ? 'border-emerald-500 bg-emerald-100 text-emerald-700 shadow-inner'
                            : 'border-slate-300 bg-white hover:border-emerald-400 hover:bg-emerald-50'">
                          <span v-if="item.reviews[offset].done" class="text-sm font-bold">âœ“</span>
                        </button>
                        <span v-else class="text-slate-300 text-[8px]">-</span>
                      </div>
                    </td>
                  </tr>
                  <tr v-if="weeklyMemoryItems.length === 0">
                    <td colspan="10" class="px-4 py-12 text-center text-slate-400 text-sm bg-white">
                      <div class="flex flex-col items-center gap-2">
                        <span class="text-2xl">ğŸ“š</span>
                        <span>æœ¬å‘¨æš‚æ— è®°å¿†ä»»åŠ¡</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            </div>

          <!-- ç»Ÿè®¡æŠ¥è¡¨ -->
          <div v-else-if="activeTab === 'stats'" class="flex-1 flex flex-col gap-4 overflow-y-auto fade-slide">
            <!-- æ¨¡å—æ ‡é¢˜ -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span v-if="!isOlderKid" class="icon-badge bg-purple-100 text-purple-700">
                  <svg class="icon icon-anim"><use :href="`#${iconSet.chart}`" :xlink:href="`#${iconSet.chart}`"></use></svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-slate-800">ç»Ÿè®¡æŠ¥è¡¨</p>
                  <p class="text-[11px] text-slate-500">æŠŠåŠªåŠ›å˜æˆæ¸…æ™°çš„æ•°æ®</p>
                </div>
              </div>
              <span class="text-[11px] px-2 py-0.5 rounded-full bg-purple-50 text-purple-600 border border-purple-200">æ•°æ®é¢æ¿</span>
            </div>
            <!-- ç»Ÿè®¡è§†å›¾åˆ‡æ¢ -->
            <div class="flex items-center gap-2 mb-2">
              <button
                @click="statsViewMode = 'daily'"
                class="px-3 py-1.5 rounded-full text-xs sm:text-sm font-semibold transition"
                :class="statsViewMode === 'daily'
                  ? 'bg-purple-100 text-purple-700'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                æ¯æ—¥ç»Ÿè®¡
              </button>
              <button
                @click="statsViewMode = 'task'"
                class="px-3 py-1.5 rounded-full text-xs sm:text-sm font-semibold transition"
                :class="statsViewMode === 'task'
                  ? 'bg-purple-100 text-purple-700'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'">
                ä»»åŠ¡ç»Ÿè®¡
              </button>
                  </div>

            <!-- æ¯æ—¥ç»Ÿè®¡ -->
            <div v-if="statsViewMode === 'daily'" class="space-y-4">
              <div class="bg-purple-50/80 border border-purple-100 rounded-2xl px-3 py-2">
                <p class="font-semibold text-purple-700 mb-1 text-sm">æ¯æ—¥å­¦ä¹ æ—¶é—´ç»Ÿè®¡</p>
                <p class="text-xs text-slate-600">æŸ¥çœ‹æ¯å¤©å®Œæˆçš„å­¦ä¹ æ€»æ—¶é•¿</p>
            </div>

              <!-- æ¯æ—¥ç»Ÿè®¡å›¾è¡¨ -->
              <div class="bg-white/90 rounded-2xl p-3 sm:p-4 shadow-sm">
                <canvas id="dailyChart" class="w-full" style="max-height: 260px;"></canvas>
              </div>

              <!-- æ¯æ—¥ç»Ÿè®¡è¡¨æ ¼ -->
              <div class="bg-white/90 rounded-2xl p-3 sm:p-4 shadow-sm overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                  <thead>
                    <tr class="border-b border-slate-200">
                      <th class="text-left py-2 px-2 font-semibold text-slate-700">æ—¥æœŸ</th>
                      <th class="text-left py-2 px-2 font-semibold text-slate-700">å®Œæˆä»»åŠ¡æ•°</th>
                      <th class="text-right py-2 px-2 font-semibold text-slate-700">æ€»æ—¶é•¿</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="day in dailyStats" :key="day.date"
                        class="border-b border-slate-100 hover:bg-purple-50/50">
                      <td class="py-2 px-2 text-slate-800">{{ day.dateLabel }}</td>
                      <td class="py-2 px-2 text-slate-600">{{ day.taskCount }} ä¸ª</td>
                      <td class="py-2 px-2 text-right font-semibold text-purple-700">{{ day.totalTime }}</td>
                    </tr>
                    <tr v-if="dailyStats.length === 0">
                      <td colspan="3" class="py-4 text-center text-slate-400">æš‚æ— ç»Ÿè®¡æ•°æ®</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- ä»»åŠ¡ç»Ÿè®¡ -->
            <div v-else class="space-y-4">
              <div class="bg-purple-50/80 border border-purple-100 rounded-2xl px-3 py-2">
                <p class="font-semibold text-purple-700 mb-1 text-sm">å„ä»»åŠ¡å­¦ä¹ æ—¶é—´ç»Ÿè®¡</p>
                <p class="text-xs text-slate-600">æŸ¥çœ‹æ¯ä¸ªä»»åŠ¡ç´¯è®¡çš„å­¦ä¹ æ—¶é•¿</p>
              </div>

              <!-- ä»»åŠ¡ç»Ÿè®¡å›¾è¡¨ -->
              <div class="bg-white/90 rounded-2xl p-3 sm:p-4 shadow-sm">
                <canvas id="taskChart" class="w-full" style="max-height: 260px;"></canvas>
              </div>

              <!-- ä»»åŠ¡ç»Ÿè®¡è¡¨æ ¼ -->
              <div class="bg-white/90 rounded-2xl p-3 sm:p-4 shadow-sm overflow-x-auto">
                <table class="w-full text-xs sm:text-sm">
                  <thead>
                    <tr class="border-b border-slate-200">
                      <th class="text-left py-2 px-2 font-semibold text-slate-700">ä»»åŠ¡åç§°</th>
                      <th class="text-left py-2 px-2 font-semibold text-slate-700">å®Œæˆæ¬¡æ•°</th>
                      <th class="text-right py-2 px-2 font-semibold text-slate-700">ç´¯è®¡æ—¶é•¿</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="(task, idx) in taskStats" :key="task.title"
                        class="border-b border-slate-100 hover:bg-purple-50/50">
                      <td class="py-2 px-2">
                        <div class="flex items-center gap-2">
                          <span class="inline-block w-3 h-3 rounded-full"
                                :style="{ backgroundColor: task.color }"></span>
                          <span class="text-slate-800">{{ task.title }}</span>
                        </div>
                      </td>
                      <td class="py-2 px-2 text-slate-600">{{ task.count }} æ¬¡</td>
                      <td class="py-2 px-2 text-right font-semibold"
                          :style="{ color: task.color }">{{ task.totalTime }}</td>
                    </tr>
                    <tr v-if="taskStats.length === 0">
                      <td colspan="3" class="py-4 text-center text-slate-400">æš‚æ— ç»Ÿè®¡æ•°æ®</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- æ•°æ®ç®¡ç†åŒºåŸŸ -->
            <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-2xl p-4 shadow-sm">
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xl">ğŸ—„ï¸</span>
                <h3 class="font-bold text-blue-900 text-sm sm:text-base">æ•°æ®å½’æ¡£ä¸ç©ºé—´æ¸…ç†</h3>
              </div>
              <p class="text-xs text-slate-600 mb-4">
                å®šæœŸæ¸…ç†3ä¸ªæœˆå‰çš„æ—§æ•°æ®ï¼Œé‡Šæ”¾å­˜å‚¨ç©ºé—´ã€‚æ•°æ®ä¼šå…ˆå¤‡ä»½ä¸ºJSONæ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç¡®è®¤åå†ä»Appä¸­åˆ é™¤ã€‚
              </p>
              
              <div class="space-y-3">
              <button
                @click="archiveOldData"
                class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold
                       active:scale-95 transition shadow-md btn-accent">
                ğŸ“¦ æ¸…ç†æ—§æ•°æ®ï¼ˆå½’æ¡£3ä¸ªæœˆå‰çš„æ•°æ®ï¼‰
              </button>
              
              <button
                @click="importArchive"
                class="w-full px-4 py-2.5 rounded-xl text-white text-sm font-semibold
                       active:scale-95 transition shadow-md btn-warm">
                ğŸ“¥ å¯¼å…¥å†å²å½’æ¡£
              </button>
                
                <div class="text-[10px] text-slate-500 mt-2 pt-2 border-t border-blue-200">
                  ğŸ’¡ æç¤ºï¼šå½’æ¡£æ–‡ä»¶ä¼šä¿å­˜åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œæ–‡ä»¶åæ ¼å¼ä¸º backup_YYYY_QN.json
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- å³ä¾§ï¼šè¯­éŸ³é¼“åŠ± & å®¶é•¿åŒºï¼ˆç®€ç‰ˆï¼‰ -->
      <aside class="w-full lg:w-80 flex-shrink-0 flex flex-col gap-3">
        <!-- è¯­éŸ³é¼“åŠ±å¡ç‰‡ï¼ˆå ä½ç‰ˆï¼‰ -->
        <div class="glass bg-white/85 rounded-3xl soft-shadow p-3 sm:p-4 flex flex-col gap-2 lift">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span v-if="!isOlderKid" class="icon-badge bg-rose-100 text-rose-700">
                <svg class="icon icon-anim"><use href="#icon-party"></use></svg>
              </span>
              <div>
                <p class="text-sm font-semibold text-slate-800">è¯­éŸ³é¼“åŠ±</p>
                <p class="text-[11px] text-slate-500">5â€“10 ç§’å°ç¥ç¦</p>
              </div>
            </div>
            <span class="text-[11px] px-2 py-0.5 rounded-full bg-rose-50 text-rose-600 border border-rose-200">å®¶é•¿åŒº</span>
          </div>
          <p class="text-xs text-slate-600 leading-snug">
            çˆ¸çˆ¸å¦ˆå¦ˆå¯ä»¥å½•ä¸€æ®µé¼“åŠ±çš„è¯ã€‚å­©å­å®Œæˆä»»åŠ¡æ‰“å¡æ—¶ï¼Œä¼šä¼˜å…ˆæ’­æ”¾è¿™æ®µæš–å¿ƒè¯­éŸ³ã€‚
            å½“å‰ç‰ˆæœ¬å…ˆæ”¾å¥½æŒ‰é’®å’Œæç¤ºï¼Œä¸‹ä¸€ç‰ˆæˆ‘ä¼šåŠ ä¸Šæ­£å¼çš„å½•éŸ³å’Œå›æ”¾åŠŸèƒ½ã€‚
          </p>
          <div class="flex items-center gap-2 mt-1">
            <button
              type="button"
              @click="toggleRecording"
              class="flex-1 px-3 py-2 rounded-2xl text-xs sm:text-sm font-semibold
                     flex items-center justify-center gap-1 transition shadow"
              :class="isRecording
                ? 'bg-rose-500 text-white'
                : 'text-white btn-primary'">
              <span :class="isRecording ? 'animate-pulse' : ''">â—</span>
              {{ isRecording ? 'æ­£åœ¨å½•éŸ³â€¦ ç‚¹å‡»åœæ­¢' : 'å½•åˆ¶é¼“åŠ±è¯­éŸ³' }}
            </button>
            <button
              type="button"
              @click="playAudio"
              :disabled="!audioUrl"
              class="px-3 py-2 rounded-2xl text-xs sm:text-sm font-semibold
                     border transition"
              :class="audioUrl
                ? 'bg-white text-emerald-700 border-emerald-200 hover:bg-emerald-50'
                : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'">
              â–¶ å›æ”¾
            </button>
          </div>
          <p class="text-[11px] text-slate-400 mt-1">
            æ²¡æœ‰å½•éŸ³æ—¶ï¼Œä¼šéšæœºæ˜¾ç¤ºé¼“åŠ±è¯­ï¼Œå¦‚â€œä½ æ˜¯æœ€æ£’çš„ï¼â€â€œä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡ï¼â€ã€‚
          </p>
        </div>

        <!-- iOS å®‰è£…æç¤º -->
        <div v-if="showIosInstallHint" class="glass bg-white/80 rounded-3xl soft-shadow p-3 sm:p-4 text-xs sm:text-sm lift">
          <div class="flex items-center gap-2 mb-1">
            <span class="icon-badge bg-slate-100 text-slate-700" style="width:32px;height:32px">
              <svg class="icon icon-anim"><use href="#icon-star"></use></svg>
            </span>
            <span class="font-semibold text-slate-800">iPhone å®‰è£…æç¤º</span>
          </div>
          <p class="text-slate-600 leading-snug">
            ç”¨ Safari æ‰“å¼€åï¼Œç‚¹å‡»åº•éƒ¨â€œåˆ†äº«â€å›¾æ ‡ï¼Œå†é€‰æ‹©â€œæ·»åŠ åˆ°ä¸»å±å¹•â€ã€‚
          </p>
          <button
            class="mt-2 px-3 py-2 rounded-xl bg-slate-900 text-white text-xs"
            @click="showIosInstallHint = false">
            æˆ‘çŸ¥é“äº†
          </button>
        </div>

        <!-- éšæœºé¼“åŠ±è¯­ + å®¶é•¿åŒº ç®€è¦ -->
        <div class="glass bg-white/85 rounded-3xl soft-shadow p-3 sm:p-4 flex flex-col gap-2 lift">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-slate-800 flex items-center gap-2">
              <span v-if="!isOlderKid" class="icon-badge bg-amber-100 text-amber-700" style="width:32px;height:32px">
                <svg class="icon icon-anim"><use href="#icon-trophy"></use></svg>
              </span>
              ä»Šæ—¥é¼“åŠ±
            </span>
            <button
              type="button"
              class="text-[11px] px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-200"
              @click="refreshQuote">
              æ¢ä¸€å¥
            </button>
          </div>
          <p class="text-sm text-emerald-700 leading-snug">
            â€œ{{ currentQuote }}â€
          </p>
          <p class="text-[11px] text-slate-400">
            å°æç¤ºï¼šå®¶é•¿å¯ä»¥æ¯å¤©å’Œå­©å­ä¸€èµ·å›é¡¾å®Œæˆäº†å“ªäº›ä»»åŠ¡ï¼Œé¡ºä¾¿ç»™ä¸€ä¸ªå°å°çš„æ‹¥æŠ±å¥–åŠ±ï½
          </p>
        </div>

        <!-- æœˆåº¦è¡¨æ‰¬ä¿¡ -->
        <div class="glass bg-white/80 rounded-3xl soft-shadow p-3 sm:p-4 text-xs sm:text-sm lift">
          <div class="flex items-center gap-2 mb-1">
            <span v-if="!isOlderKid" class="icon-badge bg-amber-100 text-amber-700">
              <svg class="icon icon-anim"><use :href="`#${iconSet.award}`" :xlink:href="`#${iconSet.award}`"></use></svg>
            </span>
            <div>
              <p class="font-semibold text-slate-800">æœˆåº¦è¡¨æ‰¬ä¿¡</p>
              <p class="text-[11px] text-slate-500">ä¸€é”®ç”Ÿæˆå­©å­ä¸“å±å¥–çŠ¶</p>
            </div>
          </div>
          <p class="text-slate-600 leading-snug">
            æ ¹æ®æœ¬æœˆå®Œæˆçš„ä»»åŠ¡æ•°é‡ï¼Œç”Ÿæˆä¸€å¼ â€œä¸“å±å¥–çŠ¶â€ï¼Œæ”¯æŒä¸€é”®æ‰“å°ï¼Œé€‚åˆè´´åˆ°å¢™ä¸Šæˆ–å¸¦å»å­¦æ ¡åˆ†äº«ã€‚
          </p>
          <button
            type="button"
            @click="openMonthlyReport"
            class="mt-2 px-3 py-2 rounded-2xl text-white font-semibold w-full
                   active:scale-95 transition btn-warm">
            ç”Ÿæˆæœ¬æœˆè¡¨æ‰¬ä¿¡
          </button>
        </div>
      </aside>
    </main>

    <footer class="w-full max-w-5xl mt-4 text-center text-[11px] text-slate-400">
      Â© fabien Zhang Â· å¿«ä¹å­¦ä¹ å¤§å†’é™©
    </footer>

    <!-- æ¨¡æ¿ç®¡ç†å¼¹çª— -->
    <div v-if="showTemplateManager"
         class="fixed inset-0 z-30 flex items-center justify-center bg-black/40">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative max-h-[80vh] overflow-y-auto">
        <button
          class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="showTemplateManager = false">
          âœ•
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">ğŸ“‹ ä»»åŠ¡æ¨¡æ¿ç®¡ç†</h2>
          <p class="text-xs text-slate-500 mt-1">åˆ›å»ºå’Œç®¡ç†ä½ çš„ä»»åŠ¡æ¨¡æ¿</p>
        </div>

        <!-- åˆ›å»ºæ–°æ¨¡æ¿ -->
        <div class="mb-4 p-3 bg-blue-50 rounded-2xl">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">åˆ›å»ºæ–°æ¨¡æ¿</h3>
          <div class="flex flex-col gap-2">
            <input
              v-model="newTemplateName"
              type="text"
              placeholder="æ¨¡æ¿åç§°ï¼Œå¦‚ï¼šå·¥ä½œæ—¥æ¨¡æ¿ã€å‘¨æœ«æ¨¡æ¿"
              class="rounded-2xl border border-slate-200 px-3 py-2 text-xs sm:text-sm bg-white
                     focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-400" />
            <button
              @click="createTemplateFromCurrent"
              class="px-3 py-2 rounded-2xl bg-blue-500 text-white text-xs sm:text-sm font-semibold
                     hover:bg-blue-600 active:scale-95 transition">
              + ä»å½“å‰ä»»åŠ¡åˆ›å»ºæ¨¡æ¿
            </button>
          </div>
        </div>

        <!-- æ¨¡æ¿åˆ—è¡¨ -->
        <div class="space-y-2">
          <h3 class="text-sm font-semibold text-slate-800 mb-2">å·²æœ‰æ¨¡æ¿</h3>
          <div v-for="tpl in templates" :key="tpl.id"
               class="bg-white border border-slate-200 rounded-2xl p-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex-1">
                <input
                  v-if="editingTemplateId === tpl.id"
                  v-model="tpl.name"
                  @blur="saveTemplates()"
                  @keyup.enter="saveTemplates()"
                  type="text"
                  class="font-medium text-sm text-slate-800 bg-white border border-blue-200 rounded-lg px-2 py-1 w-full
                         focus:outline-none focus:ring-2 focus:ring-blue-300"
                  placeholder="æ¨¡æ¿åç§°" />
                <p v-else class="font-medium text-sm text-slate-800">{{ tpl.name }}</p>
                <p class="text-xs text-slate-500 mt-0.5">{{ tpl.tasks.length }} ä¸ªä»»åŠ¡</p>
              </div>
              <div class="flex items-center gap-2">
                <button
                  @click="editTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-blue-50 text-blue-700 text-xs hover:bg-blue-100">
                  {{ editingTemplateId === tpl.id ? 'ä¿å­˜' : 'ç¼–è¾‘' }}
                </button>
                <button
                  @click="applyTemplateById(tpl.id)"
                  class="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs hover:bg-emerald-100">
                  åº”ç”¨
                </button>
                <button
                  @click="deleteTemplate(tpl.id)"
                  class="px-2 py-1 rounded-full bg-rose-50 text-rose-700 text-xs hover:bg-rose-100">
                  åˆ é™¤
                </button>
              </div>
            </div>
            <!-- ç¼–è¾‘æ¨¡æ¿ä»»åŠ¡åˆ—è¡¨ -->
            <div v-if="editingTemplateId === tpl.id" class="mt-3 space-y-2 border-t pt-2">
              <div v-for="(task, idx) in tpl.tasks" :key="idx"
                   class="flex items-center gap-2 bg-slate-50 rounded-xl p-2">
                <input
                  v-model="task.title"
                  type="text"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300"
                  placeholder="ä»»åŠ¡åç§°" />
                <button
                  @click="removeTaskFromTemplate(tpl.id, idx)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  åˆ é™¤
                </button>
              </div>
              <div class="flex gap-2">
                <input
                  v-model="newTaskForTemplate[tpl.id]"
                  @keyup.enter="addTaskToTemplate(tpl.id)"
                  type="text"
                  placeholder="æ·»åŠ æ–°ä»»åŠ¡..."
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-blue-300" />
                <button
                  @click="addTaskToTemplate(tpl.id)"
                  class="px-3 py-1 rounded-lg bg-blue-500 text-white text-xs hover:bg-blue-600">
                  + æ·»åŠ 
                </button>
              </div>
            </div>
          </div>
          <div v-if="templates.length === 0" class="text-center py-4 text-slate-400 text-sm">
            è¿˜æ²¡æœ‰æ¨¡æ¿ï¼Œåˆ›å»ºä¸€ä¸ªå§ï¼
          </div>
        </div>
      </div>
    </div>

    <!-- æ·»åŠ ä»Šå¤©å†…å®¹å¼¹çª— -->
    <transition name="fade">
      <div v-if="showAddTodayModal"
           @click.self="showAddTodayModal = false"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="showAddTodayModal = false">
        <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 relative"
             @click.stop>
          <button
            class="absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
            @click="showAddTodayModal = false">
            âœ•
          </button>
          <div class="text-center mb-4">
            <h2 class="text-lg font-bold text-slate-800">â• æ·»åŠ {{ memoryCategoryLabel }}å†…å®¹</h2>
          </div>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-semibold text-slate-700 mb-1">é€‰æ‹©æ—¥æœŸ</label>
              <input
                v-model="newTodayMemory.date"
                type="date"
                :min="todayKey"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
            </div>
            <div v-if="memoryCategory === 'poetry'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">è¯—å *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šã€Šé™å¤œæ€ã€‹"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <div class="grid grid-cols-2 gap-2 mt-2">
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">æœä»£ *</label>
                  <input
                    v-model="newTodayMemory.dynasty"
                    type="text"
                    placeholder="ä¾‹å¦‚ï¼šå”"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
                <div>
                  <label class="block text-xs font-semibold text-slate-700 mb-1">ä½œè€… *</label>
                  <input
                    v-model="newTodayMemory.author"
                    type="text"
                    placeholder="ä¾‹å¦‚ï¼šæç™½"
                    class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                           focus:outline-none focus:ring-2 focus:ring-emerald-300" />
                </div>
              </div>
            </div>
            <div v-else-if="memoryCategory === 'english'">
              <label class="block text-sm font-semibold text-slate-700 mb-1">å•è¯/å¥å­ *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šapple / I like apples"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">æ³¨é‡Šï¼ˆå¯é€‰ï¼‰</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šè‹¹æœ / æˆ‘å–œæ¬¢è‹¹æœ"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div v-else>
              <label class="block text-sm font-semibold text-slate-700 mb-1">å…¬å¼ *</label>
              <input
                v-model="newTodayMemory.title"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šaÂ² + bÂ² = cÂ²"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">ç±»åˆ« *</label>
              <input
                v-model="newTodayMemory.categoryName"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šå‡ ä½• / ç‰©ç† / åŒ–å­¦"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300" />
              <label class="block text-xs font-semibold text-slate-700 mb-1 mt-2">æ³¨é‡Šï¼ˆå¯é€‰ï¼‰</label>
              <input
                v-model="newTodayMemory.content"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šç›´è§’ä¸‰è§’å½¢å‹¾è‚¡å®šç†"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-emerald-300"
                @keyup.enter="saveTodayMemory" />
            </div>
            <div class="flex gap-2 pt-2">
              <button
                @click="saveTodayMemory"
                class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                       active:scale-95 transition btn-primary">
                  ä¿å­˜
                </button>
              <button
                @click="showAddTodayModal = false"
                class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                       hover:bg-slate-200 active:scale-95 transition">
                å–æ¶ˆ
              </button>
            </div>
          </div>
        </div>
      </div>
    </transition>

    <!-- è®°å¿†ä»»åŠ¡ç®¡ç†å¼¹çª— -->
    <!-- æš‚æ—¶ç¦ç”¨ï¼Œé˜²æ­¢è‡ªåŠ¨æ‰“å¼€ -->
    <transition name="fade">
      <div v-if="shouldShowMemoryManager && !shouldShowMonthlyReport"
           @click.self="closeMemoryManager"
           @mousedown.self="closeMemoryManager"
           class="fixed inset-0 z-30 flex items-center justify-center bg-black/40"
           @keyup.esc="closeMemoryManager">
        <div class="bg-white rounded-3xl shadow-2xl max-w-3xl w-[95%] p-5 relative max-h-[85vh] flex flex-col"
             @click.stop>
        <button
          type="button"
          class="absolute right-4 top-4 text-slate-400 hover:text-slate-600 text-lg font-bold z-10"
          @click.stop="closeMemoryManager">
          âœ•
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">ğŸ“š æ·»åŠ /æ‰¹é‡å¯¼å…¥è®°å¿†ä»»åŠ¡</h2>
          <p class="text-xs text-slate-500 mt-1">æ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ ¼å¼è§ä¸‹æ–¹æç¤º</p>
        </div>
        <div class="flex-1 overflow-y-auto space-y-3 mb-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">é€‰æ‹©èµ·å§‹æ—¥æœŸï¼ˆä»Šå¤©æˆ–ä»¥åï¼‰</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportStartDate"
                type="date"
                :min="todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <label class="block text-sm font-semibold text-slate-700 mb-1 mt-2">é€‰æ‹©ç»“æŸæ—¥æœŸï¼ˆä¸å¯æ—©äºèµ·å§‹æ—¥ï¼‰</label>
            <div class="flex gap-2">
              <input
                v-model="batchImportEndDate"
                type="date"
                :min="batchImportStartDate || todayKey"
                class="flex-1 rounded-xl border border-slate-200 px-3 py-2 text-sm bg-white
                       focus:outline-none focus:ring-2 focus:ring-sky-300" />
            </div>
            <p class="text-[11px] text-slate-400 mt-1">
              è§„åˆ™ï¼šæ¯ä¸€è¡Œå¯¹åº”ä¸€å¤©ï¼Œä»èµ·å§‹æ—¥é¡ºå»¶åˆ°ç»“æŸæ—¥
            </p>
            <p class="text-[11px] text-slate-500 mt-1">
              {{ batchImportRangeHint }}
            </p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-1">ä»»åŠ¡åˆ—è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªä»»åŠ¡ï¼‰</label>
            <textarea
              v-model="batchImportData"
              rows="12"
              :placeholder="batchImportPlaceholder"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-xs font-mono bg-white
                     focus:outline-none focus:ring-2 focus:ring-sky-300 resize-none"></textarea>
            <p class="text-[11px] text-slate-400 mt-1">
              {{ batchImportTip }}
            </p>
          </div>
          <div v-if="previewTasks.length > 0" class="bg-slate-50 rounded-xl p-3">
            <p class="text-sm font-semibold text-slate-700 mb-2">é¢„è§ˆï¼ˆå¯ç¼–è¾‘ï¼‰ï¼š</p>
            <div class="space-y-2 max-h-40 overflow-y-auto">
              <div v-for="(task, idx) in previewTasks" :key="idx"
                   class="flex items-center gap-2 bg-white rounded-lg p-2">
                <input
                  v-model="task.title"
                  type="text"
                  placeholder="ä»»åŠ¡åç§°"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <input
                  v-model="task.content"
                  type="text"
                  placeholder="å†…å®¹è¯¦æƒ…ï¼ˆå¯é€‰ï¼‰"
                  class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs bg-white
                         focus:outline-none focus:ring-1 focus:ring-sky-300" />
                <button
                  @click="previewTasks.splice(idx, 1)"
                  class="px-2 py-1 rounded-lg bg-rose-50 text-rose-600 text-xs hover:bg-rose-100">
                  åˆ é™¤
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="flex gap-2 border-t pt-3">
          <button
            @click="previewBatchImport"
            class="px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition btn-accent">
            é¢„è§ˆ
          </button>
          <button
            @click="processBatchImport"
            :disabled="previewTasks.length === 0"
            class="flex-1 px-4 py-2 rounded-xl text-white text-sm font-semibold
                   active:scale-95 transition disabled:bg-slate-300 disabled:cursor-not-allowed btn-accent">
            å¯¼å…¥å¹¶ç”Ÿæˆå¤ä¹ è®¡åˆ’
          </button>
          <button
            @click.stop="closeMemoryManager"
            class="px-4 py-2 rounded-xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            å–æ¶ˆ
          </button>
        </div>
        </div>
      </div>
    </transition>

    <!-- è¡¨æ‰¬ä¿¡å¼¹çª— -->
    <div v-if="shouldShowMonthlyReport && !shouldShowMemoryManager"
         @click.self="closeMonthlyReport"
         @mousedown.self="closeMonthlyReport"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/40"
         @keyup.esc="closeMonthlyReport">
      <div class="bg-white rounded-3xl shadow-2xl max-w-md w-[90%] p-5 glass relative">
        <button
          type="button"
          class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click.stop="closeMonthlyReport">
          âœ•
        </button>
        <div class="text-center mb-3">
          <div class="text-3xl mb-1">ğŸ…</div>
          <h2 class="text-lg font-bold text-slate-800">æœ¬æœˆå¿«ä¹å­¦ä¹ è¡¨æ‰¬ä¿¡</h2>
          <p class="text-xs text-slate-500 mt-1">
            è‡ªåŠ¨ç»Ÿè®¡æœ¬æœˆå®Œæˆæƒ…å†µï¼Œä¸ºä½ é€ä¸Šä¸€å°å°å°çš„è¡¨æ‰¬ä¿¡ã€‚
          </p>
        </div>
        <div class="text-sm text-slate-700 space-y-2">
          <p>äº²çˆ±çš„ <span class="font-semibold">å°å°å†’é™©å®¶</span>ï¼š</p>
          <p>
            æœ¬æœˆä½ ä¸€å…±å®Œæˆäº†
            <span class="font-bold text-emerald-600">{{ monthlyStats.doneTasks }}</span>
            ä¸ªå­¦ä¹ ä»»åŠ¡ï¼Œç´¯è®¡è·å¾—
            <span class="font-bold text-amber-500">{{ xp }}</span>
            ç‚¹ç»éªŒå€¼ï¼Œå·²ç»æˆä¸º
            <span class="font-bold text-emerald-700">{{ levelDisplay.title }}</span> å•¦ï¼
          </p>
          <p>
            æ¯ä¸€æ¬¡è®¤çœŸå®Œæˆä»»åŠ¡ï¼Œéƒ½æ˜¯åœ¨ä¸ºæœªæ¥çš„è‡ªå·±é“ºä¸€æ¡é—ªé—ªå‘å…‰çš„å°è·¯ã€‚
            è¯·ç»§ç»­ä¿æŒè¿™ä»½åŠªåŠ›å’Œå‹‡æ°”ï¼Œè€å¸ˆå’Œçˆ¸çˆ¸å¦ˆå¦ˆéƒ½ä¸ºä½ éª„å‚²ï¼
          </p>
          <p class="text-right text-xs text-slate-500 mt-2">
            â€”â€” å¿«ä¹å­¦ä¹ å¤§å†’é™©ç³»ç»Ÿ
          </p>
        </div>
        <div class="mt-4 flex gap-2">
          <button
            type="button"
            @click="printReport"
            class="flex-1 px-3 py-2 rounded-2xl text-white text-sm font-semibold
                   active:scale-95 transition btn-primary">
            ğŸ–¨ æ‰“å°è¡¨æ‰¬ä¿¡
          </button>
          <button
            type="button"
            @click.stop="closeMonthlyReport"
            class="px-3 py-2 rounded-2xl bg-slate-100 text-slate-700 text-sm font-semibold
                   hover:bg-slate-200 active:scale-95 transition">
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- è®¾ç½®ä¸­å¿ƒ -->
    <div v-if="showSettings"
         class="fixed inset-0 z-40 flex items-center justify-center bg-black/40">
      <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-[92%] p-5 relative glass">
        <button
          class="absolute right-3 top-3 text-slate-400 hover:text-slate-600 text-sm"
          @click="closeSettings">
          âœ•
        </button>
        <div class="text-center mb-4">
          <h2 class="text-lg font-bold text-slate-800">âš™ï¸ è®¾ç½®ä¸­å¿ƒ</h2>
          <p class="text-xs text-slate-500 mt-1">å®¶é•¿ç®¡ç†ä¸å­©å­æ¡£æ¡ˆ</p>
        </div>

        <div class="space-y-4">
          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">å®¶é•¿æˆæƒ</p>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-[11px] text-slate-500">çŠ¶æ€ï¼š</span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="parentPinSet ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'">
                {{ parentPinSet ? 'å·²è®¾ç½® PIN' : 'æœªè®¾ç½® PIN' }}
              </span>
              <span class="text-[11px] px-2 py-0.5 rounded-full"
                    :class="isParentUnlocked ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'">
                {{ isParentUnlocked ? 'å·²æˆæƒ' : 'æœªæˆæƒ' }}
              </span>
            </div>
            <div class="flex gap-2">
              <button
                class="flex-1 px-3 py-2 rounded-xl text-white text-xs font-semibold btn-primary"
                @click="setParentPin">
                è®¾ç½®/ä¿®æ”¹ PIN
              </button>
              <button
                class="flex-1 px-3 py-2 rounded-xl text-slate-700 text-xs font-semibold bg-slate-100"
                @click="resetParentPin">
                é‡ç½® PIN
              </button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              10 å²ä»¥ä¸‹è®¾ç½®ä¸ç®¡ç†éœ€å®¶é•¿ PINï¼›10 å²ä»¥ä¸Šä¹Ÿéœ€å®¶é•¿æˆæƒã€‚
            </p>
          </div>

          <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
            <p class="text-sm font-semibold text-slate-800 mb-2">å­©å­æ¡£æ¡ˆ</p>
            <div class="space-y-2">
              <div v-for="p in profiles" :key="p.id" class="flex items-center gap-2 bg-white rounded-xl p-2 border border-slate-200">
                <input v-model="p.name" class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs" />
                <input v-model.number="p.age" type="number" min="3" max="18"
                       class="w-16 rounded-lg border border-slate-200 px-2 py-1 text-xs" />
                <button class="px-2 py-1 text-[11px] rounded-full bg-emerald-50 text-emerald-700"
                        @click="setActiveProfile(p.id)">ä½¿ç”¨</button>
                <button class="px-2 py-1 text-[11px] rounded-full bg-rose-50 text-rose-600"
                        @click="removeProfile(p.id)">åˆ é™¤</button>
              </div>
            </div>
            <div class="flex gap-2 mt-2">
              <input v-model="newProfileName" placeholder="æ–°å­©å­åå­—"
                     class="flex-1 rounded-lg border border-slate-200 px-2 py-1 text-xs" />
              <input v-model.number="newProfileAge" type="number" min="3" max="18"
                     class="w-16 rounded-lg border border-slate-200 px-2 py-1 text-xs" />
              <button class="px-3 py-1 rounded-lg bg-blue-500 text-white text-xs disabled:bg-slate-300"
                      :disabled="!newProfileName.trim()"
                      @click="addProfile">ç¡®è®¤æ·»åŠ </button>
            </div>
            <p class="text-[11px] text-slate-500 mt-2">
              é¢„è§ˆï¼š{{ newProfileName || 'å­©å­' }}ï¼ˆ{{ newProfileAge || 8 }}å²ï¼‰
            </p>
          </div>

          <div class="bg-rose-50 rounded-2xl p-3 border border-rose-200">
            <p class="text-sm font-semibold text-rose-700 mb-2">å±é™©æ“ä½œ</p>
            <button
              @click="handleResetClick"
              class="w-full px-4 py-2 rounded-xl bg-rose-500 text-white text-sm font-semibold">
              æ¸…ç©ºå…¨éƒ¨æ•°æ®
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ç¡®ä¿ Vue å·²åŠ è½½
    if (typeof Vue === 'undefined') {
      document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šVue æœªåŠ è½½</h1><p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ CDN é“¾æ¥</p></div>';
    } else {
      try {
        const { createApp } = Vue;

    createApp({
      data() {
        return {
          // ä¸»é¢˜
          theme: 'forest',
          themeOptions: [
            { value: 'candy', label: 'ç³–æœæ¢¦', icon: 'ğŸ¬', swatch: 'linear-gradient(135deg, #fbcfe8 0%, #fde68a 45%, #bfdbfe 100%)' },
            { value: 'forest', label: 'æ£®æ—æ¢é™©', icon: 'ğŸŒ³', swatch: 'linear-gradient(135deg, #d1fae5 0%, #f0fdf4 40%, #bbf7d0 100%)' },
            { value: 'storybook', label: 'æ•…äº‹ä¹¦', icon: 'ğŸ“–', swatch: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fca5a5 100%)' },
            { value: 'ocean', label: 'æ·±æµ·è“', icon: 'ğŸ ', swatch: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 45%, #a5f3fc 100%)' },
            { value: 'space', label: 'æ˜Ÿé™…', icon: 'ğŸš€', swatch: 'radial-gradient(circle at top, #e0e7ff 0%, #ddd6fe 40%, #bfdbfe 100%)' },
            { value: 'sunset', label: 'å¤•é˜³è‰åœ°', icon: 'ğŸŒ‡', swatch: 'linear-gradient(160deg, #fde68a 0%, #fdba74 40%, #bfdbfe 100%)' },
          ],

          // Tabs
          activeTab: 'daily',

          // æ¯æ—¥ä»»åŠ¡
          tasks: [],
          newTaskTitle: '',

          // æ¨¡æ¿ç®¡ç†
          templates: [],
          selectedTemplateId: '',
          showTemplateManager: false,
          newTemplateName: '',
          editingTemplateId: '',
          editingTemplateName: {},
          newTaskForTemplate: {},

          // XP / ç­‰çº§
          xp: 0,

          // è®°å¿†æŒ‘æˆ˜
          memoryDraft: {
            title: '',
            content: ''
          },
          memoryList: [],
          memorySchedule: [],
          memoryViewMode: 'list',
          memoryCategory: 'poetry', // 'poetry', 'english', 'science'
          currentWeekStart: null,
          showMemoryManager: false,
          batchImportStartDate: '',
          batchImportEndDate: '',
          
          batchImportData: '',
          previewTasks: [],
          reviewStatusCache: {}, // ç¼“å­˜å¤ä¹ çŠ¶æ€ï¼Œæå‡æ€§èƒ½
          editingMemoryId: null, // æ­£åœ¨ç¼–è¾‘çš„è®°å¿†é¡¹ID
          editingMemoryTitle: '',
          editingMemoryContent: '',
          showAddTodayModal: false, // æ·»åŠ ä»Šå¤©å†…å®¹çš„å¼¹çª—
          newTodayMemory: {
            title: '',
            content: '',
            date: '',
            dynasty: '',
            author: '',
            categoryName: ''
          },
          showResetConfirm: false, // æ˜¾ç¤ºé‡ç½®ç¡®è®¤å¼¹çª—ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨åŸç”Ÿ confirmï¼‰

          // è¯­éŸ³é¼“åŠ±
          isRecording: false,
          mediaRecorder: null,
          recordedChunks: [],
          audioUrl: '',
          recordingStream: null,

          // è¡¨æ‰¬ä¿¡
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false, // æ ‡è®°ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨æ‰“å¼€è®°å¿†ç®¡ç†å¼¹çª—
          _userInitiatedMonthlyReport: false, // æ ‡è®°ç”¨æˆ·æ˜¯å¦ä¸»åŠ¨æ‰“å¼€è¡¨æ‰¬ä¿¡å¼¹çª—
          monthlyStats: {
            doneTasks: 0
          },

          // éšæœºé¼“åŠ±è¯­
          quotes: [
            'ä½ æ˜¯æœ€æ£’çš„ï¼',
            'ä»Šå¤©ä¹Ÿæ˜¯å…ƒæ°”æ»¡æ»¡çš„ä¸€å¤©ï½',
            'æ¯ä¸€æ¬¡åšæŒï¼Œéƒ½æ˜¯åœ¨ä¸ºæœªæ¥çš„è‡ªå·±åŠ æ²¹ã€‚',
            'è®¤çœŸå®Œæˆä¸€ä»¶å°äº‹ï¼Œå°±æ˜¯äº†ä¸èµ·çš„å‹‡æ°”ã€‚',
            'ä½ çš„å°è„‘è¢‹ç“œå„¿çœŸèªæ˜ï¼',
            'å†å¤šä¸€æ­¥ï¼Œå°±æ¯”æ˜¨å¤©æ›´å‰å®³äº†ã€‚',
            'å­¦ä¹ å°±åƒå‡çº§æ‰“æ€ªï¼Œä½ å·²ç»é—¯è¿‡å¥½å¤šå…³å•¦ï¼'
          ],
          currentQuote: '',

          // å®¶é•¿ä¸æ¡£æ¡ˆ
          profiles: [],
          activeProfileId: '',
          newProfileName: '',
          newProfileAge: 8,
          showSettings: false,
          isParentUnlocked: false,
          parentPinSet: false,
          deferredPrompt: null,
          showInstall: false,
          showIosInstallHint: false,
          // ç»Ÿè®¡ç›¸å…³
          statsViewMode: 'daily', // 'daily' æˆ– 'task'
          dailyStats: [],
          taskStats: [],
          dailyChart: null,
          taskChart: null,
          rewardToast: {
            visible: false,
            title: '',
            subtitle: '',
            xp: 0
          },
          allDoneToast: {
            visible: false,
            title: '',
            subtitle: ''
          },
          dragIndex: null,
          showConfetti: false,
          confettiSeed: 0,
          confettiPieces: 18,
          // ä»»åŠ¡é¢œè‰²æ± ï¼ˆæ¯ä¸ªä»»åŠ¡åˆ†é…ä¸åŒé¢œè‰²ï¼‰
          taskColors: [
            '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#3b82f6',
            '#ef4444', '#14b8a6', '#f97316', '#a855f7', '#06b6d4'
          ]
        };
      },
      computed: {
        // æ§åˆ¶å¼¹çª—æ˜¾ç¤ºçš„è®¡ç®—å±æ€§ï¼ˆé¢å¤–ä¿æŠ¤å±‚ï¼‰
        shouldShowMemoryManager() {
          return this.showMemoryManager && this._userInitiatedMemoryManager;
        },
        shouldShowMonthlyReport() {
          return this.showMonthlyReport && this._userInitiatedMonthlyReport;
        },
        activeProfile() {
          return this.profiles.find(p => p.id === this.activeProfileId) || { name: 'å­©å­', age: 8 };
        },
        isOlderKid() {
          return (this.activeProfile.age || 8) >= 10;
        },
        iconSet() {
          const map = {
            candy: {
              book: 'icon-candy-book', map: 'icon-candy-map', brain: 'icon-candy-brain',
              chart: 'icon-candy-chart', mic: 'icon-candy-mic', star: 'icon-candy-star', award: 'icon-candy-award'
            },
            forest: {
              book: 'icon-forest-book', map: 'icon-forest-map', brain: 'icon-forest-brain',
              chart: 'icon-forest-chart', mic: 'icon-forest-mic', star: 'icon-forest-star', award: 'icon-forest-award'
            },
            storybook: {
              book: 'icon-storybook-book', map: 'icon-storybook-map', brain: 'icon-storybook-brain',
              chart: 'icon-storybook-chart', mic: 'icon-storybook-mic', star: 'icon-storybook-star', award: 'icon-storybook-award'
            },
            ocean: {
              book: 'icon-ocean-book', map: 'icon-ocean-map', brain: 'icon-ocean-brain',
              chart: 'icon-ocean-chart', mic: 'icon-ocean-mic', star: 'icon-ocean-star', award: 'icon-ocean-award'
            },
            space: {
              book: 'icon-space-book', map: 'icon-space-map', brain: 'icon-space-brain',
              chart: 'icon-space-chart', mic: 'icon-space-mic', star: 'icon-space-star', award: 'icon-space-award'
            },
            sunset: {
              book: 'icon-sunset-book', map: 'icon-sunset-map', brain: 'icon-sunset-brain',
              chart: 'icon-sunset-chart', mic: 'icon-sunset-mic', star: 'icon-sunset-star', award: 'icon-sunset-award'
            }
          };
          return map[this.theme] || map.forest;
        },
        // å½“å‰ä¸»é¢˜çš„èƒŒæ™¯æ ·å¼ï¼ˆä½¿ç”¨å†…è” styleï¼Œé¿å… Tailwind CDN æ‰«æä¸åˆ°åŠ¨æ€ç±»ï¼‰
        themeConfig() {
            const map = {
              forest: {
                style: {
                background: 'linear-gradient(135deg, #e8f2ea 0%, #f3f7f0 45%, #d8e9d5 100%)',
                '--primary-start': '#10b981',
                '--primary-end': '#22c55e',
                '--accent-start': '#22d3ee',
                '--accent-end': '#3b82f6',
                '--warm-start': '#f59e0b',
                '--warm-end': '#f97316'
                }
              },
              space: {
                style: {
                background: 'radial-gradient(circle at top, #eef2ff 0%, #f5f3ff 35%, #e0f2fe 100%)',
                '--primary-start': '#6366f1',
                '--primary-end': '#3b82f6',
                '--accent-start': '#22d3ee',
                '--accent-end': '#38bdf8',
                '--warm-start': '#f59e0b',
                '--warm-end': '#f97316'
                }
              },
              ocean: {
                style: {
                background: 'linear-gradient(145deg, #e0f7fa 0%, #e0fbff 40%, #e0f2fe 100%)',
                '--primary-start': '#0ea5e9',
                '--primary-end': '#38bdf8',
                '--accent-start': '#10b981',
                '--accent-end': '#22c55e',
                '--warm-start': '#f59e0b',
                '--warm-end': '#f97316'
                }
              },
              candy: {
                style: {
                background: 'linear-gradient(135deg, #fff1f2 0%, #fef3c7 40%, #e0f2fe 100%)',
                '--primary-start': '#f472b6',
                '--primary-end': '#fb7185',
                '--accent-start': '#38bdf8',
                '--accent-end': '#60a5fa',
                '--warm-start': '#f59e0b',
                '--warm-end': '#f97316'
                }
              },
              storybook: {
                style: {
                background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 45%, #fecaca 100%)',
                '--primary-start': '#f59e0b',
                '--primary-end': '#f97316',
                '--accent-start': '#22c55e',
                '--accent-end': '#10b981',
                '--warm-start': '#ef4444',
                '--warm-end': '#f97316'
                }
              },
              sunset: {
                style: {
                background: 'linear-gradient(160deg, #fef3c7 0%, #ffedd5 40%, #e0f2fe 100%)',
                '--primary-start': '#f59e0b',
                '--primary-end': '#f97316',
                '--accent-start': '#22c55e',
                '--accent-end': '#10b981',
                '--warm-start': '#fb7185',
                '--warm-end': '#f472b6'
                }
              }
            };
          return map[this.theme] || map.forest;
        },
        // ä»Šå¤©æ—¥æœŸå­—ç¬¦ä¸²
        todayKey() {
          const d = new Date();
          return this.toLocalDateKey(d); // YYYY-MM-DD (local)
        },
        todayLabel() {
          const d = new Date();
          const weekNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
          return `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥ï¼ˆå‘¨${weekNames[d.getDay()]}ï¼‰`;
        },
        // æ¨¡æ¿æç¤ºæ–‡æ¡ˆ
        templateInfo() {
          if (!this.tasks.length) return '';
          return 'ä»Šå¤©çš„ä»»åŠ¡åˆ—è¡¨ä¼šä½œä¸ºâ€œé»˜è®¤æ¨¡æ¿â€ä¿å­˜ï¼Œæ˜å¤©è‡ªåŠ¨åŠ è½½ã€‚';
        },
        // ç­‰çº§/ç§°å·è®¡ç®—
        levelDisplay() {
          const xp = this.xp;
          let level = 1;
          let nextXp = 50;

          if (xp < 50) {
            level = 1; nextXp = 50;
          } else if (xp < 150) {
            level = 2; nextXp = 150;
          } else if (xp < 300) {
            level = 3; nextXp = 300;
          } else if (xp < 500) {
            level = 4; nextXp = 500;
          } else {
            level = 5; nextXp = 800;
          }

          let title = 'ä¹¦ç«¥';
          if (level === 2) title = 'å­¦å¾’';
          if (level === 3) title = 'å°æ‰å­';
          if (level === 4) title = 'ç§€æ‰';
          if (level >= 5) title = 'å°çŠ¶å…ƒ';

          const prevXp = level === 1 ? 0 :
            level === 2 ? 50 :
            level === 3 ? 150 :
            level === 4 ? 300 : 500;
          const range = nextXp - prevXp;
          const progress = Math.min(100, Math.max(0, ((xp - prevXp) / range) * 100));

          return { level, title, nextXp, progress: progress.toFixed(1) };
        },
        todayProgress() {
          const total = this.tasks.length;
          const done = this.tasks.filter(t => t.done).length;
          const percent = total === 0 ? 0 : Math.round((done / total) * 100);
          return { total, done, percent };
        },
        progressRing() {
          const radius = 28;
          const circumference = 2 * Math.PI * radius;
          const percent = this.todayProgress.percent / 100;
          return {
            circumference,
            offset: circumference * (1 - percent)
          };
        },
        memoryCategoryLabel() {
          const map = {
            poetry: 'å¤è¯—è¯',
            english: 'è‹±è¯­',
            science: 'æ•°ç†åŒ–'
          };
          return map[this.memoryCategory] || 'è®°å¿†';
        },
        batchImportPlaceholder() {
          if (this.memoryCategory === 'poetry') {
            return 'ä¾‹å¦‚ï¼š\\né™å¤œæ€,å”,æç™½\\nç™»é¹³é›€æ¥¼,å”,ç‹ä¹‹æ¶£';
          }
          if (this.memoryCategory === 'english') {
            return 'ä¾‹å¦‚ï¼š\\napple,è‹¹æœ\\nI like apples,æˆ‘å–œæ¬¢è‹¹æœ';
          }
          return 'ä¾‹å¦‚ï¼š\\nå‡ ä½•,aÂ² + bÂ² = cÂ²,ç›´è§’ä¸‰è§’å½¢å‹¾è‚¡å®šç†\\nåŒ–å­¦,NaCl + AgNOâ‚ƒ = AgClâ†“ + NaNOâ‚ƒ,æ²‰æ·€ååº”';
        },
        batchImportTip() {
          if (this.memoryCategory === 'poetry') {
            return 'æ ¼å¼ï¼šè¯—å,æœä»£,ä½œè€…ï¼ˆé€—å·åˆ†éš”ï¼‰';
          }
          if (this.memoryCategory === 'english') {
            return 'æ ¼å¼ï¼šå•è¯/å¥å­,æ³¨é‡Šï¼ˆé€—å·åˆ†éš”ï¼‰';
          }
          return 'æ ¼å¼ï¼šç±»åˆ«,å…¬å¼,æ³¨é‡Šï¼ˆé€—å·åˆ†éš”ï¼‰';
        },
        batchImportRangeHint() {
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            return 'æç¤ºï¼šé€‰å¥½èµ·æ­¢æ—¥æœŸåï¼Œä¼šæ˜¾ç¤ºå¯ç”¨å¤©æ•°';
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          const days = Math.floor((end - start) / (24 * 60 * 60 * 1000)) + 1;
          if (days <= 0) return 'æ—¥æœŸèŒƒå›´ä¸åˆæ³•ï¼Œè¯·æ£€æŸ¥';
          const lineCount = this.previewTasks.length || 0;
          return `å¯ç”¨ ${days} å¤© Â· å·²è¾“å…¥ ${lineCount} è¡Œ`;
        },
        // å½“å‰å‘¨çš„å¼€å§‹æ—¥æœŸ
        currentWeekLabel() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          return `${start.getMonth() + 1}/${start.getDate()} - ${end.getMonth() + 1}/${end.getDate()}`;
        },
        // å½“å‰å‘¨çš„æ‰€æœ‰æ—¥æœŸï¼ˆä¿ç•™ç”¨äºå…¶ä»–åŠŸèƒ½ï¼‰
        currentWeekDays() {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          const weekDays = [];
          const start = this.getWeekStart();
          
          for (let i = 0; i < 7; i++) {
            const date = new Date(start);
            date.setDate(start.getDate() + i);
            const dayKey = this.toLocalDateKey(date);
            const weekNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const tasks = this.memorySchedule
              .filter(s => s.dayKey === dayKey)
              .map(s => {
                const base = this.memoryList.find(m => m.id === s.baseId);
                return base && base.category === this.memoryCategory ? {
                  ...s,
                  content: base ? base.content : s.content || ''
                } : null;
              });
            const filteredTasks = tasks.filter(Boolean);
            
            weekDays.push({
              key: dayKey,
              label: `å‘¨${weekNames[date.getDay()]}`,
              date: `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`,
              isToday: dayKey === todayKey,
              tasks: filteredTasks
            });
          }
          return weekDays;
        },

        // å‘¨è§†å›¾è®°å¿†é¡¹ï¼ˆæŒ‰å­¦ä¹ é¡¹åˆ†ç»„ï¼Œæ˜¾ç¤ºæ‰€æœ‰å¤ä¹ æ—¶é—´ç‚¹ï¼‰
        weeklyMemoryItems() {
          const start = this.getWeekStart();
          const end = new Date(start);
          end.setDate(end.getDate() + 6);
          const startKey = this.toLocalDateKey(start);
          const endKey = this.toLocalDateKey(end);
          const todayKey = this.toLocalDateKey(new Date());
          
          // æ‰¾å‡ºæœ¬å‘¨å†…åˆå§‹å­¦ä¹ çš„æ‰€æœ‰è®°å¿†é¡¹ï¼Œä»¥åŠæœ¬å‘¨éœ€è¦å¤ä¹ çš„ä»»åŠ¡
          const learnedThisWeek = [];
          const reviewThisWeek = [];
          
          // æœ¬å‘¨å­¦ä¹ çš„é¡¹ç›®
          this.memoryList.forEach(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            if (learnKey >= startKey && learnKey <= endKey) {
              learnedThisWeek.push(m);
            }
          });
          
          // æœ¬å‘¨éœ€è¦å¤ä¹ çš„é¡¹ç›®ï¼ˆåŒ…æ‹¬ä¹‹å‰å­¦ä¹ ä½†æœ¬å‘¨éœ€è¦å¤ä¹ çš„ï¼‰
          const scheduleMap = {};
          this.memorySchedule.forEach(s => {
            if (s.dayKey >= startKey && s.dayKey <= endKey) {
              if (!scheduleMap[s.baseId]) {
                scheduleMap[s.baseId] = [];
              }
              scheduleMap[s.baseId].push(s);
            }
          });
          
          // åˆå¹¶æ‰€æœ‰éœ€è¦æ˜¾ç¤ºçš„é¡¹ç›®
          const allItems = new Map();
          
          // æ·»åŠ æœ¬å‘¨å­¦ä¹ çš„é¡¹ç›®
          learnedThisWeek.forEach(m => {
            allItems.set(m.id, m);
          });
          
          // æ·»åŠ æœ¬å‘¨éœ€è¦å¤ä¹ çš„é¡¹ç›®ï¼ˆå¦‚æœä¸åœ¨æœ¬å‘¨å­¦ä¹ åˆ—è¡¨ä¸­ï¼‰
          Object.keys(scheduleMap).forEach(baseId => {
            if (!allItems.has(baseId)) {
              const base = this.memoryList.find(m => m.id === baseId);
              if (base) {
                allItems.set(baseId, base);
              }
            }
          });
          
          // æŒ‰åˆ†ç±»è¿‡æ»¤ï¼ˆä½¿ç”¨æ˜¾å¼åˆ†ç±»å­—æ®µï¼‰
          let filteredItems = Array.from(allItems.values()).filter(m => m.category === this.memoryCategory);
          
          // è½¬æ¢ä¸ºæ˜¾ç¤ºæ ¼å¼
          const items = filteredItems.map(m => {
            const learnDate = new Date(m.createdAt);
            const learnKey = this.toLocalDateKey(learnDate);
            
            // ä½¿ç”¨ç¼“å­˜ä¼˜åŒ–æ€§èƒ½
            const cacheKey = `${m.id}_${this.currentWeekStart?.getTime() || 0}`;
            if (this.reviewStatusCache[cacheKey]) {
              return this.reviewStatusCache[cacheKey];
            }
            
            // è®¡ç®—æ‰€æœ‰å¤ä¹ æ—¶é—´ç‚¹
            const reviews = {};
            
            // å³æ—¶å¤ä¹ æ—¶é—´ç‚¹ï¼ˆ5åˆ†é’Ÿã€30åˆ†é’Ÿã€12å°æ—¶ï¼‰
            const learnTime = learnDate.getTime();
            
            // 5åˆ†é’Ÿå
            const fiveMinLater = new Date(learnTime + 5 * 60 * 1000);
            reviews['5min'] = {
              done: this.getReviewStatus(m.id, '5min'),
              date: this.formatReviewTime(fiveMinLater),
              timestamp: fiveMinLater.getTime()
            };
            
            // 30åˆ†é’Ÿå
            const thirtyMinLater = new Date(learnTime + 30 * 60 * 1000);
            reviews['30min'] = {
              done: this.getReviewStatus(m.id, '30min'),
              date: this.formatReviewTime(thirtyMinLater),
              timestamp: thirtyMinLater.getTime()
            };
            
            // 12å°æ—¶å
            const twelveHLater = new Date(learnTime + 12 * 60 * 60 * 1000);
            reviews['12h'] = {
              done: this.getReviewStatus(m.id, '12h'),
              date: this.formatReviewTime(twelveHLater),
              timestamp: twelveHLater.getTime()
            };
            
            // è‰¾å®¾æµ©æ–¯å¤ä¹ æ—¥æœŸï¼ˆ+1, +2, +4, +7, +15, +30å¤©ï¼‰
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(learnDate);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewKey = this.toLocalDateKey(reviewDate);
              
              // æŸ¥æ‰¾å¯¹åº”çš„å¤ä¹ è®¡åˆ’
              const scheduleItem = this.memorySchedule.find(s => 
                s.baseId === m.id && s.offsetDay === offset && s.dayKey === reviewKey
              );
              
              reviews[offset] = {
                done: scheduleItem ? scheduleItem.done : false,
                date: `${reviewDate.getMonth() + 1}/${reviewDate.getDate()}`,
                scheduleId: scheduleItem ? scheduleItem.id : null,
                dayKey: reviewKey,
                isThisWeek: reviewKey >= startKey && reviewKey <= endKey
              };
            });
            
            const relatedSchedules = scheduleMap[m.id] || [];
            const fallbackContent = relatedSchedules.find(s => s && s.content)?.content || '';
            const item = {
              id: m.id,
              title: m.title,
              content: m.content || fallbackContent,
              dynasty: m.dynasty || '',
              author: m.author || '',
              learnDate: `${learnDate.getMonth() + 1}/${learnDate.getDate()}`,
              learnYear: String(learnDate.getFullYear()),
              learnKey,
              reviews,
              isLearnedThisWeek: learnKey >= startKey && learnKey <= endKey
            };
            
            // ç¼“å­˜ç»“æœ
            this.reviewStatusCache[cacheKey] = item;
            return item;
          })
          .sort((a, b) => {
            // ä¼˜å…ˆæ˜¾ç¤ºæœ¬å‘¨å­¦ä¹ çš„ï¼Œç„¶åæŒ‰æ—¥æœŸæ’åº
            if (a.isLearnedThisWeek !== b.isLearnedThisWeek) {
              return a.isLearnedThisWeek ? -1 : 1;
            }
            return a.learnKey.localeCompare(b.learnKey);
          });
          
          return items;
        }
      },
      methods: {
        // ä¸»é¢˜åˆ‡æ¢
        setTheme(value) {
          this.theme = value;
          localStorage.setItem(this.getStorageKey('theme'), value);
          this.applyBodyTheme();
        },

        // åŠ è½½ä»Šæ—¥ä»»åŠ¡
        loadTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          const localKey = this.todayKey;
          const utcKey = this.toUTCDateKey(new Date());
          const todayTasks = byDay[localKey] || byDay[utcKey];

          if (todayTasks && Array.isArray(todayTasks)) {
            // ä¸ºæ—§æ•°æ®æ·»åŠ æ—¶é—´æˆ³ï¼ˆå‘åå…¼å®¹ï¼‰
            this.tasks = todayTasks.map(task => {
              if (!task.createdAt) {
                task.createdAt = new Date().toISOString();
              }
              if (!task.updatedAt) {
                task.updatedAt = new Date().toISOString();
              }
              return task;
            });
            // å…¼å®¹è¿ç§»ï¼šå°† UTC key çš„æ•°æ®æ˜ å°„åˆ°æœ¬åœ° key
            if (!byDay[localKey] && byDay[utcKey]) {
              byDay[localKey] = todayTasks;
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            }
            } else {
              this.tasks = [];
          }
        },

        saveTodayTasks() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          const byDay = raw ? JSON.parse(raw) : {};
          byDay[this.todayKey] = this.tasks;
          localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
        },

        // æ¨¡æ¿ç®¡ç†
        loadTemplates() {
          const raw = localStorage.getItem(this.getStorageKey('templates'));
          if (raw) {
            try {
              this.templates = JSON.parse(raw);
            } catch (e) {
              this.templates = [];
            }
          } else {
            this.templates = [];
          }
        },

        saveTemplates() {
          localStorage.setItem(this.getStorageKey('templates'), JSON.stringify(this.templates));
        },

        createTemplateFromCurrent() {
          if (!this.newTemplateName.trim()) {
            alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
          }
          if (this.tasks.length === 0) {
            alert('å½“å‰æ²¡æœ‰ä»»åŠ¡ï¼Œæ— æ³•åˆ›å»ºæ¨¡æ¿');
            return;
          }
          const template = {
            id: this.uuid(),
            name: this.newTemplateName.trim(),
            tasks: this.tasks.map(t => ({
              title: t.title,
              note: t.note || ''
              // æ¨¡æ¿ä¸ä¿å­˜æ—¶é—´ä¿¡æ¯ï¼Œå› ä¸ºæ¯æ¬¡åº”ç”¨æ¨¡æ¿æ—¶éƒ½æ˜¯æ–°çš„å¼€å§‹
            })),
            createdAt: new Date().toISOString()
          };
          this.templates.push(template);
          this.saveTemplates();
          this.newTemplateName = '';
          alert('æ¨¡æ¿åˆ›å»ºæˆåŠŸï¼');
        },

        applyTemplate() {
          if (!this.selectedTemplateId) return;
          this.applyTemplateById(this.selectedTemplateId);
        },

        applyTemplateById(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          
          // ç¡®è®¤æ˜¯å¦è¦†ç›–å½“å‰ä»»åŠ¡
          if (this.tasks.length > 0) {
            if (!confirm(`åº”ç”¨æ¨¡æ¿"${template.name}"å°†è¦†ç›–å½“å‰ä»»åŠ¡ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) {
              return;
            }
          }

          this.tasks = template.tasks.map(t => ({
            id: this.uuid(),
            title: t.title,
            note: t.note || '',
            startTime: '',
            endTime: '',
            done: false,
            coinAnimating: false
          }));
          this.saveTodayTasks();
          this.selectedTemplateId = '';
          this.showTemplateManager = false;
        },

        openTemplateManager() {
          if (!this.requireParentIfNeeded()) return;
          this.showTemplateManager = true;
        },

        deleteTemplate(templateId) {
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ')) return;
          this.templates = this.templates.filter(t => t.id !== templateId);
          this.saveTemplates();
        },

        editTemplate(templateId) {
          if (this.editingTemplateId === templateId) {
            // ä¿å­˜ç¼–è¾‘
            this.saveTemplates();
            this.editingTemplateId = '';
            this.newTaskForTemplate = {};
            this.editingTemplateName = {};
          } else {
            // å¼€å§‹ç¼–è¾‘
            this.editingTemplateId = templateId;
            const template = this.templates.find(t => t.id === templateId);
            if (template) {
              this.editingTemplateName = { ...this.editingTemplateName, [templateId]: template.name };
            }
            if (!this.newTaskForTemplate[templateId]) {
              this.newTaskForTemplate = { ...this.newTaskForTemplate, [templateId]: '' };
            }
          }
        },

        saveTemplateName(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (template && this.editingTemplateName[templateId]) {
            template.name = this.editingTemplateName[templateId].trim() || template.name;
            this.saveTemplates();
          }
        },

        addTaskToTemplate(templateId) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          const taskTitle = this.newTaskForTemplate[templateId]?.trim();
          if (!taskTitle) return;
          template.tasks.push({ title: taskTitle, note: '' });
          this.newTaskForTemplate[templateId] = '';
          this.saveTemplates();
        },

        removeTaskFromTemplate(templateId, taskIndex) {
          const template = this.templates.find(t => t.id === templateId);
          if (!template) return;
          template.tasks.splice(taskIndex, 1);
          this.saveTemplates();
        },

        // ä»»åŠ¡æ“ä½œ
        addTask() {
          if (!this.newTaskTitle.trim()) return;
          this.tasks.push({
            id: this.uuid(),
            title: this.newTaskTitle.trim(),
            note: '',
            startTime: '', // å¼€å§‹æ—¶é—´é€šè¿‡"å¼€å§‹"æŒ‰é’®è®°å½•
            endTime: '', // ç»“æŸæ—¶é—´åœ¨ä»»åŠ¡å®Œæˆæ—¶è‡ªåŠ¨è®°å½•
            done: false,
            coinAnimating: false,
            createdAt: new Date().toISOString(), // æ·»åŠ åˆ›å»ºæ—¶é—´æˆ³
            updatedAt: new Date().toISOString() // æ·»åŠ æ›´æ–°æ—¶é—´æˆ³
          });
          this.newTaskTitle = '';
          this.saveTodayTasks();
        },
        startTask(task) {
          if (task.done || task.startTime) return;
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          task.startTime = `${hours}:${minutes}`;
          this.saveTodayTasks();
        },
        removeTask(index) {
          this.tasks.splice(index, 1);
          this.saveTodayTasks();
        },
        toggleTask(task) {
          if (!task.startTime && !task.done) {
            // å¦‚æœè¿˜æ²¡å¼€å§‹ï¼Œå…ˆè‡ªåŠ¨å¼€å§‹
            this.startTask(task);
          }
          const wasDone = task.done;
          task.done = !task.done;
          if (task.done) {
            // XP å¥–åŠ±ï¼ˆåªå¥–åŠ±ä¸€æ¬¡ï¼Œé¿å…é‡å¤åˆ·åˆ†ï¼‰
            if (!task.completedAt) {
              this.gainXp(10);
              const doneCount = this.tasks.filter(t => t.done).length;
              if (doneCount === 1) {
                this.showRewardToast({
                  title: 'é¦–ä¸ªä»»åŠ¡å®Œæˆï¼',
                  subtitle: 'å¼€å±€å°±å¾ˆæ£’ï¼Œç»§ç»­ä¿æŒï½',
                  xp: 10
                });
              } else if (doneCount % 5 === 0) {
                this.showRewardToast({
                  title: `å®Œæˆ ${doneCount} ä¸ªä»»åŠ¡ï¼`,
                  subtitle: 'æŒç»­åŠªåŠ›ï¼Œè¿›åº¦é£èµ·ï½',
                  xp: 10
                });
              } else {
                this.showRewardToast({
                  title: 'å®Œæˆæ‰“å¡ï¼',
                  subtitle: 'æ¯ä¸€æ­¥éƒ½ç®—æ•°ï½',
                  xp: 10
                });
              }
            }
            // ä»Šæ—¥å…¨éƒ¨å®Œæˆå¥–åŠ±ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰
            if (this.tasks.length > 0 && this.tasks.every(t => t.done)) {
              const todayKey = this.todayKey;
              const lastKey = localStorage.getItem(this.getStorageKey('all_done_key'));
              if (lastKey !== todayKey) {
                this.showAllDoneToast();
                this.triggerConfetti();
                localStorage.setItem(this.getStorageKey('all_done_key'), todayKey);
              }
            }
            // é‡‘å¸åŠ¨ç”»
            task.coinAnimating = true;
            setTimeout(() => {
              task.coinAnimating = false;
            }, 600);
            // è‡ªåŠ¨è®°å½•ç»“æŸæ—¶é—´ï¼ˆå¦‚æœè¿˜æ²¡æœ‰è®°å½•ï¼‰
            if (!task.endTime) {
              const now = new Date();
              const hours = String(now.getHours()).padStart(2, '0');
              const minutes = String(now.getMinutes()).padStart(2, '0');
              task.endTime = `${hours}:${minutes}`;
            }
            // è®°å½•å®Œæˆæ—¶é—´æˆ³
            task.completedAt = new Date().toISOString();
          } else if (wasDone) {
            // å–æ¶ˆå®Œæˆï¼šä¿ç•™å·²å¥–åŠ±æ ‡è®°ï¼Œæ¸…ç©ºç»“æŸæ—¶é—´æ–¹ä¾¿é‡æ–°å®Œæˆ
            task.endTime = '';
          }
          // æ›´æ–°ä¿®æ”¹æ—¶é—´
          task.updatedAt = new Date().toISOString();
          this.saveTodayTasks();
        },

        // XP
        gainXp(amount) {
          this.xp += amount;
          localStorage.setItem(this.getStorageKey('xp'), String(this.xp));
        },

        // æˆå°±å¥–åŠ±å¡
        showRewardToast({ title, subtitle, xp }) {
          this.rewardToast = {
            visible: true,
            title,
            subtitle,
            xp
          };
          clearTimeout(this._rewardTimer);
          this._rewardTimer = setTimeout(() => {
            this.rewardToast.visible = false;
          }, 2200);
        },

        showAllDoneToast() {
          this.allDoneToast = {
            visible: true,
            title: 'ä»Šå¤©ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼',
            subtitle: 'ä¸ºåšæŒç‚¹ä¸ªå¤§å¤§çš„èµï½'
          };
          clearTimeout(this._allDoneTimer);
          this._allDoneTimer = setTimeout(() => {
            this.allDoneToast.visible = false;
          }, 2600);
        },

        triggerConfetti() {
          this.confettiSeed = Date.now();
          this.showConfetti = true;
          clearTimeout(this._confettiTimer);
          this._confettiTimer = setTimeout(() => {
            this.showConfetti = false;
          }, 1800);
        },

        confettiStyle(i) {
          const rand = (seed) => {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
          };
          const base = this.confettiSeed + i * 17;
          const left = Math.round(rand(base) * 90 + 5);
          const delay = (rand(base + 1) * 0.3).toFixed(2);
          const dur = (0.9 + rand(base + 2) * 0.9).toFixed(2);
          const colors = ['#f59e0b', '#10b981', '#38bdf8', '#f97316', '#ec4899', '#a855f7'];
          const color = colors[Math.floor(rand(base + 3) * colors.length)];
          return {
            '--x': `${left}%`,
            '--delay': `${delay}s`,
            '--dur': `${dur}s`,
            '--color': color
          };
        },

        // æ‹–æ‹½æ’åº
        onDragStart(index) {
          this.dragIndex = index;
        },
        onDrop(index) {
          if (this.dragIndex === null || this.dragIndex === index) return;
          const moved = this.tasks.splice(this.dragIndex, 1)[0];
          this.tasks.splice(index, 0, moved);
          this.dragIndex = null;
          this.saveTodayTasks();
        },
        onDragEnd() {
          this.dragIndex = null;
        },

        // è®°å¿†æŒ‘æˆ˜ï¼šä¿å­˜è‰ç¨¿å¹¶åŸºäºè‰¾å®¾æµ©æ–¯æ›²çº¿ç”Ÿæˆæ’æœŸ
        saveMemoryDraft() {
          if (!this.memoryDraft.title.trim()) return;
          const list = [...this.memoryList];
          const base = {
            id: this.uuid(),
            title: this.memoryDraft.title.trim(),
            content: this.memoryDraft.content.trim(),
            createdAt: new Date().toISOString()
          };
          list.push(base);
          this.memoryList = list;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(list));

          // ç”Ÿæˆè‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’ï¼š+1 / +2 / +4 / +7 / +15 / +30 å¤©
          const offsets = [1, 2, 4, 7, 15, 30];
          const now = new Date();
          const schedule = [...this.memorySchedule];
          offsets.forEach(d => {
            const dt = new Date(now);
            dt.setDate(dt.getDate() + d);
            const dayKey = this.toLocalDateKey(dt);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              dayKey,
              offsetDay: d,
              done: false
            });
          });
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          this.memoryDraft.title = '';
          this.memoryDraft.content = '';
        },

        // æ‰“å¼€è®°å¿†ç®¡ç†çª—å£ï¼ˆç”¨æˆ·ä¸»åŠ¨æ‰“å¼€ï¼‰
        openMemoryManager() {
          if (!this.requireParentIfNeeded()) return;
          this._userInitiatedMemoryManager = true;
          this.showMemoryManager = true;
        },

        // å…³é—­è®°å¿†ç®¡ç†çª—å£
        closeMemoryManager(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMemoryManager = false;
          this.showMemoryManager = false;
          // ç«‹å³å¼ºåˆ¶æ›´æ–°
          this.$forceUpdate();
          // å†æ¬¡ç¡®ä¿å…³é—­ï¼ˆé˜²æ­¢å¼‚æ­¥é—®é¢˜ï¼‰
          this.$nextTick(() => {
            this.showMemoryManager = false;
            this.$forceUpdate();
          });
          // å»¶è¿Ÿæ¸…ç†æ•°æ®ï¼Œé¿å…å…³é—­åŠ¨ç”»å¡é¡¿
          setTimeout(() => {
            if (!this.showMemoryManager) {
              this.batchImportData = '';
              this.previewTasks = [];
              this.batchImportStartDate = '';
              this.batchImportEndDate = '';
            }
          }, 300);
        },

        // é¢„è§ˆæ‰¹é‡å¯¼å…¥
        previewBatchImport() {
          if (!this.batchImportData.trim()) {
            alert('è¯·å¡«å†™ä»»åŠ¡æ•°æ®');
            return;
          }
          const lines = this.batchImportData.trim().split('\n').filter(l => l.trim());
          this.previewTasks = lines.map(line => {
            const parts = line.split(/,|ï¼Œ/).map(s => s.trim());
            if (this.memoryCategory === 'poetry') {
              return {
                title: parts[0] || '',
                dynasty: parts[1] || '',
                author: parts[2] || '',
                content: parts[1] && parts[2] ? `${parts[1]} Â· ${parts[2]}` : ''
              };
            }
            if (this.memoryCategory === 'english') {
              return {
                title: parts[0] || '',
                content: parts[1] || ''
              };
            }
            return {
              title: parts[1] || '',
              categoryName: parts[0] || '',
              content: parts[2] ? `${parts[0] ? parts[0] + ' Â· ' : ''}${parts[2]}` : ''
            };
          }).filter(t => t.title);
        },

        // æ‰¹é‡å¯¼å…¥è®°å¿†ä»»åŠ¡
        processBatchImport() {
          if (this.previewTasks.length === 0) {
            alert('è¯·å…ˆé¢„è§ˆä»»åŠ¡æˆ–å¡«å†™ä»»åŠ¡æ•°æ®');
            return;
          }
          const range = this.getBatchImportDateRange();
          if (!range) return;
          const startDate = range.start;
          const endDate = range.end;
          const daysAvailable = Math.floor((endDate - startDate) / (24 * 60 * 60 * 1000)) + 1;
          if (this.previewTasks.length > daysAvailable) {
            alert(`è¾“å…¥è¡Œæ•°è¶…è¿‡æ—¥æœŸèŒƒå›´ï¼ˆå¯ç”¨ ${daysAvailable} å¤©ï¼‰ã€‚è¯·å‡å°‘è¡Œæ•°æˆ–å»¶é•¿ç»“æŸæ—¥æœŸã€‚`);
            return;
          }

          const schedule = [...this.memorySchedule];
          
          // ä»èµ·å§‹æ—¥æœŸå¼€å§‹ï¼Œæ¯è¡Œé¡ºå»¶ä¸€å¤©
          this.previewTasks.forEach((task, idx) => {
            const date = new Date(startDate);
            date.setDate(date.getDate() + idx);
            const dayKey = this.toLocalDateKey(date);
            
            const base = {
              id: this.uuid(),
              title: task.title,
              content: task.content,
              category: this.memoryCategory,
              dynasty: task.dynasty || '',
              author: task.author || '',
              categoryName: task.categoryName || '',
              createdAt: date.toISOString()
            };
            this.memoryList.push(base);
            
            const offsets = [1, 2, 4, 7, 15, 30];
            offsets.forEach(offset => {
              const reviewDate = new Date(date);
              reviewDate.setDate(reviewDate.getDate() + offset);
              const reviewDayKey = this.toLocalDateKey(reviewDate);
              schedule.push({
                id: this.uuid(),
                baseId: base.id,
                title: base.title,
                content: base.content,
                category: base.category,
                dynasty: base.dynasty,
                author: base.author,
                categoryName: base.categoryName,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              });
            });
          });
          
          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));
          
          alert('æ‰¹é‡å¯¼å…¥æˆåŠŸï¼');
          this.closeMemoryManager();
        },

        // è·å–å‘¨å¼€å§‹æ—¥æœŸ
        getWeekStart() {
          if (!this.currentWeekStart) {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1);
            const monday = new Date(today);
            monday.setDate(diff);
            this.currentWeekStart = new Date(monday);
          }
          return new Date(this.currentWeekStart);
        },

        // å‘¨è§†å›¾å¯¼èˆª
        prevWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() - 7);
          this.currentWeekStart = new Date(start);
          // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
          this.reviewStatusCache = {};
        },

        nextWeek() {
          const start = this.getWeekStart();
          start.setDate(start.getDate() + 7);
          this.currentWeekStart = new Date(start);
          // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
          this.reviewStatusCache = {};
        },

        // åˆ‡æ¢è®°å¿†ä»»åŠ¡å®ŒæˆçŠ¶æ€
        toggleMemoryTask(task) {
          task.done = !task.done;
          this.memorySchedule = [...this.memorySchedule];
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
        },

        // åˆ‡æ¢å¤ä¹ æ£€æŸ¥çŠ¶æ€ï¼ˆä¼˜åŒ–æ€§èƒ½ï¼‰
        toggleReviewCheck(baseId, reviewKey) {
          const base = this.memoryList.find(m => m.id === baseId);
          if (!base) return;
          
          // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°è®¡ç®—
          const cacheKey = `${baseId}_${this.currentWeekStart?.getTime() || 0}`;
          delete this.reviewStatusCache[cacheKey];
          
          const learnDate = new Date(base.createdAt);
          
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            // å³æ—¶å¤ä¹ æ—¶é—´ç‚¹ï¼Œä½¿ç”¨localStorageå­˜å‚¨
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            const currentStatus = localStorage.getItem(key) === 'true';
            localStorage.setItem(key, String(!currentStatus));
            // ç›´æ¥æ›´æ–°è§†å›¾ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—æ•´ä¸ªåˆ—è¡¨
            this.$forceUpdate();
          } else {
            // è‰¾å®¾æµ©æ–¯å¤ä¹ æ—¥æœŸ
            const offset = parseInt(reviewKey);
            const reviewDate = new Date(learnDate);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            
            let scheduleItem = this.memorySchedule.find(s => 
              s.baseId === baseId && s.offsetDay === offset && s.dayKey === reviewDayKey
            );
            
            if (!scheduleItem) {
              // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„å¤ä¹ è®¡åˆ’
              scheduleItem = {
                id: this.uuid(),
                baseId: baseId,
                title: base.title,
                content: base.content,
                dayKey: reviewDayKey,
                offsetDay: offset,
                done: false
              };
              this.memorySchedule.push(scheduleItem);
            }
            
            scheduleItem.done = !scheduleItem.done;
            // Vue 3: ä½¿ç”¨ splice è§¦å‘å“åº”å¼æ›´æ–°
            const idx = this.memorySchedule.indexOf(scheduleItem);
            if (idx !== -1) {
              this.memorySchedule.splice(idx, 1, scheduleItem);
            }
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
          }
        },

        // è·å–å¤ä¹ çŠ¶æ€
        getReviewStatus(baseId, reviewKey) {
          if (reviewKey === '5min' || reviewKey === '30min' || reviewKey === '12h') {
            const key = this.getStorageKey(`review_${baseId}_${reviewKey}`);
            return localStorage.getItem(key) === 'true';
          }
          return false;
        },

        // æ ¼å¼åŒ–å¤ä¹ æ—¶é—´
        formatReviewTime(date) {
          const now = new Date();
          const diff = date.getTime() - now.getTime();
          
          if (diff < 0) {
            return 'å·²è¿‡';
          } else if (diff < 60 * 60 * 1000) {
            const minutes = Math.floor(diff / (60 * 1000));
            return `${minutes}åˆ†é’Ÿå`;
          } else if (diff < 24 * 60 * 60 * 1000) {
            const hours = Math.floor(diff / (60 * 60 * 1000));
            return `${hours}å°æ—¶å`;
          } else {
            return `${date.getMonth() + 1}/${date.getDate()}`;
          }
        },

        // æ£€æŸ¥æ˜¯å¦å¯ä»¥ç¼–è¾‘è®°å¿†é¡¹ï¼ˆåªèƒ½ç¼–è¾‘å½“å¤©åŠä»¥åçš„å†…å®¹ï¼‰
        canEditMemoryItem(item) {
          const today = new Date();
          const todayKey = this.toLocalDateKey(today);
          return item.learnKey >= todayKey;
        },

        // å¼€å§‹ç¼–è¾‘è®°å¿†é¡¹
        startEditMemory(item) {
          if (!this.canEditMemoryItem(item)) {
            alert('åªèƒ½ç¼–è¾‘å½“å¤©åŠä»¥åçš„å†…å®¹ï¼Œæ— æ³•ç¼–è¾‘è¿‡å»çš„å†…å®¹ã€‚');
            return;
          }
          this.editingMemoryId = item.id;
          this.editingMemoryTitle = item.title;
          this.editingMemoryContent = item.content || '';
        },

        // ä¿å­˜ç¼–è¾‘çš„è®°å¿†é¡¹
        saveEditMemory(item) {
          if (!this.editingMemoryTitle.trim()) {
            alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
            return;
          }

          const memoryItem = this.memoryList.find(m => m.id === item.id);
          if (memoryItem) {
            memoryItem.title = this.editingMemoryTitle.trim();
            memoryItem.content = this.editingMemoryContent.trim();
            memoryItem.updatedAt = new Date().toISOString();
            
            // æ›´æ–°ç›¸å…³çš„å¤ä¹ è®¡åˆ’
            this.memorySchedule.forEach(schedule => {
              if (schedule.baseId === item.id) {
                schedule.title = memoryItem.title;
                schedule.content = memoryItem.content;
              }
            });

            localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
            localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));
            
            // æ¸…é™¤ç¼“å­˜
            this.reviewStatusCache = {};
          }

          this.cancelEditMemory();
        },

        // å–æ¶ˆç¼–è¾‘
        cancelEditMemory() {
          this.editingMemoryId = null;
          this.editingMemoryTitle = '';
          this.editingMemoryContent = '';
        },

        // æœä»£é¢œè‰²
        dynastyColor(dynasty) {
          const map = {
            'å…ˆç§¦': '#64748b',
            'ç§¦': '#92400e',
            'æ±‰': '#b91c1c',
            'é­': '#2563eb',
            'æ™‹': '#0f766e',
            'å—åŒ—æœ': '#6d28d9',
            'éš‹': '#ea580c',
            'å”': '#f59e0b',
            'å®‹': '#10b981',
            'å…ƒ': '#3b82f6',
            'æ˜': '#ef4444',
            'æ¸…': '#8b5cf6',
            'è¿‘ç°ä»£': '#0ea5e9'
          };
          return map[dynasty] || '#64748b';
        },

        // æ·»åŠ ä»Šå¤©çš„å†…å®¹
        addTodayMemory() {
          if (!this.requireParentIfNeeded()) return;
          const today = new Date();
          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(today),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = true;
        },

        // ä¿å­˜ä»Šå¤©çš„å†…å®¹
        saveTodayMemory() {
          if (!this.newTodayMemory.title.trim()) {
            alert('è¯·è¾“å…¥æ ‡é¢˜');
            return;
          }
          if (this.memoryCategory === 'poetry') {
            if (!this.newTodayMemory.dynasty.trim() || !this.newTodayMemory.author.trim()) {
              alert('è¯·è¾“å…¥æœä»£å’Œä½œè€…');
              return;
            }
          }
          if (this.memoryCategory === 'science') {
            if (!this.newTodayMemory.categoryName.trim()) {
              alert('è¯·è¾“å…¥ç±»åˆ«');
              return;
            }
          }

          if (!this.newTodayMemory.date) {
            alert('è¯·é€‰æ‹©æ—¥æœŸ');
            return;
          }

          const date = this.parseDateInputToLocalDate(this.newTodayMemory.date);
          const contentForPoetry = this.memoryCategory === 'poetry' && !this.newTodayMemory.content.trim()
            ? `${this.newTodayMemory.dynasty.trim()} Â· ${this.newTodayMemory.author.trim()}`
            : this.newTodayMemory.content.trim();
          const base = {
            id: this.uuid(),
            title: this.newTodayMemory.title.trim(),
            content: contentForPoetry,
            category: this.memoryCategory,
            dynasty: this.newTodayMemory.dynasty.trim(),
            author: this.newTodayMemory.author.trim(),
            categoryName: this.newTodayMemory.categoryName.trim(),
            createdAt: date.toISOString()
          };
          
          this.memoryList.push(base);
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));

          // ç”Ÿæˆè‰¾å®¾æµ©æ–¯å¤ä¹ è®¡åˆ’
          const offsets = [1, 2, 4, 7, 15, 30];
          const schedule = [...this.memorySchedule];
          offsets.forEach(offset => {
            const reviewDate = new Date(date);
            reviewDate.setDate(reviewDate.getDate() + offset);
            const reviewDayKey = this.toLocalDateKey(reviewDate);
            schedule.push({
              id: this.uuid(),
              baseId: base.id,
              title: base.title,
              content: base.content,
              category: base.category,
              dynasty: base.dynasty,
              author: base.author,
              categoryName: base.categoryName,
              dayKey: reviewDayKey,
              offsetDay: offset,
              done: false
            });
          });

          this.memorySchedule = schedule;
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(schedule));

          // æ¸…é™¤ç¼“å­˜
          this.reviewStatusCache = {};

          this.newTodayMemory = {
            title: '',
            content: '',
            date: this.toLocalDateKey(new Date()),
            dynasty: '',
            author: '',
            categoryName: ''
          };
          this.showAddTodayModal = false;
          alert('æ·»åŠ æˆåŠŸï¼');
        },

        // å¤„ç†é‡ç½®æŒ‰é’®ç‚¹å‡» - ä½¿ç”¨åŸç”Ÿ confirm
        handleResetClick() {
          if (!this.requireParentIfNeeded(true)) return;
          // å…ˆå…³é—­æ‰€æœ‰å…¶ä»–å¼¹çª—
          this.showMemoryManager = false;
          this.showAddTodayModal = false;
          this.showTemplateManager = false;
          this.showMonthlyReport = false;
          this.editingMemoryId = null;
          this.showResetConfirm = false;
          this.$forceUpdate();
          
          // ä½¿ç”¨åŸç”Ÿ confirm å¯¹è¯æ¡†ï¼ˆé¿å…è‡ªå®šä¹‰å¼¹çª—çš„å…³é—­é—®é¢˜ï¼‰
          setTimeout(() => {
            const confirmed = window.confirm(
              'âš ï¸ æ¢å¤å‡ºå‚è®¾ç½®\n\n' +
              'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡ç½®å—ï¼Ÿ\n' +
              'æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼\n\n' +
              'ç‚¹å‡»"ç¡®å®š"å°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶åˆ·æ–°é¡µé¢ã€‚'
            );
            
            if (confirmed) {
              this.resetAllData();
            }
          }, 100);
        },

        // æ‰“å¼€é‡ç½®ç¡®è®¤å¼¹çª—ï¼ˆå…ˆå…³é—­å…¶ä»–å¼¹çª—ï¼‰
        openResetConfirm() {
          this.handleResetClick();
        },

        // å…³é—­é‡ç½®ç¡®è®¤å¼¹çª—ï¼ˆå·²åºŸå¼ƒï¼Œæ”¹ç”¨åŸç”Ÿ confirmï¼‰
        closeResetConfirm(event) {
          // ç›´æ¥è®¾ç½®ä¸º falseï¼ˆè™½ç„¶ä¸å†ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—ï¼Œä½†ä¿ç•™æ–¹æ³•ä»¥é˜²ä¸‡ä¸€ï¼‰
          this.showResetConfirm = false;
          this.$forceUpdate();
        },

        // æ¢å¤å‡ºå‚è®¾ç½® - é‡ç½®æ‰€æœ‰æ•°æ®
        resetAllData() {
          // æ¸…ç©ºæ‰€æœ‰ localStorage æ•°æ®
          localStorage.clear();
          
          // åˆ·æ–°é¡µé¢
          location.reload();
        },

        // æ•°æ®å½’æ¡£åŠŸèƒ½
        archiveOldData() {
          const now = new Date();
          const threeMonthsAgo = new Date(now);
          threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
          const cutoffDate = this.toLocalDateKey(threeMonthsAgo);
          
          // æ”¶é›†éœ€è¦å½’æ¡£çš„æ•°æ®
          const archive = {
            version: '1.0',
            archiveDate: now.toISOString(),
            cutoffDate: cutoffDate,
            tasks: [],
            memoryItems: [],
            memorySchedule: [],
            stats: {
              totalTasks: 0,
              totalMemoryItems: 0,
              totalScheduleItems: 0
            }
          };

          // å½’æ¡£ä»»åŠ¡æ•°æ®
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const archivedTasks = {};
              
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // åªå½’æ¡£å·²å®Œæˆçš„ä»»åŠ¡
                    const completedTasks = tasks.filter(t => {
                      if (!t.done) return false;
                      // å¦‚æœæœ‰completedAtï¼Œä½¿ç”¨å®ƒï¼›å¦åˆ™ä½¿ç”¨dayKeyä½œä¸ºæ—¥æœŸ
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate < cutoffDate;
                    });
                    
                    if (completedTasks.length > 0) {
                      archivedTasks[dayKey] = completedTasks;
                      archive.stats.totalTasks += completedTasks.length;
                    }
                  }
                }
              });
              
              archive.tasks = archivedTasks;
            } catch (e) {
              console.error('å½’æ¡£ä»»åŠ¡æ•°æ®æ—¶å‡ºé”™:', e);
            }
          }

          // å½’æ¡£è®°å¿†é¡¹å’Œå¤ä¹ è®¡åˆ’
          const memoryList = [...this.memoryList];
          const memorySchedule = [...this.memorySchedule];
          
          // æ‰¾å‡º3ä¸ªæœˆå‰çš„è®°å¿†é¡¹ï¼ˆå·²å®Œæˆæ‰€æœ‰å¤ä¹ çš„ï¼‰
          const oldMemoryItems = memoryList.filter(m => {
            const learnDate = this.toLocalDateKey(new Date(m.createdAt));
            if (learnDate >= cutoffDate) return false;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¤ä¹ éƒ½å·²å®Œæˆ
            const relatedSchedules = memorySchedule.filter(s => s.baseId === m.id);
            if (relatedSchedules.length === 0) return false;
            
            // æ£€æŸ¥æ‰€æœ‰å¤ä¹ æ˜¯å¦éƒ½åœ¨3ä¸ªæœˆå‰ä¸”å·²å®Œæˆ
            const allOldAndDone = relatedSchedules.every(s => {
              const scheduleDate = this.toLocalDateKey(new Date(s.dayKey));
              return scheduleDate < cutoffDate && s.done;
            });
            
            return allOldAndDone;
          });

          oldMemoryItems.forEach(item => {
            archive.memoryItems.push(item);
            archive.stats.totalMemoryItems++;
            
            // æ”¶é›†ç›¸å…³çš„å¤ä¹ è®¡åˆ’
            const relatedSchedules = memorySchedule.filter(s => s.baseId === item.id);
            relatedSchedules.forEach(schedule => {
              archive.memorySchedule.push(schedule);
              archive.stats.totalScheduleItems++;
            });
          });

          // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®éœ€è¦å½’æ¡£
          if (archive.stats.totalTasks === 0 && archive.stats.totalMemoryItems === 0) {
            alert('æ²¡æœ‰æ‰¾åˆ°éœ€è¦å½’æ¡£çš„æ•°æ®ï¼ˆ3ä¸ªæœˆå‰çš„å·²å®Œæˆä»»åŠ¡å’Œå·²ç»“æŸå¤ä¹ çš„è®°å¿†æ¡ç›®ï¼‰ã€‚');
            return;
          }

          // ç”Ÿæˆæ–‡ä»¶å
          const year = now.getFullYear();
          const quarter = Math.floor(now.getMonth() / 3) + 1;
          const prevQuarter = quarter === 1 ? 4 : quarter - 1;
          const prevYear = quarter === 1 ? year - 1 : year;
          const filename = `backup_${prevYear}_Q${prevQuarter}.json`;

          // ä¸‹è½½å½’æ¡£æ–‡ä»¶
          const dataStr = JSON.stringify(archive, null, 2);
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);

          // è¯¢é—®æ˜¯å¦åˆ é™¤æ—§æ•°æ®
          setTimeout(() => {
            const confirmDelete = confirm(
              `å½’æ¡£å®Œæˆï¼\n\n` +
              `å·²å½’æ¡£æ•°æ®ï¼š\n` +
              `- å·²å®Œæˆä»»åŠ¡ï¼š${archive.stats.totalTasks} ä¸ª\n` +
              `- è®°å¿†æ¡ç›®ï¼š${archive.stats.totalMemoryItems} ä¸ª\n` +
              `- å¤ä¹ è®¡åˆ’ï¼š${archive.stats.totalScheduleItems} ä¸ª\n\n` +
              `æ–‡ä»¶å·²ä¿å­˜ä¸ºï¼š${filename}\n\n` +
              `æ˜¯å¦ä» App ä¸­åˆ é™¤è¿™äº›æ—§æ•°æ®ä»¥é‡Šæ”¾ç©ºé—´ï¼Ÿ`
            );

            if (confirmDelete) {
              this.deleteArchivedData(archive, cutoffDate);
            }
          }, 500);
        },

        // åˆ é™¤å·²å½’æ¡£çš„æ•°æ®
        deleteArchivedData(archive, cutoffDate) {
          // åˆ é™¤ä»»åŠ¡æ•°æ®
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              Object.keys(byDay).forEach(dayKey => {
                if (dayKey < cutoffDate) {
                  const tasks = byDay[dayKey];
                  if (Array.isArray(tasks)) {
                    // åªåˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡
                    const remainingTasks = tasks.filter(t => {
                      if (!t.done) return true;
                      const taskDate = t.completedAt ? this.toLocalDateKey(new Date(t.completedAt)) : dayKey;
                      return taskDate >= cutoffDate;
                    });
                    
                    if (remainingTasks.length === 0) {
                      delete byDay[dayKey];
                    } else {
                      byDay[dayKey] = remainingTasks;
                    }
                  }
                }
              });
              
              localStorage.setItem(this.getStorageKey('tasks_by_day'), JSON.stringify(byDay));
            } catch (e) {
              console.error('åˆ é™¤ä»»åŠ¡æ•°æ®æ—¶å‡ºé”™:', e);
            }
          }

          // åˆ é™¤è®°å¿†é¡¹å’Œå¤ä¹ è®¡åˆ’
          const archivedIds = archive.memoryItems.map(m => m.id);
          this.memoryList = this.memoryList.filter(m => !archivedIds.includes(m.id));
          this.memorySchedule = this.memorySchedule.filter(s => !archivedIds.includes(s.baseId));
          
          localStorage.setItem(this.getStorageKey('memory_list'), JSON.stringify(this.memoryList));
          localStorage.setItem(this.getStorageKey('memory_schedule'), JSON.stringify(this.memorySchedule));

          alert('æ—§æ•°æ®å·²æˆåŠŸåˆ é™¤ï¼Œå­˜å‚¨ç©ºé—´å·²é‡Šæ”¾ï¼');
          
          // åˆ·æ–°å½“å‰ä»»åŠ¡åˆ—è¡¨
          this.loadTodayTasks();
        },

        // å¯¼å…¥å†å²å½’æ¡£
        importArchive() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const archive = JSON.parse(event.target.result);
                
                if (!archive.version || !archive.archiveDate) {
                  alert('è¿™ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å½’æ¡£æ–‡ä»¶ã€‚');
                  return;
                }

                // æ˜¾ç¤ºå½’æ¡£ä¿¡æ¯
                const info = `å½’æ¡£ä¿¡æ¯ï¼š\n` +
                  `- å½’æ¡£æ—¥æœŸï¼š${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
                  `- æˆªæ­¢æ—¥æœŸï¼š${archive.cutoffDate}\n` +
                  `- å·²å®Œæˆä»»åŠ¡ï¼š${archive.stats.totalTasks} ä¸ª\n` +
                  `- è®°å¿†æ¡ç›®ï¼š${archive.stats.totalMemoryItems} ä¸ª\n` +
                  `- å¤ä¹ è®¡åˆ’ï¼š${archive.stats.totalScheduleItems} ä¸ª\n\n` +
                  `æ˜¯å¦å¯¼å…¥æŸ¥çœ‹è¿™äº›å†å²æ•°æ®ï¼Ÿ\nï¼ˆå¯¼å…¥åå¯ä»¥æŸ¥çœ‹ï¼Œä½†ä¸ä¼šè¦†ç›–å½“å‰æ•°æ®ï¼‰`;

                if (confirm(info)) {
                  this.viewArchive(archive);
                }
              } catch (e) {
                alert('è¯»å–å½’æ¡£æ–‡ä»¶å¤±è´¥ï¼š' + e.message);
              }
            };
            reader.readAsText(file);
          };
          input.click();
        },

        // æŸ¥çœ‹å½’æ¡£æ•°æ®
        viewArchive(archive) {
          // åˆ›å»ºæŸ¥çœ‹å½’æ¡£çš„å¼¹çª—
          const archiveInfo = `ğŸ“¦ å†å²å½’æ¡£æ•°æ®\n\n` +
            `å½’æ¡£æ—¥æœŸï¼š${new Date(archive.archiveDate).toLocaleString('zh-CN')}\n` +
            `æˆªæ­¢æ—¥æœŸï¼š${archive.cutoffDate}\n\n` +
            `æ•°æ®ç»Ÿè®¡ï¼š\n` +
            `- å·²å®Œæˆä»»åŠ¡ï¼š${archive.stats.totalTasks} ä¸ª\n` +
            `- è®°å¿†æ¡ç›®ï¼š${archive.stats.totalMemoryItems} ä¸ª\n` +
            `- å¤ä¹ è®¡åˆ’ï¼š${archive.stats.totalScheduleItems} ä¸ª\n\n` +
            `è¯¦ç»†æ•°æ®å·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹æˆ–å¯¼å‡ºã€‚`;

          // æ˜¾ç¤ºå½’æ¡£æ•°æ®ï¼ˆå¯ä»¥æ‰©å±•ä¸ºæ›´è¯¦ç»†çš„è§†å›¾ï¼‰
          const dataStr = JSON.stringify(archive, null, 2);
          const newWindow = window.open('', '_blank');
          if (newWindow) {
            newWindow.document.write(`
              <html>
                <head>
                  <title>å†å²å½’æ¡£æ•°æ® - ${archive.cutoffDate}</title>
                  <style>
                    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
                    pre { background: white; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    h1 { color: #333; }
                  </style>
                </head>
                <body>
                  <h1>ğŸ“¦ å†å²å½’æ¡£æ•°æ®</h1>
                  <p><strong>å½’æ¡£æ—¥æœŸï¼š</strong>${new Date(archive.archiveDate).toLocaleString('zh-CN')}</p>
                  <p><strong>æˆªæ­¢æ—¥æœŸï¼š</strong>${archive.cutoffDate}</p>
                  <h2>æ•°æ®è¯¦æƒ…ï¼š</h2>
                  <pre>${dataStr}</pre>
                </body>
              </html>
            `);
          } else {
            alert(archiveInfo + '\n\nè¯¦ç»†æ•°æ®ï¼š\n' + dataStr.substring(0, 500) + '...');
          }
        },

        // å¤ä¹ è®¡åˆ’è§†å›¾è¾…åŠ©
        groupedSchedule() {
          const groups = {};
          this.memorySchedule
            .slice()
            .sort((a, b) => a.dayKey.localeCompare(b.dayKey))
            .forEach(item => {
              if (!groups[item.dayKey]) groups[item.dayKey] = [];
              groups[item.dayKey].push(item);
            });
          return groups;
        },

        formatDate(iso) {
          const d = new Date(iso);
          if (Number.isNaN(d.getTime())) return iso;
          return `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
        },

        // ç»Ÿä¸€ç”Ÿæˆæœ¬åœ°æ—¥æœŸ keyï¼ˆé¿å… UTC åç§»å¯¼è‡´æ—¥æœŸé”™ä¹±ï¼‰
        toLocalDateKey(date) {
          const y = date.getFullYear();
          const m = String(date.getMonth() + 1).padStart(2, '0');
          const d = String(date.getDate()).padStart(2, '0');
          return `${y}-${m}-${d}`;
        },

        // ä¿ç•™ UTC key ç”¨äºå…¼å®¹æ—§æ•°æ®
        toUTCDateKey(date) {
          return date.toISOString().slice(0, 10);
        },

        // å°† date input çš„ YYYY-MM-DD è½¬ä¸ºæœ¬åœ°æ—¶é—´ï¼ˆé¿å… UTC è§£æåç§»ï¼‰
        parseDateInputToLocalDate(dateStr) {
          const [y, m, d] = dateStr.split('-').map(Number);
          if (!y || !m || !d) return new Date();
          return new Date(y, m - 1, d, 12, 0, 0);
        },

        // æ‰¹é‡å¯¼å…¥èµ·å§‹æ—¥æœŸï¼šæœªé€‰æœˆä»½åˆ™ä»ä»Šå¤©å¼€å§‹ï¼›é€‰ä¸­æœˆä»½åˆ™ä»è¯¥æœˆå¼€å§‹ï¼ˆå½“å‰æœˆä»ä»Šå¤©å¼€å§‹ï¼‰
        getBatchImportDateRange() {
          const today = new Date();
          const minDateKey = this.toLocalDateKey(today);
          if (!this.batchImportStartDate || !this.batchImportEndDate) {
            alert('è¯·é€‰æ‹©èµ·å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ');
            return null;
          }
          if (this.batchImportStartDate < minDateKey) {
            alert('èµ·å§‹æ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©');
            return null;
          }
          if (this.batchImportEndDate < this.batchImportStartDate) {
            alert('ç»“æŸæ—¥æœŸä¸èƒ½æ—©äºèµ·å§‹æ—¥æœŸ');
            return null;
          }
          const start = this.parseDateInputToLocalDate(this.batchImportStartDate);
          const end = this.parseDateInputToLocalDate(this.batchImportEndDate);
          return { start, end };
        },

        // é¼“åŠ±è¯­
        refreshQuote() {
          const idx = Math.floor(Math.random() * this.quotes.length);
          this.currentQuote = this.quotes[idx];
        },

        // è¯­éŸ³å½•åˆ¶
        async toggleRecording() {
          if (this.isRecording) {
            if (this.mediaRecorder) {
              this.mediaRecorder.stop();
            }
            this.isRecording = false;
            return;
          }
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.recordingStream = stream;
            this.recordedChunks = [];
            const mr = new MediaRecorder(stream);
            this.mediaRecorder = mr;
            mr.ondataavailable = (e) => {
              if (e.data.size > 0) {
                this.recordedChunks.push(e.data);
              }
            };
            mr.onstop = () => {
              const blob = new Blob(this.recordedChunks, { type: 'audio/webm' });
              if (this.audioUrl) {
                URL.revokeObjectURL(this.audioUrl);
              }
              this.audioUrl = URL.createObjectURL(blob);
              if (this.recordingStream) {
                this.recordingStream.getTracks().forEach(t => t.stop());
                this.recordingStream = null;
              }
              // ç®€åŒ–å¤„ç†ï¼šå½•éŸ³åªåœ¨å½“å‰è®¾å¤‡æœ¬æ¬¡ä¼šè¯æœ‰æ•ˆï¼Œä¸å†™å…¥ localStorage
            };
            mr.start();
            this.isRecording = true;
          } catch (err) {
            alert('å½•éŸ³æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³é¼“åŠ±åŠŸèƒ½ã€‚');
          }
        },
        playAudio() {
          if (!this.audioUrl) return;
          const audio = new Audio(this.audioUrl);
          audio.play();
        },

        // è¡¨æ‰¬ä¿¡
        openMonthlyReport() {
          // æ ‡è®°ä¸ºç”¨æˆ·ä¸»åŠ¨æ‰“å¼€
          this._userInitiatedMonthlyReport = true;
          // ç»Ÿè®¡æœ¬æœˆå®Œæˆä»»åŠ¡æ•°é‡
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          let done = 0;
          if (raw) {
            try {
              const byDay = JSON.parse(raw);
              const now = new Date();
              const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
              Object.entries(byDay).forEach(([key, list]) => {
                if (key.startsWith(ym) && Array.isArray(list)) {
                  list.forEach(t => {
                    if (t && t.done) done += 1;
                  });
                }
              });
            } catch (e) {
              done = 0;
            }
          }
          this.monthlyStats.doneTasks = done;
          this.showMonthlyReport = true;
        },
        closeMonthlyReport(event) {
          if (event) {
            event.preventDefault();
            event.stopPropagation();
          }
          this._userInitiatedMonthlyReport = false;
          this.showMonthlyReport = false;
          // ç«‹å³å¼ºåˆ¶æ›´æ–°
          this.$forceUpdate();
          // å†æ¬¡ç¡®ä¿å…³é—­ï¼ˆé˜²æ­¢å¼‚æ­¥é—®é¢˜ï¼‰
          this.$nextTick(() => {
            this.showMonthlyReport = false;
            this.$forceUpdate();
          });
        },
        printReport() {
          window.print();
        },

        // ç»Ÿè®¡åŠŸèƒ½ï¼šè®¡ç®—æ—¶é—´å·®ï¼ˆåˆ†é’Ÿï¼‰
        calculateTimeDiff(startTime, endTime) {
          if (!startTime || !endTime) return 0;
          const [sh, sm] = startTime.split(':').map(Number);
          const [eh, em] = endTime.split(':').map(Number);
          const start = sh * 60 + sm;
          const end = eh * 60 + em;
          return Math.max(0, end - start);
        },

        // æ ¼å¼åŒ–æ—¶é•¿ä¸ºå¯è¯»å­—ç¬¦ä¸²
        formatDuration(minutes) {
          if (minutes < 60) {
            return `${minutes} åˆ†é’Ÿ`;
          }
          const h = Math.floor(minutes / 60);
          const m = minutes % 60;
          return m > 0 ? `${h} å°æ—¶ ${m} åˆ†é’Ÿ` : `${h} å°æ—¶`;
        },

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        updateStats() {
          try {
            this.calculateDailyStats();
            this.calculateTaskStats();
            this.$nextTick(() => {
              if (typeof Chart !== 'undefined') {
                this.renderDailyChart();
                this.renderTaskChart();
              }
            });
          } catch (error) {
            console.error('æ›´æ–°ç»Ÿè®¡æ—¶å‡ºé”™:', error);
          }
        },

        // è®¡ç®—æ¯æ—¥ç»Ÿè®¡
        calculateDailyStats() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (!raw) {
            this.dailyStats = [];
            return;
          }

          const byDay = JSON.parse(raw);
          const stats = [];

          Object.entries(byDay).forEach(([dayKey, tasks]) => {
            if (!Array.isArray(tasks)) return;

            let totalMinutes = 0;
            let taskCount = 0;

            tasks.forEach(task => {
              if (task.done && task.startTime && task.endTime) {
                const minutes = this.calculateTimeDiff(task.startTime, task.endTime);
                totalMinutes += minutes;
                taskCount += 1;
              }
            });

            if (taskCount > 0) {
              const d = new Date(dayKey);
              const weekNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
              stats.push({
                date: dayKey,
                dateLabel: `${d.getMonth() + 1}/${d.getDate()}ï¼ˆå‘¨${weekNames[d.getDay()]}ï¼‰`,
                taskCount,
                totalMinutes,
                totalTime: this.formatDuration(totalMinutes)
              });
            }
          });

          // æŒ‰æ—¥æœŸå€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          stats.sort((a, b) => b.date.localeCompare(a.date));
          this.dailyStats = stats.slice(0, 30); // åªæ˜¾ç¤ºæœ€è¿‘30å¤©
        },

        // è®¡ç®—ä»»åŠ¡ç»Ÿè®¡
        calculateTaskStats() {
          const raw = localStorage.getItem(this.getStorageKey('tasks_by_day'));
          if (!raw) {
            this.taskStats = [];
            return;
          }

          const byDay = JSON.parse(raw);
          const taskMap = {};

          Object.values(byDay).forEach(tasks => {
            if (!Array.isArray(tasks)) return;

            tasks.forEach(task => {
              if (task.done && task.startTime && task.endTime) {
                const title = task.title;
                if (!taskMap[title]) {
                  taskMap[title] = {
                    title,
                    count: 0,
                    totalMinutes: 0,
                    color: this.taskColors[Object.keys(taskMap).length % this.taskColors.length]
                  };
                }
                taskMap[title].count += 1;
                taskMap[title].totalMinutes += this.calculateTimeDiff(task.startTime, task.endTime);
              }
            });
          });

          const stats = Object.values(taskMap).map(t => ({
            ...t,
            totalTime: this.formatDuration(t.totalMinutes)
          }));

          // æŒ‰ç´¯è®¡æ—¶é•¿é™åºæ’åˆ—
          stats.sort((a, b) => b.totalMinutes - a.totalMinutes);
          this.taskStats = stats;
        },

        // æ¸²æŸ“æ¯æ—¥ç»Ÿè®¡å›¾è¡¨
        renderDailyChart() {
          const ctx = document.getElementById('dailyChart');
          if (!ctx || typeof Chart === 'undefined') return;

          if (this.dailyChart) {
            this.dailyChart.destroy();
          }

          const labels = this.dailyStats.map(d => d.dateLabel).reverse();
          const data = this.dailyStats.map(d => d.totalMinutes).reverse();

          this.dailyChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'å­¦ä¹ æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰',
                data,
                backgroundColor: 'rgba(139, 92, 246, 0.6)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const minutes = context.parsed.y;
                      return `å­¦ä¹ æ—¶é•¿: ${this.formatDuration(minutes)}`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: (value) => {
                      return this.formatDuration(value);
                    }
                  }
                }
              }
            }
          });
        },

        // æ¸²æŸ“ä»»åŠ¡ç»Ÿè®¡å›¾è¡¨
        renderTaskChart() {
          const ctx = document.getElementById('taskChart');
          if (!ctx || typeof Chart === 'undefined') return;

          if (this.taskChart) {
            this.taskChart.destroy();
          }

          const labels = this.taskStats.map(t => t.title);
          const data = this.taskStats.map(t => t.totalMinutes);
          const colors = this.taskStats.map(t => t.color);

          this.taskChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels,
              datasets: [{
                data,
                backgroundColor: colors.map(c => c + '80'), // æ·»åŠ é€æ˜åº¦
                borderColor: colors,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    boxWidth: 12,
                    font: { size: 11 },
                    padding: 8
                  }
                },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const minutes = context.parsed;
                      return `${context.label}: ${this.formatDuration(minutes)}`;
                    }
                  }
                }
              }
            }
          });
        },

        // æ ¹æ®ä¸»é¢˜ç›´æ¥ä¿®æ”¹ body èƒŒæ™¯ï¼Œè®©å˜åŒ–æ›´æ˜æ˜¾
        applyBodyTheme() {
          const map = {
            forest: 'linear-gradient(135deg, #d0f4de 0%, #e8f2ea 40%, #c4e3c1 100%)',
            space: 'radial-gradient(circle at top, #1f2937 0%, #020617 45%, #000000 100%)',
            ocean: 'linear-gradient(145deg, #0ea5e9 0%, #38bdf8 40%, #e0f2fe 100%)',
            candy: 'linear-gradient(135deg, #fecaca 0%, #fef3c7 40%, #e0f2fe 100%)',
            storybook: 'linear-gradient(135deg, #fde68a 0%, #fecaca 40%, #fef3c7 100%)',
            sunset: 'linear-gradient(160deg, #fed7aa 0%, #fb923c 40%, #1e293b 100%)'
          };
          const bg = map[this.theme] || map.forest;
          document.body.style.backgroundImage = bg;
          document.body.style.backgroundColor = '#ffffff';
          document.body.style.backgroundRepeat = 'no-repeat';
          document.body.style.backgroundAttachment = 'fixed';
          document.body.style.backgroundSize = 'cover';
          document.body.style.transition = 'background-image 0.4s ease, background-color 0.4s ease';
        },

        updateBodyMode() {
          if ((this.activeProfile.age || 8) >= 10) {
            document.body.classList.add('mature-mode');
          } else {
            document.body.classList.remove('mature-mode');
          }
        },

        // æ¡£æ¡ˆä¸æˆæƒ
        getStorageKey(base) {
          return `kldx_${this.activeProfileId}_${base}`;
        },
        loadProfiles() {
          const raw = localStorage.getItem('kldx_profiles');
          if (raw) {
            try {
              this.profiles = JSON.parse(raw);
            } catch (e) {
              this.profiles = [];
            }
          }
          if (!this.profiles.length) {
            this.profiles = [{ id: this.uuid(), name: 'å­©å­1', age: 8 }];
          }
          const active = localStorage.getItem('kldx_active_profile');
          this.activeProfileId = active || this.profiles[0].id;
          this.parentPinSet = !!localStorage.getItem('kldx_parent_pin');
          this.migrateOldDataIfNeeded();
          this.saveProfiles();
          this.updateBodyMode();
        },
        saveProfiles() {
          localStorage.setItem('kldx_profiles', JSON.stringify(this.profiles));
          localStorage.setItem('kldx_active_profile', this.activeProfileId);
        },
        setActiveProfile(id) {
          this.activeProfileId = id;
          this.saveProfiles();
          this.loadTodayTasks();
          this.loadTemplates();
          this.loadMemoryData();
          this.loadThemeAndXp();
          this.updateStats();
          this.updateBodyMode();
        },
        addProfile() {
          if (!this.requireParentIfNeeded()) return;
          if (!this.newProfileName.trim()) return;
          const age = Number(this.newProfileAge) || 8;
          this.profiles.push({ id: this.uuid(), name: this.newProfileName.trim(), age });
          this.newProfileName = '';
          this.newProfileAge = 8;
          this.saveProfiles();
          this.setActiveProfile(this.profiles[this.profiles.length - 1].id);
        },
        removeProfile(id) {
          if (!this.requireParentIfNeeded()) return;
          if (this.profiles.length <= 1) {
            alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªæ¡£æ¡ˆ');
            return;
          }
          if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå­©å­æ¡£æ¡ˆå—ï¼Ÿ')) return;
          this.profiles = this.profiles.filter(p => p.id !== id);
          if (this.activeProfileId === id) {
            this.activeProfileId = this.profiles[0].id;
          }
          this.saveProfiles();
          this.setActiveProfile(this.activeProfileId);
        },
        openSettings() {
          if (!this.requireParentIfNeeded(true)) return;
          this.showSettings = true;
        },
        closeSettings() {
          this.showSettings = false;
        },
        handleInstall() {
          if (!this.deferredPrompt) return;
          this.deferredPrompt.prompt();
          this.deferredPrompt.userChoice.then(() => {
            this.deferredPrompt = null;
            this.showInstall = false;
          });
        },
        requireParentIfNeeded(forSettings) {
          const age = this.activeProfile.age || 8;
          const pin = localStorage.getItem('kldx_parent_pin');
          this.parentPinSet = !!pin;
          if (!pin) {
            const setNow = confirm('å°šæœªè®¾ç½®å®¶é•¿ PINï¼Œæ˜¯å¦ç°åœ¨è®¾ç½®ï¼Ÿ');
            if (setNow) this.setParentPin();
            return false;
          }
          if (this.isParentUnlocked) return true;
          const input = prompt('è¯·è¾“å…¥ 6 ä½å®¶é•¿ PIN');
          if (input && input === pin) {
            this.isParentUnlocked = true;
            return true;
          }
          alert('éœ€è¦å®¶é•¿æˆæƒ');
          return false;
        },
        setParentPin() {
          const pin = prompt('è®¾ç½® 6 ä½å®¶é•¿ PIN');
          if (!pin || !/^\d{6}$/.test(pin)) {
            alert('PIN å¿…é¡»æ˜¯ 6 ä½æ•°å­—');
            return;
          }
          localStorage.setItem('kldx_parent_pin', pin);
          this.parentPinSet = true;
          this.isParentUnlocked = true;
          alert('PIN è®¾ç½®æˆåŠŸ');
        },
        resetParentPin() {
          if (!confirm('é‡ç½® PIN ä¼šæ¸…ç©ºå®¶é•¿æˆæƒè®°å½•ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;
          localStorage.removeItem('kldx_parent_pin');
          this.parentPinSet = false;
          this.isParentUnlocked = false;
          alert('PIN å·²é‡ç½®');
        },
        migrateOldDataIfNeeded() {
          if (localStorage.getItem('kldx_migrated')) return;
          const pid = this.activeProfileId;
          const map = [
            'tasks_by_day', 'templates', 'xp', 'theme',
            'memory_list', 'memory_schedule'
          ];
          map.forEach(key => {
            const oldKey = `kldx_${key}`;
            const val = localStorage.getItem(oldKey);
            if (val !== null) {
              localStorage.setItem(`kldx_${pid}_${key}`, val);
            }
          });
          localStorage.setItem('kldx_migrated', 'true');
        },

        loadMemoryData() {
          const rawList = localStorage.getItem(this.getStorageKey('memory_list'));
          if (rawList) {
            try {
              const parsed = JSON.parse(rawList);
              this.memoryList = parsed.map(item => {
                if (!item.category) {
                  const title = item.title || '';
                  const content = item.content || '';
                  if (title.includes('ã€Š') || content.includes('è¯—') || content.includes('è¯')) {
                    item.category = 'poetry';
                  } else if (/[a-zA-Z]/.test(title) || /[a-zA-Z]/.test(content)) {
                    item.category = 'english';
                  } else {
                    item.category = 'science';
                  }
                }
                return item;
              });
            } catch (e) {
              this.memoryList = [];
            }
          } else {
            this.memoryList = [];
          }
          const rawSchedule = localStorage.getItem(this.getStorageKey('memory_schedule'));
          if (rawSchedule) {
            try {
              this.memorySchedule = JSON.parse(rawSchedule);
            } catch (e) {
              this.memorySchedule = [];
            }
          } else {
            this.memorySchedule = [];
          }
        },
        loadThemeAndXp() {
          const theme = localStorage.getItem(this.getStorageKey('theme'));
          if (theme) this.theme = theme;
          const storedXp = localStorage.getItem(this.getStorageKey('xp'));
          if (storedXp) this.xp = parseInt(storedXp, 10) || 0;
        },

        // å·¥å…·
        uuid() {
          return 'xxxx-4xxx-yxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
          });
        }
      },
      created() {
        // åœ¨ created é’©å­ä¸­è®¾ç½®åˆå§‹å€¼ï¼ˆæ¯” mounted æ›´æ—©ï¼‰
        // ç¡®ä¿ç”¨æˆ·æ ‡è®°ä¹Ÿä¸º false
        this.showResetConfirm = false;
        this.showMemoryManager = false;
        this.showAddTodayModal = false;
        this.showTemplateManager = false;
        this.showMonthlyReport = false;
        this._userInitiatedMemoryManager = false;
        this._userInitiatedMonthlyReport = false;
      },
      mounted() {
        try {
        // å¼ºåˆ¶æ¸…é™¤å¯èƒ½å­˜åœ¨çš„ localStorage å¼¹çª—çŠ¶æ€
        localStorage.removeItem('kldx_showMemoryManager');
        localStorage.removeItem('kldx_showMonthlyReport');
        
        // ç¡®ä¿æ‰€æœ‰å¼¹çª—åˆå§‹çŠ¶æ€ä¸ºå…³é—­ï¼ˆå¿…é¡»åœ¨æœ€å‰é¢ï¼Œé˜²æ­¢å…¶ä»–ä»£ç æ‰“å¼€å¼¹çª—ï¼‰
        // ä½¿ç”¨ Object.assign å¼ºåˆ¶è®¾ç½®æ‰€æœ‰å¼¹çª—ä¸º false
        // åŒæ—¶ç¡®ä¿ç”¨æˆ·æ ‡è®°ä¹Ÿä¸º falseï¼ˆå¿…é¡»åœ¨ watch ä¹‹å‰è®¾ç½®ï¼‰
        Object.assign(this, {
          showResetConfirm: false,
          showMemoryManager: false,
          showAddTodayModal: false,
          showTemplateManager: false,
          showMonthlyReport: false,
          _userInitiatedMemoryManager: false,
          _userInitiatedMonthlyReport: false
        });
        
        // æ·»åŠ  watch ç›‘å¬å™¨ï¼Œä¸€æ—¦æ£€æµ‹åˆ°å¼¹çª—è¢«æ‰“å¼€ï¼Œç«‹å³å¼ºåˆ¶å…³é—­
        // ä½¿ç”¨ immediate: true ç«‹å³æ£€æŸ¥å½“å‰å€¼
        this.$watch('showMemoryManager', (newVal, oldVal) => {
          // å¼ºåˆ¶å…³é—­ï¼šå¦‚æœä¸º true ä¸”ä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨æ‰“å¼€ï¼Œç«‹å³å…³é—­
          if (newVal === true) {
            if (!this._userInitiatedMemoryManager) {
              console.warn('âš ï¸ [watch] æ£€æµ‹åˆ° showMemoryManager è¢«æ„å¤–è®¾ç½®ä¸º trueï¼Œç«‹å³å¼ºåˆ¶å…³é—­');
              // ç«‹å³åŒæ­¥å…³é—­
              this.showMemoryManager = false;
              this._userInitiatedMemoryManager = false;
              // å¼ºåˆ¶æ›´æ–°è§†å›¾
              this.$forceUpdate();
              // å†æ¬¡ç¡®ä¿ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼‰
              setTimeout(() => {
                this.showMemoryManager = false;
                this._userInitiatedMemoryManager = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        this.$watch('showMonthlyReport', (newVal, oldVal) => {
          // å¼ºåˆ¶å…³é—­ï¼šå¦‚æœä¸º true ä¸”ä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨æ‰“å¼€ï¼Œç«‹å³å…³é—­
          if (newVal === true) {
            if (!this._userInitiatedMonthlyReport) {
              console.warn('âš ï¸ [watch] æ£€æµ‹åˆ° showMonthlyReport è¢«æ„å¤–è®¾ç½®ä¸º trueï¼Œç«‹å³å¼ºåˆ¶å…³é—­');
              // ç«‹å³åŒæ­¥å…³é—­
              this.showMonthlyReport = false;
              this._userInitiatedMonthlyReport = false;
              // å¼ºåˆ¶æ›´æ–°è§†å›¾
              this.$forceUpdate();
              // å†æ¬¡ç¡®ä¿ï¼ˆå»¶è¿Ÿä¸€ç‚¹ï¼‰
              setTimeout(() => {
                this.showMonthlyReport = false;
                this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }, 1);
            }
          }
        }, { immediate: true });
        
        // ç«‹å³å¼ºåˆ¶æ›´æ–°è§†å›¾ï¼Œç¡®ä¿å¼¹çª—ä¸ä¼šæ˜¾ç¤º
        this.$forceUpdate();
        
        // ä½¿ç”¨ nextTick å†æ¬¡ç¡®ä¿
        this.$nextTick(() => {
          Object.assign(this, {
            showResetConfirm: false,
            showMemoryManager: false,
            showAddTodayModal: false,
            showTemplateManager: false,
            showMonthlyReport: false
          });
          this.$forceUpdate();
        });
        
        // åˆå§‹åŒ–æ¡£æ¡ˆä¸æ•°æ®
        this.loadProfiles();
        this.loadThemeAndXp();
        this.loadMemoryData();
        if (this.applyBodyTheme) {
          this.applyBodyTheme();
        }
        this.updateBodyMode();

          // åˆå§‹åŒ–å‘¨è§†å›¾
          const today = new Date();
          const day = today.getDay();
          const diff = today.getDate() - day + (day === 0 ? -6 : 1);
          const monday = new Date(today.setDate(diff));
          this.currentWeekStart = new Date(monday);

        // è½½å…¥æ¨¡æ¿åˆ—è¡¨
        if (this.loadTemplates) {
          this.loadTemplates();
        }

        // è½½å…¥ä»Šæ—¥ä»»åŠ¡ & åˆå§‹é¼“åŠ±è¯­
          if (this.loadTodayTasks) {
        this.loadTodayTasks();
          }
        if (this.refreshQuote) {
          this.refreshQuote();
        }

        // PWA å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          this.deferredPrompt = e;
          this.showInstall = true;
        });
        window.addEventListener('appinstalled', () => {
          this.showInstall = false;
          this.deferredPrompt = null;
        });
        // iOS å®‰è£…æç¤ºï¼ˆSafariï¼‰
        const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        if (isIos && !isStandalone) {
          this.showIosInstallHint = true;
        }

        // ç›‘å¬ä»»åŠ¡å˜åŒ–ï¼Œè‡ªåŠ¨ä¿å­˜ï¼ˆä¿é™©ï¼‰
        this.$watch('tasks', () => {
          if (this.saveTodayTasks) {
            this.saveTodayTasks();
          }
          if (this.activeTab === 'stats' && this.updateStats) {
            this.updateStats();
          }
        }, { deep: true });

          // ç›‘å¬æ ‡ç­¾é¡µåˆ‡æ¢ï¼Œå½“åˆ‡æ¢åˆ°ç»Ÿè®¡æ—¶è‡ªåŠ¨æ›´æ–°
          // ç›‘å¬åˆ†ç±»åˆ‡æ¢ï¼Œæ¸…é™¤ç¼“å­˜
          this.$watch('memoryCategory', () => {
            this.reviewStatusCache = {};
          });
        
        // ç›‘å¬è®°å¿†æ•°æ®å˜åŒ–ï¼Œæ¸…é™¤ç¼“å­˜ï¼Œç¡®ä¿å†…å®¹æ›´æ–°
        this.$watch('memoryList', () => {
          this.reviewStatusCache = {};
        }, { deep: true });
        this.$watch('memorySchedule', () => {
          this.reviewStatusCache = {};
        }, { deep: true });

          this.$watch('activeTab', (newTab) => {
            if (newTab === 'stats' && this.updateStats) {
              this.updateStats();
            }
          });
          
          // ç»Ÿè®¡è§†å›¾åˆ‡æ¢æ—¶é‡æ–°æ¸²æŸ“å›¾è¡¨
          this.$watch('statsViewMode', () => {
            if (this.activeTab === 'stats' && this.updateStats) {
              this.updateStats();
            }
          });
          
          // å¦‚æœ Chart.js è¿˜æœªåŠ è½½ï¼Œè½®è¯¢ç›´åˆ°å¯ç”¨
          const chartReadyTimer = setInterval(() => {
            if (typeof Chart !== 'undefined') {
              if (this.activeTab === 'stats' && this.updateStats) {
                this.updateStats();
              }
              clearInterval(chartReadyTimer);
            }
          }, 200);
          
          // æœ€åå†æ¬¡ç¡®ä¿æ‰€æœ‰å¼¹çª—å…³é—­ï¼ˆé˜²æ­¢å¼‚æ­¥æ“ä½œæ‰“å¼€å¼¹çª—ï¼‰
          // ä½¿ç”¨å¤šä¸ªå»¶è¿Ÿç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„å¼‚æ­¥æ“ä½œ
          [50, 100, 200, 500, 1000, 2000].forEach(delay => {
            setTimeout(() => {
              const shouldForceCloseMemory = this.showMemoryManager && !this._userInitiatedMemoryManager;
              const shouldForceCloseReport = this.showMonthlyReport && !this._userInitiatedMonthlyReport;
              if (shouldForceCloseMemory || shouldForceCloseReport) {
                console.log('âš ï¸ æ£€æµ‹åˆ°å¼¹çª—è‡ªåŠ¨æ‰“å¼€ï¼Œå¼ºåˆ¶å…³é—­ã€‚å»¶è¿Ÿ:', delay);
                this.showResetConfirm = false;
                if (shouldForceCloseMemory) this.showMemoryManager = false;
                this.showAddTodayModal = false;
                this.showTemplateManager = false;
                if (shouldForceCloseReport) this.showMonthlyReport = false;
                // åŒæ—¶æ¸…é™¤ç”¨æˆ·æ ‡è®°
                if (shouldForceCloseMemory) this._userInitiatedMemoryManager = false;
                if (shouldForceCloseReport) this._userInitiatedMonthlyReport = false;
                this.$forceUpdate();
              }
            }, delay);
          });
        } catch (error) {
          console.error('åˆå§‹åŒ–æ—¶å‡ºé”™:', error);
        }
      }
    }).mount('#app');
      } catch (error) {
        console.error('åˆ›å»º Vue åº”ç”¨æ—¶å‡ºé”™:', error);
        document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>é”™è¯¯ï¼šæ— æ³•åˆ›å»º Vue åº”ç”¨</h1><p>' + error.message + '</p></div>';
      }
    }
  </script>
  <!-- Chart.js CDN - æ”¾åœ¨æœ€åï¼Œç¡®ä¿åœ¨ Vue åˆå§‹åŒ–ååŠ è½½ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Service Worker Registration -->
  <script>
    // æ³¨å†Œ Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {
            console.log('âœ… Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
            
            // æ£€æŸ¥æ›´æ–°
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæç¤ºç”¨æˆ·åˆ·æ–°
                  if (confirm('å‘ç°æ–°ç‰ˆæœ¬ï¼Œæ˜¯å¦ç«‹å³åˆ·æ–°ï¼Ÿ')) {
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.log('âŒ Service Worker æ³¨å†Œå¤±è´¥:', error);
          });
        
        // ç›‘å¬ Service Worker æ›´æ–°
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          console.log('ğŸ”„ Service Worker å·²æ›´æ–°');
        });
      });
    } else {
      console.log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒ Service Worker');
    }
  </script>
</body>
</html>
